import{P as ee}from"./phaser-0RJB29YE.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();class vc{constructor(){this.listeners=new Map}on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}once(e,t){const s=i=>{this.off(e,s),t(i)};this.on(e,s)}off(e,t){const s=this.listeners.get(e);if(s){const i=s.indexOf(t);i>-1&&s.splice(i,1)}}emit(e,t){const s=this.listeners.get(e);s&&[...s].forEach(n=>{try{n(t)}catch(a){const l=a instanceof Error?a:new Error(String(a));if(this.errorHandler)try{this.errorHandler(l,e,t)}catch(h){console.error(`Error in event error handler for ${e}:`,h),console.error("Original error:",l)}else console.error(`Error in event listener for ${e}:`,l)}})}setErrorHandler(e){this.errorHandler=e}removeErrorHandler(){this.errorHandler=void 0}removeAllListeners(e){e?this.listeners.delete(e):this.listeners.clear()}listenerCount(e){var t;return((t=this.listeners.get(e))==null?void 0:t.length)??0}eventNames(){return Array.from(this.listeners.keys()).filter(e=>this.listenerCount(e)>0)}hasListeners(e){return this.listenerCount(e)>0}}const Yr=class Yr{static createInitialState(e,t){const s=Date.now(),i={position:{x:0,y:0},inventory:[],stats:{totalMoves:0,orbsCollected:0,timeElapsed:0,powerupsUsed:0,hintsUsed:0},activePowerups:[]},n=e.config.objectives.map(a=>({id:a.id,type:a.type,target:a.target,current:0,completed:!1,description:a.description,required:a.required}));return{levelId:e.id,levelConfig:e,status:"initializing",startTime:s,currentTime:s,pausedTime:0,player:i,maze:[],orbs:[],powerups:[],objectives:n,score:0,moves:0,hintsUsed:0,version:this.STATE_VERSION,seed:t}}static cloneState(e){return this.deepClone(e)}static deepClone(e){if(e===null||typeof e!="object")return e;if(e instanceof Date)return new Date(e.getTime());if(e instanceof Array)return e.map(t=>this.deepClone(t));if(typeof e=="object"){const t={};for(const s in e)e.hasOwnProperty(s)&&(t[s]=this.deepClone(e[s]));return t}return e}static updateState(e,t){const s=this.cloneState(e);return this.deepMerge(s,t)}static deepMerge(e,t){const s={...e};for(const i in t)if(t.hasOwnProperty(i)){const n=t[i],a=e[i];n!==void 0&&(this.isObject(n)&&this.isObject(a)?s[i]=this.deepMerge(a,n):s[i]=n)}return s}static isObject(e){return e&&typeof e=="object"&&!Array.isArray(e)&&!(e instanceof Date)}static updatePlayerPosition(e,t){return this.updateState(e,{player:{position:t,stats:{totalMoves:e.player.stats.totalMoves+1}},moves:e.moves+1,currentTime:Date.now()})}static updatePlayerStats(e,t){return this.updateState(e,{player:{stats:{...e.player.stats,...t}}})}static collectOrb(e,t){const s=e.orbs.findIndex(a=>a.id===t);if(s===-1||e.orbs[s].collected)return e;const i=e.orbs[s],n=[...e.orbs];return n[s]={...i,collected:!0,collectedAt:Date.now()},this.updateState(e,{orbs:n,score:e.score+i.value,player:{stats:{orbsCollected:e.player.stats.orbsCollected+1}}})}static updateObjectiveProgress(e,t,s){const i=e.objectives.findIndex(h=>h.id===t);if(i===-1)return e;const n=e.objectives[i],a=[...e.objectives],l=s>=n.target;return a[i]={...n,current:s,completed:l,completedAt:l&&!n.completed?Date.now():n.completedAt},this.updateState(e,{objectives:a})}static updateGameStatus(e,t){const s=Date.now(),i={status:t,currentTime:s};if(t==="playing"&&e.status==="paused"){const n=s-e.currentTime;i.pausedTime=e.pausedTime+n}else if(t==="completed"||t==="failed"){const n=s-e.startTime-e.pausedTime;i.player={stats:{timeElapsed:n}},t==="completed"&&(i.result=this.calculateGameResult(e,n))}return this.updateState(e,i)}static calculateGameResult(e,t){const s=e.objectives.filter(l=>l.completed).length,n=e.objectives.filter(l=>l.required).every(l=>l.completed);let a=0;if(n){a=1;const l=e.levelConfig.progression.starThresholds;for(const h of l.sort((d,m)=>m.stars-d.stars)){let d=!0;if(h.requirements.time&&t>h.requirements.time*1e3&&(d=!1),h.requirements.moves&&e.moves>h.requirements.moves&&(d=!1),h.requirements.orbsCollected&&e.player.stats.orbsCollected<h.requirements.orbsCollected&&(d=!1),d){a=Math.max(a,h.stars);break}}}return{completed:n,score:e.score,stars:a,completionTime:t,totalMoves:e.moves,orbsCollected:e.player.stats.orbsCollected,objectivesCompleted:s,constraintsViolated:0}}static validateState(e){return this.validateStateDetailed(e).valid}static validateStateDetailed(e){const t=[],s=[];try{return!e||typeof e!="object"?(t.push({field:"state",message:"State must be a valid object",code:"INVALID_STATE_TYPE"}),{valid:!1,errors:t,warnings:s}):(this.validateRequiredFields(e,t),this.validatePlayer(e.player,e.maze,t,s),this.validateMaze(e.maze,t,s),this.validateOrbs(e.orbs,e.maze,t,s),this.validatePowerups(e.powerups,e.maze,t,s),this.validateObjectives(e.objectives,e,t,s),this.validateGameMetrics(e,t,s),this.validateTiming(e,t,s),this.validateCrossReferences(e,t,s),{valid:t.length===0,errors:t,warnings:s})}catch(i){return t.push({field:"validation",message:`Validation failed with error: ${i.message}`,code:"VALIDATION_ERROR"}),{valid:!1,errors:t,warnings:s}}}static validateRequiredFields(e,t){const s=["levelId","levelConfig","status","startTime","currentTime","player","maze","orbs","objectives","score","moves"];for(const i of s)(!(i in e)||e[i]===null||e[i]===void 0)&&t.push({field:i,message:`Required field '${i}' is missing or null`,code:"MISSING_REQUIRED_FIELD"});(typeof e.levelId!="string"||e.levelId.length===0)&&t.push({field:"levelId",message:"Level ID must be a non-empty string",code:"INVALID_LEVEL_ID"}),["initializing","playing","paused","completed","failed"].includes(e.status)||t.push({field:"status",message:"Invalid game status",code:"INVALID_STATUS"})}static validatePlayer(e,t,s,i){var n;if(!e){s.push({field:"player",message:"Player object is required",code:"MISSING_PLAYER"});return}if(!this.isValidPosition(e.position))s.push({field:"player.position",message:"Player position is invalid",code:"INVALID_PLAYER_POSITION"});else if(t.length>0){const a=t.length,l=((n=t[0])==null?void 0:n.length)||0;(e.position.x<0||e.position.x>=l||e.position.y<0||e.position.y>=a)&&s.push({field:"player.position",message:`Player position (${e.position.x}, ${e.position.y}) is outside maze bounds (${l}x${a})`,code:"PLAYER_OUT_OF_BOUNDS"})}if(Array.isArray(e.inventory)?e.inventory.forEach((a,l)=>{(!a.id||typeof a.id!="string")&&s.push({field:`player.inventory[${l}].id`,message:"Inventory item must have a valid ID",code:"INVALID_INVENTORY_ITEM"}),(typeof a.quantity!="number"||a.quantity<0)&&s.push({field:`player.inventory[${l}].quantity`,message:"Inventory item quantity must be a non-negative number",code:"INVALID_INVENTORY_QUANTITY"})}):s.push({field:"player.inventory",message:"Player inventory must be an array",code:"INVALID_INVENTORY"}),!e.stats)s.push({field:"player.stats",message:"Player stats are required",code:"MISSING_PLAYER_STATS"});else{const a=e.stats;(typeof a.totalMoves!="number"||a.totalMoves<0)&&s.push({field:"player.stats.totalMoves",message:"Total moves must be a non-negative number",code:"INVALID_TOTAL_MOVES"}),(typeof a.orbsCollected!="number"||a.orbsCollected<0)&&s.push({field:"player.stats.orbsCollected",message:"Orbs collected must be a non-negative number",code:"INVALID_ORBS_COLLECTED"}),(typeof a.timeElapsed!="number"||a.timeElapsed<0)&&s.push({field:"player.stats.timeElapsed",message:"Time elapsed must be a non-negative number",code:"INVALID_TIME_ELAPSED"})}}static validateMaze(e,t,s){var n;if(!Array.isArray(e)){t.push({field:"maze",message:"Maze must be an array",code:"INVALID_MAZE_TYPE"});return}if(e.length===0){t.push({field:"maze",message:"Maze cannot be empty",code:"EMPTY_MAZE"});return}const i=((n=e[0])==null?void 0:n.length)||0;if(i===0){t.push({field:"maze[0]",message:"Maze rows cannot be empty",code:"EMPTY_MAZE_ROW"});return}e.forEach((a,l)=>{if(!Array.isArray(a)){t.push({field:`maze[${l}]`,message:"Maze row must be an array",code:"INVALID_MAZE_ROW"});return}a.length!==i&&t.push({field:`maze[${l}]`,message:`Maze row ${l} has width ${a.length}, expected ${i}`,code:"INCONSISTENT_MAZE_WIDTH"}),a.forEach((h,d)=>{if(!h||typeof h!="object"){t.push({field:`maze[${l}][${d}]`,message:"Maze cell must be an object",code:"INVALID_MAZE_CELL"});return}(typeof h.walls!="number"||h.walls<0||h.walls>15)&&t.push({field:`maze[${l}][${d}].walls`,message:"Cell walls must be a number between 0 and 15",code:"INVALID_CELL_WALLS"}),["floor","wall","special"].includes(h.type)||t.push({field:`maze[${l}][${d}].type`,message:"Cell type must be floor, wall, or special",code:"INVALID_CELL_TYPE"})})})}static validateOrbs(e,t,s,i){if(!Array.isArray(e)){s.push({field:"orbs",message:"Orbs must be an array",code:"INVALID_ORBS_TYPE"});return}const n=new Set;e.forEach((a,l)=>{var h;if(!a||typeof a!="object"){s.push({field:`orbs[${l}]`,message:"Orb must be an object",code:"INVALID_ORB"});return}if(!a.id||typeof a.id!="string"?s.push({field:`orbs[${l}].id`,message:"Orb must have a valid ID",code:"INVALID_ORB_ID"}):n.has(a.id)?s.push({field:`orbs[${l}].id`,message:`Duplicate orb ID: ${a.id}`,code:"DUPLICATE_ORB_ID"}):n.add(a.id),!this.isValidPosition(a.position))s.push({field:`orbs[${l}].position`,message:"Orb position is invalid",code:"INVALID_ORB_POSITION"});else if(t.length>0){const d=t.length,m=((h=t[0])==null?void 0:h.length)||0;(a.position.x<0||a.position.x>=m||a.position.y<0||a.position.y>=d)&&s.push({field:`orbs[${l}].position`,message:`Orb position (${a.position.x}, ${a.position.y}) is outside maze bounds`,code:"ORB_OUT_OF_BOUNDS"})}(typeof a.value!="number"||a.value<0)&&s.push({field:`orbs[${l}].value`,message:"Orb value must be a non-negative number",code:"INVALID_ORB_VALUE"}),typeof a.collected!="boolean"&&s.push({field:`orbs[${l}].collected`,message:"Orb collected status must be a boolean",code:"INVALID_ORB_COLLECTED"})})}static validatePowerups(e,t,s,i){if(!Array.isArray(e)){s.push({field:"powerups",message:"Powerups must be an array",code:"INVALID_POWERUPS_TYPE"});return}const n=new Set;e.forEach((a,l)=>{if(!a||typeof a!="object"){s.push({field:`powerups[${l}]`,message:"Powerup must be an object",code:"INVALID_POWERUP"});return}!a.id||typeof a.id!="string"?s.push({field:`powerups[${l}].id`,message:"Powerup must have a valid ID",code:"INVALID_POWERUP_ID"}):n.has(a.id)?s.push({field:`powerups[${l}].id`,message:`Duplicate powerup ID: ${a.id}`,code:"DUPLICATE_POWERUP_ID"}):n.add(a.id),this.isValidPosition(a.position)||s.push({field:`powerups[${l}].position`,message:"Powerup position is invalid",code:"INVALID_POWERUP_POSITION"}),(!a.type||typeof a.type!="string")&&s.push({field:`powerups[${l}].type`,message:"Powerup must have a valid type",code:"INVALID_POWERUP_TYPE"})})}static validateObjectives(e,t,s,i){if(!Array.isArray(e)){s.push({field:"objectives",message:"Objectives must be an array",code:"INVALID_OBJECTIVES_TYPE"});return}const n=new Set;let a=!1;e.forEach((l,h)=>{if(!l||typeof l!="object"){s.push({field:`objectives[${h}]`,message:"Objective must be an object",code:"INVALID_OBJECTIVE"});return}!l.id||typeof l.id!="string"?s.push({field:`objectives[${h}].id`,message:"Objective must have a valid ID",code:"INVALID_OBJECTIVE_ID"}):n.has(l.id)?s.push({field:`objectives[${h}].id`,message:`Duplicate objective ID: ${l.id}`,code:"DUPLICATE_OBJECTIVE_ID"}):n.add(l.id),(typeof l.current!="number"||l.current<0)&&s.push({field:`objectives[${h}].current`,message:"Objective current progress must be a non-negative number",code:"INVALID_OBJECTIVE_CURRENT"}),(typeof l.target!="number"||l.target<0)&&s.push({field:`objectives[${h}].target`,message:"Objective target must be a non-negative number",code:"INVALID_OBJECTIVE_TARGET"}),l.current>l.target&&!["time_limit","move_limit"].includes(l.type)&&i.push({field:`objectives[${h}].current`,message:`Objective current (${l.current}) exceeds target (${l.target})`,code:"OBJECTIVE_EXCEEDS_TARGET"}),typeof l.completed!="boolean"&&s.push({field:`objectives[${h}].completed`,message:"Objective completed status must be a boolean",code:"INVALID_OBJECTIVE_COMPLETED"}),l.required&&(a=!0)}),!a&&e.length>0&&i.push({field:"objectives",message:"No required objectives found",code:"NO_REQUIRED_OBJECTIVES"})}static validateGameMetrics(e,t,s){var i;(typeof e.score!="number"||e.score<0)&&t.push({field:"score",message:"Score must be a non-negative number",code:"INVALID_SCORE"}),(typeof e.moves!="number"||e.moves<0)&&t.push({field:"moves",message:"Moves must be a non-negative number",code:"INVALID_MOVES"}),(typeof e.hintsUsed!="number"||e.hintsUsed<0)&&t.push({field:"hintsUsed",message:"Hints used must be a non-negative number",code:"INVALID_HINTS_USED"}),(i=e.player)!=null&&i.stats&&e.moves!==e.player.stats.totalMoves&&s.push({field:"moves",message:`Game moves (${e.moves}) doesn't match player stats (${e.player.stats.totalMoves})`,code:"MOVES_MISMATCH"})}static validateTiming(e,t,s){(typeof e.startTime!="number"||e.startTime<=0)&&t.push({field:"startTime",message:"Start time must be a positive number",code:"INVALID_START_TIME"}),(typeof e.currentTime!="number"||e.currentTime<0)&&t.push({field:"currentTime",message:"Current time must be a non-negative number",code:"INVALID_CURRENT_TIME"}),e.startTime>0&&e.currentTime>0&&e.currentTime<e.startTime&&t.push({field:"currentTime",message:"Current time cannot be before start time",code:"CURRENT_TIME_BEFORE_START"}),(typeof e.pausedTime!="number"||e.pausedTime<0)&&t.push({field:"pausedTime",message:"Paused time must be a non-negative number",code:"INVALID_PAUSED_TIME"});const i=Date.now();e.startTime>i+864e5&&s.push({field:"startTime",message:"Start time is far in the future",code:"FUTURE_START_TIME"})}static validateCrossReferences(e,t,s){var a;const i=e.orbs.filter(l=>l.collected).length;(a=e.player)!=null&&a.stats&&i!==e.player.stats.orbsCollected&&s.push({field:"player.stats.orbsCollected",message:`Player stats show ${e.player.stats.orbsCollected} orbs collected, but ${i} orbs are marked as collected`,code:"ORBS_COLLECTED_MISMATCH"}),e.objectives.filter(l=>l.completed).forEach((l,h)=>{l.current<l.target&&!["time_limit","move_limit"].includes(l.type)&&s.push({field:`objectives[${h}]`,message:`Objective marked as completed but current (${l.current}) < target (${l.target})`,code:"COMPLETED_OBJECTIVE_INCONSISTENT"})})}static isValidPosition(e){return e&&typeof e.x=="number"&&typeof e.y=="number"&&e.x>=0&&e.y>=0&&Number.isInteger(e.x)&&Number.isInteger(e.y)}static toJSON(e){try{return JSON.stringify(e,this.serializationReplacer,0)}catch(t){throw new Error(`Failed to serialize game state: ${t.message}`)}}static fromJSON(e){try{const t=JSON.parse(e,this.serializationReviver),s=this.migrateState(t);if(!this.validateState(s))throw new Error("Invalid game state structure");return s}catch(t){throw new Error(`Failed to deserialize game state: ${t.message}`)}}static serializationReplacer(e,t){return t instanceof Date?{__type:"Date",__value:t.toISOString()}:t instanceof Map?{__type:"Map",__value:Array.from(t.entries())}:t instanceof Set?{__type:"Set",__value:Array.from(t)}:t instanceof RegExp?{__type:"RegExp",__value:t.toString()}:t===void 0?{__type:"undefined"}:t}static serializationReviver(e,t){if(t&&typeof t=="object"&&t.__type)switch(t.__type){case"Date":return new Date(t.__value);case"Map":return new Map(t.__value);case"Set":return new Set(t.__value);case"RegExp":const s=t.__value.match(/^\/(.*)\/([gimuy]*)$/);return s?new RegExp(s[1],s[2]):new RegExp(t.__value);case"undefined":return;default:return t}return t}static toCompressedJSON(e){const t={v:e.version,lid:e.levelId,st:e.status,stt:e.startTime,ct:e.currentTime,pt:e.pausedTime,p:{pos:e.player.position,inv:e.player.inventory,stats:e.player.stats,ap:e.player.activePowerups},m:e.maze,o:e.orbs,pu:e.powerups,obj:e.objectives,sc:e.score,mv:e.moves,h:e.hintsUsed,r:e.result,s:e.seed};return this.toJSON(t)}static fromCompressedJSON(e,t){try{const s=JSON.parse(e,this.serializationReviver),i={version:s.v||this.STATE_VERSION,levelId:s.lid,levelConfig:t,status:s.st,startTime:s.stt,currentTime:s.ct,pausedTime:s.pt||0,player:{position:s.p.pos,inventory:s.p.inv||[],stats:s.p.stats,activePowerups:s.p.ap||[]},maze:s.m,orbs:s.o||[],powerups:s.pu||[],objectives:s.obj||[],score:s.sc||0,moves:s.mv||0,hintsUsed:s.h||0,result:s.r,seed:s.s};if(!this.validateState(i))throw new Error("Invalid compressed game state structure");return i}catch(s){throw new Error(`Failed to deserialize compressed game state: ${s.message}`)}}static migrateState(e){return(!e.version||e.version<this.STATE_VERSION)&&(e.version=this.STATE_VERSION),e}};Yr.STATE_VERSION=1;let be=Yr;function Yo(r,e){const{width:t,height:s,algorithm:i="prim",startPosition:n}=r;wc(r);const a=Jn(t,s,n,e),l=n||{x:Math.floor(e()*t),y:Math.floor(e()*s)};return{maze:a,metadata:{width:t,height:s,algorithm:i,startPosition:l,totalCells:t*s,connectedCells:Ec(a)}}}function Jn(r,e,t,s){const i=_c(r,e),n=new Set,a=[],l=(t==null?void 0:t.x)??Math.floor(s()*r),h=(t==null?void 0:t.y)??Math.floor(s()*e);for(n.add(Ke(l,h)),Zn(l,h,r,e,a,n);a.length>0;){const d=Math.floor(s()*a.length),m=a[d];a.splice(d,1);const{x:p,y:b,nx:A,ny:C,dir:L,backDir:D}=m,F=Ke(A,C);n.has(F)||(i[b][p]|=L,i[C][A]|=D,n.add(F),Zn(A,C,r,e,a,n))}return i}function _c(r,e){return Array.from({length:e},()=>Array(r).fill(0))}function Ke(r,e){return`${r},${e}`}function Zn(r,e,t,s,i,n){const a=_r();for(const{dx:l,dy:h,dir:d,backDir:m}of a){const p=r+l,b=e+h;Ge(p,b,t,s)&&!n.has(Ke(p,b))&&i.push({x:r,y:e,nx:p,ny:b,dir:d,backDir:m})}}function _r(){return[{dx:1,dy:0,dir:1,backDir:4},{dx:0,dy:1,dir:2,backDir:8},{dx:-1,dy:0,dir:4,backDir:1},{dx:0,dy:-1,dir:8,backDir:2}]}function Ge(r,e,t,s){return r>=0&&e>=0&&r<t&&e<s}function wc(r){const{width:e,height:t,startPosition:s}=r;if(e<=0||t<=0)throw new Error("Maze dimensions must be positive");if(!Number.isInteger(e)||!Number.isInteger(t))throw new Error("Maze dimensions must be integers");if(s&&!Ge(s.x,s.y,e,t))throw new Error("Start position is outside maze bounds")}function Ec(r){let e=0;for(let t=0;t<r.length;t++)for(let s=0;s<r[0].length;s++)r[t][s]>0&&e++;return e}function tr(r,e,t,s){const i=r.length,n=i>0?r[0].length:0,a={isValid:!0,isSolvable:!1,errors:[],pathLength:0,complexity:0,reachableCells:0};if(!bc(r,a)||!Sc(e,t,n,i,a)||!Ac(r,a))return a;const l=Ic(r,e,t);return l.path.length>0?(a.isSolvable=!0,a.pathLength=l.path.length-1,a.complexity=Cc(r,l.path)):(a.isValid=!1,a.errors.push("No path exists from start to goal")),a.reachableCells=Pc(r,e),s&&(s.minPathLength&&a.pathLength<s.minPathLength&&(a.isValid=!1,a.errors.push(`Path length ${a.pathLength} is below minimum ${s.minPathLength}`)),s.minComplexity&&a.complexity<s.minComplexity&&(a.isValid=!1,a.errors.push(`Complexity ${a.complexity} is below minimum ${s.minComplexity}`)),s.minReachableCells&&a.reachableCells<s.minReachableCells&&(a.isValid=!1,a.errors.push(`Reachable cells ${a.reachableCells} is below minimum ${s.minReachableCells}`))),a}function Tc(r,e,t){const s=wr(r,e),i=[];for(const n of t){const a=Ke(n.x,n.y);s.has(a)||i.push(n)}return{allAccessible:i.length===0,inaccessibleOrbs:i,totalOrbs:t.length,accessibleOrbs:t.length-i.length}}function wr(r,e){const t=r.length,s=t>0?r[0].length:0,i=new Set,n=[e];for(i.add(Ke(e.x,e.y));n.length>0;){const a=n.shift(),l=r[a.y][a.x],h=_r();for(const{dx:d,dy:m,dir:p}of h)if(l&p){const b=a.x+d,A=a.y+m,C=Ke(b,A);Ge(b,A,s,t)&&!i.has(C)&&(i.add(C),n.push({x:b,y:A}))}}return i}function bc(r,e){if(r.length===0)return e.isValid=!1,e.errors.push("Maze is empty"),!1;const t=r[0].length;if(t===0)return e.isValid=!1,e.errors.push("Maze has zero width"),!1;for(let s=0;s<r.length;s++){if(r[s].length!==t)return e.isValid=!1,e.errors.push(`Row ${s} has inconsistent width`),!1;for(let i=0;i<t;i++){const n=r[s][i];if(n<0||n>15)return e.isValid=!1,e.errors.push(`Invalid cell value ${n} at (${i}, ${s})`),!1}}return!0}function Sc(r,e,t,s,i){return Ge(r.x,r.y,t,s)?Ge(e.x,e.y,t,s)?!0:(i.isValid=!1,i.errors.push(`Goal position (${e.x}, ${e.y}) is outside maze bounds`),!1):(i.isValid=!1,i.errors.push(`Start position (${r.x}, ${r.y}) is outside maze bounds`),!1)}function Ac(r,e){const t=r.length,s=r[0].length;for(let i=0;i<t;i++)for(let n=0;n<s;n++){const a=r[i][n];if(n<s-1&&a&1&&!(r[i][n+1]&4))return e.isValid=!1,e.errors.push(`Asymmetric East connection at (${n}, ${i})`),!1;if(i<t-1&&a&2&&!(r[i+1][n]&8))return e.isValid=!1,e.errors.push(`Asymmetric South connection at (${n}, ${i})`),!1;if(n>0&&a&4&&!(r[i][n-1]&1))return e.isValid=!1,e.errors.push(`Asymmetric West connection at (${n}, ${i})`),!1;if(i>0&&a&8&&!(r[i-1][n]&2))return e.isValid=!1,e.errors.push(`Asymmetric North connection at (${n}, ${i})`),!1}return!0}function Ic(r,e,t){const s=r.length,i=s>0?r[0].length:0;if(!Ge(e.x,e.y,i,s)||!Ge(t.x,t.y,i,s))return{path:[],distance:-1};const n=new Set,a=[{pos:e,path:[e]}];for(n.add(Ke(e.x,e.y));a.length>0;){const{pos:l,path:h}=a.shift();if(l.x===t.x&&l.y===t.y)return{path:h,distance:h.length-1};const d=r[l.y][l.x],m=_r();for(const{dx:p,dy:b,dir:A}of m)if(d&A){const C=l.x+p,L=l.y+b,D=Ke(C,L);Ge(C,L,i,s)&&!n.has(D)&&(n.add(D),a.push({pos:{x:C,y:L},path:[...h,{x:C,y:L}]}))}}return{path:[],distance:-1}}function Cc(r,e){if(e.length<2)return 0;let t=0,s=0;for(let i=1;i<e.length;i++){const n=e[i-1],a=e[i],l=a.x-n.x,h=a.y-n.y;let d=0;l===1?d=0:h===1?d=1:l===-1?d=2:h===-1&&(d=3),i>1&&d!==s&&t++,s=d}return t}function Pc(r,e){return wr(r,e).size}class Xo{constructor(e){this.state=e}next(){let e=this.state+=1831565813;return e=Math.imul(e^e>>>15,e|1),e^=e+Math.imul(e^e>>>7,e|61),((e^e>>>14)>>>0)/4294967296}nextInt(e,t){if(e>=t)throw new Error("min must be less than max");return Math.floor(this.next()*(t-e))+e}nextFloat(e,t){if(e>=t)throw new Error("min must be less than max");return this.next()*(t-e)+e}shuffle(e){for(let t=e.length-1;t>0;t--){const s=this.nextInt(0,t+1);[e[t],e[s]]=[e[s],e[t]]}return e}getState(){return this.state}reset(e){this.state=e}}function Rc(r=new Date){const e=r.getFullYear(),t=(r.getMonth()+1).toString().padStart(2,"0"),s=r.getDate().toString().padStart(2,"0");return+`${e}${t}${s}`}class Dc{constructor(){this.gameState=null,this.currentLevelDefinition=null,this.pausedAt=null,this.totalPausedTime=0,this.eventEmitter=new vc,this.eventEmitter.setErrorHandler((e,t,s)=>{this.emit("error",{error:e,context:`Event listener error for ${t}`,recoverable:!0,timestamp:Date.now()})})}initializeLevel(e,t){try{const s=t??e.generation.seed??Date.now(),i=new Xo(s);this.gameState=be.createInitialState(e,s),this.currentLevelDefinition=e,this.pausedAt=null,this.totalPausedTime=0;const n=Date.now();try{if(e.generation.type==="procedural")this.generateProceduralMaze(e,i);else if(e.generation.type==="handcrafted")this.loadHandcraftedMaze(e);else throw new Error(`Unsupported level generation type: ${e.generation.type}`)}catch(l){this.emit("debug",{level:"warn",message:`Maze generation failed, attempting fallback: ${l.message}`,data:{originalError:l,levelId:e.id},timestamp:Date.now()}),this.generateFallbackMaze(e,i)}const a=Date.now()-n;this.emit("level.generated",{levelId:e.id,seed:s,generationTime:a,mazeSize:e.config.boardSize,orbCount:this.gameState.orbs.length,timestamp:Date.now()}),this.emit("game.initialized",{state:this.gameState,levelDefinition:e,timestamp:Date.now()}),this.emit("debug",{level:"info",message:`Level initialized: ${e.id}`,data:{seed:s,levelId:e.id,generationTime:a,mazeSize:e.config.boardSize,orbCount:this.gameState.orbs.length},timestamp:Date.now()})}catch(s){throw this.emit("error",{error:s instanceof Error?s:new Error(String(s)),context:"Level initialization",recoverable:!1,timestamp:Date.now()}),s}}startGame(){if(!this.gameState||!this.currentLevelDefinition)throw new Error("Game not initialized");const e=Date.now(),t=this.gameState;this.gameState=be.updateGameStatus(this.gameState,"playing"),this.emit("game.started",{timestamp:e,levelId:this.currentLevelDefinition.id,seed:this.gameState.seed}),this.emitStateChanged(t,this.gameState,"Game started")}pauseGame(){if(!this.gameState)throw new Error("Game not initialized");if(this.gameState.status!=="playing")return;const e=Date.now(),t=this.gameState,s=e-this.gameState.startTime-this.totalPausedTime;this.gameState=be.updateGameStatus(this.gameState,"paused"),this.pausedAt=e,this.emit("game.paused",{timestamp:e,duration:s}),this.emitStateChanged(t,this.gameState,"Game paused")}resumeGame(){if(!this.gameState)throw new Error("Game not initialized");if(this.gameState.status!=="paused"||!this.pausedAt)return;const e=Date.now(),t=this.gameState,s=e-this.pausedAt;this.totalPausedTime+=s,this.gameState=be.updateGameStatus(this.gameState,"playing"),this.pausedAt=null,this.emit("game.resumed",{timestamp:e,pausedDuration:s}),this.emitStateChanged(t,this.gameState,"Game resumed")}resetGame(){if(!this.currentLevelDefinition)throw new Error("No level to reset");const e=Date.now(),t=this.currentLevelDefinition.id;this.initializeLevel(this.currentLevelDefinition),this.emit("game.reset",{timestamp:e,levelId:t,reason:"user_request"})}movePlayer(e){if(!this.gameState)throw new Error("Game not initialized");if(this.gameState.status!=="playing")return{success:!1,newPosition:this.gameState.player.position,reason:"Game not in playing state",moveCount:this.gameState.moves};const t=this.gameState.player.position,s=this.calculateNewPosition(t,e),i=Date.now();if(this.emit("player.move.attempted",{from:t,attemptedTo:s,direction:this.directionToCardinal(e),blocked:!1,timestamp:i}),!this.isValidMove(t,s))return this.emit("player.move.attempted",{from:t,attemptedTo:s,direction:this.directionToCardinal(e),blocked:!0,reason:"Invalid move",timestamp:i}),{success:!1,newPosition:t,reason:"Invalid move",moveCount:this.gameState.moves};const a=this.gameState;this.gameState=be.updatePlayerPosition(this.gameState,s);const l={success:!0,newPosition:s,moveCount:this.gameState.moves};return this.emit("player.moved",{from:t,to:s,valid:!0,moveCount:this.gameState.moves,timestamp:i}),this.emitStateChanged(a,this.gameState,"Player moved"),this.checkAutomaticOrbCollection(s),this.updateObjectives(),this.checkGameCompletion(),l}collectOrb(e){if(!this.gameState)throw new Error("Game not initialized");const t=this.gameState.orbs.find(d=>d.id===e);if(!t)return{success:!1,orbId:e,scoreGained:0,reason:"Orb not found",totalScore:this.gameState.score};if(t.collected)return{success:!1,orbId:e,scoreGained:0,reason:"Orb already collected",totalScore:this.gameState.score};if(this.gameState.player.position.x!==t.position.x||this.gameState.player.position.y!==t.position.y)return{success:!1,orbId:e,scoreGained:0,reason:"Player not at orb position",totalScore:this.gameState.score};const s=Date.now(),i=this.gameState,n=this.gameState.score;this.gameState=be.collectOrb(this.gameState,e);const a=this.gameState.score-n,l=this.gameState.orbs.filter(d=>!d.collected).length;this.updateObjectives();const h={success:!0,orbId:e,scoreGained:a,totalScore:this.gameState.score};return this.emit("orb.collected",{orbId:e,position:t.position,score:a,totalScore:this.gameState.score,orbsRemaining:l,timestamp:s}),a>0&&this.emit("score.changed",{previousScore:n,newScore:this.gameState.score,change:a,reason:"orb_collected",timestamp:s}),this.emitStateChanged(i,this.gameState,"Orb collected"),this.checkGameCompletion(),h}getGameState(){if(!this.gameState)throw new Error("Game not initialized");return this.gameState}isGameComplete(){return this.gameState?this.gameState.objectives.filter(e=>e.required).every(e=>e.completed):!1}getScore(){var e;return((e=this.gameState)==null?void 0:e.score)??0}getCurrentTime(){if(!this.gameState)return 0;const e=Date.now(),t=e-this.gameState.startTime,s=this.pausedAt?e-this.pausedAt:0;return t-this.totalPausedTime-s}getCurrentLevelDefinition(){return this.currentLevelDefinition}on(e,t){this.eventEmitter.on(e,t)}off(e,t){this.eventEmitter.off(e,t)}once(e,t){this.eventEmitter.once(e,t)}emit(e,t){this.eventEmitter.emit(e,t)}emitStateChanged(e,t,s){const i=this.calculateStateChanges(e,t);this.emit("state.changed",{state:t,changes:i,timestamp:Date.now()}),this.emit("debug",{level:"debug",message:`State changed: ${s}`,data:{changeCount:i.length,changes:i},timestamp:Date.now()})}calculateStateChanges(e,t){const s=[],i=Date.now();e.status!==t.status&&s.push({property:"status",oldValue:e.status,newValue:t.status,timestamp:i}),e.score!==t.score&&s.push({property:"score",oldValue:e.score,newValue:t.score,timestamp:i}),e.moves!==t.moves&&s.push({property:"moves",oldValue:e.moves,newValue:t.moves,timestamp:i}),(e.player.position.x!==t.player.position.x||e.player.position.y!==t.player.position.y)&&s.push({property:"player.position",oldValue:e.player.position,newValue:t.player.position,timestamp:i});for(let n=0;n<Math.max(e.orbs.length,t.orbs.length);n++){const a=e.orbs[n],l=t.orbs[n];a&&l&&a.collected!==l.collected&&s.push({property:`orbs[${n}].collected`,oldValue:a.collected,newValue:l.collected,timestamp:i})}return s}calculateNewPosition(e,t){switch(t){case"up":return{x:e.x,y:e.y-1};case"down":return{x:e.x,y:e.y+1};case"left":return{x:e.x-1,y:e.y};case"right":return{x:e.x+1,y:e.y};default:return e}}directionToCardinal(e){switch(e){case"up":return"north";case"down":return"south";case"left":return"west";case"right":return"east";default:return"north"}}checkAutomaticOrbCollection(e){if(!this.gameState)return;const t=this.gameState.orbs.filter(s=>s.position.x===e.x&&s.position.y===e.y&&!s.collected);for(const s of t)this.collectOrb(s.id)}updateObjectives(){if(!this.gameState)return;const e=this.gameState;let t=!1;for(const s of this.gameState.objectives){if(s.completed)continue;let i=s.current;switch(s.type){case"collect_orbs":i=this.gameState.player.stats.orbsCollected;break;case"reach_goal":i=this.isPlayerAtGoal()?1:0;break;case"collect_all_orbs":const a=this.gameState.orbs.length;i=this.gameState.orbs.filter(d=>d.collected).length===a?1:0;break;case"time_limit":const h=this.getCurrentTime();i=Math.max(0,s.target-Math.floor(h/1e3));break;case"move_limit":i=Math.max(0,s.target-this.gameState.moves);break;default:continue}i!==s.current&&(this.gameState=be.updateObjectiveProgress(this.gameState,s.id,i),t=!0,this.emit("objective.progress",{objectiveId:s.id,previousProgress:s.current,newProgress:i,target:s.target,completed:i>=s.target,timestamp:Date.now()}),i>=s.target&&s.current<s.target&&this.emit("objective.completed",{objectiveId:s.id,completionTime:this.getCurrentTime(),timestamp:Date.now()}))}t&&this.emitStateChanged(e,this.gameState,"Objectives updated")}checkGameCompletion(){if(!this.gameState)return;if(this.gameState.objectives.filter(s=>s.required).every(s=>s.completed)&&this.gameState.status==="playing"){const s=Date.now(),i=this.getCurrentTime(),n=this.gameState;this.gameState=be.updateGameStatus(this.gameState,"completed");const a=this.calculateGameResult(i);this.emit("game.completed",{result:a,timestamp:s,duration:i}),this.emitStateChanged(n,this.gameState,"Game completed")}}calculateGameResult(e){if(!this.gameState)throw new Error("Game not initialized");const t=this.gameState.objectives.filter(a=>a.completed).length,i=this.gameState.objectives.filter(a=>a.required).every(a=>a.completed);let n=0;if(i){n=1;const a=this.gameState.levelConfig.progression.starThresholds;for(const l of a.sort((h,d)=>d.stars-h.stars)){let h=!0;if(l.requirements.time&&e>l.requirements.time*1e3&&(h=!1),l.requirements.moves&&this.gameState.moves>l.requirements.moves&&(h=!1),l.requirements.orbsCollected&&this.gameState.player.stats.orbsCollected<l.requirements.orbsCollected&&(h=!1),h){n=Math.max(n,l.stars);break}}}return{completed:i,score:this.gameState.score,stars:n,completionTime:e,totalMoves:this.gameState.moves,orbsCollected:this.gameState.player.stats.orbsCollected,objectivesCompleted:t,constraintsViolated:0}}generateProceduralMaze(e,t){if(!this.gameState)throw new Error("Game state not initialized");const{width:s,height:i}=e.config.boardSize,n=e.generation.parameters,a={width:s,height:i,algorithm:(n==null?void 0:n.algorithm)||"prim"},l=Yo(a,()=>t.next()),h={x:0,y:0},d={x:s-1,y:i-1},m=l.maze.map((A,C)=>A.map((L,D)=>({walls:L,type:D===h.x&&C===h.y?"start":D===d.x&&C===d.y?"goal":"floor",properties:{isStart:D===h.x&&C===h.y,isGoal:D===d.x&&C===d.y,isVisited:!1}})));if(!tr(l.maze,h,d).isSolvable)throw new Error("Generated maze is not solvable");const b=this.generateOrbsIntelligent(e,t,l.maze,h,d);this.gameState=be.updateState(this.gameState,{maze:m,orbs:b,player:{position:h}})}loadHandcraftedMaze(e){if(!this.gameState)throw new Error("Game state not initialized");const t=e.generation.layout;if(!t)throw new Error("Handcrafted level missing layout data");const s=t.cells.map(n=>n.map(a=>({walls:a.walls,type:a.type==="start"||a.type==="goal"?"special":a.type,properties:{isStart:a.type==="start",isGoal:a.type==="goal",isVisited:!1,...a.properties}}))),i=t.orbPositions.map((n,a)=>({id:n.id||`orb_${a}`,position:{x:n.x,y:n.y},collected:!1,value:n.value}));this.gameState=be.updateState(this.gameState,{maze:s,orbs:i,player:{position:t.startPosition}})}generateOrbsIntelligent(e,t,s,i,n){const a=e.generation.parameters;if(!a)return[];const l=[],{width:h,height:d}=e.config.boardSize,m=a.orbCount||2,p=wr(s,i),b=[];for(const L of p){const[D,F]=L.split(",").map(Number);(D!==i.x||F!==i.y)&&(D!==n.x||F!==n.y)&&b.push({x:D,y:F})}if(b.length===0)return[];const A=a.orbPlacement||"random";let C=[];if(A==="balanced")C=this.selectBalancedOrbPositions(b,i,n,m,t);else{const L=t.shuffle([...b]);C=L.slice(0,Math.min(m,L.length))}return C.forEach((L,D)=>{l.push({id:`orb_${D+1}`,position:L,collected:!1,value:10+D*5})}),l}selectBalancedOrbPositions(e,t,s,i,n){if(e.length===0)return[];const a=e.map(d=>({position:d,distanceFromStart:Math.abs(d.x-t.x)+Math.abs(d.y-t.y),distanceFromGoal:Math.abs(d.x-s.x)+Math.abs(d.y-s.y)}));a.sort((d,m)=>d.distanceFromStart-m.distanceFromStart);const l=[],h=a.length;for(let d=0;d<i&&d<h;d++){const m=Math.floor(h/i),p=d*m,b=Math.min(p+m,h);if(p<h){const A=p+Math.floor(n.next()*(b-p));l.push(a[A].position)}}return l}generateOrbs(e,t,s){const i=e.generation.parameters;if(!i)return[];const n=[],{width:a,height:l}=e.config.boardSize,h=i.orbCount||3,d=[];for(let A=0;A<l;A++)for(let C=0;C<a;C++){const L=s[A][C];!L.properties.isStart&&!L.properties.isGoal&&d.push({x:C,y:A})}const m=t.shuffle([...d]),p=i.orbPlacement||"random";let b=[];switch(p){case"random":b=m.slice(0,Math.min(h,m.length));break;case"corners":const A=m.filter(C=>(C.x===0||C.x===a-1)&&(C.y===0||C.y===l-1));b=[...A.slice(0,Math.min(h,A.length)),...m.filter(C=>!A.includes(C)).slice(0,Math.max(0,h-A.length))];break;case"strategic":case"path":default:b=m.slice(0,Math.min(h,m.length));break}return b.forEach((A,C)=>{n.push({id:`orb_${C}`,position:A,collected:!1,value:100})}),n}isPlayerAtGoal(){var s;if(!this.gameState||!this.currentLevelDefinition)return!1;const e=this.gameState.player.position,t=(s=this.gameState.maze[e.y])==null?void 0:s[e.x];return(t==null?void 0:t.properties.isGoal)===!0}generateFallbackMaze(e,t){if(!this.gameState)throw new Error("Game state not initialized");const{width:s,height:i}=e.config.boardSize,n=[];for(let h=0;h<i;h++){const d=[];for(let m=0;m<s;m++){let p=0;m<s-1&&(p|=1),h<i-1&&(p|=2),m>0&&(p|=4),h>0&&(p|=8),d.push({walls:p,type:m===0&&h===0||m===s-1&&h===i-1?"special":"floor",properties:{isStart:m===0&&h===0,isGoal:m===s-1&&h===i-1,isVisited:!1}})}n.push(d)}const a=[],l=Math.min(2,Math.floor(s*i/4));for(let h=0;h<l;h++){let d,m;do d=Math.floor(t.next()*s),m=Math.floor(t.next()*i);while(d===0&&m===0||d===s-1&&m===i-1);a.push({id:`fallback_orb_${h}`,position:{x:d,y:m},collected:!1,value:100})}this.gameState=be.updateState(this.gameState,{maze:n,orbs:a,player:{position:{x:0,y:0}}}),this.emit("debug",{level:"info",message:"Fallback maze generated successfully",data:{mazeSize:{width:s,height:i},orbCount:a.length},timestamp:Date.now()})}isValidMove(e,t){var h;if(!this.gameState||t.x<0||t.y<0||this.gameState.maze.length===0)return!1;const s=this.gameState.maze.length,i=((h=this.gameState.maze[0])==null?void 0:h.length)??0;if(t.x>=i||t.y>=s)return!1;const n=t.x-e.x,a=t.y-e.y;if(Math.abs(n)+Math.abs(a)!==1)return!1;const l=this.gameState.maze[e.y][e.x];return!(n===1&&!(l.walls&1)||n===-1&&!(l.walls&4)||a===1&&!(l.walls&2)||a===-1&&!(l.walls&8))}}const xc="modulepreload",Lc=function(r){return"/"+r},eo={},Re=function(e,t,s){let i=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),l=(a==null?void 0:a.nonce)||(a==null?void 0:a.getAttribute("nonce"));i=Promise.allSettled(t.map(h=>{if(h=Lc(h),h in eo)return;eo[h]=!0;const d=h.endsWith(".css"),m=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${h}"]${m}`))return;const p=document.createElement("link");if(p.rel=d?"stylesheet":xc,d||(p.as="script"),p.crossOrigin="",p.href=h,l&&p.setAttribute("nonce",l),document.head.appendChild(p),d)return new Promise((b,A)=>{p.addEventListener("load",b),p.addEventListener("error",()=>A(new Error(`Unable to preload CSS for ${h}`)))})}))}function n(a){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=a,window.dispatchEvent(l),!l.defaultPrevented)throw a}return i.then(a=>{for(const l of a||[])l.status==="rejected"&&n(l.reason);return e().catch(n)})},kc=(r,e,t)=>{const s=r[e];return s?typeof s=="function"?s():Promise.resolve(s):new Promise((i,n)=>{(typeof queueMicrotask=="function"?queueMicrotask:setTimeout)(n.bind(null,new Error("Unknown variable dynamic import: "+e+(e.split("/").length!==t?". Note that variables only represent file names one level deep.":""))))})},ai=class ai{static isLevelDefinition(e){return this.validate(e).valid}static isLevelMetadata(e){return this.validateMetadata(e).valid}static isLevelGeneration(e){return this.validateGeneration(e).valid}static isLevelConfig(e){return this.validateConfig(e).valid}static isLevelProgression(e){return this.validateProgression(e).valid}static validate(e){const t=[],s=[];if(!e||typeof e!="object")return t.push({field:"root",message:"Level definition must be an object",severity:"error",code:"INVALID_TYPE"}),{valid:!1,errors:t,warnings:s};const i=["id","version","metadata","generation","config","progression"];for(const n of i)n in e||t.push({field:n,message:`Required field '${n}' is missing`,severity:"error",code:"MISSING_FIELD"});if(typeof e.version!="number"?t.push({field:"version",message:"Version must be a number",severity:"error",code:"INVALID_TYPE"}):this.SUPPORTED_VERSIONS.includes(e.version)||s.push({field:"version",message:`Version ${e.version} may not be fully supported`,severity:"warning",code:"UNSUPPORTED_VERSION"}),typeof e.id!="string"||!e.id.trim()?t.push({field:"id",message:"ID must be a non-empty string",severity:"error",code:"INVALID_ID"}):/^[a-zA-Z0-9_-]+$/.test(e.id)||t.push({field:"id",message:"ID must contain only alphanumeric characters, underscores, and hyphens",severity:"error",code:"INVALID_ID_FORMAT"}),e.metadata){const n=this.validateMetadata(e.metadata);t.push(...n.errors),s.push(...n.warnings)}if(e.generation){const n=this.validateGeneration(e.generation);t.push(...n.errors),s.push(...n.warnings)}if(e.config){const n=this.validateConfig(e.config);t.push(...n.errors),s.push(...n.warnings)}if(e.progression){const n=this.validateProgression(e.progression);t.push(...n.errors),s.push(...n.warnings)}return{valid:t.length===0,errors:t,warnings:s}}static validateMetadata(e){const t=[],s=[];if(!e||typeof e!="object")return t.push({field:"metadata",message:"Metadata must be an object",severity:"error",code:"INVALID_TYPE"}),{valid:!1,errors:t,warnings:s};const i=["name","difficulty","estimatedTime","tags"];for(const a of i)a in e||t.push({field:`metadata.${a}`,message:`Required field '${a}' is missing`,severity:"error",code:"MISSING_FIELD"});(typeof e.name!="string"||!e.name.trim())&&t.push({field:"metadata.name",message:"Name must be a non-empty string",severity:"error",code:"INVALID_NAME"});const n=["easy","medium","hard","expert"];return n.includes(e.difficulty)||t.push({field:"metadata.difficulty",message:`Difficulty must be one of: ${n.join(", ")}`,severity:"error",code:"INVALID_DIFFICULTY"}),(typeof e.estimatedTime!="number"||e.estimatedTime<=0)&&t.push({field:"metadata.estimatedTime",message:"Estimated time must be a positive number",severity:"error",code:"INVALID_TIME"}),Array.isArray(e.tags)?e.tags.forEach((a,l)=>{typeof a!="string"&&t.push({field:`metadata.tags[${l}]`,message:"Each tag must be a string",severity:"error",code:"INVALID_TAG"})}):t.push({field:"metadata.tags",message:"Tags must be an array",severity:"error",code:"INVALID_TAGS"}),{valid:t.length===0,errors:t,warnings:s}}static validateGeneration(e){const t=[],s=[];if(!e||typeof e!="object")return t.push({field:"generation",message:"Generation must be an object",severity:"error",code:"INVALID_TYPE"}),{valid:!1,errors:t,warnings:s};const i=["procedural","handcrafted"];if(i.includes(e.type)||t.push({field:"generation.type",message:`Generation type must be one of: ${i.join(", ")}`,severity:"error",code:"INVALID_GENERATION_TYPE"}),e.type==="procedural"&&(typeof e.seed!="number"&&s.push({field:"generation.seed",message:"Procedural generation should include a seed for deterministic results",severity:"warning",code:"MISSING_SEED"}),e.parameters)){const n=this.validateProceduralParameters(e.parameters);t.push(...n.errors),s.push(...n.warnings)}if(e.type==="handcrafted")if(!e.layout)t.push({field:"generation.layout",message:"Handcrafted generation must include layout data",severity:"error",code:"MISSING_LAYOUT"});else{const n=this.validateHandcraftedLayout(e.layout);t.push(...n.errors),s.push(...n.warnings)}return{valid:t.length===0,errors:t,warnings:s}}static validateProceduralParameters(e){const t=[],s=[],i=["recursive_backtrack","kruskal","prim","wilson"];i.includes(e.algorithm)||t.push({field:"generation.parameters.algorithm",message:`Algorithm must be one of: ${i.join(", ")}`,severity:"error",code:"INVALID_ALGORITHM"});const n=[{name:"complexity",min:0,max:1},{name:"branchingFactor",min:0,max:1},{name:"deadEndRatio",min:0,max:1}];for(const l of n){const h=e[l.name];(typeof h!="number"||h<l.min||h>l.max)&&t.push({field:`generation.parameters.${l.name}`,message:`${l.name} must be a number between ${l.min} and ${l.max}`,severity:"error",code:"INVALID_PARAMETER_RANGE"})}(typeof e.orbCount!="number"||e.orbCount<0)&&t.push({field:"generation.parameters.orbCount",message:"Orb count must be a non-negative number",severity:"error",code:"INVALID_ORB_COUNT"});const a=["random","strategic","path","corners"];return a.includes(e.orbPlacement)||t.push({field:"generation.parameters.orbPlacement",message:`Orb placement must be one of: ${a.join(", ")}`,severity:"error",code:"INVALID_ORB_PLACEMENT"}),{valid:t.length===0,errors:t,warnings:s}}static validateHandcraftedLayout(e){const t=[],s=[],i=["cells","startPosition","goalPosition","orbPositions"];for(const n of i)n in e||t.push({field:`generation.layout.${n}`,message:`Required field '${n}' is missing`,severity:"error",code:"MISSING_FIELD"});return e.startPosition&&!this.isValidPosition(e.startPosition)&&t.push({field:"generation.layout.startPosition",message:"Start position must have valid x and y coordinates",severity:"error",code:"INVALID_POSITION"}),e.goalPosition&&!this.isValidPosition(e.goalPosition)&&t.push({field:"generation.layout.goalPosition",message:"Goal position must have valid x and y coordinates",severity:"error",code:"INVALID_POSITION"}),Array.isArray(e.orbPositions)&&e.orbPositions.forEach((n,a)=>{(!this.isValidPosition(n)||typeof n.value!="number")&&t.push({field:`generation.layout.orbPositions[${a}]`,message:"Orb position must have valid x, y coordinates and numeric value",severity:"error",code:"INVALID_ORB_POSITION"})}),{valid:t.length===0,errors:t,warnings:s}}static validateConfig(e){const t=[],s=[];return!e||typeof e!="object"?(t.push({field:"config",message:"Config must be an object",severity:"error",code:"INVALID_TYPE"}),{valid:!1,errors:t,warnings:s}):((!e.boardSize||!this.isValidSize(e.boardSize))&&t.push({field:"config.boardSize",message:"Board size must have valid width and height",severity:"error",code:"INVALID_BOARD_SIZE"}),Array.isArray(e.objectives)?e.objectives.forEach((i,n)=>{const a=this.validateObjective(i,n);t.push(...a.errors),s.push(...a.warnings)}):t.push({field:"config.objectives",message:"Objectives must be an array",severity:"error",code:"INVALID_OBJECTIVES"}),Array.isArray(e.constraints)?e.constraints.forEach((i,n)=>{const a=this.validateConstraint(i,n);t.push(...a.errors),s.push(...a.warnings)}):t.push({field:"config.constraints",message:"Constraints must be an array",severity:"error",code:"INVALID_CONSTRAINTS"}),{valid:t.length===0,errors:t,warnings:s})}static validateProgression(e){const t=[],s=[];return!e||typeof e!="object"?(t.push({field:"progression",message:"Progression must be an object",severity:"error",code:"INVALID_TYPE"}),{valid:!1,errors:t,warnings:s}):(Array.isArray(e.starThresholds)?e.starThresholds.length===0&&s.push({field:"progression.starThresholds",message:"No star thresholds defined",severity:"warning",code:"EMPTY_STAR_THRESHOLDS"}):t.push({field:"progression.starThresholds",message:"Star thresholds must be an array",severity:"error",code:"INVALID_STAR_THRESHOLDS"}),Array.isArray(e.rewards)||t.push({field:"progression.rewards",message:"Rewards must be an array",severity:"error",code:"INVALID_REWARDS"}),Array.isArray(e.unlocks)||t.push({field:"progression.unlocks",message:"Unlocks must be an array",severity:"error",code:"INVALID_UNLOCKS"}),{valid:t.length===0,errors:t,warnings:s})}static isValidPosition(e){return e&&typeof e=="object"&&typeof e.x=="number"&&typeof e.y=="number"&&e.x>=0&&e.y>=0}static isValidSize(e){return e&&typeof e=="object"&&typeof e.width=="number"&&typeof e.height=="number"&&e.width>0&&e.height>0}static validateObjective(e,t){const s=[],i=[],n=["collect_orbs","collect_all_orbs","reach_goal","time_limit","move_limit","collect_sequence","avoid_traps"];return n.includes(e.type)||s.push({field:`config.objectives[${t}].type`,message:`Objective type must be one of: ${n.join(", ")}`,severity:"error",code:"INVALID_OBJECTIVE_TYPE"}),(typeof e.target!="number"||e.target<0)&&s.push({field:`config.objectives[${t}].target`,message:"Objective target must be a non-negative number",severity:"error",code:"INVALID_OBJECTIVE_TARGET"}),{valid:s.length===0,errors:s,warnings:i}}static validateConstraint(e,t){const s=[],i=[],n=["time_limit","move_limit","no_backtrack","no_diagonal","limited_vision","one_way_paths"];return n.includes(e.type)||s.push({field:`config.constraints[${t}].type`,message:`Constraint type must be one of: ${n.join(", ")}`,severity:"error",code:"INVALID_CONSTRAINT_TYPE"}),(typeof e.value!="number"||e.value<0)&&s.push({field:`config.constraints[${t}].value`,message:"Constraint value must be a non-negative number",severity:"error",code:"INVALID_CONSTRAINT_VALUE"}),{valid:s.length===0,errors:s,warnings:i}}};ai.CURRENT_VERSION=1,ai.SUPPORTED_VERSIONS=[1];let sr=ai;const Xr=class Xr{static migrate(e,t,s=this.CURRENT_VERSION){if(t===s)return e;let i={...e};return t<1&&s>=1&&(i=this.migrateToV1(i)),i.version=s,i}static getCurrentVersion(){return this.CURRENT_VERSION}static isVersionSupported(e){return e<=this.CURRENT_VERSION&&e>=1}static migrateToV1(e){return e.metadata||(e.metadata={name:e.name||`Level ${e.id}`,difficulty:e.difficulty||"medium",estimatedTime:e.estimatedTime||300,tags:e.tags||[]}),e.generation||(e.generation={type:"procedural",seed:Math.floor(Math.random()*1e6),parameters:{algorithm:"recursive_backtrack",complexity:.5,branchingFactor:.3,deadEndRatio:.1,orbCount:3,orbPlacement:"random"}}),e.config||(e.config={boardSize:{width:10,height:10},objectives:[{id:"reach_goal",type:"reach_goal",target:1,description:"Reach the goal",required:!0,priority:1}],constraints:[],powerups:[]}),e.progression||(e.progression={starThresholds:[{stars:1,requirements:{}},{stars:2,requirements:{time:300}},{stars:3,requirements:{time:180}}],rewards:[],unlocks:[]}),e}};Xr.CURRENT_VERSION=1;let Zt=Xr;class Qo{constructor(e=100){this.levelCache=new Map,this.cacheStats={size:0,hitRate:0,totalRequests:0,totalHits:0,totalMisses:0},this.embeddedLevels=new Map,this.maxCacheSize=e,this.initializeEmbeddedLevels()}async loadLevel(e,t){return(await this.loadLevelWithResult(e,t)).level}async loadLevelWithResult(e,t){const s=performance.now();this.cacheStats.totalRequests++;const i={validateSchema:!0,migrateVersion:!0,includeMetadata:!0,cacheable:!0,...t};if(i.cacheable){const n=this.getCachedLevelEntry(e);if(n)return this.cacheStats.totalHits++,this.updateCacheStats(),n.lastAccessed=Date.now(),n.accessCount++,{level:n.level,loadTime:performance.now()-s,fromCache:!0,migrated:n.migrated,validationResult:i.validateSchema?this.validateLevel(n.level):void 0}}this.cacheStats.totalMisses++;try{const n=await this.loadLevelData(e);let a=n,l=!1,h;if(i.migrateVersion&&n.version!==Zt.getCurrentVersion()&&(a=Zt.migrate(n,n.version||1,Zt.getCurrentVersion()),l=!0),i.validateSchema&&(h=this.validateLevel(a),!h.valid))throw new Error(`Level validation failed for ${e}: ${h.errors.map(d=>d.message).join(", ")}`);return i.cacheable&&this.cacheLevel(e,a,l),this.updateCacheStats(),{level:a,loadTime:performance.now()-s,fromCache:!1,migrated:l,validationResult:h}}catch(n){throw this.updateCacheStats(),new Error(`Failed to load level ${e}: ${n instanceof Error?n.message:"Unknown error"}`)}}async loadLevels(e,t){const s=e.map(i=>this.loadLevel(i,t));return Promise.all(s)}getCachedLevel(e){const t=this.getCachedLevelEntry(e);return t?t.level:null}async preloadLevels(e,t){for(let i=0;i<e.length;i+=5){const n=e.slice(i,i+5);await Promise.all(n.map(a=>this.loadLevel(a,t)))}}clearCache(){this.levelCache.clear(),this.cacheStats={size:0,hitRate:0,totalRequests:0,totalHits:0,totalMisses:0}}getCacheStats(){return{size:this.cacheStats.size,hitRate:this.cacheStats.hitRate,totalRequests:this.cacheStats.totalRequests}}validateLevel(e){return sr.validate(e)}async listAvailableLevels(){const e=Array.from(this.embeddedLevels.keys()),t=Array.from(this.levelCache.keys()),s=["level-001-tutorial","level-002-simple-path","level-003-branching-paths","level-004-time-pressure","level-005-puzzle-chamber","level-006-maze-runner","level-007-symmetry-challenge","level-008-trap-maze","level-009-speed-demon","level-010-master-challenge"],i=[];for(const a of s)try{await this.loadLevelData(a),i.push(a)}catch(l){console.warn(`Level ${a} not available:`,l)}const n=new Set([...e,...t,...i]);return Array.from(n).sort()}getCachedLevelEntry(e){return this.levelCache.get(e)||null}cacheLevel(e,t,s){this.levelCache.size>=this.maxCacheSize&&this.evictLeastRecentlyUsed();const i={level:t,loadTime:Date.now(),lastAccessed:Date.now(),accessCount:1,migrated:s};this.levelCache.set(e,i),this.cacheStats.size=this.levelCache.size}evictLeastRecentlyUsed(){let e=null,t=Date.now();for(const[s,i]of this.levelCache.entries())i.lastAccessed<t&&(t=i.lastAccessed,e=s);e&&this.levelCache.delete(e)}updateCacheStats(){this.cacheStats.size=this.levelCache.size,this.cacheStats.totalRequests>0&&(this.cacheStats.hitRate=this.cacheStats.totalHits/this.cacheStats.totalRequests)}async loadLevelData(e){try{const s=await kc(Object.assign({"../data/levels/level-001-tutorial.json":()=>Re(()=>import("./level-001-tutorial-Ce3P_qlB.js"),[]),"../data/levels/level-002-simple-path.json":()=>Re(()=>import("./level-002-simple-path-RkmzWUcy.js"),[]),"../data/levels/level-003-branching-paths.json":()=>Re(()=>import("./level-003-branching-paths-CNaGAgB9.js"),[]),"../data/levels/level-004-time-pressure.json":()=>Re(()=>import("./level-004-time-pressure-BDX9a_KL.js"),[]),"../data/levels/level-005-puzzle-chamber.json":()=>Re(()=>import("./level-005-puzzle-chamber-C9q7Kty3.js"),[]),"../data/levels/level-006-maze-runner.json":()=>Re(()=>import("./level-006-maze-runner-BBgG5vUY.js"),[]),"../data/levels/level-007-symmetry-challenge.json":()=>Re(()=>import("./level-007-symmetry-challenge-B2tVyWaX.js"),[]),"../data/levels/level-008-trap-maze.json":()=>Re(()=>import("./level-008-trap-maze-BZOE-uzr.js"),[]),"../data/levels/level-009-speed-demon.json":()=>Re(()=>import("./level-009-speed-demon-Dmj__R6_.js"),[]),"../data/levels/level-010-master-challenge.json":()=>Re(()=>import("./level-010-master-challenge-D0KqP2VY.js"),[])}),`../data/levels/${e}.json`,4);return s.default||s}catch(s){console.warn(`Failed to import ${e}:`,s)}try{const s=await fetch(`/src/data/levels/${e}.json`);if(s.ok)return await s.json()}catch(s){console.warn(`Failed to fetch ${e}:`,s)}const t=this.embeddedLevels.get(e);if(t)return console.warn(`Using embedded metadata for ${e}, full level data not available`),t;throw new Error(`Level data not found for ID: ${e}`)}async generateLevel(e,t){const s=performance.now(),i=t??e.generation.seed??Date.now(),n=new Xo(i);try{let a;if(e.generation.type==="procedural")a=await this.generateProceduralLevel(e,n,i);else if(e.generation.type==="handcrafted")a=await this.generateHandcraftedLevel(e,i);else{const h=new Error(`Unsupported generation type: ${e.generation.type}`);throw h.code="UNSUPPORTED_TYPE",h.levelId=e.id,h}a.metadata.generationTime=performance.now()-s;const l=this.validateGeneratedLevel(a);if(!l.valid)try{a=await this.generateFallbackLevel(e,n,i),a.metadata.generationTime=performance.now()-s}catch(h){const d=new Error(`Level generation and fallback failed: ${l.errors.map(m=>m.message).join(", ")}`);throw d.code="GENERATION_FAILED",d.levelId=e.id,d.details={validationErrors:l.errors,fallbackError:h},d}return a}catch(a){if(a instanceof Error&&"code"in a)throw a;const l=new Error(`Level generation failed: ${a instanceof Error?a.message:"Unknown error"}`);throw l.code="GENERATION_FAILED",l.levelId=e.id,l.details={originalError:a},l}}validateGeneratedLevel(e){var h,d;const t=[],s=[];if(!e.maze||e.maze.length===0)return t.push({message:"Generated maze is empty",severity:"error",code:"EMPTY_MAZE"}),{valid:!1,errors:t,warnings:s};const{width:i,height:n}=e.definition.config.boardSize;(e.maze.length!==n||((h=e.maze[0])==null?void 0:h.length)!==i)&&t.push({message:`Maze dimensions ${(d=e.maze[0])==null?void 0:d.length}x${e.maze.length} don't match config ${i}x${n}`,severity:"error",code:"DIMENSION_MISMATCH"}),this.isPositionInBounds(e.startPosition,i,n)||t.push({message:"Start position is outside maze bounds",severity:"error",code:"INVALID_START_POSITION"}),this.isPositionInBounds(e.goalPosition,i,n)||t.push({message:"Goal position is outside maze bounds",severity:"error",code:"INVALID_GOAL_POSITION"});for(let m=0;m<e.orbPositions.length;m++){const p=e.orbPositions[m];this.isPositionInBounds(p,i,n)||t.push({message:`Orb position (${p.x}, ${p.y}) is outside maze bounds`,severity:"error",code:"INVALID_ORB_POSITION"})}e.metadata.solvable||t.push({message:"Generated maze is not solvable",severity:"error",code:"UNSOLVABLE_MAZE"});const a=this.getMinPathLengthRequirement(e.definition);a&&e.metadata.pathLength<a&&s.push({message:`Path length ${e.metadata.pathLength} is below recommended minimum ${a}`,severity:"warning",code:"SHORT_PATH"});const l=Tc(e.maze.map(m=>m.map(p=>p.walls)),e.startPosition,e.orbPositions);return l.allAccessible||t.push({message:`${l.inaccessibleOrbs.length} orbs are not accessible from start position`,severity:"error",code:"INACCESSIBLE_ORBS"}),{valid:t.length===0,errors:t,warnings:s}}async generateProceduralLevel(e,t,s){const i=e.generation.parameters;if(!i)throw new Error("Procedural generation requires parameters");const{width:n,height:a}=e.config.boardSize,l={width:n,height:a,algorithm:this.mapAlgorithm(i.algorithm),startPosition:{x:0,y:0}},d=Yo(l,()=>t.next()).maze.map((L,D)=>L.map((F,U)=>({walls:F,type:this.determineCellType(U,D,n,a),properties:{isStart:U===0&&D===0,isGoal:U===n-1&&D===a-1,isVisited:!1}}))),m={x:0,y:0},p={x:n-1,y:a-1},b=this.generateOrbPositions(i,d,m,p,t),A=[],C=tr(d.map(L=>L.map(D=>D.walls)),m,p,this.getMazeValidationOptions(i));return{definition:e,maze:d,startPosition:m,goalPosition:p,orbPositions:b,powerupPositions:A,metadata:{seed:s,generationTime:0,algorithm:i.algorithm,solvable:C.isSolvable,pathLength:C.pathLength,complexity:C.complexity}}}async generateHandcraftedLevel(e,t){var d;const s=e.generation.layout;if(!s)throw new Error("Handcrafted generation requires layout data");const i=s.cells.map(m=>m.map(p=>({walls:p.walls,type:p.type==="start"||p.type==="goal"?"special":p.type,properties:{isStart:p.type==="start",isGoal:p.type==="goal",isVisited:!1,...p.properties}}))),n=s.orbPositions.map((m,p)=>({x:m.x,y:m.y,value:m.value,id:m.id||`orb_${p}`})),a=((d=s.powerupPositions)==null?void 0:d.map((m,p)=>({x:m.x,y:m.y,type:m.type,id:m.id||`powerup_${p}`})))||[],l=tr(i.map(m=>m.map(p=>p.walls)),s.startPosition,s.goalPosition);return{definition:e,maze:i,startPosition:{...s.startPosition},goalPosition:{...s.goalPosition},orbPositions:n,powerupPositions:a,metadata:{seed:t,generationTime:0,solvable:l.isSolvable,pathLength:l.pathLength,complexity:l.complexity}}}async generateFallbackLevel(e,t,s){const{width:i,height:n}=e.config.boardSize,a=[];for(let p=0;p<n;p++){const b=[];for(let A=0;A<i;A++){let C=0;A<i-1&&(C|=1),p<n-1&&(C|=2),A>0&&(C|=4),p>0&&(C|=8),b.push({walls:C,type:this.determineCellType(A,p,i,n),properties:{isStart:A===0&&p===0,isGoal:A===i-1&&p===n-1,isVisited:!1}})}a.push(b)}const l={x:0,y:0},h={x:i-1,y:n-1},d=Math.min(2,Math.floor(i*n/8)),m=[];for(let p=0;p<d;p++){let b,A;do b=Math.floor(t.next()*i),A=Math.floor(t.next()*n);while(b===0&&A===0||b===i-1&&A===n-1);m.push({x:b,y:A,value:100,id:`fallback_orb_${p}`})}return{definition:e,maze:a,startPosition:l,goalPosition:h,orbPositions:m,powerupPositions:[],metadata:{seed:s,generationTime:0,algorithm:"fallback",solvable:!0,pathLength:Math.abs(h.x-l.x)+Math.abs(h.y-l.y),complexity:0}}}generateOrbPositions(e,t,s,i,n){var C;const a=[],l=t.length,h=((C=t[0])==null?void 0:C.length)||0,d=e.orbCount||3,m=[];for(let L=0;L<l;L++)for(let D=0;D<h;D++)D===s.x&&L===s.y||D===i.x&&L===i.y||m.push({x:D,y:L});const p=n.shuffle([...m]);let b=[];switch(e.orbPlacement||"random"){case"random":b=p.slice(0,Math.min(d,p.length));break;case"corners":const L=p.filter(D=>(D.x===0||D.x===h-1)&&(D.y===0||D.y===l-1));b=[...L.slice(0,Math.min(d,L.length)),...p.filter(D=>!L.includes(D)).slice(0,Math.max(0,d-L.length))];break;case"strategic":case"path":default:b=p.slice(0,Math.min(d,p.length));break}return b.forEach((L,D)=>{a.push({x:L.x,y:L.y,value:100,id:`orb_${D}`})}),a}mapAlgorithm(e){switch(e){case"prim":case"kruskal":return"prim";case"recursive_backtrack":case"wilson":return"recursive-backtrack";default:return"prim"}}determineCellType(e,t,s,i){return e===0&&t===0||e===s-1&&t===i-1?"special":"floor"}getMazeValidationOptions(e){return{minPathLength:e.minPathLength,minComplexity:Math.floor(e.complexity*10),minReachableCells:Math.floor((e.branchingFactor||.3)*20)}}getMinPathLengthRequirement(e){const t=e.generation.parameters;return t==null?void 0:t.minPathLength}isPositionInBounds(e,t,s){return e.x>=0&&e.y>=0&&e.x<t&&e.y<s}initializeEmbeddedLevels(){[{id:"level-001-tutorial",name:"Tutorial",difficulty:"easy"},{id:"level-002-simple-path",name:"Simple Path",difficulty:"easy"},{id:"level-003-branching-paths",name:"Branching Paths",difficulty:"easy"},{id:"level-004-time-pressure",name:"Time Pressure",difficulty:"medium"},{id:"level-005-puzzle-chamber",name:"Puzzle Chamber",difficulty:"medium"},{id:"level-006-maze-runner",name:"Maze Runner",difficulty:"medium"},{id:"level-007-symmetry-challenge",name:"Symmetry Challenge",difficulty:"hard"},{id:"level-008-trap-maze",name:"Trap Maze",difficulty:"hard"},{id:"level-009-speed-demon",name:"Speed Demon",difficulty:"expert"},{id:"level-010-master-challenge",name:"Master Challenge",difficulty:"expert"}].forEach(t=>{this.embeddedLevels.set(t.id,{id:t.id,name:t.name,difficulty:t.difficulty})})}}var to={};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Jo=function(r){const e=[];let t=0;for(let s=0;s<r.length;s++){let i=r.charCodeAt(s);i<128?e[t++]=i:i<2048?(e[t++]=i>>6|192,e[t++]=i&63|128):(i&64512)===55296&&s+1<r.length&&(r.charCodeAt(s+1)&64512)===56320?(i=65536+((i&1023)<<10)+(r.charCodeAt(++s)&1023),e[t++]=i>>18|240,e[t++]=i>>12&63|128,e[t++]=i>>6&63|128,e[t++]=i&63|128):(e[t++]=i>>12|224,e[t++]=i>>6&63|128,e[t++]=i&63|128)}return e},Vc=function(r){const e=[];let t=0,s=0;for(;t<r.length;){const i=r[t++];if(i<128)e[s++]=String.fromCharCode(i);else if(i>191&&i<224){const n=r[t++];e[s++]=String.fromCharCode((i&31)<<6|n&63)}else if(i>239&&i<365){const n=r[t++],a=r[t++],l=r[t++],h=((i&7)<<18|(n&63)<<12|(a&63)<<6|l&63)-65536;e[s++]=String.fromCharCode(55296+(h>>10)),e[s++]=String.fromCharCode(56320+(h&1023))}else{const n=r[t++],a=r[t++];e[s++]=String.fromCharCode((i&15)<<12|(n&63)<<6|a&63)}}return e.join("")},Zo={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:typeof atob=="function",encodeByteArray(r,e){if(!Array.isArray(r))throw Error("encodeByteArray takes an array as a parameter");this.init_();const t=e?this.byteToCharMapWebSafe_:this.byteToCharMap_,s=[];for(let i=0;i<r.length;i+=3){const n=r[i],a=i+1<r.length,l=a?r[i+1]:0,h=i+2<r.length,d=h?r[i+2]:0,m=n>>2,p=(n&3)<<4|l>>4;let b=(l&15)<<2|d>>6,A=d&63;h||(A=64,a||(b=64)),s.push(t[m],t[p],t[b],t[A])}return s.join("")},encodeString(r,e){return this.HAS_NATIVE_SUPPORT&&!e?btoa(r):this.encodeByteArray(Jo(r),e)},decodeString(r,e){return this.HAS_NATIVE_SUPPORT&&!e?atob(r):Vc(this.decodeStringToByteArray(r,e))},decodeStringToByteArray(r,e){this.init_();const t=e?this.charToByteMapWebSafe_:this.charToByteMap_,s=[];for(let i=0;i<r.length;){const n=t[r.charAt(i++)],l=i<r.length?t[r.charAt(i)]:0;++i;const d=i<r.length?t[r.charAt(i)]:64;++i;const p=i<r.length?t[r.charAt(i)]:64;if(++i,n==null||l==null||d==null||p==null)throw new Oc;const b=n<<2|l>>4;if(s.push(b),d!==64){const A=l<<4&240|d>>2;if(s.push(A),p!==64){const C=d<<6&192|p;s.push(C)}}}return s},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let r=0;r<this.ENCODED_VALS.length;r++)this.byteToCharMap_[r]=this.ENCODED_VALS.charAt(r),this.charToByteMap_[this.byteToCharMap_[r]]=r,this.byteToCharMapWebSafe_[r]=this.ENCODED_VALS_WEBSAFE.charAt(r),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[r]]=r,r>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(r)]=r,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(r)]=r)}}};class Oc extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const Mc=function(r){const e=Jo(r);return Zo.encodeByteArray(e,!0)},Hs=function(r){return Mc(r).replace(/\./g,"")},Nc=function(r){try{return Zo.decodeString(r,!0)}catch(e){console.error("base64Decode failed: ",e)}return null};/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Fc(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("Unable to locate global object.")}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const $c=()=>Fc().__FIREBASE_DEFAULTS__,zc=()=>{if(typeof process>"u"||typeof to>"u")return;const r=to.__FIREBASE_DEFAULTS__;if(r)return JSON.parse(r)},Bc=()=>{if(typeof document>"u")return;let r;try{r=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch{return}const e=r&&Nc(r[1]);return e&&JSON.parse(e)},Er=()=>{try{return $c()||zc()||Bc()}catch(r){console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${r}`);return}},Uc=r=>{var e,t;return(t=(e=Er())===null||e===void 0?void 0:e.emulatorHosts)===null||t===void 0?void 0:t[r]},jc=r=>{const e=Uc(r);if(!e)return;const t=e.lastIndexOf(":");if(t<=0||t+1===e.length)throw new Error(`Invalid host ${e} with no separate hostname and port!`);const s=parseInt(e.substring(t+1),10);return e[0]==="["?[e.substring(1,t-1),s]:[e.substring(0,t),s]},ea=()=>{var r;return(r=Er())===null||r===void 0?void 0:r.config};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Gc{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}wrapCallback(e){return(t,s)=>{t?this.reject(t):this.resolve(s),typeof e=="function"&&(this.promise.catch(()=>{}),e.length===1?e(t):e(t,s))}}}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function qc(r,e){if(r.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');const t={alg:"none",type:"JWT"},s=e||"demo-project",i=r.iat||0,n=r.sub||r.user_id;if(!n)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");const a=Object.assign({iss:`https://securetoken.google.com/${s}`,aud:s,iat:i,exp:i+3600,auth_time:i,sub:n,user_id:n,firebase:{sign_in_provider:"custom",identities:{}}},r);return[Hs(JSON.stringify(t)),Hs(JSON.stringify(a)),""].join(".")}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Hc(){return typeof navigator<"u"&&typeof navigator.userAgent=="string"?navigator.userAgent:""}function Wc(){var r;const e=(r=Er())===null||r===void 0?void 0:r.forceEnvironment;if(e==="node")return!0;if(e==="browser")return!1;try{return Object.prototype.toString.call(global.process)==="[object process]"}catch{return!1}}function ta(){const r=typeof chrome=="object"?chrome.runtime:typeof browser=="object"?browser.runtime:void 0;return typeof r=="object"&&r.id!==void 0}function Kc(){return!Wc()&&!!navigator.userAgent&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}function Tr(){try{return typeof indexedDB=="object"}catch{return!1}}function br(){return new Promise((r,e)=>{try{let t=!0;const s="validate-browser-context-for-indexeddb-analytics-module",i=self.indexedDB.open(s);i.onsuccess=()=>{i.result.close(),t||self.indexedDB.deleteDatabase(s),r(!0)},i.onupgradeneeded=()=>{t=!1},i.onerror=()=>{var n;e(((n=i.error)===null||n===void 0?void 0:n.message)||"")}}catch(t){e(t)}})}function sa(){return!(typeof navigator>"u"||!navigator.cookieEnabled)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Yc="FirebaseError";class Ze extends Error{constructor(e,t,s){super(t),this.code=e,this.customData=s,this.name=Yc,Object.setPrototypeOf(this,Ze.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,li.prototype.create)}}class li{constructor(e,t,s){this.service=e,this.serviceName=t,this.errors=s}create(e,...t){const s=t[0]||{},i=`${this.service}/${e}`,n=this.errors[e],a=n?Xc(n,s):"Error",l=`${this.serviceName}: ${a} (${i}).`;return new Ze(i,l,s)}}function Xc(r,e){return r.replace(Qc,(t,s)=>{const i=e[s];return i!=null?String(i):`<${s}?>`})}const Qc=/\{\$([^}]+)}/g;function Ws(r,e){if(r===e)return!0;const t=Object.keys(r),s=Object.keys(e);for(const i of t){if(!s.includes(i))return!1;const n=r[i],a=e[i];if(so(n)&&so(a)){if(!Ws(n,a))return!1}else if(n!==a)return!1}for(const i of s)if(!t.includes(i))return!1;return!0}function so(r){return r!==null&&typeof r=="object"}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Jc=1e3,Zc=2,eh=4*60*60*1e3,th=.5;function io(r,e=Jc,t=Zc){const s=e*Math.pow(t,r),i=Math.round(th*s*(Math.random()-.5)*2);return Math.min(eh,s+i)}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function ut(r){return r&&r._delegate?r._delegate:r}class Fe{constructor(e,t,s){this.name=e,this.instanceFactory=t,this.type=s,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const nt="[DEFAULT]";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class sh{constructor(e,t){this.name=e,this.container=t,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(e){const t=this.normalizeInstanceIdentifier(e);if(!this.instancesDeferred.has(t)){const s=new Gc;if(this.instancesDeferred.set(t,s),this.isInitialized(t)||this.shouldAutoInitialize())try{const i=this.getOrInitializeService({instanceIdentifier:t});i&&s.resolve(i)}catch{}}return this.instancesDeferred.get(t).promise}getImmediate(e){var t;const s=this.normalizeInstanceIdentifier(e==null?void 0:e.identifier),i=(t=e==null?void 0:e.optional)!==null&&t!==void 0?t:!1;if(this.isInitialized(s)||this.shouldAutoInitialize())try{return this.getOrInitializeService({instanceIdentifier:s})}catch(n){if(i)return null;throw n}else{if(i)return null;throw Error(`Service ${this.name} is not available`)}}getComponent(){return this.component}setComponent(e){if(e.name!==this.name)throw Error(`Mismatching Component ${e.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=e,!!this.shouldAutoInitialize()){if(rh(e))try{this.getOrInitializeService({instanceIdentifier:nt})}catch{}for(const[t,s]of this.instancesDeferred.entries()){const i=this.normalizeInstanceIdentifier(t);try{const n=this.getOrInitializeService({instanceIdentifier:i});s.resolve(n)}catch{}}}}clearInstance(e=nt){this.instancesDeferred.delete(e),this.instancesOptions.delete(e),this.instances.delete(e)}async delete(){const e=Array.from(this.instances.values());await Promise.all([...e.filter(t=>"INTERNAL"in t).map(t=>t.INTERNAL.delete()),...e.filter(t=>"_delete"in t).map(t=>t._delete())])}isComponentSet(){return this.component!=null}isInitialized(e=nt){return this.instances.has(e)}getOptions(e=nt){return this.instancesOptions.get(e)||{}}initialize(e={}){const{options:t={}}=e,s=this.normalizeInstanceIdentifier(e.instanceIdentifier);if(this.isInitialized(s))throw Error(`${this.name}(${s}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const i=this.getOrInitializeService({instanceIdentifier:s,options:t});for(const[n,a]of this.instancesDeferred.entries()){const l=this.normalizeInstanceIdentifier(n);s===l&&a.resolve(i)}return i}onInit(e,t){var s;const i=this.normalizeInstanceIdentifier(t),n=(s=this.onInitCallbacks.get(i))!==null&&s!==void 0?s:new Set;n.add(e),this.onInitCallbacks.set(i,n);const a=this.instances.get(i);return a&&e(a,i),()=>{n.delete(e)}}invokeOnInitCallbacks(e,t){const s=this.onInitCallbacks.get(t);if(s)for(const i of s)try{i(e,t)}catch{}}getOrInitializeService({instanceIdentifier:e,options:t={}}){let s=this.instances.get(e);if(!s&&this.component&&(s=this.component.instanceFactory(this.container,{instanceIdentifier:ih(e),options:t}),this.instances.set(e,s),this.instancesOptions.set(e,t),this.invokeOnInitCallbacks(s,e),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,e,s)}catch{}return s||null}normalizeInstanceIdentifier(e=nt){return this.component?this.component.multipleInstances?e:nt:e}shouldAutoInitialize(){return!!this.component&&this.component.instantiationMode!=="EXPLICIT"}}function ih(r){return r===nt?void 0:r}function rh(r){return r.instantiationMode==="EAGER"}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class nh{constructor(e){this.name=e,this.providers=new Map}addComponent(e){const t=this.getProvider(e.name);if(t.isComponentSet())throw new Error(`Component ${e.name} has already been registered with ${this.name}`);t.setComponent(e)}addOrOverwriteComponent(e){this.getProvider(e.name).isComponentSet()&&this.providers.delete(e.name),this.addComponent(e)}getProvider(e){if(this.providers.has(e))return this.providers.get(e);const t=new sh(e,this);return this.providers.set(e,t),t}getProviders(){return Array.from(this.providers.values())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var z;(function(r){r[r.DEBUG=0]="DEBUG",r[r.VERBOSE=1]="VERBOSE",r[r.INFO=2]="INFO",r[r.WARN=3]="WARN",r[r.ERROR=4]="ERROR",r[r.SILENT=5]="SILENT"})(z||(z={}));const oh={debug:z.DEBUG,verbose:z.VERBOSE,info:z.INFO,warn:z.WARN,error:z.ERROR,silent:z.SILENT},ah=z.INFO,lh={[z.DEBUG]:"log",[z.VERBOSE]:"log",[z.INFO]:"info",[z.WARN]:"warn",[z.ERROR]:"error"},ch=(r,e,...t)=>{if(e<r.logLevel)return;const s=new Date().toISOString(),i=lh[e];if(i)console[i](`[${s}]  ${r.name}:`,...t);else throw new Error(`Attempted to log a message with an invalid logType (value: ${e})`)};class Sr{constructor(e){this.name=e,this._logLevel=ah,this._logHandler=ch,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in z))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel=typeof e=="string"?oh[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if(typeof e!="function")throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,z.DEBUG,...e),this._logHandler(this,z.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,z.VERBOSE,...e),this._logHandler(this,z.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,z.INFO,...e),this._logHandler(this,z.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,z.WARN,...e),this._logHandler(this,z.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,z.ERROR,...e),this._logHandler(this,z.ERROR,...e)}}const hh=(r,e)=>e.some(t=>r instanceof t);let ro,no;function uh(){return ro||(ro=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function dh(){return no||(no=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const ia=new WeakMap,ir=new WeakMap,ra=new WeakMap,Gi=new WeakMap,Ar=new WeakMap;function fh(r){const e=new Promise((t,s)=>{const i=()=>{r.removeEventListener("success",n),r.removeEventListener("error",a)},n=()=>{t(qe(r.result)),i()},a=()=>{s(r.error),i()};r.addEventListener("success",n),r.addEventListener("error",a)});return e.then(t=>{t instanceof IDBCursor&&ia.set(t,r)}).catch(()=>{}),Ar.set(e,r),e}function mh(r){if(ir.has(r))return;const e=new Promise((t,s)=>{const i=()=>{r.removeEventListener("complete",n),r.removeEventListener("error",a),r.removeEventListener("abort",a)},n=()=>{t(),i()},a=()=>{s(r.error||new DOMException("AbortError","AbortError")),i()};r.addEventListener("complete",n),r.addEventListener("error",a),r.addEventListener("abort",a)});ir.set(r,e)}let rr={get(r,e,t){if(r instanceof IDBTransaction){if(e==="done")return ir.get(r);if(e==="objectStoreNames")return r.objectStoreNames||ra.get(r);if(e==="store")return t.objectStoreNames[1]?void 0:t.objectStore(t.objectStoreNames[0])}return qe(r[e])},set(r,e,t){return r[e]=t,!0},has(r,e){return r instanceof IDBTransaction&&(e==="done"||e==="store")?!0:e in r}};function ph(r){rr=r(rr)}function gh(r){return r===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(e,...t){const s=r.call(qi(this),e,...t);return ra.set(s,e.sort?e.sort():[e]),qe(s)}:dh().includes(r)?function(...e){return r.apply(qi(this),e),qe(ia.get(this))}:function(...e){return qe(r.apply(qi(this),e))}}function yh(r){return typeof r=="function"?gh(r):(r instanceof IDBTransaction&&mh(r),hh(r,uh())?new Proxy(r,rr):r)}function qe(r){if(r instanceof IDBRequest)return fh(r);if(Gi.has(r))return Gi.get(r);const e=yh(r);return e!==r&&(Gi.set(r,e),Ar.set(e,r)),e}const qi=r=>Ar.get(r);function na(r,e,{blocked:t,upgrade:s,blocking:i,terminated:n}={}){const a=indexedDB.open(r,e),l=qe(a);return s&&a.addEventListener("upgradeneeded",h=>{s(qe(a.result),h.oldVersion,h.newVersion,qe(a.transaction),h)}),t&&a.addEventListener("blocked",h=>t(h.oldVersion,h.newVersion,h)),l.then(h=>{n&&h.addEventListener("close",()=>n()),i&&h.addEventListener("versionchange",d=>i(d.oldVersion,d.newVersion,d))}).catch(()=>{}),l}const vh=["get","getKey","getAll","getAllKeys","count"],_h=["put","add","delete","clear"],Hi=new Map;function oo(r,e){if(!(r instanceof IDBDatabase&&!(e in r)&&typeof e=="string"))return;if(Hi.get(e))return Hi.get(e);const t=e.replace(/FromIndex$/,""),s=e!==t,i=_h.includes(t);if(!(t in(s?IDBIndex:IDBObjectStore).prototype)||!(i||vh.includes(t)))return;const n=async function(a,...l){const h=this.transaction(a,i?"readwrite":"readonly");let d=h.store;return s&&(d=d.index(l.shift())),(await Promise.all([d[t](...l),i&&h.done]))[0]};return Hi.set(e,n),n}ph(r=>({...r,get:(e,t,s)=>oo(e,t)||r.get(e,t,s),has:(e,t)=>!!oo(e,t)||r.has(e,t)}));/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class wh{constructor(e){this.container=e}getPlatformInfoString(){return this.container.getProviders().map(t=>{if(Eh(t)){const s=t.getImmediate();return`${s.library}/${s.version}`}else return null}).filter(t=>t).join(" ")}}function Eh(r){const e=r.getComponent();return(e==null?void 0:e.type)==="VERSION"}const nr="@firebase/app",ao="0.10.13";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const $e=new Sr("@firebase/app"),Th="@firebase/app-compat",bh="@firebase/analytics-compat",Sh="@firebase/analytics",Ah="@firebase/app-check-compat",Ih="@firebase/app-check",Ch="@firebase/auth",Ph="@firebase/auth-compat",Rh="@firebase/database",Dh="@firebase/data-connect",xh="@firebase/database-compat",Lh="@firebase/functions",kh="@firebase/functions-compat",Vh="@firebase/installations",Oh="@firebase/installations-compat",Mh="@firebase/messaging",Nh="@firebase/messaging-compat",Fh="@firebase/performance",$h="@firebase/performance-compat",zh="@firebase/remote-config",Bh="@firebase/remote-config-compat",Uh="@firebase/storage",jh="@firebase/storage-compat",Gh="@firebase/firestore",qh="@firebase/vertexai-preview",Hh="@firebase/firestore-compat",Wh="firebase",Kh="10.14.1";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const or="[DEFAULT]",Yh={[nr]:"fire-core",[Th]:"fire-core-compat",[Sh]:"fire-analytics",[bh]:"fire-analytics-compat",[Ih]:"fire-app-check",[Ah]:"fire-app-check-compat",[Ch]:"fire-auth",[Ph]:"fire-auth-compat",[Rh]:"fire-rtdb",[Dh]:"fire-data-connect",[xh]:"fire-rtdb-compat",[Lh]:"fire-fn",[kh]:"fire-fn-compat",[Vh]:"fire-iid",[Oh]:"fire-iid-compat",[Mh]:"fire-fcm",[Nh]:"fire-fcm-compat",[Fh]:"fire-perf",[$h]:"fire-perf-compat",[zh]:"fire-rc",[Bh]:"fire-rc-compat",[Uh]:"fire-gcs",[jh]:"fire-gcs-compat",[Gh]:"fire-fst",[Hh]:"fire-fst-compat",[qh]:"fire-vertex","fire-js":"fire-js",[Wh]:"fire-js-all"};/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Ks=new Map,Xh=new Map,ar=new Map;function lo(r,e){try{r.container.addComponent(e)}catch(t){$e.debug(`Component ${e.name} failed to register with FirebaseApp ${r.name}`,t)}}function Ye(r){const e=r.name;if(ar.has(e))return $e.debug(`There were multiple attempts to register component ${e}.`),!1;ar.set(e,r);for(const t of Ks.values())lo(t,r);for(const t of Xh.values())lo(t,r);return!0}function ms(r,e){const t=r.container.getProvider("heartbeat").getImmediate({optional:!0});return t&&t.triggerHeartbeat(),r.container.getProvider(e)}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Qh={"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}'","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","server-app-deleted":"Firebase Server App has been deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.","finalization-registry-not-supported":"FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.","invalid-server-app-environment":"FirebaseServerApp is not for use in browser environments."},He=new li("app","Firebase",Qh);/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Jh{constructor(e,t,s){this._isDeleted=!1,this._options=Object.assign({},e),this._config=Object.assign({},t),this._name=t.name,this._automaticDataCollectionEnabled=t.automaticDataCollectionEnabled,this._container=s,this.container.addComponent(new Fe("app",()=>this,"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(e){this.checkDestroyed(),this._automaticDataCollectionEnabled=e}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(e){this._isDeleted=e}checkDestroyed(){if(this.isDeleted)throw He.create("app-deleted",{appName:this._name})}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Zh=Kh;function oa(r,e={}){let t=r;typeof e!="object"&&(e={name:e});const s=Object.assign({name:or,automaticDataCollectionEnabled:!1},e),i=s.name;if(typeof i!="string"||!i)throw He.create("bad-app-name",{appName:String(i)});if(t||(t=ea()),!t)throw He.create("no-options");const n=Ks.get(i);if(n){if(Ws(t,n.options)&&Ws(s,n.config))return n;throw He.create("duplicate-app",{appName:i})}const a=new nh(i);for(const h of ar.values())a.addComponent(h);const l=new Jh(t,s,a);return Ks.set(i,l),l}function aa(r=or){const e=Ks.get(r);if(!e&&r===or&&ea())return oa();if(!e)throw He.create("no-app",{appName:r});return e}function De(r,e,t){var s;let i=(s=Yh[r])!==null&&s!==void 0?s:r;t&&(i+=`-${t}`);const n=i.match(/\s|\//),a=e.match(/\s|\//);if(n||a){const l=[`Unable to register library "${i}" with version "${e}":`];n&&l.push(`library name "${i}" contains illegal characters (whitespace or "/")`),n&&a&&l.push("and"),a&&l.push(`version name "${e}" contains illegal characters (whitespace or "/")`),$e.warn(l.join(" "));return}Ye(new Fe(`${i}-version`,()=>({library:i,version:e}),"VERSION"))}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const eu="firebase-heartbeat-database",tu=1,os="firebase-heartbeat-store";let Wi=null;function la(){return Wi||(Wi=na(eu,tu,{upgrade:(r,e)=>{switch(e){case 0:try{r.createObjectStore(os)}catch(t){console.warn(t)}}}}).catch(r=>{throw He.create("idb-open",{originalErrorMessage:r.message})})),Wi}async function su(r){try{const t=(await la()).transaction(os),s=await t.objectStore(os).get(ca(r));return await t.done,s}catch(e){if(e instanceof Ze)$e.warn(e.message);else{const t=He.create("idb-get",{originalErrorMessage:e==null?void 0:e.message});$e.warn(t.message)}}}async function co(r,e){try{const s=(await la()).transaction(os,"readwrite");await s.objectStore(os).put(e,ca(r)),await s.done}catch(t){if(t instanceof Ze)$e.warn(t.message);else{const s=He.create("idb-set",{originalErrorMessage:t==null?void 0:t.message});$e.warn(s.message)}}}function ca(r){return`${r.name}!${r.options.appId}`}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const iu=1024,ru=30*24*60*60*1e3;class nu{constructor(e){this.container=e,this._heartbeatsCache=null;const t=this.container.getProvider("app").getImmediate();this._storage=new au(t),this._heartbeatsCachePromise=this._storage.read().then(s=>(this._heartbeatsCache=s,s))}async triggerHeartbeat(){var e,t;try{const i=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),n=ho();return((e=this._heartbeatsCache)===null||e===void 0?void 0:e.heartbeats)==null&&(this._heartbeatsCache=await this._heartbeatsCachePromise,((t=this._heartbeatsCache)===null||t===void 0?void 0:t.heartbeats)==null)||this._heartbeatsCache.lastSentHeartbeatDate===n||this._heartbeatsCache.heartbeats.some(a=>a.date===n)?void 0:(this._heartbeatsCache.heartbeats.push({date:n,agent:i}),this._heartbeatsCache.heartbeats=this._heartbeatsCache.heartbeats.filter(a=>{const l=new Date(a.date).valueOf();return Date.now()-l<=ru}),this._storage.overwrite(this._heartbeatsCache))}catch(s){$e.warn(s)}}async getHeartbeatsHeader(){var e;try{if(this._heartbeatsCache===null&&await this._heartbeatsCachePromise,((e=this._heartbeatsCache)===null||e===void 0?void 0:e.heartbeats)==null||this._heartbeatsCache.heartbeats.length===0)return"";const t=ho(),{heartbeatsToSend:s,unsentEntries:i}=ou(this._heartbeatsCache.heartbeats),n=Hs(JSON.stringify({version:2,heartbeats:s}));return this._heartbeatsCache.lastSentHeartbeatDate=t,i.length>0?(this._heartbeatsCache.heartbeats=i,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),n}catch(t){return $e.warn(t),""}}}function ho(){return new Date().toISOString().substring(0,10)}function ou(r,e=iu){const t=[];let s=r.slice();for(const i of r){const n=t.find(a=>a.agent===i.agent);if(n){if(n.dates.push(i.date),uo(t)>e){n.dates.pop();break}}else if(t.push({agent:i.agent,dates:[i.date]}),uo(t)>e){t.pop();break}s=s.slice(1)}return{heartbeatsToSend:t,unsentEntries:s}}class au{constructor(e){this.app=e,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return Tr()?br().then(()=>!0).catch(()=>!1):!1}async read(){if(await this._canUseIndexedDBPromise){const t=await su(this.app);return t!=null&&t.heartbeats?t:{heartbeats:[]}}else return{heartbeats:[]}}async overwrite(e){var t;if(await this._canUseIndexedDBPromise){const i=await this.read();return co(this.app,{lastSentHeartbeatDate:(t=e.lastSentHeartbeatDate)!==null&&t!==void 0?t:i.lastSentHeartbeatDate,heartbeats:e.heartbeats})}else return}async add(e){var t;if(await this._canUseIndexedDBPromise){const i=await this.read();return co(this.app,{lastSentHeartbeatDate:(t=e.lastSentHeartbeatDate)!==null&&t!==void 0?t:i.lastSentHeartbeatDate,heartbeats:[...i.heartbeats,...e.heartbeats]})}else return}}function uo(r){return Hs(JSON.stringify({version:2,heartbeats:r})).length}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function lu(r){Ye(new Fe("platform-logger",e=>new wh(e),"PRIVATE")),Ye(new Fe("heartbeat",e=>new nu(e),"PRIVATE")),De(nr,ao,r),De(nr,ao,"esm2017"),De("fire-js","")}lu("");var fo=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};/** @license
Copyright The Closure Library Authors.
SPDX-License-Identifier: Apache-2.0
*/var ha;(function(){var r;/** @license

 Copyright The Closure Library Authors.
 SPDX-License-Identifier: Apache-2.0
*/function e(E,g){function v(){}v.prototype=g.prototype,E.D=g.prototype,E.prototype=new v,E.prototype.constructor=E,E.C=function(_,w,S){for(var y=Array(arguments.length-2),ke=2;ke<arguments.length;ke++)y[ke-2]=arguments[ke];return g.prototype[w].apply(_,y)}}function t(){this.blockSize=-1}function s(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.B=Array(this.blockSize),this.o=this.h=0,this.s()}e(s,t),s.prototype.s=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.o=this.h=0};function i(E,g,v){v||(v=0);var _=Array(16);if(typeof g=="string")for(var w=0;16>w;++w)_[w]=g.charCodeAt(v++)|g.charCodeAt(v++)<<8|g.charCodeAt(v++)<<16|g.charCodeAt(v++)<<24;else for(w=0;16>w;++w)_[w]=g[v++]|g[v++]<<8|g[v++]<<16|g[v++]<<24;g=E.g[0],v=E.g[1],w=E.g[2];var S=E.g[3],y=g+(S^v&(w^S))+_[0]+3614090360&4294967295;g=v+(y<<7&4294967295|y>>>25),y=S+(w^g&(v^w))+_[1]+3905402710&4294967295,S=g+(y<<12&4294967295|y>>>20),y=w+(v^S&(g^v))+_[2]+606105819&4294967295,w=S+(y<<17&4294967295|y>>>15),y=v+(g^w&(S^g))+_[3]+3250441966&4294967295,v=w+(y<<22&4294967295|y>>>10),y=g+(S^v&(w^S))+_[4]+4118548399&4294967295,g=v+(y<<7&4294967295|y>>>25),y=S+(w^g&(v^w))+_[5]+1200080426&4294967295,S=g+(y<<12&4294967295|y>>>20),y=w+(v^S&(g^v))+_[6]+2821735955&4294967295,w=S+(y<<17&4294967295|y>>>15),y=v+(g^w&(S^g))+_[7]+4249261313&4294967295,v=w+(y<<22&4294967295|y>>>10),y=g+(S^v&(w^S))+_[8]+1770035416&4294967295,g=v+(y<<7&4294967295|y>>>25),y=S+(w^g&(v^w))+_[9]+2336552879&4294967295,S=g+(y<<12&4294967295|y>>>20),y=w+(v^S&(g^v))+_[10]+4294925233&4294967295,w=S+(y<<17&4294967295|y>>>15),y=v+(g^w&(S^g))+_[11]+2304563134&4294967295,v=w+(y<<22&4294967295|y>>>10),y=g+(S^v&(w^S))+_[12]+1804603682&4294967295,g=v+(y<<7&4294967295|y>>>25),y=S+(w^g&(v^w))+_[13]+4254626195&4294967295,S=g+(y<<12&4294967295|y>>>20),y=w+(v^S&(g^v))+_[14]+2792965006&4294967295,w=S+(y<<17&4294967295|y>>>15),y=v+(g^w&(S^g))+_[15]+1236535329&4294967295,v=w+(y<<22&4294967295|y>>>10),y=g+(w^S&(v^w))+_[1]+4129170786&4294967295,g=v+(y<<5&4294967295|y>>>27),y=S+(v^w&(g^v))+_[6]+3225465664&4294967295,S=g+(y<<9&4294967295|y>>>23),y=w+(g^v&(S^g))+_[11]+643717713&4294967295,w=S+(y<<14&4294967295|y>>>18),y=v+(S^g&(w^S))+_[0]+3921069994&4294967295,v=w+(y<<20&4294967295|y>>>12),y=g+(w^S&(v^w))+_[5]+3593408605&4294967295,g=v+(y<<5&4294967295|y>>>27),y=S+(v^w&(g^v))+_[10]+38016083&4294967295,S=g+(y<<9&4294967295|y>>>23),y=w+(g^v&(S^g))+_[15]+3634488961&4294967295,w=S+(y<<14&4294967295|y>>>18),y=v+(S^g&(w^S))+_[4]+3889429448&4294967295,v=w+(y<<20&4294967295|y>>>12),y=g+(w^S&(v^w))+_[9]+568446438&4294967295,g=v+(y<<5&4294967295|y>>>27),y=S+(v^w&(g^v))+_[14]+3275163606&4294967295,S=g+(y<<9&4294967295|y>>>23),y=w+(g^v&(S^g))+_[3]+4107603335&4294967295,w=S+(y<<14&4294967295|y>>>18),y=v+(S^g&(w^S))+_[8]+1163531501&4294967295,v=w+(y<<20&4294967295|y>>>12),y=g+(w^S&(v^w))+_[13]+2850285829&4294967295,g=v+(y<<5&4294967295|y>>>27),y=S+(v^w&(g^v))+_[2]+4243563512&4294967295,S=g+(y<<9&4294967295|y>>>23),y=w+(g^v&(S^g))+_[7]+1735328473&4294967295,w=S+(y<<14&4294967295|y>>>18),y=v+(S^g&(w^S))+_[12]+2368359562&4294967295,v=w+(y<<20&4294967295|y>>>12),y=g+(v^w^S)+_[5]+4294588738&4294967295,g=v+(y<<4&4294967295|y>>>28),y=S+(g^v^w)+_[8]+2272392833&4294967295,S=g+(y<<11&4294967295|y>>>21),y=w+(S^g^v)+_[11]+1839030562&4294967295,w=S+(y<<16&4294967295|y>>>16),y=v+(w^S^g)+_[14]+4259657740&4294967295,v=w+(y<<23&4294967295|y>>>9),y=g+(v^w^S)+_[1]+2763975236&4294967295,g=v+(y<<4&4294967295|y>>>28),y=S+(g^v^w)+_[4]+1272893353&4294967295,S=g+(y<<11&4294967295|y>>>21),y=w+(S^g^v)+_[7]+4139469664&4294967295,w=S+(y<<16&4294967295|y>>>16),y=v+(w^S^g)+_[10]+3200236656&4294967295,v=w+(y<<23&4294967295|y>>>9),y=g+(v^w^S)+_[13]+681279174&4294967295,g=v+(y<<4&4294967295|y>>>28),y=S+(g^v^w)+_[0]+3936430074&4294967295,S=g+(y<<11&4294967295|y>>>21),y=w+(S^g^v)+_[3]+3572445317&4294967295,w=S+(y<<16&4294967295|y>>>16),y=v+(w^S^g)+_[6]+76029189&4294967295,v=w+(y<<23&4294967295|y>>>9),y=g+(v^w^S)+_[9]+3654602809&4294967295,g=v+(y<<4&4294967295|y>>>28),y=S+(g^v^w)+_[12]+3873151461&4294967295,S=g+(y<<11&4294967295|y>>>21),y=w+(S^g^v)+_[15]+530742520&4294967295,w=S+(y<<16&4294967295|y>>>16),y=v+(w^S^g)+_[2]+3299628645&4294967295,v=w+(y<<23&4294967295|y>>>9),y=g+(w^(v|~S))+_[0]+4096336452&4294967295,g=v+(y<<6&4294967295|y>>>26),y=S+(v^(g|~w))+_[7]+1126891415&4294967295,S=g+(y<<10&4294967295|y>>>22),y=w+(g^(S|~v))+_[14]+2878612391&4294967295,w=S+(y<<15&4294967295|y>>>17),y=v+(S^(w|~g))+_[5]+4237533241&4294967295,v=w+(y<<21&4294967295|y>>>11),y=g+(w^(v|~S))+_[12]+1700485571&4294967295,g=v+(y<<6&4294967295|y>>>26),y=S+(v^(g|~w))+_[3]+2399980690&4294967295,S=g+(y<<10&4294967295|y>>>22),y=w+(g^(S|~v))+_[10]+4293915773&4294967295,w=S+(y<<15&4294967295|y>>>17),y=v+(S^(w|~g))+_[1]+2240044497&4294967295,v=w+(y<<21&4294967295|y>>>11),y=g+(w^(v|~S))+_[8]+1873313359&4294967295,g=v+(y<<6&4294967295|y>>>26),y=S+(v^(g|~w))+_[15]+4264355552&4294967295,S=g+(y<<10&4294967295|y>>>22),y=w+(g^(S|~v))+_[6]+2734768916&4294967295,w=S+(y<<15&4294967295|y>>>17),y=v+(S^(w|~g))+_[13]+1309151649&4294967295,v=w+(y<<21&4294967295|y>>>11),y=g+(w^(v|~S))+_[4]+4149444226&4294967295,g=v+(y<<6&4294967295|y>>>26),y=S+(v^(g|~w))+_[11]+3174756917&4294967295,S=g+(y<<10&4294967295|y>>>22),y=w+(g^(S|~v))+_[2]+718787259&4294967295,w=S+(y<<15&4294967295|y>>>17),y=v+(S^(w|~g))+_[9]+3951481745&4294967295,E.g[0]=E.g[0]+g&4294967295,E.g[1]=E.g[1]+(w+(y<<21&4294967295|y>>>11))&4294967295,E.g[2]=E.g[2]+w&4294967295,E.g[3]=E.g[3]+S&4294967295}s.prototype.u=function(E,g){g===void 0&&(g=E.length);for(var v=g-this.blockSize,_=this.B,w=this.h,S=0;S<g;){if(w==0)for(;S<=v;)i(this,E,S),S+=this.blockSize;if(typeof E=="string"){for(;S<g;)if(_[w++]=E.charCodeAt(S++),w==this.blockSize){i(this,_),w=0;break}}else for(;S<g;)if(_[w++]=E[S++],w==this.blockSize){i(this,_),w=0;break}}this.h=w,this.o+=g},s.prototype.v=function(){var E=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);E[0]=128;for(var g=1;g<E.length-8;++g)E[g]=0;var v=8*this.o;for(g=E.length-8;g<E.length;++g)E[g]=v&255,v/=256;for(this.u(E),E=Array(16),g=v=0;4>g;++g)for(var _=0;32>_;_+=8)E[v++]=this.g[g]>>>_&255;return E};function n(E,g){var v=l;return Object.prototype.hasOwnProperty.call(v,E)?v[E]:v[E]=g(E)}function a(E,g){this.h=g;for(var v=[],_=!0,w=E.length-1;0<=w;w--){var S=E[w]|0;_&&S==g||(v[w]=S,_=!1)}this.g=v}var l={};function h(E){return-128<=E&&128>E?n(E,function(g){return new a([g|0],0>g?-1:0)}):new a([E|0],0>E?-1:0)}function d(E){if(isNaN(E)||!isFinite(E))return p;if(0>E)return D(d(-E));for(var g=[],v=1,_=0;E>=v;_++)g[_]=E/v|0,v*=4294967296;return new a(g,0)}function m(E,g){if(E.length==0)throw Error("number format error: empty string");if(g=g||10,2>g||36<g)throw Error("radix out of range: "+g);if(E.charAt(0)=="-")return D(m(E.substring(1),g));if(0<=E.indexOf("-"))throw Error('number format error: interior "-" character');for(var v=d(Math.pow(g,8)),_=p,w=0;w<E.length;w+=8){var S=Math.min(8,E.length-w),y=parseInt(E.substring(w,w+S),g);8>S?(S=d(Math.pow(g,S)),_=_.j(S).add(d(y))):(_=_.j(v),_=_.add(d(y)))}return _}var p=h(0),b=h(1),A=h(16777216);r=a.prototype,r.m=function(){if(L(this))return-D(this).m();for(var E=0,g=1,v=0;v<this.g.length;v++){var _=this.i(v);E+=(0<=_?_:4294967296+_)*g,g*=4294967296}return E},r.toString=function(E){if(E=E||10,2>E||36<E)throw Error("radix out of range: "+E);if(C(this))return"0";if(L(this))return"-"+D(this).toString(E);for(var g=d(Math.pow(E,6)),v=this,_="";;){var w=le(v,g).g;v=F(v,w.j(g));var S=((0<v.g.length?v.g[0]:v.h)>>>0).toString(E);if(v=w,C(v))return S+_;for(;6>S.length;)S="0"+S;_=S+_}},r.i=function(E){return 0>E?0:E<this.g.length?this.g[E]:this.h};function C(E){if(E.h!=0)return!1;for(var g=0;g<E.g.length;g++)if(E.g[g]!=0)return!1;return!0}function L(E){return E.h==-1}r.l=function(E){return E=F(this,E),L(E)?-1:C(E)?0:1};function D(E){for(var g=E.g.length,v=[],_=0;_<g;_++)v[_]=~E.g[_];return new a(v,~E.h).add(b)}r.abs=function(){return L(this)?D(this):this},r.add=function(E){for(var g=Math.max(this.g.length,E.g.length),v=[],_=0,w=0;w<=g;w++){var S=_+(this.i(w)&65535)+(E.i(w)&65535),y=(S>>>16)+(this.i(w)>>>16)+(E.i(w)>>>16);_=y>>>16,S&=65535,y&=65535,v[w]=y<<16|S}return new a(v,v[v.length-1]&-2147483648?-1:0)};function F(E,g){return E.add(D(g))}r.j=function(E){if(C(this)||C(E))return p;if(L(this))return L(E)?D(this).j(D(E)):D(D(this).j(E));if(L(E))return D(this.j(D(E)));if(0>this.l(A)&&0>E.l(A))return d(this.m()*E.m());for(var g=this.g.length+E.g.length,v=[],_=0;_<2*g;_++)v[_]=0;for(_=0;_<this.g.length;_++)for(var w=0;w<E.g.length;w++){var S=this.i(_)>>>16,y=this.i(_)&65535,ke=E.i(w)>>>16,kt=E.i(w)&65535;v[2*_+2*w]+=y*kt,U(v,2*_+2*w),v[2*_+2*w+1]+=S*kt,U(v,2*_+2*w+1),v[2*_+2*w+1]+=y*ke,U(v,2*_+2*w+1),v[2*_+2*w+2]+=S*ke,U(v,2*_+2*w+2)}for(_=0;_<g;_++)v[_]=v[2*_+1]<<16|v[2*_];for(_=g;_<2*g;_++)v[_]=0;return new a(v,0)};function U(E,g){for(;(E[g]&65535)!=E[g];)E[g+1]+=E[g]>>>16,E[g]&=65535,g++}function X(E,g){this.g=E,this.h=g}function le(E,g){if(C(g))throw Error("division by zero");if(C(E))return new X(p,p);if(L(E))return g=le(D(E),g),new X(D(g.g),D(g.h));if(L(g))return g=le(E,D(g)),new X(D(g.g),g.h);if(30<E.g.length){if(L(E)||L(g))throw Error("slowDivide_ only works with positive integers.");for(var v=b,_=g;0>=_.l(E);)v=et(v),_=et(_);var w=_e(v,1),S=_e(_,1);for(_=_e(_,2),v=_e(v,2);!C(_);){var y=S.add(_);0>=y.l(E)&&(w=w.add(v),S=y),_=_e(_,1),v=_e(v,1)}return g=F(E,w.j(g)),new X(w,g)}for(w=p;0<=E.l(g);){for(v=Math.max(1,Math.floor(E.m()/g.m())),_=Math.ceil(Math.log(v)/Math.LN2),_=48>=_?1:Math.pow(2,_-48),S=d(v),y=S.j(g);L(y)||0<y.l(E);)v-=_,S=d(v),y=S.j(g);C(S)&&(S=b),w=w.add(S),E=F(E,y)}return new X(w,E)}r.A=function(E){return le(this,E).h},r.and=function(E){for(var g=Math.max(this.g.length,E.g.length),v=[],_=0;_<g;_++)v[_]=this.i(_)&E.i(_);return new a(v,this.h&E.h)},r.or=function(E){for(var g=Math.max(this.g.length,E.g.length),v=[],_=0;_<g;_++)v[_]=this.i(_)|E.i(_);return new a(v,this.h|E.h)},r.xor=function(E){for(var g=Math.max(this.g.length,E.g.length),v=[],_=0;_<g;_++)v[_]=this.i(_)^E.i(_);return new a(v,this.h^E.h)};function et(E){for(var g=E.g.length+1,v=[],_=0;_<g;_++)v[_]=E.i(_)<<1|E.i(_-1)>>>31;return new a(v,E.h)}function _e(E,g){var v=g>>5;g%=32;for(var _=E.g.length-v,w=[],S=0;S<_;S++)w[S]=0<g?E.i(S+v)>>>g|E.i(S+v+1)<<32-g:E.i(S+v);return new a(w,E.h)}s.prototype.digest=s.prototype.v,s.prototype.reset=s.prototype.s,s.prototype.update=s.prototype.u,a.prototype.add=a.prototype.add,a.prototype.multiply=a.prototype.j,a.prototype.modulo=a.prototype.A,a.prototype.compare=a.prototype.l,a.prototype.toNumber=a.prototype.m,a.prototype.toString=a.prototype.toString,a.prototype.getBits=a.prototype.i,a.fromNumber=d,a.fromString=m,ha=a}).apply(typeof fo<"u"?fo:typeof self<"u"?self:typeof window<"u"?window:{});var Fs=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};/** @license
Copyright The Closure Library Authors.
SPDX-License-Identifier: Apache-2.0
*/var ua,Jt,da,js,lr,fa,ma,pa;(function(){var r,e=typeof Object.defineProperties=="function"?Object.defineProperty:function(o,c,u){return o==Array.prototype||o==Object.prototype||(o[c]=u.value),o};function t(o){o=[typeof globalThis=="object"&&globalThis,o,typeof window=="object"&&window,typeof self=="object"&&self,typeof Fs=="object"&&Fs];for(var c=0;c<o.length;++c){var u=o[c];if(u&&u.Math==Math)return u}throw Error("Cannot find global object")}var s=t(this);function i(o,c){if(c)e:{var u=s;o=o.split(".");for(var f=0;f<o.length-1;f++){var T=o[f];if(!(T in u))break e;u=u[T]}o=o[o.length-1],f=u[o],c=c(f),c!=f&&c!=null&&e(u,o,{configurable:!0,writable:!0,value:c})}}function n(o,c){o instanceof String&&(o+="");var u=0,f=!1,T={next:function(){if(!f&&u<o.length){var I=u++;return{value:c(I,o[I]),done:!1}}return f=!0,{done:!0,value:void 0}}};return T[Symbol.iterator]=function(){return T},T}i("Array.prototype.values",function(o){return o||function(){return n(this,function(c,u){return u})}});/** @license

 Copyright The Closure Library Authors.
 SPDX-License-Identifier: Apache-2.0
*/var a=a||{},l=this||self;function h(o){var c=typeof o;return c=c!="object"?c:o?Array.isArray(o)?"array":c:"null",c=="array"||c=="object"&&typeof o.length=="number"}function d(o){var c=typeof o;return c=="object"&&o!=null||c=="function"}function m(o,c,u){return o.call.apply(o.bind,arguments)}function p(o,c,u){if(!o)throw Error();if(2<arguments.length){var f=Array.prototype.slice.call(arguments,2);return function(){var T=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(T,f),o.apply(c,T)}}return function(){return o.apply(c,arguments)}}function b(o,c,u){return b=Function.prototype.bind&&Function.prototype.bind.toString().indexOf("native code")!=-1?m:p,b.apply(null,arguments)}function A(o,c){var u=Array.prototype.slice.call(arguments,1);return function(){var f=u.slice();return f.push.apply(f,arguments),o.apply(this,f)}}function C(o,c){function u(){}u.prototype=c.prototype,o.aa=c.prototype,o.prototype=new u,o.prototype.constructor=o,o.Qb=function(f,T,I){for(var x=Array(arguments.length-2),j=2;j<arguments.length;j++)x[j-2]=arguments[j];return c.prototype[T].apply(f,x)}}function L(o){const c=o.length;if(0<c){const u=Array(c);for(let f=0;f<c;f++)u[f]=o[f];return u}return[]}function D(o,c){for(let u=1;u<arguments.length;u++){const f=arguments[u];if(h(f)){const T=o.length||0,I=f.length||0;o.length=T+I;for(let x=0;x<I;x++)o[T+x]=f[x]}else o.push(f)}}class F{constructor(c,u){this.i=c,this.j=u,this.h=0,this.g=null}get(){let c;return 0<this.h?(this.h--,c=this.g,this.g=c.next,c.next=null):c=this.i(),c}}function U(o){return/^[\s\xa0]*$/.test(o)}function X(){var o=l.navigator;return o&&(o=o.userAgent)?o:""}function le(o){return le[" "](o),o}le[" "]=function(){};var et=X().indexOf("Gecko")!=-1&&!(X().toLowerCase().indexOf("webkit")!=-1&&X().indexOf("Edge")==-1)&&!(X().indexOf("Trident")!=-1||X().indexOf("MSIE")!=-1)&&X().indexOf("Edge")==-1;function _e(o,c,u){for(const f in o)c.call(u,o[f],f,o)}function E(o,c){for(const u in o)c.call(void 0,o[u],u,o)}function g(o){const c={};for(const u in o)c[u]=o[u];return c}const v="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function _(o,c){let u,f;for(let T=1;T<arguments.length;T++){f=arguments[T];for(u in f)o[u]=f[u];for(let I=0;I<v.length;I++)u=v[I],Object.prototype.hasOwnProperty.call(f,u)&&(o[u]=f[u])}}function w(o){var c=1;o=o.split(":");const u=[];for(;0<c&&o.length;)u.push(o.shift()),c--;return o.length&&u.push(o.join(":")),u}function S(o){l.setTimeout(()=>{throw o},0)}function y(){var o=wi;let c=null;return o.g&&(c=o.g,o.g=o.g.next,o.g||(o.h=null),c.next=null),c}class ke{constructor(){this.h=this.g=null}add(c,u){const f=kt.get();f.set(c,u),this.h?this.h.next=f:this.g=f,this.h=f}}var kt=new F(()=>new Nl,o=>o.reset());class Nl{constructor(){this.next=this.g=this.h=null}set(c,u){this.h=c,this.g=u,this.next=null}reset(){this.next=this.g=this.h=null}}let Vt,Ot=!1,wi=new ke,Qr=()=>{const o=l.Promise.resolve(void 0);Vt=()=>{o.then(Fl)}};var Fl=()=>{for(var o;o=y();){try{o.h.call(o.g)}catch(u){S(u)}var c=kt;c.j(o),100>c.h&&(c.h++,o.next=c.g,c.g=o)}Ot=!1};function ze(){this.s=this.s,this.C=this.C}ze.prototype.s=!1,ze.prototype.ma=function(){this.s||(this.s=!0,this.N())},ze.prototype.N=function(){if(this.C)for(;this.C.length;)this.C.shift()()};function ce(o,c){this.type=o,this.g=this.target=c,this.defaultPrevented=!1}ce.prototype.h=function(){this.defaultPrevented=!0};var $l=function(){if(!l.addEventListener||!Object.defineProperty)return!1;var o=!1,c=Object.defineProperty({},"passive",{get:function(){o=!0}});try{const u=()=>{};l.addEventListener("test",u,c),l.removeEventListener("test",u,c)}catch{}return o}();function Mt(o,c){if(ce.call(this,o?o.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,o){var u=this.type=o.type,f=o.changedTouches&&o.changedTouches.length?o.changedTouches[0]:null;if(this.target=o.target||o.srcElement,this.g=c,c=o.relatedTarget){if(et){e:{try{le(c.nodeName);var T=!0;break e}catch{}T=!1}T||(c=null)}}else u=="mouseover"?c=o.fromElement:u=="mouseout"&&(c=o.toElement);this.relatedTarget=c,f?(this.clientX=f.clientX!==void 0?f.clientX:f.pageX,this.clientY=f.clientY!==void 0?f.clientY:f.pageY,this.screenX=f.screenX||0,this.screenY=f.screenY||0):(this.clientX=o.clientX!==void 0?o.clientX:o.pageX,this.clientY=o.clientY!==void 0?o.clientY:o.pageY,this.screenX=o.screenX||0,this.screenY=o.screenY||0),this.button=o.button,this.key=o.key||"",this.ctrlKey=o.ctrlKey,this.altKey=o.altKey,this.shiftKey=o.shiftKey,this.metaKey=o.metaKey,this.pointerId=o.pointerId||0,this.pointerType=typeof o.pointerType=="string"?o.pointerType:zl[o.pointerType]||"",this.state=o.state,this.i=o,o.defaultPrevented&&Mt.aa.h.call(this)}}C(Mt,ce);var zl={2:"touch",3:"pen",4:"mouse"};Mt.prototype.h=function(){Mt.aa.h.call(this);var o=this.i;o.preventDefault?o.preventDefault():o.returnValue=!1};var _s="closure_listenable_"+(1e6*Math.random()|0),Bl=0;function Ul(o,c,u,f,T){this.listener=o,this.proxy=null,this.src=c,this.type=u,this.capture=!!f,this.ha=T,this.key=++Bl,this.da=this.fa=!1}function ws(o){o.da=!0,o.listener=null,o.proxy=null,o.src=null,o.ha=null}function Es(o){this.src=o,this.g={},this.h=0}Es.prototype.add=function(o,c,u,f,T){var I=o.toString();o=this.g[I],o||(o=this.g[I]=[],this.h++);var x=Ti(o,c,f,T);return-1<x?(c=o[x],u||(c.fa=!1)):(c=new Ul(c,this.src,I,!!f,T),c.fa=u,o.push(c)),c};function Ei(o,c){var u=c.type;if(u in o.g){var f=o.g[u],T=Array.prototype.indexOf.call(f,c,void 0),I;(I=0<=T)&&Array.prototype.splice.call(f,T,1),I&&(ws(c),o.g[u].length==0&&(delete o.g[u],o.h--))}}function Ti(o,c,u,f){for(var T=0;T<o.length;++T){var I=o[T];if(!I.da&&I.listener==c&&I.capture==!!u&&I.ha==f)return T}return-1}var bi="closure_lm_"+(1e6*Math.random()|0),Si={};function Jr(o,c,u,f,T){if(Array.isArray(c)){for(var I=0;I<c.length;I++)Jr(o,c[I],u,f,T);return null}return u=tn(u),o&&o[_s]?o.K(c,u,d(f)?!!f.capture:!1,T):jl(o,c,u,!1,f,T)}function jl(o,c,u,f,T,I){if(!c)throw Error("Invalid event type");var x=d(T)?!!T.capture:!!T,j=Ii(o);if(j||(o[bi]=j=new Es(o)),u=j.add(c,u,f,x,I),u.proxy)return u;if(f=Gl(),u.proxy=f,f.src=o,f.listener=u,o.addEventListener)$l||(T=x),T===void 0&&(T=!1),o.addEventListener(c.toString(),f,T);else if(o.attachEvent)o.attachEvent(en(c.toString()),f);else if(o.addListener&&o.removeListener)o.addListener(f);else throw Error("addEventListener and attachEvent are unavailable.");return u}function Gl(){function o(u){return c.call(o.src,o.listener,u)}const c=ql;return o}function Zr(o,c,u,f,T){if(Array.isArray(c))for(var I=0;I<c.length;I++)Zr(o,c[I],u,f,T);else f=d(f)?!!f.capture:!!f,u=tn(u),o&&o[_s]?(o=o.i,c=String(c).toString(),c in o.g&&(I=o.g[c],u=Ti(I,u,f,T),-1<u&&(ws(I[u]),Array.prototype.splice.call(I,u,1),I.length==0&&(delete o.g[c],o.h--)))):o&&(o=Ii(o))&&(c=o.g[c.toString()],o=-1,c&&(o=Ti(c,u,f,T)),(u=-1<o?c[o]:null)&&Ai(u))}function Ai(o){if(typeof o!="number"&&o&&!o.da){var c=o.src;if(c&&c[_s])Ei(c.i,o);else{var u=o.type,f=o.proxy;c.removeEventListener?c.removeEventListener(u,f,o.capture):c.detachEvent?c.detachEvent(en(u),f):c.addListener&&c.removeListener&&c.removeListener(f),(u=Ii(c))?(Ei(u,o),u.h==0&&(u.src=null,c[bi]=null)):ws(o)}}}function en(o){return o in Si?Si[o]:Si[o]="on"+o}function ql(o,c){if(o.da)o=!0;else{c=new Mt(c,this);var u=o.listener,f=o.ha||o.src;o.fa&&Ai(o),o=u.call(f,c)}return o}function Ii(o){return o=o[bi],o instanceof Es?o:null}var Ci="__closure_events_fn_"+(1e9*Math.random()>>>0);function tn(o){return typeof o=="function"?o:(o[Ci]||(o[Ci]=function(c){return o.handleEvent(c)}),o[Ci])}function he(){ze.call(this),this.i=new Es(this),this.M=this,this.F=null}C(he,ze),he.prototype[_s]=!0,he.prototype.removeEventListener=function(o,c,u,f){Zr(this,o,c,u,f)};function ye(o,c){var u,f=o.F;if(f)for(u=[];f;f=f.F)u.push(f);if(o=o.M,f=c.type||c,typeof c=="string")c=new ce(c,o);else if(c instanceof ce)c.target=c.target||o;else{var T=c;c=new ce(f,o),_(c,T)}if(T=!0,u)for(var I=u.length-1;0<=I;I--){var x=c.g=u[I];T=Ts(x,f,!0,c)&&T}if(x=c.g=o,T=Ts(x,f,!0,c)&&T,T=Ts(x,f,!1,c)&&T,u)for(I=0;I<u.length;I++)x=c.g=u[I],T=Ts(x,f,!1,c)&&T}he.prototype.N=function(){if(he.aa.N.call(this),this.i){var o=this.i,c;for(c in o.g){for(var u=o.g[c],f=0;f<u.length;f++)ws(u[f]);delete o.g[c],o.h--}}this.F=null},he.prototype.K=function(o,c,u,f){return this.i.add(String(o),c,!1,u,f)},he.prototype.L=function(o,c,u,f){return this.i.add(String(o),c,!0,u,f)};function Ts(o,c,u,f){if(c=o.i.g[String(c)],!c)return!0;c=c.concat();for(var T=!0,I=0;I<c.length;++I){var x=c[I];if(x&&!x.da&&x.capture==u){var j=x.listener,re=x.ha||x.src;x.fa&&Ei(o.i,x),T=j.call(re,f)!==!1&&T}}return T&&!f.defaultPrevented}function sn(o,c,u){if(typeof o=="function")u&&(o=b(o,u));else if(o&&typeof o.handleEvent=="function")o=b(o.handleEvent,o);else throw Error("Invalid listener argument");return 2147483647<Number(c)?-1:l.setTimeout(o,c||0)}function rn(o){o.g=sn(()=>{o.g=null,o.i&&(o.i=!1,rn(o))},o.l);const c=o.h;o.h=null,o.m.apply(null,c)}class Hl extends ze{constructor(c,u){super(),this.m=c,this.l=u,this.h=null,this.i=!1,this.g=null}j(c){this.h=arguments,this.g?this.i=!0:rn(this)}N(){super.N(),this.g&&(l.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function Nt(o){ze.call(this),this.h=o,this.g={}}C(Nt,ze);var nn=[];function on(o){_e(o.g,function(c,u){this.g.hasOwnProperty(u)&&Ai(c)},o),o.g={}}Nt.prototype.N=function(){Nt.aa.N.call(this),on(this)},Nt.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var Pi=l.JSON.stringify,Wl=l.JSON.parse,Kl=class{stringify(o){return l.JSON.stringify(o,void 0)}parse(o){return l.JSON.parse(o,void 0)}};function Ri(){}Ri.prototype.h=null;function an(o){return o.h||(o.h=o.i())}function ln(){}var Ft={OPEN:"a",kb:"b",Ja:"c",wb:"d"};function Di(){ce.call(this,"d")}C(Di,ce);function xi(){ce.call(this,"c")}C(xi,ce);var tt={},cn=null;function bs(){return cn=cn||new he}tt.La="serverreachability";function hn(o){ce.call(this,tt.La,o)}C(hn,ce);function $t(o){const c=bs();ye(c,new hn(c))}tt.STAT_EVENT="statevent";function un(o,c){ce.call(this,tt.STAT_EVENT,o),this.stat=c}C(un,ce);function ve(o){const c=bs();ye(c,new un(c,o))}tt.Ma="timingevent";function dn(o,c){ce.call(this,tt.Ma,o),this.size=c}C(dn,ce);function zt(o,c){if(typeof o!="function")throw Error("Fn must not be null and must be a function");return l.setTimeout(function(){o()},c)}function Bt(){this.g=!0}Bt.prototype.xa=function(){this.g=!1};function Yl(o,c,u,f,T,I){o.info(function(){if(o.g)if(I)for(var x="",j=I.split("&"),re=0;re<j.length;re++){var B=j[re].split("=");if(1<B.length){var ue=B[0];B=B[1];var de=ue.split("_");x=2<=de.length&&de[1]=="type"?x+(ue+"="+B+"&"):x+(ue+"=redacted&")}}else x=null;else x=I;return"XMLHTTP REQ ("+f+") [attempt "+T+"]: "+c+`
`+u+`
`+x})}function Xl(o,c,u,f,T,I,x){o.info(function(){return"XMLHTTP RESP ("+f+") [ attempt "+T+"]: "+c+`
`+u+`
`+I+" "+x})}function vt(o,c,u,f){o.info(function(){return"XMLHTTP TEXT ("+c+"): "+Jl(o,u)+(f?" "+f:"")})}function Ql(o,c){o.info(function(){return"TIMEOUT: "+c})}Bt.prototype.info=function(){};function Jl(o,c){if(!o.g)return c;if(!c)return null;try{var u=JSON.parse(c);if(u){for(o=0;o<u.length;o++)if(Array.isArray(u[o])){var f=u[o];if(!(2>f.length)){var T=f[1];if(Array.isArray(T)&&!(1>T.length)){var I=T[0];if(I!="noop"&&I!="stop"&&I!="close")for(var x=1;x<T.length;x++)T[x]=""}}}}return Pi(u)}catch{return c}}var Ss={NO_ERROR:0,gb:1,tb:2,sb:3,nb:4,rb:5,ub:6,Ia:7,TIMEOUT:8,xb:9},fn={lb:"complete",Hb:"success",Ja:"error",Ia:"abort",zb:"ready",Ab:"readystatechange",TIMEOUT:"timeout",vb:"incrementaldata",yb:"progress",ob:"downloadprogress",Pb:"uploadprogress"},Li;function As(){}C(As,Ri),As.prototype.g=function(){return new XMLHttpRequest},As.prototype.i=function(){return{}},Li=new As;function Be(o,c,u,f){this.j=o,this.i=c,this.l=u,this.R=f||1,this.U=new Nt(this),this.I=45e3,this.H=null,this.o=!1,this.m=this.A=this.v=this.L=this.F=this.S=this.B=null,this.D=[],this.g=null,this.C=0,this.s=this.u=null,this.X=-1,this.J=!1,this.O=0,this.M=null,this.W=this.K=this.T=this.P=!1,this.h=new mn}function mn(){this.i=null,this.g="",this.h=!1}var pn={},ki={};function Vi(o,c,u){o.L=1,o.v=Rs(Ve(c)),o.m=u,o.P=!0,gn(o,null)}function gn(o,c){o.F=Date.now(),Is(o),o.A=Ve(o.v);var u=o.A,f=o.R;Array.isArray(f)||(f=[String(f)]),Dn(u.i,"t",f),o.C=0,u=o.j.J,o.h=new mn,o.g=Kn(o.j,u?c:null,!o.m),0<o.O&&(o.M=new Hl(b(o.Y,o,o.g),o.O)),c=o.U,u=o.g,f=o.ca;var T="readystatechange";Array.isArray(T)||(T&&(nn[0]=T.toString()),T=nn);for(var I=0;I<T.length;I++){var x=Jr(u,T[I],f||c.handleEvent,!1,c.h||c);if(!x)break;c.g[x.key]=x}c=o.H?g(o.H):{},o.m?(o.u||(o.u="POST"),c["Content-Type"]="application/x-www-form-urlencoded",o.g.ea(o.A,o.u,o.m,c)):(o.u="GET",o.g.ea(o.A,o.u,null,c)),$t(),Yl(o.i,o.u,o.A,o.l,o.R,o.m)}Be.prototype.ca=function(o){o=o.target;const c=this.M;c&&Oe(o)==3?c.j():this.Y(o)},Be.prototype.Y=function(o){try{if(o==this.g)e:{const de=Oe(this.g);var c=this.g.Ba();const Et=this.g.Z();if(!(3>de)&&(de!=3||this.g&&(this.h.h||this.g.oa()||Nn(this.g)))){this.J||de!=4||c==7||(c==8||0>=Et?$t(3):$t(2)),Oi(this);var u=this.g.Z();this.X=u;t:if(yn(this)){var f=Nn(this.g);o="";var T=f.length,I=Oe(this.g)==4;if(!this.h.i){if(typeof TextDecoder>"u"){st(this),Ut(this);var x="";break t}this.h.i=new l.TextDecoder}for(c=0;c<T;c++)this.h.h=!0,o+=this.h.i.decode(f[c],{stream:!(I&&c==T-1)});f.length=0,this.h.g+=o,this.C=0,x=this.h.g}else x=this.g.oa();if(this.o=u==200,Xl(this.i,this.u,this.A,this.l,this.R,de,u),this.o){if(this.T&&!this.K){t:{if(this.g){var j,re=this.g;if((j=re.g?re.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!U(j)){var B=j;break t}}B=null}if(u=B)vt(this.i,this.l,u,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,Mi(this,u);else{this.o=!1,this.s=3,ve(12),st(this),Ut(this);break e}}if(this.P){u=!0;let Ae;for(;!this.J&&this.C<x.length;)if(Ae=Zl(this,x),Ae==ki){de==4&&(this.s=4,ve(14),u=!1),vt(this.i,this.l,null,"[Incomplete Response]");break}else if(Ae==pn){this.s=4,ve(15),vt(this.i,this.l,x,"[Invalid Chunk]"),u=!1;break}else vt(this.i,this.l,Ae,null),Mi(this,Ae);if(yn(this)&&this.C!=0&&(this.h.g=this.h.g.slice(this.C),this.C=0),de!=4||x.length!=0||this.h.h||(this.s=1,ve(16),u=!1),this.o=this.o&&u,!u)vt(this.i,this.l,x,"[Invalid Chunked Response]"),st(this),Ut(this);else if(0<x.length&&!this.W){this.W=!0;var ue=this.j;ue.g==this&&ue.ba&&!ue.M&&(ue.j.info("Great, no buffering proxy detected. Bytes received: "+x.length),Ui(ue),ue.M=!0,ve(11))}}else vt(this.i,this.l,x,null),Mi(this,x);de==4&&st(this),this.o&&!this.J&&(de==4?Gn(this.j,this):(this.o=!1,Is(this)))}else gc(this.g),u==400&&0<x.indexOf("Unknown SID")?(this.s=3,ve(12)):(this.s=0,ve(13)),st(this),Ut(this)}}}catch{}finally{}};function yn(o){return o.g?o.u=="GET"&&o.L!=2&&o.j.Ca:!1}function Zl(o,c){var u=o.C,f=c.indexOf(`
`,u);return f==-1?ki:(u=Number(c.substring(u,f)),isNaN(u)?pn:(f+=1,f+u>c.length?ki:(c=c.slice(f,f+u),o.C=f+u,c)))}Be.prototype.cancel=function(){this.J=!0,st(this)};function Is(o){o.S=Date.now()+o.I,vn(o,o.I)}function vn(o,c){if(o.B!=null)throw Error("WatchDog timer not null");o.B=zt(b(o.ba,o),c)}function Oi(o){o.B&&(l.clearTimeout(o.B),o.B=null)}Be.prototype.ba=function(){this.B=null;const o=Date.now();0<=o-this.S?(Ql(this.i,this.A),this.L!=2&&($t(),ve(17)),st(this),this.s=2,Ut(this)):vn(this,this.S-o)};function Ut(o){o.j.G==0||o.J||Gn(o.j,o)}function st(o){Oi(o);var c=o.M;c&&typeof c.ma=="function"&&c.ma(),o.M=null,on(o.U),o.g&&(c=o.g,o.g=null,c.abort(),c.ma())}function Mi(o,c){try{var u=o.j;if(u.G!=0&&(u.g==o||Ni(u.h,o))){if(!o.K&&Ni(u.h,o)&&u.G==3){try{var f=u.Da.g.parse(c)}catch{f=null}if(Array.isArray(f)&&f.length==3){var T=f;if(T[0]==0){e:if(!u.u){if(u.g)if(u.g.F+3e3<o.F)Os(u),ks(u);else break e;Bi(u),ve(18)}}else u.za=T[1],0<u.za-u.T&&37500>T[2]&&u.F&&u.v==0&&!u.C&&(u.C=zt(b(u.Za,u),6e3));if(1>=En(u.h)&&u.ca){try{u.ca()}catch{}u.ca=void 0}}else rt(u,11)}else if((o.K||u.g==o)&&Os(u),!U(c))for(T=u.Da.g.parse(c),c=0;c<T.length;c++){let B=T[c];if(u.T=B[0],B=B[1],u.G==2)if(B[0]=="c"){u.K=B[1],u.ia=B[2];const ue=B[3];ue!=null&&(u.la=ue,u.j.info("VER="+u.la));const de=B[4];de!=null&&(u.Aa=de,u.j.info("SVER="+u.Aa));const Et=B[5];Et!=null&&typeof Et=="number"&&0<Et&&(f=1.5*Et,u.L=f,u.j.info("backChannelRequestTimeoutMs_="+f)),f=u;const Ae=o.g;if(Ae){const Ns=Ae.g?Ae.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(Ns){var I=f.h;I.g||Ns.indexOf("spdy")==-1&&Ns.indexOf("quic")==-1&&Ns.indexOf("h2")==-1||(I.j=I.l,I.g=new Set,I.h&&(Fi(I,I.h),I.h=null))}if(f.D){const ji=Ae.g?Ae.g.getResponseHeader("X-HTTP-Session-Id"):null;ji&&(f.ya=ji,H(f.I,f.D,ji))}}u.G=3,u.l&&u.l.ua(),u.ba&&(u.R=Date.now()-o.F,u.j.info("Handshake RTT: "+u.R+"ms")),f=u;var x=o;if(f.qa=Wn(f,f.J?f.ia:null,f.W),x.K){Tn(f.h,x);var j=x,re=f.L;re&&(j.I=re),j.B&&(Oi(j),Is(j)),f.g=x}else Un(f);0<u.i.length&&Vs(u)}else B[0]!="stop"&&B[0]!="close"||rt(u,7);else u.G==3&&(B[0]=="stop"||B[0]=="close"?B[0]=="stop"?rt(u,7):zi(u):B[0]!="noop"&&u.l&&u.l.ta(B),u.v=0)}}$t(4)}catch{}}var ec=class{constructor(o,c){this.g=o,this.map=c}};function _n(o){this.l=o||10,l.PerformanceNavigationTiming?(o=l.performance.getEntriesByType("navigation"),o=0<o.length&&(o[0].nextHopProtocol=="hq"||o[0].nextHopProtocol=="h2")):o=!!(l.chrome&&l.chrome.loadTimes&&l.chrome.loadTimes()&&l.chrome.loadTimes().wasFetchedViaSpdy),this.j=o?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function wn(o){return o.h?!0:o.g?o.g.size>=o.j:!1}function En(o){return o.h?1:o.g?o.g.size:0}function Ni(o,c){return o.h?o.h==c:o.g?o.g.has(c):!1}function Fi(o,c){o.g?o.g.add(c):o.h=c}function Tn(o,c){o.h&&o.h==c?o.h=null:o.g&&o.g.has(c)&&o.g.delete(c)}_n.prototype.cancel=function(){if(this.i=bn(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&this.g.size!==0){for(const o of this.g.values())o.cancel();this.g.clear()}};function bn(o){if(o.h!=null)return o.i.concat(o.h.D);if(o.g!=null&&o.g.size!==0){let c=o.i;for(const u of o.g.values())c=c.concat(u.D);return c}return L(o.i)}function tc(o){if(o.V&&typeof o.V=="function")return o.V();if(typeof Map<"u"&&o instanceof Map||typeof Set<"u"&&o instanceof Set)return Array.from(o.values());if(typeof o=="string")return o.split("");if(h(o)){for(var c=[],u=o.length,f=0;f<u;f++)c.push(o[f]);return c}c=[],u=0;for(f in o)c[u++]=o[f];return c}function sc(o){if(o.na&&typeof o.na=="function")return o.na();if(!o.V||typeof o.V!="function"){if(typeof Map<"u"&&o instanceof Map)return Array.from(o.keys());if(!(typeof Set<"u"&&o instanceof Set)){if(h(o)||typeof o=="string"){var c=[];o=o.length;for(var u=0;u<o;u++)c.push(u);return c}c=[],u=0;for(const f in o)c[u++]=f;return c}}}function Sn(o,c){if(o.forEach&&typeof o.forEach=="function")o.forEach(c,void 0);else if(h(o)||typeof o=="string")Array.prototype.forEach.call(o,c,void 0);else for(var u=sc(o),f=tc(o),T=f.length,I=0;I<T;I++)c.call(void 0,f[I],u&&u[I],o)}var An=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function ic(o,c){if(o){o=o.split("&");for(var u=0;u<o.length;u++){var f=o[u].indexOf("="),T=null;if(0<=f){var I=o[u].substring(0,f);T=o[u].substring(f+1)}else I=o[u];c(I,T?decodeURIComponent(T.replace(/\+/g," ")):"")}}}function it(o){if(this.g=this.o=this.j="",this.s=null,this.m=this.l="",this.h=!1,o instanceof it){this.h=o.h,Cs(this,o.j),this.o=o.o,this.g=o.g,Ps(this,o.s),this.l=o.l;var c=o.i,u=new qt;u.i=c.i,c.g&&(u.g=new Map(c.g),u.h=c.h),In(this,u),this.m=o.m}else o&&(c=String(o).match(An))?(this.h=!1,Cs(this,c[1]||"",!0),this.o=jt(c[2]||""),this.g=jt(c[3]||"",!0),Ps(this,c[4]),this.l=jt(c[5]||"",!0),In(this,c[6]||"",!0),this.m=jt(c[7]||"")):(this.h=!1,this.i=new qt(null,this.h))}it.prototype.toString=function(){var o=[],c=this.j;c&&o.push(Gt(c,Cn,!0),":");var u=this.g;return(u||c=="file")&&(o.push("//"),(c=this.o)&&o.push(Gt(c,Cn,!0),"@"),o.push(encodeURIComponent(String(u)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),u=this.s,u!=null&&o.push(":",String(u))),(u=this.l)&&(this.g&&u.charAt(0)!="/"&&o.push("/"),o.push(Gt(u,u.charAt(0)=="/"?oc:nc,!0))),(u=this.i.toString())&&o.push("?",u),(u=this.m)&&o.push("#",Gt(u,lc)),o.join("")};function Ve(o){return new it(o)}function Cs(o,c,u){o.j=u?jt(c,!0):c,o.j&&(o.j=o.j.replace(/:$/,""))}function Ps(o,c){if(c){if(c=Number(c),isNaN(c)||0>c)throw Error("Bad port number "+c);o.s=c}else o.s=null}function In(o,c,u){c instanceof qt?(o.i=c,cc(o.i,o.h)):(u||(c=Gt(c,ac)),o.i=new qt(c,o.h))}function H(o,c,u){o.i.set(c,u)}function Rs(o){return H(o,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),o}function jt(o,c){return o?c?decodeURI(o.replace(/%25/g,"%2525")):decodeURIComponent(o):""}function Gt(o,c,u){return typeof o=="string"?(o=encodeURI(o).replace(c,rc),u&&(o=o.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),o):null}function rc(o){return o=o.charCodeAt(0),"%"+(o>>4&15).toString(16)+(o&15).toString(16)}var Cn=/[#\/\?@]/g,nc=/[#\?:]/g,oc=/[#\?]/g,ac=/[#\?@]/g,lc=/#/g;function qt(o,c){this.h=this.g=null,this.i=o||null,this.j=!!c}function Ue(o){o.g||(o.g=new Map,o.h=0,o.i&&ic(o.i,function(c,u){o.add(decodeURIComponent(c.replace(/\+/g," ")),u)}))}r=qt.prototype,r.add=function(o,c){Ue(this),this.i=null,o=_t(this,o);var u=this.g.get(o);return u||this.g.set(o,u=[]),u.push(c),this.h+=1,this};function Pn(o,c){Ue(o),c=_t(o,c),o.g.has(c)&&(o.i=null,o.h-=o.g.get(c).length,o.g.delete(c))}function Rn(o,c){return Ue(o),c=_t(o,c),o.g.has(c)}r.forEach=function(o,c){Ue(this),this.g.forEach(function(u,f){u.forEach(function(T){o.call(c,T,f,this)},this)},this)},r.na=function(){Ue(this);const o=Array.from(this.g.values()),c=Array.from(this.g.keys()),u=[];for(let f=0;f<c.length;f++){const T=o[f];for(let I=0;I<T.length;I++)u.push(c[f])}return u},r.V=function(o){Ue(this);let c=[];if(typeof o=="string")Rn(this,o)&&(c=c.concat(this.g.get(_t(this,o))));else{o=Array.from(this.g.values());for(let u=0;u<o.length;u++)c=c.concat(o[u])}return c},r.set=function(o,c){return Ue(this),this.i=null,o=_t(this,o),Rn(this,o)&&(this.h-=this.g.get(o).length),this.g.set(o,[c]),this.h+=1,this},r.get=function(o,c){return o?(o=this.V(o),0<o.length?String(o[0]):c):c};function Dn(o,c,u){Pn(o,c),0<u.length&&(o.i=null,o.g.set(_t(o,c),L(u)),o.h+=u.length)}r.toString=function(){if(this.i)return this.i;if(!this.g)return"";const o=[],c=Array.from(this.g.keys());for(var u=0;u<c.length;u++){var f=c[u];const I=encodeURIComponent(String(f)),x=this.V(f);for(f=0;f<x.length;f++){var T=I;x[f]!==""&&(T+="="+encodeURIComponent(String(x[f]))),o.push(T)}}return this.i=o.join("&")};function _t(o,c){return c=String(c),o.j&&(c=c.toLowerCase()),c}function cc(o,c){c&&!o.j&&(Ue(o),o.i=null,o.g.forEach(function(u,f){var T=f.toLowerCase();f!=T&&(Pn(this,f),Dn(this,T,u))},o)),o.j=c}function hc(o,c){const u=new Bt;if(l.Image){const f=new Image;f.onload=A(je,u,"TestLoadImage: loaded",!0,c,f),f.onerror=A(je,u,"TestLoadImage: error",!1,c,f),f.onabort=A(je,u,"TestLoadImage: abort",!1,c,f),f.ontimeout=A(je,u,"TestLoadImage: timeout",!1,c,f),l.setTimeout(function(){f.ontimeout&&f.ontimeout()},1e4),f.src=o}else c(!1)}function uc(o,c){const u=new Bt,f=new AbortController,T=setTimeout(()=>{f.abort(),je(u,"TestPingServer: timeout",!1,c)},1e4);fetch(o,{signal:f.signal}).then(I=>{clearTimeout(T),I.ok?je(u,"TestPingServer: ok",!0,c):je(u,"TestPingServer: server error",!1,c)}).catch(()=>{clearTimeout(T),je(u,"TestPingServer: error",!1,c)})}function je(o,c,u,f,T){try{T&&(T.onload=null,T.onerror=null,T.onabort=null,T.ontimeout=null),f(u)}catch{}}function dc(){this.g=new Kl}function fc(o,c,u){const f=u||"";try{Sn(o,function(T,I){let x=T;d(T)&&(x=Pi(T)),c.push(f+I+"="+encodeURIComponent(x))})}catch(T){throw c.push(f+"type="+encodeURIComponent("_badmap")),T}}function Ds(o){this.l=o.Ub||null,this.j=o.eb||!1}C(Ds,Ri),Ds.prototype.g=function(){return new xs(this.l,this.j)},Ds.prototype.i=function(o){return function(){return o}}({});function xs(o,c){he.call(this),this.D=o,this.o=c,this.m=void 0,this.status=this.readyState=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.u=new Headers,this.h=null,this.B="GET",this.A="",this.g=!1,this.v=this.j=this.l=null}C(xs,he),r=xs.prototype,r.open=function(o,c){if(this.readyState!=0)throw this.abort(),Error("Error reopening a connection");this.B=o,this.A=c,this.readyState=1,Wt(this)},r.send=function(o){if(this.readyState!=1)throw this.abort(),Error("need to call open() first. ");this.g=!0;const c={headers:this.u,method:this.B,credentials:this.m,cache:void 0};o&&(c.body=o),(this.D||l).fetch(new Request(this.A,c)).then(this.Sa.bind(this),this.ga.bind(this))},r.abort=function(){this.response=this.responseText="",this.u=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&this.readyState!=4&&(this.g=!1,Ht(this)),this.readyState=0},r.Sa=function(o){if(this.g&&(this.l=o,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=o.headers,this.readyState=2,Wt(this)),this.g&&(this.readyState=3,Wt(this),this.g)))if(this.responseType==="arraybuffer")o.arrayBuffer().then(this.Qa.bind(this),this.ga.bind(this));else if(typeof l.ReadableStream<"u"&&"body"in o){if(this.j=o.body.getReader(),this.o){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.v=new TextDecoder;xn(this)}else o.text().then(this.Ra.bind(this),this.ga.bind(this))};function xn(o){o.j.read().then(o.Pa.bind(o)).catch(o.ga.bind(o))}r.Pa=function(o){if(this.g){if(this.o&&o.value)this.response.push(o.value);else if(!this.o){var c=o.value?o.value:new Uint8Array(0);(c=this.v.decode(c,{stream:!o.done}))&&(this.response=this.responseText+=c)}o.done?Ht(this):Wt(this),this.readyState==3&&xn(this)}},r.Ra=function(o){this.g&&(this.response=this.responseText=o,Ht(this))},r.Qa=function(o){this.g&&(this.response=o,Ht(this))},r.ga=function(){this.g&&Ht(this)};function Ht(o){o.readyState=4,o.l=null,o.j=null,o.v=null,Wt(o)}r.setRequestHeader=function(o,c){this.u.append(o,c)},r.getResponseHeader=function(o){return this.h&&this.h.get(o.toLowerCase())||""},r.getAllResponseHeaders=function(){if(!this.h)return"";const o=[],c=this.h.entries();for(var u=c.next();!u.done;)u=u.value,o.push(u[0]+": "+u[1]),u=c.next();return o.join(`\r
`)};function Wt(o){o.onreadystatechange&&o.onreadystatechange.call(o)}Object.defineProperty(xs.prototype,"withCredentials",{get:function(){return this.m==="include"},set:function(o){this.m=o?"include":"same-origin"}});function Ln(o){let c="";return _e(o,function(u,f){c+=f,c+=":",c+=u,c+=`\r
`}),c}function $i(o,c,u){e:{for(f in u){var f=!1;break e}f=!0}f||(u=Ln(u),typeof o=="string"?u!=null&&encodeURIComponent(String(u)):H(o,c,u))}function K(o){he.call(this),this.headers=new Map,this.o=o||null,this.h=!1,this.v=this.g=null,this.D="",this.m=0,this.l="",this.j=this.B=this.u=this.A=!1,this.I=null,this.H="",this.J=!1}C(K,he);var mc=/^https?$/i,pc=["POST","PUT"];r=K.prototype,r.Ha=function(o){this.J=o},r.ea=function(o,c,u,f){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.D+"; newUri="+o);c=c?c.toUpperCase():"GET",this.D=o,this.l="",this.m=0,this.A=!1,this.h=!0,this.g=this.o?this.o.g():Li.g(),this.v=this.o?an(this.o):an(Li),this.g.onreadystatechange=b(this.Ea,this);try{this.B=!0,this.g.open(c,String(o),!0),this.B=!1}catch(I){kn(this,I);return}if(o=u||"",u=new Map(this.headers),f)if(Object.getPrototypeOf(f)===Object.prototype)for(var T in f)u.set(T,f[T]);else if(typeof f.keys=="function"&&typeof f.get=="function")for(const I of f.keys())u.set(I,f.get(I));else throw Error("Unknown input type for opt_headers: "+String(f));f=Array.from(u.keys()).find(I=>I.toLowerCase()=="content-type"),T=l.FormData&&o instanceof l.FormData,!(0<=Array.prototype.indexOf.call(pc,c,void 0))||f||T||u.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[I,x]of u)this.g.setRequestHeader(I,x);this.H&&(this.g.responseType=this.H),"withCredentials"in this.g&&this.g.withCredentials!==this.J&&(this.g.withCredentials=this.J);try{Mn(this),this.u=!0,this.g.send(o),this.u=!1}catch(I){kn(this,I)}};function kn(o,c){o.h=!1,o.g&&(o.j=!0,o.g.abort(),o.j=!1),o.l=c,o.m=5,Vn(o),Ls(o)}function Vn(o){o.A||(o.A=!0,ye(o,"complete"),ye(o,"error"))}r.abort=function(o){this.g&&this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1,this.m=o||7,ye(this,"complete"),ye(this,"abort"),Ls(this))},r.N=function(){this.g&&(this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1),Ls(this,!0)),K.aa.N.call(this)},r.Ea=function(){this.s||(this.B||this.u||this.j?On(this):this.bb())},r.bb=function(){On(this)};function On(o){if(o.h&&typeof a<"u"&&(!o.v[1]||Oe(o)!=4||o.Z()!=2)){if(o.u&&Oe(o)==4)sn(o.Ea,0,o);else if(ye(o,"readystatechange"),Oe(o)==4){o.h=!1;try{const x=o.Z();e:switch(x){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var c=!0;break e;default:c=!1}var u;if(!(u=c)){var f;if(f=x===0){var T=String(o.D).match(An)[1]||null;!T&&l.self&&l.self.location&&(T=l.self.location.protocol.slice(0,-1)),f=!mc.test(T?T.toLowerCase():"")}u=f}if(u)ye(o,"complete"),ye(o,"success");else{o.m=6;try{var I=2<Oe(o)?o.g.statusText:""}catch{I=""}o.l=I+" ["+o.Z()+"]",Vn(o)}}finally{Ls(o)}}}}function Ls(o,c){if(o.g){Mn(o);const u=o.g,f=o.v[0]?()=>{}:null;o.g=null,o.v=null,c||ye(o,"ready");try{u.onreadystatechange=f}catch{}}}function Mn(o){o.I&&(l.clearTimeout(o.I),o.I=null)}r.isActive=function(){return!!this.g};function Oe(o){return o.g?o.g.readyState:0}r.Z=function(){try{return 2<Oe(this)?this.g.status:-1}catch{return-1}},r.oa=function(){try{return this.g?this.g.responseText:""}catch{return""}},r.Oa=function(o){if(this.g){var c=this.g.responseText;return o&&c.indexOf(o)==0&&(c=c.substring(o.length)),Wl(c)}};function Nn(o){try{if(!o.g)return null;if("response"in o.g)return o.g.response;switch(o.H){case"":case"text":return o.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in o.g)return o.g.mozResponseArrayBuffer}return null}catch{return null}}function gc(o){const c={};o=(o.g&&2<=Oe(o)&&o.g.getAllResponseHeaders()||"").split(`\r
`);for(let f=0;f<o.length;f++){if(U(o[f]))continue;var u=w(o[f]);const T=u[0];if(u=u[1],typeof u!="string")continue;u=u.trim();const I=c[T]||[];c[T]=I,I.push(u)}E(c,function(f){return f.join(", ")})}r.Ba=function(){return this.m},r.Ka=function(){return typeof this.l=="string"?this.l:String(this.l)};function Kt(o,c,u){return u&&u.internalChannelParams&&u.internalChannelParams[o]||c}function Fn(o){this.Aa=0,this.i=[],this.j=new Bt,this.ia=this.qa=this.I=this.W=this.g=this.ya=this.D=this.H=this.m=this.S=this.o=null,this.Ya=this.U=0,this.Va=Kt("failFast",!1,o),this.F=this.C=this.u=this.s=this.l=null,this.X=!0,this.za=this.T=-1,this.Y=this.v=this.B=0,this.Ta=Kt("baseRetryDelayMs",5e3,o),this.cb=Kt("retryDelaySeedMs",1e4,o),this.Wa=Kt("forwardChannelMaxRetries",2,o),this.wa=Kt("forwardChannelRequestTimeoutMs",2e4,o),this.pa=o&&o.xmlHttpFactory||void 0,this.Xa=o&&o.Tb||void 0,this.Ca=o&&o.useFetchStreams||!1,this.L=void 0,this.J=o&&o.supportsCrossDomainXhr||!1,this.K="",this.h=new _n(o&&o.concurrentRequestLimit),this.Da=new dc,this.P=o&&o.fastHandshake||!1,this.O=o&&o.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.Ua=o&&o.Rb||!1,o&&o.xa&&this.j.xa(),o&&o.forceLongPolling&&(this.X=!1),this.ba=!this.P&&this.X&&o&&o.detectBufferingProxy||!1,this.ja=void 0,o&&o.longPollingTimeout&&0<o.longPollingTimeout&&(this.ja=o.longPollingTimeout),this.ca=void 0,this.R=0,this.M=!1,this.ka=this.A=null}r=Fn.prototype,r.la=8,r.G=1,r.connect=function(o,c,u,f){ve(0),this.W=o,this.H=c||{},u&&f!==void 0&&(this.H.OSID=u,this.H.OAID=f),this.F=this.X,this.I=Wn(this,null,this.W),Vs(this)};function zi(o){if($n(o),o.G==3){var c=o.U++,u=Ve(o.I);if(H(u,"SID",o.K),H(u,"RID",c),H(u,"TYPE","terminate"),Yt(o,u),c=new Be(o,o.j,c),c.L=2,c.v=Rs(Ve(u)),u=!1,l.navigator&&l.navigator.sendBeacon)try{u=l.navigator.sendBeacon(c.v.toString(),"")}catch{}!u&&l.Image&&(new Image().src=c.v,u=!0),u||(c.g=Kn(c.j,null),c.g.ea(c.v)),c.F=Date.now(),Is(c)}Hn(o)}function ks(o){o.g&&(Ui(o),o.g.cancel(),o.g=null)}function $n(o){ks(o),o.u&&(l.clearTimeout(o.u),o.u=null),Os(o),o.h.cancel(),o.s&&(typeof o.s=="number"&&l.clearTimeout(o.s),o.s=null)}function Vs(o){if(!wn(o.h)&&!o.s){o.s=!0;var c=o.Ga;Vt||Qr(),Ot||(Vt(),Ot=!0),wi.add(c,o),o.B=0}}function yc(o,c){return En(o.h)>=o.h.j-(o.s?1:0)?!1:o.s?(o.i=c.D.concat(o.i),!0):o.G==1||o.G==2||o.B>=(o.Va?0:o.Wa)?!1:(o.s=zt(b(o.Ga,o,c),qn(o,o.B)),o.B++,!0)}r.Ga=function(o){if(this.s)if(this.s=null,this.G==1){if(!o){this.U=Math.floor(1e5*Math.random()),o=this.U++;const T=new Be(this,this.j,o);let I=this.o;if(this.S&&(I?(I=g(I),_(I,this.S)):I=this.S),this.m!==null||this.O||(T.H=I,I=null),this.P)e:{for(var c=0,u=0;u<this.i.length;u++){t:{var f=this.i[u];if("__data__"in f.map&&(f=f.map.__data__,typeof f=="string")){f=f.length;break t}f=void 0}if(f===void 0)break;if(c+=f,4096<c){c=u;break e}if(c===4096||u===this.i.length-1){c=u+1;break e}}c=1e3}else c=1e3;c=Bn(this,T,c),u=Ve(this.I),H(u,"RID",o),H(u,"CVER",22),this.D&&H(u,"X-HTTP-Session-Id",this.D),Yt(this,u),I&&(this.O?c="headers="+encodeURIComponent(String(Ln(I)))+"&"+c:this.m&&$i(u,this.m,I)),Fi(this.h,T),this.Ua&&H(u,"TYPE","init"),this.P?(H(u,"$req",c),H(u,"SID","null"),T.T=!0,Vi(T,u,null)):Vi(T,u,c),this.G=2}}else this.G==3&&(o?zn(this,o):this.i.length==0||wn(this.h)||zn(this))};function zn(o,c){var u;c?u=c.l:u=o.U++;const f=Ve(o.I);H(f,"SID",o.K),H(f,"RID",u),H(f,"AID",o.T),Yt(o,f),o.m&&o.o&&$i(f,o.m,o.o),u=new Be(o,o.j,u,o.B+1),o.m===null&&(u.H=o.o),c&&(o.i=c.D.concat(o.i)),c=Bn(o,u,1e3),u.I=Math.round(.5*o.wa)+Math.round(.5*o.wa*Math.random()),Fi(o.h,u),Vi(u,f,c)}function Yt(o,c){o.H&&_e(o.H,function(u,f){H(c,f,u)}),o.l&&Sn({},function(u,f){H(c,f,u)})}function Bn(o,c,u){u=Math.min(o.i.length,u);var f=o.l?b(o.l.Na,o.l,o):null;e:{var T=o.i;let I=-1;for(;;){const x=["count="+u];I==-1?0<u?(I=T[0].g,x.push("ofs="+I)):I=0:x.push("ofs="+I);let j=!0;for(let re=0;re<u;re++){let B=T[re].g;const ue=T[re].map;if(B-=I,0>B)I=Math.max(0,T[re].g-100),j=!1;else try{fc(ue,x,"req"+B+"_")}catch{f&&f(ue)}}if(j){f=x.join("&");break e}}}return o=o.i.splice(0,u),c.D=o,f}function Un(o){if(!o.g&&!o.u){o.Y=1;var c=o.Fa;Vt||Qr(),Ot||(Vt(),Ot=!0),wi.add(c,o),o.v=0}}function Bi(o){return o.g||o.u||3<=o.v?!1:(o.Y++,o.u=zt(b(o.Fa,o),qn(o,o.v)),o.v++,!0)}r.Fa=function(){if(this.u=null,jn(this),this.ba&&!(this.M||this.g==null||0>=this.R)){var o=2*this.R;this.j.info("BP detection timer enabled: "+o),this.A=zt(b(this.ab,this),o)}},r.ab=function(){this.A&&(this.A=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.F=!1,this.M=!0,ve(10),ks(this),jn(this))};function Ui(o){o.A!=null&&(l.clearTimeout(o.A),o.A=null)}function jn(o){o.g=new Be(o,o.j,"rpc",o.Y),o.m===null&&(o.g.H=o.o),o.g.O=0;var c=Ve(o.qa);H(c,"RID","rpc"),H(c,"SID",o.K),H(c,"AID",o.T),H(c,"CI",o.F?"0":"1"),!o.F&&o.ja&&H(c,"TO",o.ja),H(c,"TYPE","xmlhttp"),Yt(o,c),o.m&&o.o&&$i(c,o.m,o.o),o.L&&(o.g.I=o.L);var u=o.g;o=o.ia,u.L=1,u.v=Rs(Ve(c)),u.m=null,u.P=!0,gn(u,o)}r.Za=function(){this.C!=null&&(this.C=null,ks(this),Bi(this),ve(19))};function Os(o){o.C!=null&&(l.clearTimeout(o.C),o.C=null)}function Gn(o,c){var u=null;if(o.g==c){Os(o),Ui(o),o.g=null;var f=2}else if(Ni(o.h,c))u=c.D,Tn(o.h,c),f=1;else return;if(o.G!=0){if(c.o)if(f==1){u=c.m?c.m.length:0,c=Date.now()-c.F;var T=o.B;f=bs(),ye(f,new dn(f,u)),Vs(o)}else Un(o);else if(T=c.s,T==3||T==0&&0<c.X||!(f==1&&yc(o,c)||f==2&&Bi(o)))switch(u&&0<u.length&&(c=o.h,c.i=c.i.concat(u)),T){case 1:rt(o,5);break;case 4:rt(o,10);break;case 3:rt(o,6);break;default:rt(o,2)}}}function qn(o,c){let u=o.Ta+Math.floor(Math.random()*o.cb);return o.isActive()||(u*=2),u*c}function rt(o,c){if(o.j.info("Error code "+c),c==2){var u=b(o.fb,o),f=o.Xa;const T=!f;f=new it(f||"//www.google.com/images/cleardot.gif"),l.location&&l.location.protocol=="http"||Cs(f,"https"),Rs(f),T?hc(f.toString(),u):uc(f.toString(),u)}else ve(2);o.G=0,o.l&&o.l.sa(c),Hn(o),$n(o)}r.fb=function(o){o?(this.j.info("Successfully pinged google.com"),ve(2)):(this.j.info("Failed to ping google.com"),ve(1))};function Hn(o){if(o.G=0,o.ka=[],o.l){const c=bn(o.h);(c.length!=0||o.i.length!=0)&&(D(o.ka,c),D(o.ka,o.i),o.h.i.length=0,L(o.i),o.i.length=0),o.l.ra()}}function Wn(o,c,u){var f=u instanceof it?Ve(u):new it(u);if(f.g!="")c&&(f.g=c+"."+f.g),Ps(f,f.s);else{var T=l.location;f=T.protocol,c=c?c+"."+T.hostname:T.hostname,T=+T.port;var I=new it(null);f&&Cs(I,f),c&&(I.g=c),T&&Ps(I,T),u&&(I.l=u),f=I}return u=o.D,c=o.ya,u&&c&&H(f,u,c),H(f,"VER",o.la),Yt(o,f),f}function Kn(o,c,u){if(c&&!o.J)throw Error("Can't create secondary domain capable XhrIo object.");return c=o.Ca&&!o.pa?new K(new Ds({eb:u})):new K(o.pa),c.Ha(o.J),c}r.isActive=function(){return!!this.l&&this.l.isActive(this)};function Yn(){}r=Yn.prototype,r.ua=function(){},r.ta=function(){},r.sa=function(){},r.ra=function(){},r.isActive=function(){return!0},r.Na=function(){};function Ms(){}Ms.prototype.g=function(o,c){return new Te(o,c)};function Te(o,c){he.call(this),this.g=new Fn(c),this.l=o,this.h=c&&c.messageUrlParams||null,o=c&&c.messageHeaders||null,c&&c.clientProtocolHeaderRequired&&(o?o["X-Client-Protocol"]="webchannel":o={"X-Client-Protocol":"webchannel"}),this.g.o=o,o=c&&c.initMessageHeaders||null,c&&c.messageContentType&&(o?o["X-WebChannel-Content-Type"]=c.messageContentType:o={"X-WebChannel-Content-Type":c.messageContentType}),c&&c.va&&(o?o["X-WebChannel-Client-Profile"]=c.va:o={"X-WebChannel-Client-Profile":c.va}),this.g.S=o,(o=c&&c.Sb)&&!U(o)&&(this.g.m=o),this.v=c&&c.supportsCrossDomainXhr||!1,this.u=c&&c.sendRawJson||!1,(c=c&&c.httpSessionIdParam)&&!U(c)&&(this.g.D=c,o=this.h,o!==null&&c in o&&(o=this.h,c in o&&delete o[c])),this.j=new wt(this)}C(Te,he),Te.prototype.m=function(){this.g.l=this.j,this.v&&(this.g.J=!0),this.g.connect(this.l,this.h||void 0)},Te.prototype.close=function(){zi(this.g)},Te.prototype.o=function(o){var c=this.g;if(typeof o=="string"){var u={};u.__data__=o,o=u}else this.u&&(u={},u.__data__=Pi(o),o=u);c.i.push(new ec(c.Ya++,o)),c.G==3&&Vs(c)},Te.prototype.N=function(){this.g.l=null,delete this.j,zi(this.g),delete this.g,Te.aa.N.call(this)};function Xn(o){Di.call(this),o.__headers__&&(this.headers=o.__headers__,this.statusCode=o.__status__,delete o.__headers__,delete o.__status__);var c=o.__sm__;if(c){e:{for(const u in c){o=u;break e}o=void 0}(this.i=o)&&(o=this.i,c=c!==null&&o in c?c[o]:void 0),this.data=c}else this.data=o}C(Xn,Di);function Qn(){xi.call(this),this.status=1}C(Qn,xi);function wt(o){this.g=o}C(wt,Yn),wt.prototype.ua=function(){ye(this.g,"a")},wt.prototype.ta=function(o){ye(this.g,new Xn(o))},wt.prototype.sa=function(o){ye(this.g,new Qn)},wt.prototype.ra=function(){ye(this.g,"b")},Ms.prototype.createWebChannel=Ms.prototype.g,Te.prototype.send=Te.prototype.o,Te.prototype.open=Te.prototype.m,Te.prototype.close=Te.prototype.close,pa=function(){return new Ms},ma=function(){return bs()},fa=tt,lr={mb:0,pb:1,qb:2,Jb:3,Ob:4,Lb:5,Mb:6,Kb:7,Ib:8,Nb:9,PROXY:10,NOPROXY:11,Gb:12,Cb:13,Db:14,Bb:15,Eb:16,Fb:17,ib:18,hb:19,jb:20},Ss.NO_ERROR=0,Ss.TIMEOUT=8,Ss.HTTP_ERROR=6,js=Ss,fn.COMPLETE="complete",da=fn,ln.EventType=Ft,Ft.OPEN="a",Ft.CLOSE="b",Ft.ERROR="c",Ft.MESSAGE="d",he.prototype.listen=he.prototype.K,Jt=ln,K.prototype.listenOnce=K.prototype.L,K.prototype.getLastError=K.prototype.Ka,K.prototype.getLastErrorCode=K.prototype.Ba,K.prototype.getStatus=K.prototype.Z,K.prototype.getResponseJson=K.prototype.Oa,K.prototype.getResponseText=K.prototype.oa,K.prototype.send=K.prototype.ea,K.prototype.setWithCredentials=K.prototype.Ha,ua=K}).apply(typeof Fs<"u"?Fs:typeof self<"u"?self:typeof window<"u"?window:{});const mo="@firebase/firestore";/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class me{constructor(e){this.uid=e}isAuthenticated(){return this.uid!=null}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}me.UNAUTHENTICATED=new me(null),me.GOOGLE_CREDENTIALS=new me("google-credentials-uid"),me.FIRST_PARTY=new me("first-party-uid"),me.MOCK_USER=new me("mock-user");/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let xt="10.14.0";/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const dt=new Sr("@firebase/firestore");function Xt(){return dt.logLevel}function V(r,...e){if(dt.logLevel<=z.DEBUG){const t=e.map(Ir);dt.debug(`Firestore (${xt}): ${r}`,...t)}}function ft(r,...e){if(dt.logLevel<=z.ERROR){const t=e.map(Ir);dt.error(`Firestore (${xt}): ${r}`,...t)}}function Ys(r,...e){if(dt.logLevel<=z.WARN){const t=e.map(Ir);dt.warn(`Firestore (${xt}): ${r}`,...t)}}function Ir(r){if(typeof r=="string")return r;try{/**
* @license
* Copyright 2020 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/return function(t){return JSON.stringify(t)}(r)}catch{return r}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function N(r="Unexpected state"){const e=`FIRESTORE (${xt}) INTERNAL ASSERTION FAILED: `+r;throw ft(e),new Error(e)}function J(r,e){r||N()}function q(r,e){return r}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const R={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class O extends Ze{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ct{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ga{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class cu{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(me.UNAUTHENTICATED))}shutdown(){}}class hu{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class uu{constructor(e){this.t=e,this.currentUser=me.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){J(this.o===void 0);let s=this.i;const i=h=>this.i!==s?(s=this.i,t(h)):Promise.resolve();let n=new ct;this.o=()=>{this.i++,this.currentUser=this.u(),n.resolve(),n=new ct,e.enqueueRetryable(()=>i(this.currentUser))};const a=()=>{const h=n;e.enqueueRetryable(async()=>{await h.promise,await i(this.currentUser)})},l=h=>{V("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=h,this.o&&(this.auth.addAuthTokenListener(this.o),a())};this.t.onInit(h=>l(h)),setTimeout(()=>{if(!this.auth){const h=this.t.getImmediate({optional:!0});h?l(h):(V("FirebaseAuthCredentialsProvider","Auth not yet detected"),n.resolve(),n=new ct)}},0),a()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(s=>this.i!==e?(V("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):s?(J(typeof s.accessToken=="string"),new ga(s.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){const e=this.auth&&this.auth.getUid();return J(e===null||typeof e=="string"),new me(e)}}class du{constructor(e,t,s){this.l=e,this.h=t,this.P=s,this.type="FirstParty",this.user=me.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);const e=this.T();return e&&this.I.set("Authorization",e),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}}class fu{constructor(e,t,s){this.l=e,this.h=t,this.P=s}getToken(){return Promise.resolve(new du(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable(()=>t(me.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class mu{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class pu{constructor(e){this.A=e,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(e,t){J(this.o===void 0);const s=n=>{n.error!=null&&V("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${n.error.message}`);const a=n.token!==this.R;return this.R=n.token,V("FirebaseAppCheckTokenProvider",`Received ${a?"new":"existing"} token.`),a?t(n.token):Promise.resolve()};this.o=n=>{e.enqueueRetryable(()=>s(n))};const i=n=>{V("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=n,this.o&&this.appCheck.addTokenListener(this.o)};this.A.onInit(n=>i(n)),setTimeout(()=>{if(!this.appCheck){const n=this.A.getImmediate({optional:!0});n?i(n):V("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){const e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(t=>t?(J(typeof t.token=="string"),this.R=t.token,new mu(t.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function gu(r){const e=typeof self<"u"&&(self.crypto||self.msCrypto),t=new Uint8Array(r);if(e&&typeof e.getRandomValues=="function")e.getRandomValues(t);else for(let s=0;s<r;s++)t[s]=Math.floor(256*Math.random());return t}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ya{static newId(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=Math.floor(256/e.length)*e.length;let s="";for(;s.length<20;){const i=gu(40);for(let n=0;n<i.length;++n)s.length<20&&i[n]<t&&(s+=e.charAt(i[n]%e.length))}return s}}function G(r,e){return r<e?-1:r>e?1:0}function It(r,e,t){return r.length===e.length&&r.every((s,i)=>t(s,e[i]))}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ie{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new O(R.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new O(R.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new O(R.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new O(R.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return ie.fromMillis(Date.now())}static fromDate(e){return ie.fromMillis(e.getTime())}static fromMillis(e){const t=Math.floor(e/1e3),s=Math.floor(1e6*(e-1e3*t));return new ie(t,s)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?G(this.nanoseconds,e.nanoseconds):G(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class W{constructor(e){this.timestamp=e}static fromTimestamp(e){return new W(e)}static min(){return new W(new ie(0,0))}static max(){return new W(new ie(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class as{constructor(e,t,s){t===void 0?t=0:t>e.length&&N(),s===void 0?s=e.length-t:s>e.length-t&&N(),this.segments=e,this.offset=t,this.len=s}get length(){return this.len}isEqual(e){return as.comparator(this,e)===0}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof as?e.forEach(s=>{t.push(s)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=e===void 0?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return this.length===0}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,s=this.limit();t<s;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const s=Math.min(e.length,t.length);for(let i=0;i<s;i++){const n=e.get(i),a=t.get(i);if(n<a)return-1;if(n>a)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class Y extends as{construct(e,t,s){return new Y(e,t,s)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){const t=[];for(const s of e){if(s.indexOf("//")>=0)throw new O(R.INVALID_ARGUMENT,`Invalid segment (${s}). Paths must not contain // in them.`);t.push(...s.split("/").filter(i=>i.length>0))}return new Y(t)}static emptyPath(){return new Y([])}}const yu=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class ae extends as{construct(e,t,s){return new ae(e,t,s)}static isValidIdentifier(e){return yu.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),ae.isValidIdentifier(e)||(e="`"+e+"`"),e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return this.length===1&&this.get(0)==="__name__"}static keyField(){return new ae(["__name__"])}static fromServerFormat(e){const t=[];let s="",i=0;const n=()=>{if(s.length===0)throw new O(R.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(s),s=""};let a=!1;for(;i<e.length;){const l=e[i];if(l==="\\"){if(i+1===e.length)throw new O(R.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const h=e[i+1];if(h!=="\\"&&h!=="."&&h!=="`")throw new O(R.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);s+=h,i+=2}else l==="`"?(a=!a,i++):l!=="."||a?(s+=l,i++):(n(),i++)}if(n(),a)throw new O(R.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new ae(t)}static emptyPath(){return new ae([])}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class M{constructor(e){this.path=e}static fromPath(e){return new M(Y.fromString(e))}static fromName(e){return new M(Y.fromString(e).popFirst(5))}static empty(){return new M(Y.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return e!==null&&Y.comparator(this.path,e.path)===0}toString(){return this.path.toString()}static comparator(e,t){return Y.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new M(new Y(e.slice()))}}function vu(r,e){const t=r.toTimestamp().seconds,s=r.toTimestamp().nanoseconds+1,i=W.fromTimestamp(s===1e9?new ie(t+1,0):new ie(t,s));return new Xe(i,M.empty(),e)}function _u(r){return new Xe(r.readTime,r.key,-1)}class Xe{constructor(e,t,s){this.readTime=e,this.documentKey=t,this.largestBatchId=s}static min(){return new Xe(W.min(),M.empty(),-1)}static max(){return new Xe(W.max(),M.empty(),-1)}}function wu(r,e){let t=r.readTime.compareTo(e.readTime);return t!==0?t:(t=M.comparator(r.documentKey,e.documentKey),t!==0?t:G(r.largestBatchId,e.largestBatchId))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Eu="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class Tu{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function va(r){if(r.code!==R.FAILED_PRECONDITION||r.message!==Eu)throw r;V("LocalStore","Unexpectedly lost primary lease")}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class P{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)},t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)})}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&N(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new P((s,i)=>{this.nextCallback=n=>{this.wrapSuccess(e,n).next(s,i)},this.catchCallback=n=>{this.wrapFailure(t,n).next(s,i)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{const t=e();return t instanceof P?t:P.resolve(t)}catch(t){return P.reject(t)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):P.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):P.reject(t)}static resolve(e){return new P((t,s)=>{t(e)})}static reject(e){return new P((t,s)=>{s(e)})}static waitFor(e){return new P((t,s)=>{let i=0,n=0,a=!1;e.forEach(l=>{++i,l.next(()=>{++n,a&&n===i&&t()},h=>s(h))}),a=!0,n===i&&t()})}static or(e){let t=P.resolve(!1);for(const s of e)t=t.next(i=>i?P.resolve(i):s());return t}static forEach(e,t){const s=[];return e.forEach((i,n)=>{s.push(t.call(this,i,n))}),this.waitFor(s)}static mapArray(e,t){return new P((s,i)=>{const n=e.length,a=new Array(n);let l=0;for(let h=0;h<n;h++){const d=h;t(e[d]).next(m=>{a[d]=m,++l,l===n&&s(a)},m=>i(m))}})}static doWhile(e,t){return new P((s,i)=>{const n=()=>{e()===!0?t().next(()=>{n()},i):s()};n()})}}function bu(r){const e=r.match(/Android ([\d.]+)/i),t=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(t)}function ci(r){return r.name==="IndexedDbTransactionError"}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class _a{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=s=>this.ie(s),this.se=s=>t.writeSequenceNumber(s))}ie(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){const e=++this.previousValue;return this.se&&this.se(e),e}}_a.oe=-1;function Cr(r){return r==null}function Xs(r){return r===0&&1/r==-1/0}function Su(r){return typeof r=="number"&&Number.isInteger(r)&&!Xs(r)&&r<=Number.MAX_SAFE_INTEGER&&r>=Number.MIN_SAFE_INTEGER}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function po(r){let e=0;for(const t in r)Object.prototype.hasOwnProperty.call(r,t)&&e++;return e}function ps(r,e){for(const t in r)Object.prototype.hasOwnProperty.call(r,t)&&e(t,r[t])}function wa(r){for(const e in r)if(Object.prototype.hasOwnProperty.call(r,e))return!1;return!0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ee{constructor(e,t){this.comparator=e,this.root=t||ne.EMPTY}insert(e,t){return new Ee(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,ne.BLACK,null,null))}remove(e){return new Ee(this.comparator,this.root.remove(e,this.comparator).copy(null,null,ne.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){const s=this.comparator(e,t.key);if(s===0)return t.value;s<0?t=t.left:s>0&&(t=t.right)}return null}indexOf(e){let t=0,s=this.root;for(;!s.isEmpty();){const i=this.comparator(e,s.key);if(i===0)return t+s.left.size;i<0?s=s.left:(t+=s.left.size+1,s=s.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal((t,s)=>(e(t,s),!1))}toString(){const e=[];return this.inorderTraversal((t,s)=>(e.push(`${t}:${s}`),!1)),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new $s(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new $s(this.root,e,this.comparator,!1)}getReverseIterator(){return new $s(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new $s(this.root,e,this.comparator,!0)}}class $s{constructor(e,t,s,i){this.isReverse=i,this.nodeStack=[];let n=1;for(;!e.isEmpty();)if(n=t?s(e.key,t):1,t&&i&&(n*=-1),n<0)e=this.isReverse?e.left:e.right;else{if(n===0){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();const t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(this.nodeStack.length===0)return null;const e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class ne{constructor(e,t,s,i,n){this.key=e,this.value=t,this.color=s??ne.RED,this.left=i??ne.EMPTY,this.right=n??ne.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,s,i,n){return new ne(e??this.key,t??this.value,s??this.color,i??this.left,n??this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,s){let i=this;const n=s(e,i.key);return i=n<0?i.copy(null,null,null,i.left.insert(e,t,s),null):n===0?i.copy(null,t,null,null,null):i.copy(null,null,null,null,i.right.insert(e,t,s)),i.fixUp()}removeMin(){if(this.left.isEmpty())return ne.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let s,i=this;if(t(e,i.key)<0)i.left.isEmpty()||i.left.isRed()||i.left.left.isRed()||(i=i.moveRedLeft()),i=i.copy(null,null,null,i.left.remove(e,t),null);else{if(i.left.isRed()&&(i=i.rotateRight()),i.right.isEmpty()||i.right.isRed()||i.right.left.isRed()||(i=i.moveRedRight()),t(e,i.key)===0){if(i.right.isEmpty())return ne.EMPTY;s=i.right.min(),i=i.copy(s.key,s.value,null,null,i.right.removeMin())}i=i.copy(null,null,null,null,i.right.remove(e,t))}return i.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){const e=this.copy(null,null,ne.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){const e=this.copy(null,null,ne.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){const e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed()||this.right.isRed())throw N();const e=this.left.check();if(e!==this.right.check())throw N();return e+(this.isRed()?0:1)}}ne.EMPTY=null,ne.RED=!0,ne.BLACK=!1;ne.EMPTY=new class{constructor(){this.size=0}get key(){throw N()}get value(){throw N()}get color(){throw N()}get left(){throw N()}get right(){throw N()}copy(e,t,s,i,n){return this}insert(e,t,s){return new ne(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ge{constructor(e){this.comparator=e,this.data=new Ee(this.comparator)}has(e){return this.data.get(e)!==null}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal((t,s)=>(e(t),!1))}forEachInRange(e,t){const s=this.data.getIteratorFrom(e[0]);for(;s.hasNext();){const i=s.getNext();if(this.comparator(i.key,e[1])>=0)return;t(i.key)}}forEachWhile(e,t){let s;for(s=t!==void 0?this.data.getIteratorFrom(t):this.data.getIterator();s.hasNext();)if(!e(s.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new go(this.data.getIterator())}getIteratorFrom(e){return new go(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(s=>{t=t.add(s)}),t}isEqual(e){if(!(e instanceof ge)||this.size!==e.size)return!1;const t=this.data.getIterator(),s=e.data.getIterator();for(;t.hasNext();){const i=t.getNext().key,n=s.getNext().key;if(this.comparator(i,n)!==0)return!1}return!0}toArray(){const e=[];return this.forEach(t=>{e.push(t)}),e}toString(){const e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(e){const t=new ge(this.comparator);return t.data=e,t}}class go{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Pe{constructor(e){this.fields=e,e.sort(ae.comparator)}static empty(){return new Pe([])}unionWith(e){let t=new ge(ae.comparator);for(const s of this.fields)t=t.add(s);for(const s of e)t=t.add(s);return new Pe(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return It(this.fields,e.fields,(t,s)=>t.isEqual(s))}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Au extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class xe{constructor(e){this.binaryString=e}static fromBase64String(e){const t=function(i){try{return atob(i)}catch(n){throw typeof DOMException<"u"&&n instanceof DOMException?new Au("Invalid base64 string: "+n):n}}(e);return new xe(t)}static fromUint8Array(e){const t=function(i){let n="";for(let a=0;a<i.length;++a)n+=String.fromCharCode(i[a]);return n}(e);return new xe(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return function(t){return btoa(t)}(this.binaryString)}toUint8Array(){return function(t){const s=new Uint8Array(t.length);for(let i=0;i<t.length;i++)s[i]=t.charCodeAt(i);return s}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return G(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}xe.EMPTY_BYTE_STRING=new xe("");const Iu=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function mt(r){if(J(!!r),typeof r=="string"){let e=0;const t=Iu.exec(r);if(J(!!t),t[1]){let i=t[1];i=(i+"000000000").substr(0,9),e=Number(i)}const s=new Date(r);return{seconds:Math.floor(s.getTime()/1e3),nanos:e}}return{seconds:oe(r.seconds),nanos:oe(r.nanos)}}function oe(r){return typeof r=="number"?r:typeof r=="string"?Number(r):0}function ls(r){return typeof r=="string"?xe.fromBase64String(r):xe.fromUint8Array(r)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Pr(r){var e,t;return((t=(((e=r==null?void 0:r.mapValue)===null||e===void 0?void 0:e.fields)||{}).__type__)===null||t===void 0?void 0:t.stringValue)==="server_timestamp"}function Ea(r){const e=r.mapValue.fields.__previous_value__;return Pr(e)?Ea(e):e}function Qs(r){const e=mt(r.mapValue.fields.__local_write_time__.timestampValue);return new ie(e.seconds,e.nanos)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Cu{constructor(e,t,s,i,n,a,l,h,d){this.databaseId=e,this.appId=t,this.persistenceKey=s,this.host=i,this.ssl=n,this.forceLongPolling=a,this.autoDetectLongPolling=l,this.longPollingOptions=h,this.useFetchStreams=d}}class Js{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new Js("","")}get isDefaultDatabase(){return this.database==="(default)"}isEqual(e){return e instanceof Js&&e.projectId===this.projectId&&e.database===this.database}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const zs={mapValue:{}};function Ct(r){return"nullValue"in r?0:"booleanValue"in r?1:"integerValue"in r||"doubleValue"in r?2:"timestampValue"in r?3:"stringValue"in r?5:"bytesValue"in r?6:"referenceValue"in r?7:"geoPointValue"in r?8:"arrayValue"in r?9:"mapValue"in r?Pr(r)?4:Ru(r)?9007199254740991:Pu(r)?10:11:N()}function Le(r,e){if(r===e)return!0;const t=Ct(r);if(t!==Ct(e))return!1;switch(t){case 0:case 9007199254740991:return!0;case 1:return r.booleanValue===e.booleanValue;case 4:return Qs(r).isEqual(Qs(e));case 3:return function(i,n){if(typeof i.timestampValue=="string"&&typeof n.timestampValue=="string"&&i.timestampValue.length===n.timestampValue.length)return i.timestampValue===n.timestampValue;const a=mt(i.timestampValue),l=mt(n.timestampValue);return a.seconds===l.seconds&&a.nanos===l.nanos}(r,e);case 5:return r.stringValue===e.stringValue;case 6:return function(i,n){return ls(i.bytesValue).isEqual(ls(n.bytesValue))}(r,e);case 7:return r.referenceValue===e.referenceValue;case 8:return function(i,n){return oe(i.geoPointValue.latitude)===oe(n.geoPointValue.latitude)&&oe(i.geoPointValue.longitude)===oe(n.geoPointValue.longitude)}(r,e);case 2:return function(i,n){if("integerValue"in i&&"integerValue"in n)return oe(i.integerValue)===oe(n.integerValue);if("doubleValue"in i&&"doubleValue"in n){const a=oe(i.doubleValue),l=oe(n.doubleValue);return a===l?Xs(a)===Xs(l):isNaN(a)&&isNaN(l)}return!1}(r,e);case 9:return It(r.arrayValue.values||[],e.arrayValue.values||[],Le);case 10:case 11:return function(i,n){const a=i.mapValue.fields||{},l=n.mapValue.fields||{};if(po(a)!==po(l))return!1;for(const h in a)if(a.hasOwnProperty(h)&&(l[h]===void 0||!Le(a[h],l[h])))return!1;return!0}(r,e);default:return N()}}function cs(r,e){return(r.values||[]).find(t=>Le(t,e))!==void 0}function Pt(r,e){if(r===e)return 0;const t=Ct(r),s=Ct(e);if(t!==s)return G(t,s);switch(t){case 0:case 9007199254740991:return 0;case 1:return G(r.booleanValue,e.booleanValue);case 2:return function(n,a){const l=oe(n.integerValue||n.doubleValue),h=oe(a.integerValue||a.doubleValue);return l<h?-1:l>h?1:l===h?0:isNaN(l)?isNaN(h)?0:-1:1}(r,e);case 3:return yo(r.timestampValue,e.timestampValue);case 4:return yo(Qs(r),Qs(e));case 5:return G(r.stringValue,e.stringValue);case 6:return function(n,a){const l=ls(n),h=ls(a);return l.compareTo(h)}(r.bytesValue,e.bytesValue);case 7:return function(n,a){const l=n.split("/"),h=a.split("/");for(let d=0;d<l.length&&d<h.length;d++){const m=G(l[d],h[d]);if(m!==0)return m}return G(l.length,h.length)}(r.referenceValue,e.referenceValue);case 8:return function(n,a){const l=G(oe(n.latitude),oe(a.latitude));return l!==0?l:G(oe(n.longitude),oe(a.longitude))}(r.geoPointValue,e.geoPointValue);case 9:return vo(r.arrayValue,e.arrayValue);case 10:return function(n,a){var l,h,d,m;const p=n.fields||{},b=a.fields||{},A=(l=p.value)===null||l===void 0?void 0:l.arrayValue,C=(h=b.value)===null||h===void 0?void 0:h.arrayValue,L=G(((d=A==null?void 0:A.values)===null||d===void 0?void 0:d.length)||0,((m=C==null?void 0:C.values)===null||m===void 0?void 0:m.length)||0);return L!==0?L:vo(A,C)}(r.mapValue,e.mapValue);case 11:return function(n,a){if(n===zs.mapValue&&a===zs.mapValue)return 0;if(n===zs.mapValue)return 1;if(a===zs.mapValue)return-1;const l=n.fields||{},h=Object.keys(l),d=a.fields||{},m=Object.keys(d);h.sort(),m.sort();for(let p=0;p<h.length&&p<m.length;++p){const b=G(h[p],m[p]);if(b!==0)return b;const A=Pt(l[h[p]],d[m[p]]);if(A!==0)return A}return G(h.length,m.length)}(r.mapValue,e.mapValue);default:throw N()}}function yo(r,e){if(typeof r=="string"&&typeof e=="string"&&r.length===e.length)return G(r,e);const t=mt(r),s=mt(e),i=G(t.seconds,s.seconds);return i!==0?i:G(t.nanos,s.nanos)}function vo(r,e){const t=r.values||[],s=e.values||[];for(let i=0;i<t.length&&i<s.length;++i){const n=Pt(t[i],s[i]);if(n)return n}return G(t.length,s.length)}function Rt(r){return cr(r)}function cr(r){return"nullValue"in r?"null":"booleanValue"in r?""+r.booleanValue:"integerValue"in r?""+r.integerValue:"doubleValue"in r?""+r.doubleValue:"timestampValue"in r?function(t){const s=mt(t);return`time(${s.seconds},${s.nanos})`}(r.timestampValue):"stringValue"in r?r.stringValue:"bytesValue"in r?function(t){return ls(t).toBase64()}(r.bytesValue):"referenceValue"in r?function(t){return M.fromName(t).toString()}(r.referenceValue):"geoPointValue"in r?function(t){return`geo(${t.latitude},${t.longitude})`}(r.geoPointValue):"arrayValue"in r?function(t){let s="[",i=!0;for(const n of t.values||[])i?i=!1:s+=",",s+=cr(n);return s+"]"}(r.arrayValue):"mapValue"in r?function(t){const s=Object.keys(t.fields||{}).sort();let i="{",n=!0;for(const a of s)n?n=!1:i+=",",i+=`${a}:${cr(t.fields[a])}`;return i+"}"}(r.mapValue):N()}function hr(r){return!!r&&"integerValue"in r}function Rr(r){return!!r&&"arrayValue"in r}function Gs(r){return!!r&&"mapValue"in r}function Pu(r){var e,t;return((t=(((e=r==null?void 0:r.mapValue)===null||e===void 0?void 0:e.fields)||{}).__type__)===null||t===void 0?void 0:t.stringValue)==="__vector__"}function es(r){if(r.geoPointValue)return{geoPointValue:Object.assign({},r.geoPointValue)};if(r.timestampValue&&typeof r.timestampValue=="object")return{timestampValue:Object.assign({},r.timestampValue)};if(r.mapValue){const e={mapValue:{fields:{}}};return ps(r.mapValue.fields,(t,s)=>e.mapValue.fields[t]=es(s)),e}if(r.arrayValue){const e={arrayValue:{values:[]}};for(let t=0;t<(r.arrayValue.values||[]).length;++t)e.arrayValue.values[t]=es(r.arrayValue.values[t]);return e}return Object.assign({},r)}function Ru(r){return(((r.mapValue||{}).fields||{}).__type__||{}).stringValue==="__max__"}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ce{constructor(e){this.value=e}static empty(){return new Ce({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let s=0;s<e.length-1;++s)if(t=(t.mapValue.fields||{})[e.get(s)],!Gs(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=es(t)}setAll(e){let t=ae.emptyPath(),s={},i=[];e.forEach((a,l)=>{if(!t.isImmediateParentOf(l)){const h=this.getFieldsMap(t);this.applyChanges(h,s,i),s={},i=[],t=l.popLast()}a?s[l.lastSegment()]=es(a):i.push(l.lastSegment())});const n=this.getFieldsMap(t);this.applyChanges(n,s,i)}delete(e){const t=this.field(e.popLast());Gs(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return Le(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let s=0;s<e.length;++s){let i=t.mapValue.fields[e.get(s)];Gs(i)&&i.mapValue.fields||(i={mapValue:{fields:{}}},t.mapValue.fields[e.get(s)]=i),t=i}return t.mapValue.fields}applyChanges(e,t,s){ps(t,(i,n)=>e[i]=n);for(const i of s)delete e[i]}clone(){return new Ce(es(this.value))}}function Ta(r){const e=[];return ps(r.fields,(t,s)=>{const i=new ae([t]);if(Gs(s)){const n=Ta(s.mapValue).fields;if(n.length===0)e.push(i);else for(const a of n)e.push(i.child(a))}else e.push(i)}),new Pe(e)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ie{constructor(e,t,s,i,n,a,l){this.key=e,this.documentType=t,this.version=s,this.readTime=i,this.createTime=n,this.data=a,this.documentState=l}static newInvalidDocument(e){return new Ie(e,0,W.min(),W.min(),W.min(),Ce.empty(),0)}static newFoundDocument(e,t,s,i){return new Ie(e,1,t,W.min(),s,i,0)}static newNoDocument(e,t){return new Ie(e,2,t,W.min(),W.min(),Ce.empty(),0)}static newUnknownDocument(e,t){return new Ie(e,3,t,W.min(),W.min(),Ce.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(W.min())||this.documentType!==2&&this.documentType!==0||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=Ce.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=Ce.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=W.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return this.documentState===1}get hasCommittedMutations(){return this.documentState===2}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return this.documentType!==0}isFoundDocument(){return this.documentType===1}isNoDocument(){return this.documentType===2}isUnknownDocument(){return this.documentType===3}isEqual(e){return e instanceof Ie&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new Ie(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Zs{constructor(e,t){this.position=e,this.inclusive=t}}function _o(r,e,t){let s=0;for(let i=0;i<r.position.length;i++){const n=e[i],a=r.position[i];if(n.field.isKeyField()?s=M.comparator(M.fromName(a.referenceValue),t.key):s=Pt(a,t.data.field(n.field)),n.dir==="desc"&&(s*=-1),s!==0)break}return s}function wo(r,e){if(r===null)return e===null;if(e===null||r.inclusive!==e.inclusive||r.position.length!==e.position.length)return!1;for(let t=0;t<r.position.length;t++)if(!Le(r.position[t],e.position[t]))return!1;return!0}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ei{constructor(e,t="asc"){this.field=e,this.dir=t}}function Du(r,e){return r.dir===e.dir&&r.field.isEqual(e.field)}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ba{}class se extends ba{constructor(e,t,s){super(),this.field=e,this.op=t,this.value=s}static create(e,t,s){return e.isKeyField()?t==="in"||t==="not-in"?this.createKeyFieldInFilter(e,t,s):new Lu(e,t,s):t==="array-contains"?new Ou(e,s):t==="in"?new Mu(e,s):t==="not-in"?new Nu(e,s):t==="array-contains-any"?new Fu(e,s):new se(e,t,s)}static createKeyFieldInFilter(e,t,s){return t==="in"?new ku(e,s):new Vu(e,s)}matches(e){const t=e.data.field(this.field);return this.op==="!="?t!==null&&this.matchesComparison(Pt(t,this.value)):t!==null&&Ct(this.value)===Ct(t)&&this.matchesComparison(Pt(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return e===0;case"!=":return e!==0;case">":return e>0;case">=":return e>=0;default:return N()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class Qe extends ba{constructor(e,t){super(),this.filters=e,this.op=t,this.ae=null}static create(e,t){return new Qe(e,t)}matches(e){return Sa(this)?this.filters.find(t=>!t.matches(e))===void 0:this.filters.find(t=>t.matches(e))!==void 0}getFlattenedFilters(){return this.ae!==null||(this.ae=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.ae}getFilters(){return Object.assign([],this.filters)}}function Sa(r){return r.op==="and"}function Aa(r){return xu(r)&&Sa(r)}function xu(r){for(const e of r.filters)if(e instanceof Qe)return!1;return!0}function ur(r){if(r instanceof se)return r.field.canonicalString()+r.op.toString()+Rt(r.value);if(Aa(r))return r.filters.map(e=>ur(e)).join(",");{const e=r.filters.map(t=>ur(t)).join(",");return`${r.op}(${e})`}}function Ia(r,e){return r instanceof se?function(s,i){return i instanceof se&&s.op===i.op&&s.field.isEqual(i.field)&&Le(s.value,i.value)}(r,e):r instanceof Qe?function(s,i){return i instanceof Qe&&s.op===i.op&&s.filters.length===i.filters.length?s.filters.reduce((n,a,l)=>n&&Ia(a,i.filters[l]),!0):!1}(r,e):void N()}function Ca(r){return r instanceof se?function(t){return`${t.field.canonicalString()} ${t.op} ${Rt(t.value)}`}(r):r instanceof Qe?function(t){return t.op.toString()+" {"+t.getFilters().map(Ca).join(" ,")+"}"}(r):"Filter"}class Lu extends se{constructor(e,t,s){super(e,t,s),this.key=M.fromName(s.referenceValue)}matches(e){const t=M.comparator(e.key,this.key);return this.matchesComparison(t)}}class ku extends se{constructor(e,t){super(e,"in",t),this.keys=Pa("in",t)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}}class Vu extends se{constructor(e,t){super(e,"not-in",t),this.keys=Pa("not-in",t)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}}function Pa(r,e){var t;return(((t=e.arrayValue)===null||t===void 0?void 0:t.values)||[]).map(s=>M.fromName(s.referenceValue))}class Ou extends se{constructor(e,t){super(e,"array-contains",t)}matches(e){const t=e.data.field(this.field);return Rr(t)&&cs(t.arrayValue,this.value)}}class Mu extends se{constructor(e,t){super(e,"in",t)}matches(e){const t=e.data.field(this.field);return t!==null&&cs(this.value.arrayValue,t)}}class Nu extends se{constructor(e,t){super(e,"not-in",t)}matches(e){if(cs(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const t=e.data.field(this.field);return t!==null&&!cs(this.value.arrayValue,t)}}class Fu extends se{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!Rr(t)||!t.arrayValue.values)&&t.arrayValue.values.some(s=>cs(this.value.arrayValue,s))}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class $u{constructor(e,t=null,s=[],i=[],n=null,a=null,l=null){this.path=e,this.collectionGroup=t,this.orderBy=s,this.filters=i,this.limit=n,this.startAt=a,this.endAt=l,this.ue=null}}function Eo(r,e=null,t=[],s=[],i=null,n=null,a=null){return new $u(r,e,t,s,i,n,a)}function Dr(r){const e=q(r);if(e.ue===null){let t=e.path.canonicalString();e.collectionGroup!==null&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map(s=>ur(s)).join(","),t+="|ob:",t+=e.orderBy.map(s=>function(n){return n.field.canonicalString()+n.dir}(s)).join(","),Cr(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(s=>Rt(s)).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(s=>Rt(s)).join(",")),e.ue=t}return e.ue}function xr(r,e){if(r.limit!==e.limit||r.orderBy.length!==e.orderBy.length)return!1;for(let t=0;t<r.orderBy.length;t++)if(!Du(r.orderBy[t],e.orderBy[t]))return!1;if(r.filters.length!==e.filters.length)return!1;for(let t=0;t<r.filters.length;t++)if(!Ia(r.filters[t],e.filters[t]))return!1;return r.collectionGroup===e.collectionGroup&&!!r.path.isEqual(e.path)&&!!wo(r.startAt,e.startAt)&&wo(r.endAt,e.endAt)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class hi{constructor(e,t=null,s=[],i=[],n=null,a="F",l=null,h=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=s,this.filters=i,this.limit=n,this.limitType=a,this.startAt=l,this.endAt=h,this.ce=null,this.le=null,this.he=null,this.startAt,this.endAt}}function zu(r,e,t,s,i,n,a,l){return new hi(r,e,t,s,i,n,a,l)}function Bu(r){return new hi(r)}function To(r){return r.filters.length===0&&r.limit===null&&r.startAt==null&&r.endAt==null&&(r.explicitOrderBy.length===0||r.explicitOrderBy.length===1&&r.explicitOrderBy[0].field.isKeyField())}function Uu(r){return r.collectionGroup!==null}function ts(r){const e=q(r);if(e.ce===null){e.ce=[];const t=new Set;for(const n of e.explicitOrderBy)e.ce.push(n),t.add(n.field.canonicalString());const s=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";(function(a){let l=new ge(ae.comparator);return a.filters.forEach(h=>{h.getFlattenedFilters().forEach(d=>{d.isInequality()&&(l=l.add(d.field))})}),l})(e).forEach(n=>{t.has(n.canonicalString())||n.isKeyField()||e.ce.push(new ei(n,s))}),t.has(ae.keyField().canonicalString())||e.ce.push(new ei(ae.keyField(),s))}return e.ce}function ht(r){const e=q(r);return e.le||(e.le=ju(e,ts(r))),e.le}function ju(r,e){if(r.limitType==="F")return Eo(r.path,r.collectionGroup,e,r.filters,r.limit,r.startAt,r.endAt);{e=e.map(i=>{const n=i.dir==="desc"?"asc":"desc";return new ei(i.field,n)});const t=r.endAt?new Zs(r.endAt.position,r.endAt.inclusive):null,s=r.startAt?new Zs(r.startAt.position,r.startAt.inclusive):null;return Eo(r.path,r.collectionGroup,e,r.filters,r.limit,t,s)}}function dr(r,e,t){return new hi(r.path,r.collectionGroup,r.explicitOrderBy.slice(),r.filters.slice(),e,t,r.startAt,r.endAt)}function Ra(r,e){return xr(ht(r),ht(e))&&r.limitType===e.limitType}function Da(r){return`${Dr(ht(r))}|lt:${r.limitType}`}function Qt(r){return`Query(target=${function(t){let s=t.path.canonicalString();return t.collectionGroup!==null&&(s+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(s+=`, filters: [${t.filters.map(i=>Ca(i)).join(", ")}]`),Cr(t.limit)||(s+=", limit: "+t.limit),t.orderBy.length>0&&(s+=`, orderBy: [${t.orderBy.map(i=>function(a){return`${a.field.canonicalString()} (${a.dir})`}(i)).join(", ")}]`),t.startAt&&(s+=", startAt: ",s+=t.startAt.inclusive?"b:":"a:",s+=t.startAt.position.map(i=>Rt(i)).join(",")),t.endAt&&(s+=", endAt: ",s+=t.endAt.inclusive?"a:":"b:",s+=t.endAt.position.map(i=>Rt(i)).join(",")),`Target(${s})`}(ht(r))}; limitType=${r.limitType})`}function Lr(r,e){return e.isFoundDocument()&&function(s,i){const n=i.key.path;return s.collectionGroup!==null?i.key.hasCollectionId(s.collectionGroup)&&s.path.isPrefixOf(n):M.isDocumentKey(s.path)?s.path.isEqual(n):s.path.isImmediateParentOf(n)}(r,e)&&function(s,i){for(const n of ts(s))if(!n.field.isKeyField()&&i.data.field(n.field)===null)return!1;return!0}(r,e)&&function(s,i){for(const n of s.filters)if(!n.matches(i))return!1;return!0}(r,e)&&function(s,i){return!(s.startAt&&!function(a,l,h){const d=_o(a,l,h);return a.inclusive?d<=0:d<0}(s.startAt,ts(s),i)||s.endAt&&!function(a,l,h){const d=_o(a,l,h);return a.inclusive?d>=0:d>0}(s.endAt,ts(s),i))}(r,e)}function Gu(r){return(e,t)=>{let s=!1;for(const i of ts(r)){const n=qu(i,e,t);if(n!==0)return n;s=s||i.field.isKeyField()}return 0}}function qu(r,e,t){const s=r.field.isKeyField()?M.comparator(e.key,t.key):function(n,a,l){const h=a.data.field(n),d=l.data.field(n);return h!==null&&d!==null?Pt(h,d):N()}(r.field,e,t);switch(r.dir){case"asc":return s;case"desc":return-1*s;default:return N()}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Lt{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),s=this.inner[t];if(s!==void 0){for(const[i,n]of s)if(this.equalsFn(i,e))return n}}has(e){return this.get(e)!==void 0}set(e,t){const s=this.mapKeyFn(e),i=this.inner[s];if(i===void 0)return this.inner[s]=[[e,t]],void this.innerSize++;for(let n=0;n<i.length;n++)if(this.equalsFn(i[n][0],e))return void(i[n]=[e,t]);i.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),s=this.inner[t];if(s===void 0)return!1;for(let i=0;i<s.length;i++)if(this.equalsFn(s[i][0],e))return s.length===1?delete this.inner[t]:s.splice(i,1),this.innerSize--,!0;return!1}forEach(e){ps(this.inner,(t,s)=>{for(const[i,n]of s)e(i,n)})}isEmpty(){return wa(this.inner)}size(){return this.innerSize}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Hu=new Ee(M.comparator);function ti(){return Hu}const xa=new Ee(M.comparator);function Bs(...r){let e=xa;for(const t of r)e=e.insert(t.key,t);return e}function La(r){let e=xa;return r.forEach((t,s)=>e=e.insert(t,s.overlayedDocument)),e}function ot(){return ss()}function ka(){return ss()}function ss(){return new Lt(r=>r.toString(),(r,e)=>r.isEqual(e))}const Wu=new Ee(M.comparator),Ku=new ge(M.comparator);function pe(...r){let e=Ku;for(const t of r)e=e.add(t);return e}const Yu=new ge(G);function Xu(){return Yu}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function kr(r,e){if(r.useProto3Json){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Xs(e)?"-0":e}}function Va(r){return{integerValue:""+r}}function Qu(r,e){return Su(e)?Va(e):kr(r,e)}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ui{constructor(){this._=void 0}}function Ju(r,e,t){return r instanceof hs?function(i,n){const a={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:i.seconds,nanos:i.nanoseconds}}}};return n&&Pr(n)&&(n=Ea(n)),n&&(a.fields.__previous_value__=n),{mapValue:a}}(t,e):r instanceof us?Ma(r,e):r instanceof ds?Na(r,e):function(i,n){const a=Oa(i,n),l=bo(a)+bo(i.Pe);return hr(a)&&hr(i.Pe)?Va(l):kr(i.serializer,l)}(r,e)}function Zu(r,e,t){return r instanceof us?Ma(r,e):r instanceof ds?Na(r,e):t}function Oa(r,e){return r instanceof si?function(s){return hr(s)||function(n){return!!n&&"doubleValue"in n}(s)}(e)?e:{integerValue:0}:null}class hs extends ui{}class us extends ui{constructor(e){super(),this.elements=e}}function Ma(r,e){const t=Fa(e);for(const s of r.elements)t.some(i=>Le(i,s))||t.push(s);return{arrayValue:{values:t}}}class ds extends ui{constructor(e){super(),this.elements=e}}function Na(r,e){let t=Fa(e);for(const s of r.elements)t=t.filter(i=>!Le(i,s));return{arrayValue:{values:t}}}class si extends ui{constructor(e,t){super(),this.serializer=e,this.Pe=t}}function bo(r){return oe(r.integerValue||r.doubleValue)}function Fa(r){return Rr(r)&&r.arrayValue.values?r.arrayValue.values.slice():[]}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ed{constructor(e,t){this.field=e,this.transform=t}}function td(r,e){return r.field.isEqual(e.field)&&function(s,i){return s instanceof us&&i instanceof us||s instanceof ds&&i instanceof ds?It(s.elements,i.elements,Le):s instanceof si&&i instanceof si?Le(s.Pe,i.Pe):s instanceof hs&&i instanceof hs}(r.transform,e.transform)}class sd{constructor(e,t){this.version=e,this.transformResults=t}}class Me{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new Me}static exists(e){return new Me(void 0,e)}static updateTime(e){return new Me(e)}get isNone(){return this.updateTime===void 0&&this.exists===void 0}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function qs(r,e){return r.updateTime!==void 0?e.isFoundDocument()&&e.version.isEqual(r.updateTime):r.exists===void 0||r.exists===e.isFoundDocument()}class di{}function $a(r,e){if(!r.hasLocalMutations||e&&e.fields.length===0)return null;if(e===null)return r.isNoDocument()?new Ba(r.key,Me.none()):new gs(r.key,r.data,Me.none());{const t=r.data,s=Ce.empty();let i=new ge(ae.comparator);for(let n of e.fields)if(!i.has(n)){let a=t.field(n);a===null&&n.length>1&&(n=n.popLast(),a=t.field(n)),a===null?s.delete(n):s.set(n,a),i=i.add(n)}return new yt(r.key,s,new Pe(i.toArray()),Me.none())}}function id(r,e,t){r instanceof gs?function(i,n,a){const l=i.value.clone(),h=Ao(i.fieldTransforms,n,a.transformResults);l.setAll(h),n.convertToFoundDocument(a.version,l).setHasCommittedMutations()}(r,e,t):r instanceof yt?function(i,n,a){if(!qs(i.precondition,n))return void n.convertToUnknownDocument(a.version);const l=Ao(i.fieldTransforms,n,a.transformResults),h=n.data;h.setAll(za(i)),h.setAll(l),n.convertToFoundDocument(a.version,h).setHasCommittedMutations()}(r,e,t):function(i,n,a){n.convertToNoDocument(a.version).setHasCommittedMutations()}(0,e,t)}function is(r,e,t,s){return r instanceof gs?function(n,a,l,h){if(!qs(n.precondition,a))return l;const d=n.value.clone(),m=Io(n.fieldTransforms,h,a);return d.setAll(m),a.convertToFoundDocument(a.version,d).setHasLocalMutations(),null}(r,e,t,s):r instanceof yt?function(n,a,l,h){if(!qs(n.precondition,a))return l;const d=Io(n.fieldTransforms,h,a),m=a.data;return m.setAll(za(n)),m.setAll(d),a.convertToFoundDocument(a.version,m).setHasLocalMutations(),l===null?null:l.unionWith(n.fieldMask.fields).unionWith(n.fieldTransforms.map(p=>p.field))}(r,e,t,s):function(n,a,l){return qs(n.precondition,a)?(a.convertToNoDocument(a.version).setHasLocalMutations(),null):l}(r,e,t)}function rd(r,e){let t=null;for(const s of r.fieldTransforms){const i=e.data.field(s.field),n=Oa(s.transform,i||null);n!=null&&(t===null&&(t=Ce.empty()),t.set(s.field,n))}return t||null}function So(r,e){return r.type===e.type&&!!r.key.isEqual(e.key)&&!!r.precondition.isEqual(e.precondition)&&!!function(s,i){return s===void 0&&i===void 0||!(!s||!i)&&It(s,i,(n,a)=>td(n,a))}(r.fieldTransforms,e.fieldTransforms)&&(r.type===0?r.value.isEqual(e.value):r.type!==1||r.data.isEqual(e.data)&&r.fieldMask.isEqual(e.fieldMask))}class gs extends di{constructor(e,t,s,i=[]){super(),this.key=e,this.value=t,this.precondition=s,this.fieldTransforms=i,this.type=0}getFieldMask(){return null}}class yt extends di{constructor(e,t,s,i,n=[]){super(),this.key=e,this.data=t,this.fieldMask=s,this.precondition=i,this.fieldTransforms=n,this.type=1}getFieldMask(){return this.fieldMask}}function za(r){const e=new Map;return r.fieldMask.fields.forEach(t=>{if(!t.isEmpty()){const s=r.data.field(t);e.set(t,s)}}),e}function Ao(r,e,t){const s=new Map;J(r.length===t.length);for(let i=0;i<t.length;i++){const n=r[i],a=n.transform,l=e.data.field(n.field);s.set(n.field,Zu(a,l,t[i]))}return s}function Io(r,e,t){const s=new Map;for(const i of r){const n=i.transform,a=t.data.field(i.field);s.set(i.field,Ju(n,a,e))}return s}class Ba extends di{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class nd extends di{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class od{constructor(e,t,s,i){this.batchId=e,this.localWriteTime=t,this.baseMutations=s,this.mutations=i}applyToRemoteDocument(e,t){const s=t.mutationResults;for(let i=0;i<this.mutations.length;i++){const n=this.mutations[i];n.key.isEqual(e.key)&&id(n,e,s[i])}}applyToLocalView(e,t){for(const s of this.baseMutations)s.key.isEqual(e.key)&&(t=is(s,e,t,this.localWriteTime));for(const s of this.mutations)s.key.isEqual(e.key)&&(t=is(s,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){const s=ka();return this.mutations.forEach(i=>{const n=e.get(i.key),a=n.overlayedDocument;let l=this.applyToLocalView(a,n.mutatedFields);l=t.has(i.key)?null:l;const h=$a(a,l);h!==null&&s.set(i.key,h),a.isValidDocument()||a.convertToNoDocument(W.min())}),s}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),pe())}isEqual(e){return this.batchId===e.batchId&&It(this.mutations,e.mutations,(t,s)=>So(t,s))&&It(this.baseMutations,e.baseMutations,(t,s)=>So(t,s))}}class Vr{constructor(e,t,s,i){this.batch=e,this.commitVersion=t,this.mutationResults=s,this.docVersions=i}static from(e,t,s){J(e.mutations.length===s.length);let i=function(){return Wu}();const n=e.mutations;for(let a=0;a<n.length;a++)i=i.insert(n[a].key,s[a].version);return new Vr(e,t,s,i)}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ad{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return e!==null&&this.mutation===e.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Z,$;function ld(r){switch(r){default:return N();case R.CANCELLED:case R.UNKNOWN:case R.DEADLINE_EXCEEDED:case R.RESOURCE_EXHAUSTED:case R.INTERNAL:case R.UNAVAILABLE:case R.UNAUTHENTICATED:return!1;case R.INVALID_ARGUMENT:case R.NOT_FOUND:case R.ALREADY_EXISTS:case R.PERMISSION_DENIED:case R.FAILED_PRECONDITION:case R.ABORTED:case R.OUT_OF_RANGE:case R.UNIMPLEMENTED:case R.DATA_LOSS:return!0}}function cd(r){if(r===void 0)return ft("GRPC error has no .code"),R.UNKNOWN;switch(r){case Z.OK:return R.OK;case Z.CANCELLED:return R.CANCELLED;case Z.UNKNOWN:return R.UNKNOWN;case Z.DEADLINE_EXCEEDED:return R.DEADLINE_EXCEEDED;case Z.RESOURCE_EXHAUSTED:return R.RESOURCE_EXHAUSTED;case Z.INTERNAL:return R.INTERNAL;case Z.UNAVAILABLE:return R.UNAVAILABLE;case Z.UNAUTHENTICATED:return R.UNAUTHENTICATED;case Z.INVALID_ARGUMENT:return R.INVALID_ARGUMENT;case Z.NOT_FOUND:return R.NOT_FOUND;case Z.ALREADY_EXISTS:return R.ALREADY_EXISTS;case Z.PERMISSION_DENIED:return R.PERMISSION_DENIED;case Z.FAILED_PRECONDITION:return R.FAILED_PRECONDITION;case Z.ABORTED:return R.ABORTED;case Z.OUT_OF_RANGE:return R.OUT_OF_RANGE;case Z.UNIMPLEMENTED:return R.UNIMPLEMENTED;case Z.DATA_LOSS:return R.DATA_LOSS;default:return N()}}($=Z||(Z={}))[$.OK=0]="OK",$[$.CANCELLED=1]="CANCELLED",$[$.UNKNOWN=2]="UNKNOWN",$[$.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",$[$.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",$[$.NOT_FOUND=5]="NOT_FOUND",$[$.ALREADY_EXISTS=6]="ALREADY_EXISTS",$[$.PERMISSION_DENIED=7]="PERMISSION_DENIED",$[$.UNAUTHENTICATED=16]="UNAUTHENTICATED",$[$.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",$[$.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",$[$.ABORTED=10]="ABORTED",$[$.OUT_OF_RANGE=11]="OUT_OF_RANGE",$[$.UNIMPLEMENTED=12]="UNIMPLEMENTED",$[$.INTERNAL=13]="INTERNAL",$[$.UNAVAILABLE=14]="UNAVAILABLE",$[$.DATA_LOSS=15]="DATA_LOSS";/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */new ha([4294967295,4294967295],0);class hd{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function fr(r,e){return r.useProto3Json?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function ud(r,e){return r.useProto3Json?e.toBase64():e.toUint8Array()}function dd(r,e){return fr(r,e.toTimestamp())}function At(r){return J(!!r),W.fromTimestamp(function(t){const s=mt(t);return new ie(s.seconds,s.nanos)}(r))}function Ua(r,e){return mr(r,e).canonicalString()}function mr(r,e){const t=function(i){return new Y(["projects",i.projectId,"databases",i.database])}(r).child("documents");return e===void 0?t:t.child(e)}function fd(r){const e=Y.fromString(r);return J(Ed(e)),e}function pr(r,e){return Ua(r.databaseId,e.path)}function md(r){const e=fd(r);return e.length===4?Y.emptyPath():gd(e)}function pd(r){return new Y(["projects",r.databaseId.projectId,"databases",r.databaseId.database]).canonicalString()}function gd(r){return J(r.length>4&&r.get(4)==="documents"),r.popFirst(5)}function Co(r,e,t){return{name:pr(r,e),fields:t.value.mapValue.fields}}function yd(r,e){let t;if(e instanceof gs)t={update:Co(r,e.key,e.value)};else if(e instanceof Ba)t={delete:pr(r,e.key)};else if(e instanceof yt)t={update:Co(r,e.key,e.data),updateMask:wd(e.fieldMask)};else{if(!(e instanceof nd))return N();t={verify:pr(r,e.key)}}return e.fieldTransforms.length>0&&(t.updateTransforms=e.fieldTransforms.map(s=>function(n,a){const l=a.transform;if(l instanceof hs)return{fieldPath:a.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(l instanceof us)return{fieldPath:a.field.canonicalString(),appendMissingElements:{values:l.elements}};if(l instanceof ds)return{fieldPath:a.field.canonicalString(),removeAllFromArray:{values:l.elements}};if(l instanceof si)return{fieldPath:a.field.canonicalString(),increment:l.Pe};throw N()}(0,s))),e.precondition.isNone||(t.currentDocument=function(i,n){return n.updateTime!==void 0?{updateTime:dd(i,n.updateTime)}:n.exists!==void 0?{exists:n.exists}:N()}(r,e.precondition)),t}function vd(r,e){return r&&r.length>0?(J(e!==void 0),r.map(t=>function(i,n){let a=i.updateTime?At(i.updateTime):At(n);return a.isEqual(W.min())&&(a=At(n)),new sd(a,i.transformResults||[])}(t,e))):[]}function _d(r){let e=md(r.parent);const t=r.structuredQuery,s=t.from?t.from.length:0;let i=null;if(s>0){J(s===1);const m=t.from[0];m.allDescendants?i=m.collectionId:e=e.child(m.collectionId)}let n=[];t.where&&(n=function(p){const b=ja(p);return b instanceof Qe&&Aa(b)?b.getFilters():[b]}(t.where));let a=[];t.orderBy&&(a=function(p){return p.map(b=>function(C){return new ei(Tt(C.field),function(D){switch(D){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(C.direction))}(b))}(t.orderBy));let l=null;t.limit&&(l=function(p){let b;return b=typeof p=="object"?p.value:p,Cr(b)?null:b}(t.limit));let h=null;t.startAt&&(h=function(p){const b=!!p.before,A=p.values||[];return new Zs(A,b)}(t.startAt));let d=null;return t.endAt&&(d=function(p){const b=!p.before,A=p.values||[];return new Zs(A,b)}(t.endAt)),zu(e,i,a,n,l,"F",h,d)}function ja(r){return r.unaryFilter!==void 0?function(t){switch(t.unaryFilter.op){case"IS_NAN":const s=Tt(t.unaryFilter.field);return se.create(s,"==",{doubleValue:NaN});case"IS_NULL":const i=Tt(t.unaryFilter.field);return se.create(i,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const n=Tt(t.unaryFilter.field);return se.create(n,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const a=Tt(t.unaryFilter.field);return se.create(a,"!=",{nullValue:"NULL_VALUE"});default:return N()}}(r):r.fieldFilter!==void 0?function(t){return se.create(Tt(t.fieldFilter.field),function(i){switch(i){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return N()}}(t.fieldFilter.op),t.fieldFilter.value)}(r):r.compositeFilter!==void 0?function(t){return Qe.create(t.compositeFilter.filters.map(s=>ja(s)),function(i){switch(i){case"AND":return"and";case"OR":return"or";default:return N()}}(t.compositeFilter.op))}(r):N()}function Tt(r){return ae.fromServerFormat(r.fieldPath)}function wd(r){const e=[];return r.fields.forEach(t=>e.push(t.canonicalString())),{fieldPaths:e}}function Ed(r){return r.length>=4&&r.get(0)==="projects"&&r.get(2)==="databases"}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Td{constructor(e){this.ct=e}}function bd(r){const e=_d({parent:r.parent,structuredQuery:r.structuredQuery});return r.limitType==="LAST"?dr(e,e.limit,"L"):e}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Sd{constructor(){this.un=new Ad}addToCollectionParentIndex(e,t){return this.un.add(t),P.resolve()}getCollectionParents(e,t){return P.resolve(this.un.getEntries(t))}addFieldIndex(e,t){return P.resolve()}deleteFieldIndex(e,t){return P.resolve()}deleteAllFieldIndexes(e){return P.resolve()}createTargetIndexes(e,t){return P.resolve()}getDocumentsMatchingTarget(e,t){return P.resolve(null)}getIndexType(e,t){return P.resolve(0)}getFieldIndexes(e,t){return P.resolve([])}getNextCollectionGroupToUpdate(e){return P.resolve(null)}getMinOffset(e,t){return P.resolve(Xe.min())}getMinOffsetFromCollectionGroup(e,t){return P.resolve(Xe.min())}updateCollectionGroup(e,t,s){return P.resolve()}updateIndexEntries(e,t){return P.resolve()}}class Ad{constructor(){this.index={}}add(e){const t=e.lastSegment(),s=e.popLast(),i=this.index[t]||new ge(Y.comparator),n=!i.has(s);return this.index[t]=i.add(s),n}has(e){const t=e.lastSegment(),s=e.popLast(),i=this.index[t];return i&&i.has(s)}getEntries(e){return(this.index[e]||new ge(Y.comparator)).toArray()}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Dt{constructor(e){this.Ln=e}next(){return this.Ln+=2,this.Ln}static Bn(){return new Dt(0)}static kn(){return new Dt(-1)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Id{constructor(){this.changes=new Lt(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,Ie.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();const s=this.changes.get(t);return s!==void 0?P.resolve(s):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Cd{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Pd{constructor(e,t,s,i){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=s,this.indexManager=i}getDocument(e,t){let s=null;return this.documentOverlayCache.getOverlay(e,t).next(i=>(s=i,this.remoteDocumentCache.getEntry(e,t))).next(i=>(s!==null&&is(s.mutation,i,Pe.empty(),ie.now()),i))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next(s=>this.getLocalViewOfDocuments(e,s,pe()).next(()=>s))}getLocalViewOfDocuments(e,t,s=pe()){const i=ot();return this.populateOverlays(e,i,t).next(()=>this.computeViews(e,t,i,s).next(n=>{let a=Bs();return n.forEach((l,h)=>{a=a.insert(l,h.overlayedDocument)}),a}))}getOverlayedDocuments(e,t){const s=ot();return this.populateOverlays(e,s,t).next(()=>this.computeViews(e,t,s,pe()))}populateOverlays(e,t,s){const i=[];return s.forEach(n=>{t.has(n)||i.push(n)}),this.documentOverlayCache.getOverlays(e,i).next(n=>{n.forEach((a,l)=>{t.set(a,l)})})}computeViews(e,t,s,i){let n=ti();const a=ss(),l=function(){return ss()}();return t.forEach((h,d)=>{const m=s.get(d.key);i.has(d.key)&&(m===void 0||m.mutation instanceof yt)?n=n.insert(d.key,d):m!==void 0?(a.set(d.key,m.mutation.getFieldMask()),is(m.mutation,d,m.mutation.getFieldMask(),ie.now())):a.set(d.key,Pe.empty())}),this.recalculateAndSaveOverlays(e,n).next(h=>(h.forEach((d,m)=>a.set(d,m)),t.forEach((d,m)=>{var p;return l.set(d,new Cd(m,(p=a.get(d))!==null&&p!==void 0?p:null))}),l))}recalculateAndSaveOverlays(e,t){const s=ss();let i=new Ee((a,l)=>a-l),n=pe();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next(a=>{for(const l of a)l.keys().forEach(h=>{const d=t.get(h);if(d===null)return;let m=s.get(h)||Pe.empty();m=l.applyToLocalView(d,m),s.set(h,m);const p=(i.get(l.batchId)||pe()).add(h);i=i.insert(l.batchId,p)})}).next(()=>{const a=[],l=i.getReverseIterator();for(;l.hasNext();){const h=l.getNext(),d=h.key,m=h.value,p=ka();m.forEach(b=>{if(!n.has(b)){const A=$a(t.get(b),s.get(b));A!==null&&p.set(b,A),n=n.add(b)}}),a.push(this.documentOverlayCache.saveOverlays(e,d,p))}return P.waitFor(a)}).next(()=>s)}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next(s=>this.recalculateAndSaveOverlays(e,s))}getDocumentsMatchingQuery(e,t,s,i){return function(a){return M.isDocumentKey(a.path)&&a.collectionGroup===null&&a.filters.length===0}(t)?this.getDocumentsMatchingDocumentQuery(e,t.path):Uu(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,s,i):this.getDocumentsMatchingCollectionQuery(e,t,s,i)}getNextDocuments(e,t,s,i){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,s,i).next(n=>{const a=i-n.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,s.largestBatchId,i-n.size):P.resolve(ot());let l=-1,h=n;return a.next(d=>P.forEach(d,(m,p)=>(l<p.largestBatchId&&(l=p.largestBatchId),n.get(m)?P.resolve():this.remoteDocumentCache.getEntry(e,m).next(b=>{h=h.insert(m,b)}))).next(()=>this.populateOverlays(e,d,n)).next(()=>this.computeViews(e,h,d,pe())).next(m=>({batchId:l,changes:La(m)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new M(t)).next(s=>{let i=Bs();return s.isFoundDocument()&&(i=i.insert(s.key,s)),i})}getDocumentsMatchingCollectionGroupQuery(e,t,s,i){const n=t.collectionGroup;let a=Bs();return this.indexManager.getCollectionParents(e,n).next(l=>P.forEach(l,h=>{const d=function(p,b){return new hi(b,null,p.explicitOrderBy.slice(),p.filters.slice(),p.limit,p.limitType,p.startAt,p.endAt)}(t,h.child(n));return this.getDocumentsMatchingCollectionQuery(e,d,s,i).next(m=>{m.forEach((p,b)=>{a=a.insert(p,b)})})}).next(()=>a))}getDocumentsMatchingCollectionQuery(e,t,s,i){let n;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,s.largestBatchId).next(a=>(n=a,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,s,n,i))).next(a=>{n.forEach((h,d)=>{const m=d.getKey();a.get(m)===null&&(a=a.insert(m,Ie.newInvalidDocument(m)))});let l=Bs();return a.forEach((h,d)=>{const m=n.get(h);m!==void 0&&is(m.mutation,d,Pe.empty(),ie.now()),Lr(t,d)&&(l=l.insert(h,d))}),l})}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Rd{constructor(e){this.serializer=e,this.hr=new Map,this.Pr=new Map}getBundleMetadata(e,t){return P.resolve(this.hr.get(t))}saveBundleMetadata(e,t){return this.hr.set(t.id,function(i){return{id:i.id,version:i.version,createTime:At(i.createTime)}}(t)),P.resolve()}getNamedQuery(e,t){return P.resolve(this.Pr.get(t))}saveNamedQuery(e,t){return this.Pr.set(t.name,function(i){return{name:i.name,query:bd(i.bundledQuery),readTime:At(i.readTime)}}(t)),P.resolve()}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Dd{constructor(){this.overlays=new Ee(M.comparator),this.Ir=new Map}getOverlay(e,t){return P.resolve(this.overlays.get(t))}getOverlays(e,t){const s=ot();return P.forEach(t,i=>this.getOverlay(e,i).next(n=>{n!==null&&s.set(i,n)})).next(()=>s)}saveOverlays(e,t,s){return s.forEach((i,n)=>{this.ht(e,t,n)}),P.resolve()}removeOverlaysForBatchId(e,t,s){const i=this.Ir.get(s);return i!==void 0&&(i.forEach(n=>this.overlays=this.overlays.remove(n)),this.Ir.delete(s)),P.resolve()}getOverlaysForCollection(e,t,s){const i=ot(),n=t.length+1,a=new M(t.child("")),l=this.overlays.getIteratorFrom(a);for(;l.hasNext();){const h=l.getNext().value,d=h.getKey();if(!t.isPrefixOf(d.path))break;d.path.length===n&&h.largestBatchId>s&&i.set(h.getKey(),h)}return P.resolve(i)}getOverlaysForCollectionGroup(e,t,s,i){let n=new Ee((d,m)=>d-m);const a=this.overlays.getIterator();for(;a.hasNext();){const d=a.getNext().value;if(d.getKey().getCollectionGroup()===t&&d.largestBatchId>s){let m=n.get(d.largestBatchId);m===null&&(m=ot(),n=n.insert(d.largestBatchId,m)),m.set(d.getKey(),d)}}const l=ot(),h=n.getIterator();for(;h.hasNext()&&(h.getNext().value.forEach((d,m)=>l.set(d,m)),!(l.size()>=i)););return P.resolve(l)}ht(e,t,s){const i=this.overlays.get(s.key);if(i!==null){const a=this.Ir.get(i.largestBatchId).delete(s.key);this.Ir.set(i.largestBatchId,a)}this.overlays=this.overlays.insert(s.key,new ad(t,s));let n=this.Ir.get(t);n===void 0&&(n=pe(),this.Ir.set(t,n)),this.Ir.set(t,n.add(s.key))}}/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class xd{constructor(){this.sessionToken=xe.EMPTY_BYTE_STRING}getSessionToken(e){return P.resolve(this.sessionToken)}setSessionToken(e,t){return this.sessionToken=t,P.resolve()}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Or{constructor(){this.Tr=new ge(te.Er),this.dr=new ge(te.Ar)}isEmpty(){return this.Tr.isEmpty()}addReference(e,t){const s=new te(e,t);this.Tr=this.Tr.add(s),this.dr=this.dr.add(s)}Rr(e,t){e.forEach(s=>this.addReference(s,t))}removeReference(e,t){this.Vr(new te(e,t))}mr(e,t){e.forEach(s=>this.removeReference(s,t))}gr(e){const t=new M(new Y([])),s=new te(t,e),i=new te(t,e+1),n=[];return this.dr.forEachInRange([s,i],a=>{this.Vr(a),n.push(a.key)}),n}pr(){this.Tr.forEach(e=>this.Vr(e))}Vr(e){this.Tr=this.Tr.delete(e),this.dr=this.dr.delete(e)}yr(e){const t=new M(new Y([])),s=new te(t,e),i=new te(t,e+1);let n=pe();return this.dr.forEachInRange([s,i],a=>{n=n.add(a.key)}),n}containsKey(e){const t=new te(e,0),s=this.Tr.firstAfterOrEqual(t);return s!==null&&e.isEqual(s.key)}}class te{constructor(e,t){this.key=e,this.wr=t}static Er(e,t){return M.comparator(e.key,t.key)||G(e.wr,t.wr)}static Ar(e,t){return G(e.wr,t.wr)||M.comparator(e.key,t.key)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ld{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.Sr=1,this.br=new ge(te.Er)}checkEmpty(e){return P.resolve(this.mutationQueue.length===0)}addMutationBatch(e,t,s,i){const n=this.Sr;this.Sr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const a=new od(n,t,s,i);this.mutationQueue.push(a);for(const l of i)this.br=this.br.add(new te(l.key,n)),this.indexManager.addToCollectionParentIndex(e,l.key.path.popLast());return P.resolve(a)}lookupMutationBatch(e,t){return P.resolve(this.Dr(t))}getNextMutationBatchAfterBatchId(e,t){const s=t+1,i=this.vr(s),n=i<0?0:i;return P.resolve(this.mutationQueue.length>n?this.mutationQueue[n]:null)}getHighestUnacknowledgedBatchId(){return P.resolve(this.mutationQueue.length===0?-1:this.Sr-1)}getAllMutationBatches(e){return P.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const s=new te(t,0),i=new te(t,Number.POSITIVE_INFINITY),n=[];return this.br.forEachInRange([s,i],a=>{const l=this.Dr(a.wr);n.push(l)}),P.resolve(n)}getAllMutationBatchesAffectingDocumentKeys(e,t){let s=new ge(G);return t.forEach(i=>{const n=new te(i,0),a=new te(i,Number.POSITIVE_INFINITY);this.br.forEachInRange([n,a],l=>{s=s.add(l.wr)})}),P.resolve(this.Cr(s))}getAllMutationBatchesAffectingQuery(e,t){const s=t.path,i=s.length+1;let n=s;M.isDocumentKey(n)||(n=n.child(""));const a=new te(new M(n),0);let l=new ge(G);return this.br.forEachWhile(h=>{const d=h.key.path;return!!s.isPrefixOf(d)&&(d.length===i&&(l=l.add(h.wr)),!0)},a),P.resolve(this.Cr(l))}Cr(e){const t=[];return e.forEach(s=>{const i=this.Dr(s);i!==null&&t.push(i)}),t}removeMutationBatch(e,t){J(this.Fr(t.batchId,"removed")===0),this.mutationQueue.shift();let s=this.br;return P.forEach(t.mutations,i=>{const n=new te(i.key,t.batchId);return s=s.delete(n),this.referenceDelegate.markPotentiallyOrphaned(e,i.key)}).next(()=>{this.br=s})}On(e){}containsKey(e,t){const s=new te(t,0),i=this.br.firstAfterOrEqual(s);return P.resolve(t.isEqual(i&&i.key))}performConsistencyCheck(e){return this.mutationQueue.length,P.resolve()}Fr(e,t){return this.vr(e)}vr(e){return this.mutationQueue.length===0?0:e-this.mutationQueue[0].batchId}Dr(e){const t=this.vr(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class kd{constructor(e){this.Mr=e,this.docs=function(){return new Ee(M.comparator)}(),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const s=t.key,i=this.docs.get(s),n=i?i.size:0,a=this.Mr(t);return this.docs=this.docs.insert(s,{document:t.mutableCopy(),size:a}),this.size+=a-n,this.indexManager.addToCollectionParentIndex(e,s.path.popLast())}removeEntry(e){const t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const s=this.docs.get(t);return P.resolve(s?s.document.mutableCopy():Ie.newInvalidDocument(t))}getEntries(e,t){let s=ti();return t.forEach(i=>{const n=this.docs.get(i);s=s.insert(i,n?n.document.mutableCopy():Ie.newInvalidDocument(i))}),P.resolve(s)}getDocumentsMatchingQuery(e,t,s,i){let n=ti();const a=t.path,l=new M(a.child("")),h=this.docs.getIteratorFrom(l);for(;h.hasNext();){const{key:d,value:{document:m}}=h.getNext();if(!a.isPrefixOf(d.path))break;d.path.length>a.length+1||wu(_u(m),s)<=0||(i.has(m.key)||Lr(t,m))&&(n=n.insert(m.key,m.mutableCopy()))}return P.resolve(n)}getAllFromCollectionGroup(e,t,s,i){N()}Or(e,t){return P.forEach(this.docs,s=>t(s))}newChangeBuffer(e){return new Vd(this)}getSize(e){return P.resolve(this.size)}}class Vd extends Id{constructor(e){super(),this.cr=e}applyChanges(e){const t=[];return this.changes.forEach((s,i)=>{i.isValidDocument()?t.push(this.cr.addEntry(e,i)):this.cr.removeEntry(s)}),P.waitFor(t)}getFromCache(e,t){return this.cr.getEntry(e,t)}getAllFromCache(e,t){return this.cr.getEntries(e,t)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Od{constructor(e){this.persistence=e,this.Nr=new Lt(t=>Dr(t),xr),this.lastRemoteSnapshotVersion=W.min(),this.highestTargetId=0,this.Lr=0,this.Br=new Or,this.targetCount=0,this.kr=Dt.Bn()}forEachTarget(e,t){return this.Nr.forEach((s,i)=>t(i)),P.resolve()}getLastRemoteSnapshotVersion(e){return P.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return P.resolve(this.Lr)}allocateTargetId(e){return this.highestTargetId=this.kr.next(),P.resolve(this.highestTargetId)}setTargetsMetadata(e,t,s){return s&&(this.lastRemoteSnapshotVersion=s),t>this.Lr&&(this.Lr=t),P.resolve()}Kn(e){this.Nr.set(e.target,e);const t=e.targetId;t>this.highestTargetId&&(this.kr=new Dt(t),this.highestTargetId=t),e.sequenceNumber>this.Lr&&(this.Lr=e.sequenceNumber)}addTargetData(e,t){return this.Kn(t),this.targetCount+=1,P.resolve()}updateTargetData(e,t){return this.Kn(t),P.resolve()}removeTargetData(e,t){return this.Nr.delete(t.target),this.Br.gr(t.targetId),this.targetCount-=1,P.resolve()}removeTargets(e,t,s){let i=0;const n=[];return this.Nr.forEach((a,l)=>{l.sequenceNumber<=t&&s.get(l.targetId)===null&&(this.Nr.delete(a),n.push(this.removeMatchingKeysForTargetId(e,l.targetId)),i++)}),P.waitFor(n).next(()=>i)}getTargetCount(e){return P.resolve(this.targetCount)}getTargetData(e,t){const s=this.Nr.get(t)||null;return P.resolve(s)}addMatchingKeys(e,t,s){return this.Br.Rr(t,s),P.resolve()}removeMatchingKeys(e,t,s){this.Br.mr(t,s);const i=this.persistence.referenceDelegate,n=[];return i&&t.forEach(a=>{n.push(i.markPotentiallyOrphaned(e,a))}),P.waitFor(n)}removeMatchingKeysForTargetId(e,t){return this.Br.gr(t),P.resolve()}getMatchingKeysForTargetId(e,t){const s=this.Br.yr(t);return P.resolve(s)}containsKey(e,t){return P.resolve(this.Br.containsKey(t))}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Md{constructor(e,t){this.qr={},this.overlays={},this.Qr=new _a(0),this.Kr=!1,this.Kr=!0,this.$r=new xd,this.referenceDelegate=e(this),this.Ur=new Od(this),this.indexManager=new Sd,this.remoteDocumentCache=function(i){return new kd(i)}(s=>this.referenceDelegate.Wr(s)),this.serializer=new Td(t),this.Gr=new Rd(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.Kr=!1,Promise.resolve()}get started(){return this.Kr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new Dd,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let s=this.qr[e.toKey()];return s||(s=new Ld(t,this.referenceDelegate),this.qr[e.toKey()]=s),s}getGlobalsCache(){return this.$r}getTargetCache(){return this.Ur}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Gr}runTransaction(e,t,s){V("MemoryPersistence","Starting transaction:",e);const i=new Nd(this.Qr.next());return this.referenceDelegate.zr(),s(i).next(n=>this.referenceDelegate.jr(i).next(()=>n)).toPromise().then(n=>(i.raiseOnCommittedEvent(),n))}Hr(e,t){return P.or(Object.values(this.qr).map(s=>()=>s.containsKey(e,t)))}}class Nd extends Tu{constructor(e){super(),this.currentSequenceNumber=e}}class Mr{constructor(e){this.persistence=e,this.Jr=new Or,this.Yr=null}static Zr(e){return new Mr(e)}get Xr(){if(this.Yr)return this.Yr;throw N()}addReference(e,t,s){return this.Jr.addReference(s,t),this.Xr.delete(s.toString()),P.resolve()}removeReference(e,t,s){return this.Jr.removeReference(s,t),this.Xr.add(s.toString()),P.resolve()}markPotentiallyOrphaned(e,t){return this.Xr.add(t.toString()),P.resolve()}removeTarget(e,t){this.Jr.gr(t.targetId).forEach(i=>this.Xr.add(i.toString()));const s=this.persistence.getTargetCache();return s.getMatchingKeysForTargetId(e,t.targetId).next(i=>{i.forEach(n=>this.Xr.add(n.toString()))}).next(()=>s.removeTargetData(e,t))}zr(){this.Yr=new Set}jr(e){const t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return P.forEach(this.Xr,s=>{const i=M.fromPath(s);return this.ei(e,i).next(n=>{n||t.removeEntry(i,W.min())})}).next(()=>(this.Yr=null,t.apply(e)))}updateLimboDocument(e,t){return this.ei(e,t).next(s=>{s?this.Xr.delete(t.toString()):this.Xr.add(t.toString())})}Wr(e){return 0}ei(e,t){return P.or([()=>P.resolve(this.Jr.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Hr(e,t)])}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Nr{constructor(e,t,s,i){this.targetId=e,this.fromCache=t,this.$i=s,this.Ui=i}static Wi(e,t){let s=pe(),i=pe();for(const n of t.docChanges)switch(n.type){case 0:s=s.add(n.doc.key);break;case 1:i=i.add(n.doc.key)}return new Nr(e,t.fromCache,s,i)}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Fd{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class $d{constructor(){this.Gi=!1,this.zi=!1,this.ji=100,this.Hi=function(){return Kc()?8:bu(Hc())>0?6:4}()}initialize(e,t){this.Ji=e,this.indexManager=t,this.Gi=!0}getDocumentsMatchingQuery(e,t,s,i){const n={result:null};return this.Yi(e,t).next(a=>{n.result=a}).next(()=>{if(!n.result)return this.Zi(e,t,i,s).next(a=>{n.result=a})}).next(()=>{if(n.result)return;const a=new Fd;return this.Xi(e,t,a).next(l=>{if(n.result=l,this.zi)return this.es(e,t,a,l.size)})}).next(()=>n.result)}es(e,t,s,i){return s.documentReadCount<this.ji?(Xt()<=z.DEBUG&&V("QueryEngine","SDK will not create cache indexes for query:",Qt(t),"since it only creates cache indexes for collection contains","more than or equal to",this.ji,"documents"),P.resolve()):(Xt()<=z.DEBUG&&V("QueryEngine","Query:",Qt(t),"scans",s.documentReadCount,"local documents and returns",i,"documents as results."),s.documentReadCount>this.Hi*i?(Xt()<=z.DEBUG&&V("QueryEngine","The SDK decides to create cache indexes for query:",Qt(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,ht(t))):P.resolve())}Yi(e,t){if(To(t))return P.resolve(null);let s=ht(t);return this.indexManager.getIndexType(e,s).next(i=>i===0?null:(t.limit!==null&&i===1&&(t=dr(t,null,"F"),s=ht(t)),this.indexManager.getDocumentsMatchingTarget(e,s).next(n=>{const a=pe(...n);return this.Ji.getDocuments(e,a).next(l=>this.indexManager.getMinOffset(e,s).next(h=>{const d=this.ts(t,l);return this.ns(t,d,a,h.readTime)?this.Yi(e,dr(t,null,"F")):this.rs(e,d,t,h)}))})))}Zi(e,t,s,i){return To(t)||i.isEqual(W.min())?P.resolve(null):this.Ji.getDocuments(e,s).next(n=>{const a=this.ts(t,n);return this.ns(t,a,s,i)?P.resolve(null):(Xt()<=z.DEBUG&&V("QueryEngine","Re-using previous result from %s to execute query: %s",i.toString(),Qt(t)),this.rs(e,a,t,vu(i,-1)).next(l=>l))})}ts(e,t){let s=new ge(Gu(e));return t.forEach((i,n)=>{Lr(e,n)&&(s=s.add(n))}),s}ns(e,t,s,i){if(e.limit===null)return!1;if(s.size!==t.size)return!0;const n=e.limitType==="F"?t.last():t.first();return!!n&&(n.hasPendingWrites||n.version.compareTo(i)>0)}Xi(e,t,s){return Xt()<=z.DEBUG&&V("QueryEngine","Using full collection scan to execute query:",Qt(t)),this.Ji.getDocumentsMatchingQuery(e,t,Xe.min(),s)}rs(e,t,s,i){return this.Ji.getDocumentsMatchingQuery(e,s,i).next(n=>(t.forEach(a=>{n=n.insert(a.key,a)}),n))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class zd{constructor(e,t,s,i){this.persistence=e,this.ss=t,this.serializer=i,this.os=new Ee(G),this._s=new Lt(n=>Dr(n),xr),this.us=new Map,this.cs=e.getRemoteDocumentCache(),this.Ur=e.getTargetCache(),this.Gr=e.getBundleCache(),this.ls(s)}ls(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new Pd(this.cs,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.cs.setIndexManager(this.indexManager),this.ss.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.os))}}function Bd(r,e,t,s){return new zd(r,e,t,s)}async function Ga(r,e){const t=q(r);return await t.persistence.runTransaction("Handle user change","readonly",s=>{let i;return t.mutationQueue.getAllMutationBatches(s).next(n=>(i=n,t.ls(e),t.mutationQueue.getAllMutationBatches(s))).next(n=>{const a=[],l=[];let h=pe();for(const d of i){a.push(d.batchId);for(const m of d.mutations)h=h.add(m.key)}for(const d of n){l.push(d.batchId);for(const m of d.mutations)h=h.add(m.key)}return t.localDocuments.getDocuments(s,h).next(d=>({hs:d,removedBatchIds:a,addedBatchIds:l}))})})}function Ud(r,e){const t=q(r);return t.persistence.runTransaction("Acknowledge batch","readwrite-primary",s=>{const i=e.batch.keys(),n=t.cs.newChangeBuffer({trackRemovals:!0});return function(l,h,d,m){const p=d.batch,b=p.keys();let A=P.resolve();return b.forEach(C=>{A=A.next(()=>m.getEntry(h,C)).next(L=>{const D=d.docVersions.get(C);J(D!==null),L.version.compareTo(D)<0&&(p.applyToRemoteDocument(L,d),L.isValidDocument()&&(L.setReadTime(d.commitVersion),m.addEntry(L)))})}),A.next(()=>l.mutationQueue.removeMutationBatch(h,p))}(t,s,e,n).next(()=>n.apply(s)).next(()=>t.mutationQueue.performConsistencyCheck(s)).next(()=>t.documentOverlayCache.removeOverlaysForBatchId(s,i,e.batch.batchId)).next(()=>t.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(s,function(l){let h=pe();for(let d=0;d<l.mutationResults.length;++d)l.mutationResults[d].transformResults.length>0&&(h=h.add(l.batch.mutations[d].key));return h}(e))).next(()=>t.localDocuments.getDocuments(s,i))})}function jd(r){const e=q(r);return e.persistence.runTransaction("Get last remote snapshot version","readonly",t=>e.Ur.getLastRemoteSnapshotVersion(t))}function Gd(r,e){const t=q(r);return t.persistence.runTransaction("Get next mutation batch","readonly",s=>(e===void 0&&(e=-1),t.mutationQueue.getNextMutationBatchAfterBatchId(s,e)))}class Po{constructor(){this.activeTargetIds=Xu()}fs(e){this.activeTargetIds=this.activeTargetIds.add(e)}gs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Vs(){const e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class qd{constructor(){this.so=new Po,this.oo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,s){}addLocalQueryTarget(e,t=!0){return t&&this.so.fs(e),this.oo[e]||"not-current"}updateQueryState(e,t,s){this.oo[e]=t}removeLocalQueryTarget(e){this.so.gs(e)}isLocalQueryTarget(e){return this.so.activeTargetIds.has(e)}clearQueryState(e){delete this.oo[e]}getAllActiveQueryTargets(){return this.so.activeTargetIds}isActiveQueryTarget(e){return this.so.activeTargetIds.has(e)}start(){return this.so=new Po,Promise.resolve()}handleUserChange(e,t,s){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Hd{_o(e){}shutdown(){}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ro{constructor(){this.ao=()=>this.uo(),this.co=()=>this.lo(),this.ho=[],this.Po()}_o(e){this.ho.push(e)}shutdown(){window.removeEventListener("online",this.ao),window.removeEventListener("offline",this.co)}Po(){window.addEventListener("online",this.ao),window.addEventListener("offline",this.co)}uo(){V("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.ho)e(0)}lo(){V("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.ho)e(1)}static D(){return typeof window<"u"&&window.addEventListener!==void 0&&window.removeEventListener!==void 0}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let Us=null;function Ki(){return Us===null?Us=function(){return 268435456+Math.round(2147483648*Math.random())}():Us++,"0x"+Us.toString(16)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Wd={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Kd{constructor(e){this.Io=e.Io,this.To=e.To}Eo(e){this.Ao=e}Ro(e){this.Vo=e}mo(e){this.fo=e}onMessage(e){this.po=e}close(){this.To()}send(e){this.Io(e)}yo(){this.Ao()}wo(){this.Vo()}So(e){this.fo(e)}bo(e){this.po(e)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const fe="WebChannelConnection";class Yd extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;const s=t.ssl?"https":"http",i=encodeURIComponent(this.databaseId.projectId),n=encodeURIComponent(this.databaseId.database);this.Do=s+"://"+t.host,this.vo=`projects/${i}/databases/${n}`,this.Co=this.databaseId.database==="(default)"?`project_id=${i}`:`project_id=${i}&database_id=${n}`}get Fo(){return!1}Mo(t,s,i,n,a){const l=Ki(),h=this.xo(t,s.toUriEncodedString());V("RestConnection",`Sending RPC '${t}' ${l}:`,h,i);const d={"google-cloud-resource-prefix":this.vo,"x-goog-request-params":this.Co};return this.Oo(d,n,a),this.No(t,h,d,i).then(m=>(V("RestConnection",`Received RPC '${t}' ${l}: `,m),m),m=>{throw Ys("RestConnection",`RPC '${t}' ${l} failed with error: `,m,"url: ",h,"request:",i),m})}Lo(t,s,i,n,a,l){return this.Mo(t,s,i,n,a)}Oo(t,s,i){t["X-Goog-Api-Client"]=function(){return"gl-js/ fire/"+xt}(),t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),s&&s.headers.forEach((n,a)=>t[a]=n),i&&i.headers.forEach((n,a)=>t[a]=n)}xo(t,s){const i=Wd[t];return`${this.Do}/v1/${s}:${i}`}terminate(){}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}No(e,t,s,i){const n=Ki();return new Promise((a,l)=>{const h=new ua;h.setWithCredentials(!0),h.listenOnce(da.COMPLETE,()=>{try{switch(h.getLastErrorCode()){case js.NO_ERROR:const m=h.getResponseJson();V(fe,`XHR for RPC '${e}' ${n} received:`,JSON.stringify(m)),a(m);break;case js.TIMEOUT:V(fe,`RPC '${e}' ${n} timed out`),l(new O(R.DEADLINE_EXCEEDED,"Request time out"));break;case js.HTTP_ERROR:const p=h.getStatus();if(V(fe,`RPC '${e}' ${n} failed with status:`,p,"response text:",h.getResponseText()),p>0){let b=h.getResponseJson();Array.isArray(b)&&(b=b[0]);const A=b==null?void 0:b.error;if(A&&A.status&&A.message){const C=function(D){const F=D.toLowerCase().replace(/_/g,"-");return Object.values(R).indexOf(F)>=0?F:R.UNKNOWN}(A.status);l(new O(C,A.message))}else l(new O(R.UNKNOWN,"Server responded with status "+h.getStatus()))}else l(new O(R.UNAVAILABLE,"Connection failed."));break;default:N()}}finally{V(fe,`RPC '${e}' ${n} completed.`)}});const d=JSON.stringify(i);V(fe,`RPC '${e}' ${n} sending request:`,i),h.send(t,"POST",d,s,15)})}Bo(e,t,s){const i=Ki(),n=[this.Do,"/","google.firestore.v1.Firestore","/",e,"/channel"],a=pa(),l=ma(),h={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},d=this.longPollingOptions.timeoutSeconds;d!==void 0&&(h.longPollingTimeout=Math.round(1e3*d)),this.useFetchStreams&&(h.useFetchStreams=!0),this.Oo(h.initMessageHeaders,t,s),h.encodeInitMessageHeaders=!0;const m=n.join("");V(fe,`Creating RPC '${e}' stream ${i}: ${m}`,h);const p=a.createWebChannel(m,h);let b=!1,A=!1;const C=new Kd({Io:D=>{A?V(fe,`Not sending because RPC '${e}' stream ${i} is closed:`,D):(b||(V(fe,`Opening RPC '${e}' stream ${i} transport.`),p.open(),b=!0),V(fe,`RPC '${e}' stream ${i} sending:`,D),p.send(D))},To:()=>p.close()}),L=(D,F,U)=>{D.listen(F,X=>{try{U(X)}catch(le){setTimeout(()=>{throw le},0)}})};return L(p,Jt.EventType.OPEN,()=>{A||(V(fe,`RPC '${e}' stream ${i} transport opened.`),C.yo())}),L(p,Jt.EventType.CLOSE,()=>{A||(A=!0,V(fe,`RPC '${e}' stream ${i} transport closed`),C.So())}),L(p,Jt.EventType.ERROR,D=>{A||(A=!0,Ys(fe,`RPC '${e}' stream ${i} transport errored:`,D),C.So(new O(R.UNAVAILABLE,"The operation could not be completed")))}),L(p,Jt.EventType.MESSAGE,D=>{var F;if(!A){const U=D.data[0];J(!!U);const X=U,le=X.error||((F=X[0])===null||F===void 0?void 0:F.error);if(le){V(fe,`RPC '${e}' stream ${i} received error:`,le);const et=le.status;let _e=function(v){const _=Z[v];if(_!==void 0)return cd(_)}(et),E=le.message;_e===void 0&&(_e=R.INTERNAL,E="Unknown error status: "+et+" with message "+le.message),A=!0,C.So(new O(_e,E)),p.close()}else V(fe,`RPC '${e}' stream ${i} received:`,U),C.bo(U)}}),L(l,fa.STAT_EVENT,D=>{D.stat===lr.PROXY?V(fe,`RPC '${e}' stream ${i} detected buffering proxy`):D.stat===lr.NOPROXY&&V(fe,`RPC '${e}' stream ${i} detected no buffering proxy`)}),setTimeout(()=>{C.wo()},0),C}}function Yi(){return typeof document<"u"?document:null}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function fi(r){return new hd(r,!0)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class qa{constructor(e,t,s=1e3,i=1.5,n=6e4){this.ui=e,this.timerId=t,this.ko=s,this.qo=i,this.Qo=n,this.Ko=0,this.$o=null,this.Uo=Date.now(),this.reset()}reset(){this.Ko=0}Wo(){this.Ko=this.Qo}Go(e){this.cancel();const t=Math.floor(this.Ko+this.zo()),s=Math.max(0,Date.now()-this.Uo),i=Math.max(0,t-s);i>0&&V("ExponentialBackoff",`Backing off for ${i} ms (base delay: ${this.Ko} ms, delay with jitter: ${t} ms, last attempt: ${s} ms ago)`),this.$o=this.ui.enqueueAfterDelay(this.timerId,i,()=>(this.Uo=Date.now(),e())),this.Ko*=this.qo,this.Ko<this.ko&&(this.Ko=this.ko),this.Ko>this.Qo&&(this.Ko=this.Qo)}jo(){this.$o!==null&&(this.$o.skipDelay(),this.$o=null)}cancel(){this.$o!==null&&(this.$o.cancel(),this.$o=null)}zo(){return(Math.random()-.5)*this.Ko}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Xd{constructor(e,t,s,i,n,a,l,h){this.ui=e,this.Ho=s,this.Jo=i,this.connection=n,this.authCredentialsProvider=a,this.appCheckCredentialsProvider=l,this.listener=h,this.state=0,this.Yo=0,this.Zo=null,this.Xo=null,this.stream=null,this.e_=0,this.t_=new qa(e,t)}n_(){return this.state===1||this.state===5||this.r_()}r_(){return this.state===2||this.state===3}start(){this.e_=0,this.state!==4?this.auth():this.i_()}async stop(){this.n_()&&await this.close(0)}s_(){this.state=0,this.t_.reset()}o_(){this.r_()&&this.Zo===null&&(this.Zo=this.ui.enqueueAfterDelay(this.Ho,6e4,()=>this.__()))}a_(e){this.u_(),this.stream.send(e)}async __(){if(this.r_())return this.close(0)}u_(){this.Zo&&(this.Zo.cancel(),this.Zo=null)}c_(){this.Xo&&(this.Xo.cancel(),this.Xo=null)}async close(e,t){this.u_(),this.c_(),this.t_.cancel(),this.Yo++,e!==4?this.t_.reset():t&&t.code===R.RESOURCE_EXHAUSTED?(ft(t.toString()),ft("Using maximum backoff delay to prevent overloading the backend."),this.t_.Wo()):t&&t.code===R.UNAUTHENTICATED&&this.state!==3&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),this.stream!==null&&(this.l_(),this.stream.close(),this.stream=null),this.state=e,await this.listener.mo(t)}l_(){}auth(){this.state=1;const e=this.h_(this.Yo),t=this.Yo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([s,i])=>{this.Yo===t&&this.P_(s,i)},s=>{e(()=>{const i=new O(R.UNKNOWN,"Fetching auth token failed: "+s.message);return this.I_(i)})})}P_(e,t){const s=this.h_(this.Yo);this.stream=this.T_(e,t),this.stream.Eo(()=>{s(()=>this.listener.Eo())}),this.stream.Ro(()=>{s(()=>(this.state=2,this.Xo=this.ui.enqueueAfterDelay(this.Jo,1e4,()=>(this.r_()&&(this.state=3),Promise.resolve())),this.listener.Ro()))}),this.stream.mo(i=>{s(()=>this.I_(i))}),this.stream.onMessage(i=>{s(()=>++this.e_==1?this.E_(i):this.onNext(i))})}i_(){this.state=5,this.t_.Go(async()=>{this.state=0,this.start()})}I_(e){return V("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}h_(e){return t=>{this.ui.enqueueAndForget(()=>this.Yo===e?t():(V("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class Qd extends Xd{constructor(e,t,s,i,n,a){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,s,i,a),this.serializer=n}get V_(){return this.e_>0}start(){this.lastStreamToken=void 0,super.start()}l_(){this.V_&&this.m_([])}T_(e,t){return this.connection.Bo("Write",e,t)}E_(e){return J(!!e.streamToken),this.lastStreamToken=e.streamToken,J(!e.writeResults||e.writeResults.length===0),this.listener.f_()}onNext(e){J(!!e.streamToken),this.lastStreamToken=e.streamToken,this.t_.reset();const t=vd(e.writeResults,e.commitTime),s=At(e.commitTime);return this.listener.g_(s,t)}p_(){const e={};e.database=pd(this.serializer),this.a_(e)}m_(e){const t={streamToken:this.lastStreamToken,writes:e.map(s=>yd(this.serializer,s))};this.a_(t)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Jd extends class{}{constructor(e,t,s,i){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=s,this.serializer=i,this.y_=!1}w_(){if(this.y_)throw new O(R.FAILED_PRECONDITION,"The client has already been terminated.")}Mo(e,t,s,i){return this.w_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([n,a])=>this.connection.Mo(e,mr(t,s),i,n,a)).catch(n=>{throw n.name==="FirebaseError"?(n.code===R.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),n):new O(R.UNKNOWN,n.toString())})}Lo(e,t,s,i,n){return this.w_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([a,l])=>this.connection.Lo(e,mr(t,s),i,a,l,n)).catch(a=>{throw a.name==="FirebaseError"?(a.code===R.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),a):new O(R.UNKNOWN,a.toString())})}terminate(){this.y_=!0,this.connection.terminate()}}class Zd{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.S_=0,this.b_=null,this.D_=!0}v_(){this.S_===0&&(this.C_("Unknown"),this.b_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.b_=null,this.F_("Backend didn't respond within 10 seconds."),this.C_("Offline"),Promise.resolve())))}M_(e){this.state==="Online"?this.C_("Unknown"):(this.S_++,this.S_>=1&&(this.x_(),this.F_(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.C_("Offline")))}set(e){this.x_(),this.S_=0,e==="Online"&&(this.D_=!1),this.C_(e)}C_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}F_(e){const t=`Could not reach Cloud Firestore backend. ${e}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.D_?(ft(t),this.D_=!1):V("OnlineStateTracker",t)}x_(){this.b_!==null&&(this.b_.cancel(),this.b_=null)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ef{constructor(e,t,s,i,n){this.localStore=e,this.datastore=t,this.asyncQueue=s,this.remoteSyncer={},this.O_=[],this.N_=new Map,this.L_=new Set,this.B_=[],this.k_=n,this.k_._o(a=>{s.enqueueAndForget(async()=>{vs(this)&&(V("RemoteStore","Restarting streams for network reachability change."),await async function(h){const d=q(h);d.L_.add(4),await ys(d),d.q_.set("Unknown"),d.L_.delete(4),await mi(d)}(this))})}),this.q_=new Zd(s,i)}}async function mi(r){if(vs(r))for(const e of r.B_)await e(!0)}async function ys(r){for(const e of r.B_)await e(!1)}function vs(r){return q(r).L_.size===0}async function Ha(r,e,t){if(!ci(e))throw e;r.L_.add(1),await ys(r),r.q_.set("Offline"),t||(t=()=>jd(r.localStore)),r.asyncQueue.enqueueRetryable(async()=>{V("RemoteStore","Retrying IndexedDB access"),await t(),r.L_.delete(1),await mi(r)})}function Wa(r,e){return e().catch(t=>Ha(r,t,e))}async function pi(r){const e=q(r),t=Je(e);let s=e.O_.length>0?e.O_[e.O_.length-1].batchId:-1;for(;tf(e);)try{const i=await Gd(e.localStore,s);if(i===null){e.O_.length===0&&t.o_();break}s=i.batchId,sf(e,i)}catch(i){await Ha(e,i)}Ka(e)&&Ya(e)}function tf(r){return vs(r)&&r.O_.length<10}function sf(r,e){r.O_.push(e);const t=Je(r);t.r_()&&t.V_&&t.m_(e.mutations)}function Ka(r){return vs(r)&&!Je(r).n_()&&r.O_.length>0}function Ya(r){Je(r).start()}async function rf(r){Je(r).p_()}async function nf(r){const e=Je(r);for(const t of r.O_)e.m_(t.mutations)}async function of(r,e,t){const s=r.O_.shift(),i=Vr.from(s,e,t);await Wa(r,()=>r.remoteSyncer.applySuccessfulWrite(i)),await pi(r)}async function af(r,e){e&&Je(r).V_&&await async function(s,i){if(function(a){return ld(a)&&a!==R.ABORTED}(i.code)){const n=s.O_.shift();Je(s).s_(),await Wa(s,()=>s.remoteSyncer.rejectFailedWrite(n.batchId,i)),await pi(s)}}(r,e),Ka(r)&&Ya(r)}async function Do(r,e){const t=q(r);t.asyncQueue.verifyOperationInProgress(),V("RemoteStore","RemoteStore received new credentials");const s=vs(t);t.L_.add(3),await ys(t),s&&t.q_.set("Unknown"),await t.remoteSyncer.handleCredentialChange(e),t.L_.delete(3),await mi(t)}async function lf(r,e){const t=q(r);e?(t.L_.delete(2),await mi(t)):e||(t.L_.add(2),await ys(t),t.q_.set("Unknown"))}function Je(r){return r.U_||(r.U_=function(t,s,i){const n=q(t);return n.w_(),new Qd(s,n.connection,n.authCredentials,n.appCheckCredentials,n.serializer,i)}(r.datastore,r.asyncQueue,{Eo:()=>Promise.resolve(),Ro:rf.bind(null,r),mo:af.bind(null,r),f_:nf.bind(null,r),g_:of.bind(null,r)}),r.B_.push(async e=>{e?(r.U_.s_(),await pi(r)):(await r.U_.stop(),r.O_.length>0&&(V("RemoteStore",`Stopping write stream with ${r.O_.length} pending writes`),r.O_=[]))})),r.U_}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Fr{constructor(e,t,s,i,n){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=s,this.op=i,this.removalCallback=n,this.deferred=new ct,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(a=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,s,i,n){const a=Date.now()+s,l=new Fr(e,t,a,i,n);return l.start(s),l}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){this.timerHandle!==null&&(this.clearTimeout(),this.deferred.reject(new O(R.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>this.timerHandle!==null?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){this.timerHandle!==null&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Xa(r,e){if(ft("AsyncQueue",`${e}: ${r}`),ci(r))return new O(R.UNAVAILABLE,`${e}: ${r}`);throw r}class cf{constructor(){this.queries=xo(),this.onlineState="Unknown",this.Y_=new Set}terminate(){(function(t,s){const i=q(t),n=i.queries;i.queries=xo(),n.forEach((a,l)=>{for(const h of l.j_)h.onError(s)})})(this,new O(R.ABORTED,"Firestore shutting down"))}}function xo(){return new Lt(r=>Da(r),Ra)}function hf(r){r.Y_.forEach(e=>{e.next()})}var Lo,ko;(ko=Lo||(Lo={})).ea="default",ko.Cache="cache";class uf{constructor(e,t,s,i,n,a){this.localStore=e,this.remoteStore=t,this.eventManager=s,this.sharedClientState=i,this.currentUser=n,this.maxConcurrentLimboResolutions=a,this.Ca={},this.Fa=new Lt(l=>Da(l),Ra),this.Ma=new Map,this.xa=new Set,this.Oa=new Ee(M.comparator),this.Na=new Map,this.La=new Or,this.Ba={},this.ka=new Map,this.qa=Dt.kn(),this.onlineState="Unknown",this.Qa=void 0}get isPrimaryClient(){return this.Qa===!0}}async function df(r,e,t){const s=gf(r);try{const i=await function(a,l){const h=q(a),d=ie.now(),m=l.reduce((A,C)=>A.add(C.key),pe());let p,b;return h.persistence.runTransaction("Locally write mutations","readwrite",A=>{let C=ti(),L=pe();return h.cs.getEntries(A,m).next(D=>{C=D,C.forEach((F,U)=>{U.isValidDocument()||(L=L.add(F))})}).next(()=>h.localDocuments.getOverlayedDocuments(A,C)).next(D=>{p=D;const F=[];for(const U of l){const X=rd(U,p.get(U.key).overlayedDocument);X!=null&&F.push(new yt(U.key,X,Ta(X.value.mapValue),Me.exists(!0)))}return h.mutationQueue.addMutationBatch(A,d,F,l)}).next(D=>{b=D;const F=D.applyToLocalDocumentSet(p,L);return h.documentOverlayCache.saveOverlays(A,D.batchId,F)})}).then(()=>({batchId:b.batchId,changes:La(p)}))}(s.localStore,e);s.sharedClientState.addPendingMutation(i.batchId),function(a,l,h){let d=a.Ba[a.currentUser.toKey()];d||(d=new Ee(G)),d=d.insert(l,h),a.Ba[a.currentUser.toKey()]=d}(s,i.batchId,t),await gi(s,i.changes),await pi(s.remoteStore)}catch(i){const n=Xa(i,"Failed to persist write");t.reject(n)}}function Vo(r,e,t){const s=q(r);if(s.isPrimaryClient&&t===0||!s.isPrimaryClient&&t===1){const i=[];s.Fa.forEach((n,a)=>{const l=a.view.Z_(e);l.snapshot&&i.push(l.snapshot)}),function(a,l){const h=q(a);h.onlineState=l;let d=!1;h.queries.forEach((m,p)=>{for(const b of p.j_)b.Z_(l)&&(d=!0)}),d&&hf(h)}(s.eventManager,e),i.length&&s.Ca.d_(i),s.onlineState=e,s.isPrimaryClient&&s.sharedClientState.setOnlineState(e)}}async function ff(r,e){const t=q(r),s=e.batch.batchId;try{const i=await Ud(t.localStore,e);Ja(t,s,null),Qa(t,s),t.sharedClientState.updateMutationState(s,"acknowledged"),await gi(t,i)}catch(i){await va(i)}}async function mf(r,e,t){const s=q(r);try{const i=await function(a,l){const h=q(a);return h.persistence.runTransaction("Reject batch","readwrite-primary",d=>{let m;return h.mutationQueue.lookupMutationBatch(d,l).next(p=>(J(p!==null),m=p.keys(),h.mutationQueue.removeMutationBatch(d,p))).next(()=>h.mutationQueue.performConsistencyCheck(d)).next(()=>h.documentOverlayCache.removeOverlaysForBatchId(d,m,l)).next(()=>h.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(d,m)).next(()=>h.localDocuments.getDocuments(d,m))})}(s.localStore,e);Ja(s,e,t),Qa(s,e),s.sharedClientState.updateMutationState(e,"rejected",t),await gi(s,i)}catch(i){await va(i)}}function Qa(r,e){(r.ka.get(e)||[]).forEach(t=>{t.resolve()}),r.ka.delete(e)}function Ja(r,e,t){const s=q(r);let i=s.Ba[s.currentUser.toKey()];if(i){const n=i.get(e);n&&(t?n.reject(t):n.resolve(),i=i.remove(e)),s.Ba[s.currentUser.toKey()]=i}}async function gi(r,e,t){const s=q(r),i=[],n=[],a=[];s.Fa.isEmpty()||(s.Fa.forEach((l,h)=>{a.push(s.Ka(h,e,t).then(d=>{var m;if((d||t)&&s.isPrimaryClient){const p=d?!d.fromCache:(m=void 0)===null||m===void 0?void 0:m.current;s.sharedClientState.updateQueryState(h.targetId,p?"current":"not-current")}if(d){i.push(d);const p=Nr.Wi(h.targetId,d);n.push(p)}}))}),await Promise.all(a),s.Ca.d_(i),await async function(h,d){const m=q(h);try{await m.persistence.runTransaction("notifyLocalViewChanges","readwrite",p=>P.forEach(d,b=>P.forEach(b.$i,A=>m.persistence.referenceDelegate.addReference(p,b.targetId,A)).next(()=>P.forEach(b.Ui,A=>m.persistence.referenceDelegate.removeReference(p,b.targetId,A)))))}catch(p){if(!ci(p))throw p;V("LocalStore","Failed to update sequence numbers: "+p)}for(const p of d){const b=p.targetId;if(!p.fromCache){const A=m.os.get(b),C=A.snapshotVersion,L=A.withLastLimboFreeSnapshotVersion(C);m.os=m.os.insert(b,L)}}}(s.localStore,n))}async function pf(r,e){const t=q(r);if(!t.currentUser.isEqual(e)){V("SyncEngine","User change. New user:",e.toKey());const s=await Ga(t.localStore,e);t.currentUser=e,function(n,a){n.ka.forEach(l=>{l.forEach(h=>{h.reject(new O(R.CANCELLED,a))})}),n.ka.clear()}(t,"'waitForPendingWrites' promise is rejected due to a user change."),t.sharedClientState.handleUserChange(e,s.removedBatchIds,s.addedBatchIds),await gi(t,s.hs)}}function gf(r){const e=q(r);return e.remoteStore.remoteSyncer.applySuccessfulWrite=ff.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=mf.bind(null,e),e}class ii{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(e){this.serializer=fi(e.databaseInfo.databaseId),this.sharedClientState=this.Wa(e),this.persistence=this.Ga(e),await this.persistence.start(),this.localStore=this.za(e),this.gcScheduler=this.ja(e,this.localStore),this.indexBackfillerScheduler=this.Ha(e,this.localStore)}ja(e,t){return null}Ha(e,t){return null}za(e){return Bd(this.persistence,new $d,e.initialUser,this.serializer)}Ga(e){return new Md(Mr.Zr,this.serializer)}Wa(e){return new qd}async terminate(){var e,t;(e=this.gcScheduler)===null||e===void 0||e.stop(),(t=this.indexBackfillerScheduler)===null||t===void 0||t.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}ii.provider={build:()=>new ii};class gr{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=s=>Vo(this.syncEngine,s,1),this.remoteStore.remoteSyncer.handleCredentialChange=pf.bind(null,this.syncEngine),await lf(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return function(){return new cf}()}createDatastore(e){const t=fi(e.databaseInfo.databaseId),s=function(n){return new Yd(n)}(e.databaseInfo);return function(n,a,l,h){return new Jd(n,a,l,h)}(e.authCredentials,e.appCheckCredentials,s,t)}createRemoteStore(e){return function(s,i,n,a,l){return new ef(s,i,n,a,l)}(this.localStore,this.datastore,e.asyncQueue,t=>Vo(this.syncEngine,t,0),function(){return Ro.D()?new Ro:new Hd}())}createSyncEngine(e,t){return function(i,n,a,l,h,d,m){const p=new uf(i,n,a,l,h,d);return m&&(p.Qa=!0),p}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}async terminate(){var e,t;await async function(i){const n=q(i);V("RemoteStore","RemoteStore shutting down."),n.L_.add(5),await ys(n),n.k_.shutdown(),n.q_.set("Unknown")}(this.remoteStore),(e=this.datastore)===null||e===void 0||e.terminate(),(t=this.eventManager)===null||t===void 0||t.terminate()}}gr.provider={build:()=>new gr};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class yf{constructor(e,t,s,i,n){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=s,this.databaseInfo=i,this.user=me.UNAUTHENTICATED,this.clientId=ya.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=n,this.authCredentials.start(s,async a=>{V("FirestoreClient","Received user=",a.uid),await this.authCredentialListener(a),this.user=a}),this.appCheckCredentials.start(s,a=>(V("FirestoreClient","Received new app check token=",a),this.appCheckCredentialListener(a,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}terminate(){this.asyncQueue.enterRestrictedMode();const e=new ct;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(t){const s=Xa(t,"Failed to shutdown persistence");e.reject(s)}}),e.promise}}async function Xi(r,e){r.asyncQueue.verifyOperationInProgress(),V("FirestoreClient","Initializing OfflineComponentProvider");const t=r.configuration;await e.initialize(t);let s=t.initialUser;r.setCredentialChangeListener(async i=>{s.isEqual(i)||(await Ga(e.localStore,i),s=i)}),e.persistence.setDatabaseDeletedListener(()=>r.terminate()),r._offlineComponents=e}async function Oo(r,e){r.asyncQueue.verifyOperationInProgress();const t=await vf(r);V("FirestoreClient","Initializing OnlineComponentProvider"),await e.initialize(t,r.configuration),r.setCredentialChangeListener(s=>Do(e.remoteStore,s)),r.setAppCheckTokenChangeListener((s,i)=>Do(e.remoteStore,i)),r._onlineComponents=e}async function vf(r){if(!r._offlineComponents)if(r._uninitializedComponentsProvider){V("FirestoreClient","Using user provided OfflineComponentProvider");try{await Xi(r,r._uninitializedComponentsProvider._offline)}catch(e){const t=e;if(!function(i){return i.name==="FirebaseError"?i.code===R.FAILED_PRECONDITION||i.code===R.UNIMPLEMENTED:!(typeof DOMException<"u"&&i instanceof DOMException)||i.code===22||i.code===20||i.code===11}(t))throw t;Ys("Error using user provided cache. Falling back to memory cache: "+t),await Xi(r,new ii)}}else V("FirestoreClient","Using default OfflineComponentProvider"),await Xi(r,new ii);return r._offlineComponents}async function _f(r){return r._onlineComponents||(r._uninitializedComponentsProvider?(V("FirestoreClient","Using user provided OnlineComponentProvider"),await Oo(r,r._uninitializedComponentsProvider._online)):(V("FirestoreClient","Using default OnlineComponentProvider"),await Oo(r,new gr))),r._onlineComponents}function wf(r){return _f(r).then(e=>e.syncEngine)}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Za(r){const e={};return r.timeoutSeconds!==void 0&&(e.timeoutSeconds=r.timeoutSeconds),e}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Mo=new Map;/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function el(r,e,t){if(!t)throw new O(R.INVALID_ARGUMENT,`Function ${r}() cannot be called with an empty ${e}.`)}function Ef(r,e,t,s){if(e===!0&&s===!0)throw new O(R.INVALID_ARGUMENT,`${r} and ${t} cannot be used together.`)}function No(r){if(!M.isDocumentKey(r))throw new O(R.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${r} has ${r.length}.`)}function Fo(r){if(M.isDocumentKey(r))throw new O(R.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${r} has ${r.length}.`)}function $r(r){if(r===void 0)return"undefined";if(r===null)return"null";if(typeof r=="string")return r.length>20&&(r=`${r.substring(0,20)}...`),JSON.stringify(r);if(typeof r=="number"||typeof r=="boolean")return""+r;if(typeof r=="object"){if(r instanceof Array)return"an array";{const e=function(s){return s.constructor?s.constructor.name:null}(r);return e?`a custom ${e} object`:"an object"}}return typeof r=="function"?"a function":N()}function tl(r,e){if("_delegate"in r&&(r=r._delegate),!(r instanceof e)){if(e.name===r.constructor.name)throw new O(R.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const t=$r(r);throw new O(R.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${t}`)}}return r}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class $o{constructor(e){var t,s;if(e.host===void 0){if(e.ssl!==void 0)throw new O(R.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=(t=e.ssl)===null||t===void 0||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,e.cacheSizeBytes===void 0)this.cacheSizeBytes=41943040;else{if(e.cacheSizeBytes!==-1&&e.cacheSizeBytes<1048576)throw new O(R.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}Ef("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:e.experimentalAutoDetectLongPolling===void 0?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=Za((s=e.experimentalLongPollingOptions)!==null&&s!==void 0?s:{}),function(n){if(n.timeoutSeconds!==void 0){if(isNaN(n.timeoutSeconds))throw new O(R.INVALID_ARGUMENT,`invalid long polling timeout: ${n.timeoutSeconds} (must not be NaN)`);if(n.timeoutSeconds<5)throw new O(R.INVALID_ARGUMENT,`invalid long polling timeout: ${n.timeoutSeconds} (minimum allowed value is 5)`);if(n.timeoutSeconds>30)throw new O(R.INVALID_ARGUMENT,`invalid long polling timeout: ${n.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&function(s,i){return s.timeoutSeconds===i.timeoutSeconds}(this.experimentalLongPollingOptions,e.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class yi{constructor(e,t,s,i){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=s,this._app=i,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new $o({}),this._settingsFrozen=!1,this._terminateTask="notTerminated"}get app(){if(!this._app)throw new O(R.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return this._terminateTask!=="notTerminated"}_setSettings(e){if(this._settingsFrozen)throw new O(R.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new $o(e),e.credentials!==void 0&&(this._authCredentials=function(s){if(!s)return new cu;switch(s.type){case"firstParty":return new fu(s.sessionIndex||"0",s.iamToken||null,s.authTokenFactory||null);case"provider":return s.client;default:throw new O(R.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask==="notTerminated"&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){this._terminateTask==="notTerminated"?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){const s=Mo.get(t);s&&(V("ComponentProvider","Removing Datastore"),Mo.delete(t),s.terminate())}(this),Promise.resolve()}}function Tf(r,e,t,s={}){var i;const n=(r=tl(r,yi))._getSettings(),a=`${e}:${t}`;if(n.host!=="firestore.googleapis.com"&&n.host!==a&&Ys("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),r._setSettings(Object.assign(Object.assign({},n),{host:a,ssl:!1})),s.mockUserToken){let l,h;if(typeof s.mockUserToken=="string")l=s.mockUserToken,h=me.MOCK_USER;else{l=qc(s.mockUserToken,(i=r._app)===null||i===void 0?void 0:i.options.projectId);const d=s.mockUserToken.sub||s.mockUserToken.user_id;if(!d)throw new O(R.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");h=new me(d)}r._authCredentials=new hu(new ga(l,h))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class zr{constructor(e,t,s){this.converter=t,this._query=s,this.type="query",this.firestore=e}withConverter(e){return new zr(this.firestore,e,this._query)}}class Ne{constructor(e,t,s){this.converter=t,this._key=s,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new We(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new Ne(this.firestore,e,this._key)}}class We extends zr{constructor(e,t,s){super(e,t,Bu(s)),this._path=s,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new Ne(this.firestore,null,new M(e))}withConverter(e){return new We(this.firestore,e,this._path)}}function bf(r,e,...t){if(r=ut(r),el("collection","path",e),r instanceof yi){const s=Y.fromString(e,...t);return Fo(s),new We(r,null,s)}{if(!(r instanceof Ne||r instanceof We))throw new O(R.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const s=r._path.child(Y.fromString(e,...t));return Fo(s),new We(r.firestore,null,s)}}function Sf(r,e,...t){if(r=ut(r),arguments.length===1&&(e=ya.newId()),el("doc","path",e),r instanceof yi){const s=Y.fromString(e,...t);return No(s),new Ne(r,null,new M(s))}{if(!(r instanceof Ne||r instanceof We))throw new O(R.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const s=r._path.child(Y.fromString(e,...t));return No(s),new Ne(r.firestore,r instanceof We?r.converter:null,new M(s))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class zo{constructor(e=Promise.resolve()){this.Pu=[],this.Iu=!1,this.Tu=[],this.Eu=null,this.du=!1,this.Au=!1,this.Ru=[],this.t_=new qa(this,"async_queue_retry"),this.Vu=()=>{const s=Yi();s&&V("AsyncQueue","Visibility state changed to "+s.visibilityState),this.t_.jo()},this.mu=e;const t=Yi();t&&typeof t.addEventListener=="function"&&t.addEventListener("visibilitychange",this.Vu)}get isShuttingDown(){return this.Iu}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.fu(),this.gu(e)}enterRestrictedMode(e){if(!this.Iu){this.Iu=!0,this.Au=e||!1;const t=Yi();t&&typeof t.removeEventListener=="function"&&t.removeEventListener("visibilitychange",this.Vu)}}enqueue(e){if(this.fu(),this.Iu)return new Promise(()=>{});const t=new ct;return this.gu(()=>this.Iu&&this.Au?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Pu.push(e),this.pu()))}async pu(){if(this.Pu.length!==0){try{await this.Pu[0](),this.Pu.shift(),this.t_.reset()}catch(e){if(!ci(e))throw e;V("AsyncQueue","Operation failed with retryable error: "+e)}this.Pu.length>0&&this.t_.Go(()=>this.pu())}}gu(e){const t=this.mu.then(()=>(this.du=!0,e().catch(s=>{this.Eu=s,this.du=!1;const i=function(a){let l=a.message||"";return a.stack&&(l=a.stack.includes(a.message)?a.stack:a.message+`
`+a.stack),l}(s);throw ft("INTERNAL UNHANDLED ERROR: ",i),s}).then(s=>(this.du=!1,s))));return this.mu=t,t}enqueueAfterDelay(e,t,s){this.fu(),this.Ru.indexOf(e)>-1&&(t=0);const i=Fr.createAndSchedule(this,e,t,s,n=>this.yu(n));return this.Tu.push(i),i}fu(){this.Eu&&N()}verifyOperationInProgress(){}async wu(){let e;do e=this.mu,await e;while(e!==this.mu)}Su(e){for(const t of this.Tu)if(t.timerId===e)return!0;return!1}bu(e){return this.wu().then(()=>{this.Tu.sort((t,s)=>t.targetTimeMs-s.targetTimeMs);for(const t of this.Tu)if(t.skipDelay(),e!=="all"&&t.timerId===e)break;return this.wu()})}Du(e){this.Ru.push(e)}yu(e){const t=this.Tu.indexOf(e);this.Tu.splice(t,1)}}class sl extends yi{constructor(e,t,s,i){super(e,t,s,i),this.type="firestore",this._queue=new zo,this._persistenceKey=(i==null?void 0:i.name)||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){const e=this._firestoreClient.terminate();this._queue=new zo(e),this._firestoreClient=void 0,await e}}}function Af(r,e){const t=typeof r=="object"?r:aa(),s=typeof r=="string"?r:"(default)",i=ms(t,"firestore").getImmediate({identifier:s});if(!i._initialized){const n=jc("firestore");n&&Tf(i,...n)}return i}function If(r){if(r._terminated)throw new O(R.FAILED_PRECONDITION,"The client has already been terminated.");return r._firestoreClient||Cf(r),r._firestoreClient}function Cf(r){var e,t,s;const i=r._freezeSettings(),n=function(l,h,d,m){return new Cu(l,h,d,m.host,m.ssl,m.experimentalForceLongPolling,m.experimentalAutoDetectLongPolling,Za(m.experimentalLongPollingOptions),m.useFetchStreams)}(r._databaseId,((e=r._app)===null||e===void 0?void 0:e.options.appId)||"",r._persistenceKey,i);r._componentsProvider||!((t=i.localCache)===null||t===void 0)&&t._offlineComponentProvider&&(!((s=i.localCache)===null||s===void 0)&&s._onlineComponentProvider)&&(r._componentsProvider={_offline:i.localCache._offlineComponentProvider,_online:i.localCache._onlineComponentProvider}),r._firestoreClient=new yf(r._authCredentials,r._appCheckCredentials,r._queue,n,r._componentsProvider&&function(l){const h=l==null?void 0:l._online.build();return{_offline:l==null?void 0:l._offline.build(h),_online:h}}(r._componentsProvider))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class fs{constructor(e){this._byteString=e}static fromBase64String(e){try{return new fs(xe.fromBase64String(e))}catch(t){throw new O(R.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(e){return new fs(xe.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class il{constructor(...e){for(let t=0;t<e.length;++t)if(e[t].length===0)throw new O(R.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new ae(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Br{constructor(e){this._methodName=e}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class rl{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new O(R.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new O(R.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return G(this._lat,e._lat)||G(this._long,e._long)}}/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class nl{constructor(e){this._values=(e||[]).map(t=>t)}toArray(){return this._values.map(e=>e)}isEqual(e){return function(s,i){if(s.length!==i.length)return!1;for(let n=0;n<s.length;++n)if(s[n]!==i[n])return!1;return!0}(this._values,e._values)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Pf=/^__.*__$/;class Rf{constructor(e,t,s){this.data=e,this.fieldMask=t,this.fieldTransforms=s}toMutation(e,t){return this.fieldMask!==null?new yt(e,this.data,this.fieldMask,t,this.fieldTransforms):new gs(e,this.data,t,this.fieldTransforms)}}function ol(r){switch(r){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw N()}}class Ur{constructor(e,t,s,i,n,a){this.settings=e,this.databaseId=t,this.serializer=s,this.ignoreUndefinedProperties=i,n===void 0&&this.vu(),this.fieldTransforms=n||[],this.fieldMask=a||[]}get path(){return this.settings.path}get Cu(){return this.settings.Cu}Fu(e){return new Ur(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Mu(e){var t;const s=(t=this.path)===null||t===void 0?void 0:t.child(e),i=this.Fu({path:s,xu:!1});return i.Ou(e),i}Nu(e){var t;const s=(t=this.path)===null||t===void 0?void 0:t.child(e),i=this.Fu({path:s,xu:!1});return i.vu(),i}Lu(e){return this.Fu({path:void 0,xu:!0})}Bu(e){return ri(e,this.settings.methodName,this.settings.ku||!1,this.path,this.settings.qu)}contains(e){return this.fieldMask.find(t=>e.isPrefixOf(t))!==void 0||this.fieldTransforms.find(t=>e.isPrefixOf(t.field))!==void 0}vu(){if(this.path)for(let e=0;e<this.path.length;e++)this.Ou(this.path.get(e))}Ou(e){if(e.length===0)throw this.Bu("Document fields must not be empty");if(ol(this.Cu)&&Pf.test(e))throw this.Bu('Document fields cannot begin and end with "__"')}}class Df{constructor(e,t,s){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=s||fi(e)}Qu(e,t,s,i=!1){return new Ur({Cu:e,methodName:t,qu:s,path:ae.emptyPath(),xu:!1,ku:i},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function xf(r){const e=r._freezeSettings(),t=fi(r._databaseId);return new Df(r._databaseId,!!e.ignoreUndefinedProperties,t)}function Lf(r,e,t,s,i,n={}){const a=r.Qu(n.merge||n.mergeFields?2:0,e,t,i);hl("Data must be an object, but it was:",a,s);const l=ll(s,a);let h,d;if(n.merge)h=new Pe(a.fieldMask),d=a.fieldTransforms;else if(n.mergeFields){const m=[];for(const p of n.mergeFields){const b=kf(e,p,t);if(!a.contains(b))throw new O(R.INVALID_ARGUMENT,`Field '${b}' is specified in your field mask but missing from your input data.`);Mf(m,b)||m.push(b)}h=new Pe(m),d=a.fieldTransforms.filter(p=>h.covers(p.field))}else h=null,d=a.fieldTransforms;return new Rf(new Ce(l),h,d)}class jr extends Br{_toFieldTransform(e){return new ed(e.path,new hs)}isEqual(e){return e instanceof jr}}function al(r,e){if(cl(r=ut(r)))return hl("Unsupported field value:",e,r),ll(r,e);if(r instanceof Br)return function(s,i){if(!ol(i.Cu))throw i.Bu(`${s._methodName}() can only be used with update() and set()`);if(!i.path)throw i.Bu(`${s._methodName}() is not currently supported inside arrays`);const n=s._toFieldTransform(i);n&&i.fieldTransforms.push(n)}(r,e),null;if(r===void 0&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),r instanceof Array){if(e.settings.xu&&e.Cu!==4)throw e.Bu("Nested arrays are not supported");return function(s,i){const n=[];let a=0;for(const l of s){let h=al(l,i.Lu(a));h==null&&(h={nullValue:"NULL_VALUE"}),n.push(h),a++}return{arrayValue:{values:n}}}(r,e)}return function(s,i){if((s=ut(s))===null)return{nullValue:"NULL_VALUE"};if(typeof s=="number")return Qu(i.serializer,s);if(typeof s=="boolean")return{booleanValue:s};if(typeof s=="string")return{stringValue:s};if(s instanceof Date){const n=ie.fromDate(s);return{timestampValue:fr(i.serializer,n)}}if(s instanceof ie){const n=new ie(s.seconds,1e3*Math.floor(s.nanoseconds/1e3));return{timestampValue:fr(i.serializer,n)}}if(s instanceof rl)return{geoPointValue:{latitude:s.latitude,longitude:s.longitude}};if(s instanceof fs)return{bytesValue:ud(i.serializer,s._byteString)};if(s instanceof Ne){const n=i.databaseId,a=s.firestore._databaseId;if(!a.isEqual(n))throw i.Bu(`Document reference is for database ${a.projectId}/${a.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:Ua(s.firestore._databaseId||i.databaseId,s._key.path)}}if(s instanceof nl)return function(a,l){return{mapValue:{fields:{__type__:{stringValue:"__vector__"},value:{arrayValue:{values:a.toArray().map(h=>{if(typeof h!="number")throw l.Bu("VectorValues must only contain numeric values.");return kr(l.serializer,h)})}}}}}}(s,i);throw i.Bu(`Unsupported field value: ${$r(s)}`)}(r,e)}function ll(r,e){const t={};return wa(r)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):ps(r,(s,i)=>{const n=al(i,e.Mu(s));n!=null&&(t[s]=n)}),{mapValue:{fields:t}}}function cl(r){return!(typeof r!="object"||r===null||r instanceof Array||r instanceof Date||r instanceof ie||r instanceof rl||r instanceof fs||r instanceof Ne||r instanceof Br||r instanceof nl)}function hl(r,e,t){if(!cl(t)||!function(i){return typeof i=="object"&&i!==null&&(Object.getPrototypeOf(i)===Object.prototype||Object.getPrototypeOf(i)===null)}(t)){const s=$r(t);throw s==="an object"?e.Bu(r+" a custom object"):e.Bu(r+" "+s)}}function kf(r,e,t){if((e=ut(e))instanceof il)return e._internalPath;if(typeof e=="string")return Of(r,e);throw ri("Field path arguments must be of type string or ",r,!1,void 0,t)}const Vf=new RegExp("[~\\*/\\[\\]]");function Of(r,e,t){if(e.search(Vf)>=0)throw ri(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,r,!1,void 0,t);try{return new il(...e.split("."))._internalPath}catch{throw ri(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,r,!1,void 0,t)}}function ri(r,e,t,s,i){const n=s&&!s.isEmpty(),a=i!==void 0;let l=`Function ${e}() called with invalid data`;t&&(l+=" (via `toFirestore()`)"),l+=". ";let h="";return(n||a)&&(h+=" (found",n&&(h+=` in field ${s}`),a&&(h+=` in document ${i}`),h+=")"),new O(R.INVALID_ARGUMENT,l+r+h)}function Mf(r,e){return r.some(t=>t.isEqual(e))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Nf(r,e,t){let s;return s=r?r.toFirestore(e):e,s}function Ff(r,e){const t=tl(r.firestore,sl),s=Sf(r),i=Nf(r.converter,e);return $f(t,[Lf(xf(r.firestore),"addDoc",s._key,i,r.converter!==null,{}).toMutation(s._key,Me.exists(!1))]).then(()=>s)}function $f(r,e){return function(s,i){const n=new ct;return s.asyncQueue.enqueueAndForget(async()=>df(await wf(s),i,n)),n.promise}(If(r),e)}function zf(){return new jr("serverTimestamp")}(function(e,t=!0){(function(i){xt=i})(Zh),Ye(new Fe("firestore",(s,{instanceIdentifier:i,options:n})=>{const a=s.getProvider("app").getImmediate(),l=new sl(new uu(s.getProvider("auth-internal")),new pu(s.getProvider("app-check-internal")),function(d,m){if(!Object.prototype.hasOwnProperty.apply(d.options,["projectId"]))throw new O(R.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Js(d.options.projectId,m)}(a,i),a);return n=Object.assign({useFetchStreams:t},n),l._setSettings(n),l},"PUBLIC").setMultipleInstances(!0)),De(mo,"4.7.3",e),De(mo,"4.7.3","esm2017")})();var Bf="firebase",Uf="10.14.1";/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */De(Bf,Uf,"app");const ul="@firebase/installations",Gr="0.6.9";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const dl=1e4,fl=`w:${Gr}`,ml="FIS_v2",jf="https://firebaseinstallations.googleapis.com/v1",Gf=60*60*1e3,qf="installations",Hf="Installations";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Wf={"missing-app-config-values":'Missing App configuration value: "{$valueName}"',"not-registered":"Firebase Installation is not registered.","installation-not-found":"Firebase Installation not found.","request-failed":'{$requestName} request failed with error "{$serverCode} {$serverStatus}: {$serverMessage}"',"app-offline":"Could not process request. Application offline.","delete-pending-registration":"Can't delete installation while there is a pending registration request."},pt=new li(qf,Hf,Wf);function pl(r){return r instanceof Ze&&r.code.includes("request-failed")}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function gl({projectId:r}){return`${jf}/projects/${r}/installations`}function yl(r){return{token:r.token,requestStatus:2,expiresIn:Yf(r.expiresIn),creationTime:Date.now()}}async function vl(r,e){const s=(await e.json()).error;return pt.create("request-failed",{requestName:r,serverCode:s.code,serverMessage:s.message,serverStatus:s.status})}function _l({apiKey:r}){return new Headers({"Content-Type":"application/json",Accept:"application/json","x-goog-api-key":r})}function Kf(r,{refreshToken:e}){const t=_l(r);return t.append("Authorization",Xf(e)),t}async function wl(r){const e=await r();return e.status>=500&&e.status<600?r():e}function Yf(r){return Number(r.replace("s","000"))}function Xf(r){return`${ml} ${r}`}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function Qf({appConfig:r,heartbeatServiceProvider:e},{fid:t}){const s=gl(r),i=_l(r),n=e.getImmediate({optional:!0});if(n){const d=await n.getHeartbeatsHeader();d&&i.append("x-firebase-client",d)}const a={fid:t,authVersion:ml,appId:r.appId,sdkVersion:fl},l={method:"POST",headers:i,body:JSON.stringify(a)},h=await wl(()=>fetch(s,l));if(h.ok){const d=await h.json();return{fid:d.fid||t,registrationStatus:2,refreshToken:d.refreshToken,authToken:yl(d.authToken)}}else throw await vl("Create Installation",h)}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function El(r){return new Promise(e=>{setTimeout(e,r)})}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Jf(r){return btoa(String.fromCharCode(...r)).replace(/\+/g,"-").replace(/\//g,"_")}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Zf=/^[cdef][\w-]{21}$/,yr="";function em(){try{const r=new Uint8Array(17);(self.crypto||self.msCrypto).getRandomValues(r),r[0]=112+r[0]%16;const t=tm(r);return Zf.test(t)?t:yr}catch{return yr}}function tm(r){return Jf(r).substr(0,22)}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function vi(r){return`${r.appName}!${r.appId}`}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Tl=new Map;function bl(r,e){const t=vi(r);Sl(t,e),sm(t,e)}function Sl(r,e){const t=Tl.get(r);if(t)for(const s of t)s(e)}function sm(r,e){const t=im();t&&t.postMessage({key:r,fid:e}),rm()}let at=null;function im(){return!at&&"BroadcastChannel"in self&&(at=new BroadcastChannel("[Firebase] FID Change"),at.onmessage=r=>{Sl(r.data.key,r.data.fid)}),at}function rm(){Tl.size===0&&at&&(at.close(),at=null)}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const nm="firebase-installations-database",om=1,gt="firebase-installations-store";let Qi=null;function qr(){return Qi||(Qi=na(nm,om,{upgrade:(r,e)=>{switch(e){case 0:r.createObjectStore(gt)}}})),Qi}async function ni(r,e){const t=vi(r),i=(await qr()).transaction(gt,"readwrite"),n=i.objectStore(gt),a=await n.get(t);return await n.put(e,t),await i.done,(!a||a.fid!==e.fid)&&bl(r,e.fid),e}async function Al(r){const e=vi(r),s=(await qr()).transaction(gt,"readwrite");await s.objectStore(gt).delete(e),await s.done}async function _i(r,e){const t=vi(r),i=(await qr()).transaction(gt,"readwrite"),n=i.objectStore(gt),a=await n.get(t),l=e(a);return l===void 0?await n.delete(t):await n.put(l,t),await i.done,l&&(!a||a.fid!==l.fid)&&bl(r,l.fid),l}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function Hr(r){let e;const t=await _i(r.appConfig,s=>{const i=am(s),n=lm(r,i);return e=n.registrationPromise,n.installationEntry});return t.fid===yr?{installationEntry:await e}:{installationEntry:t,registrationPromise:e}}function am(r){const e=r||{fid:em(),registrationStatus:0};return Il(e)}function lm(r,e){if(e.registrationStatus===0){if(!navigator.onLine){const i=Promise.reject(pt.create("app-offline"));return{installationEntry:e,registrationPromise:i}}const t={fid:e.fid,registrationStatus:1,registrationTime:Date.now()},s=cm(r,t);return{installationEntry:t,registrationPromise:s}}else return e.registrationStatus===1?{installationEntry:e,registrationPromise:hm(r)}:{installationEntry:e}}async function cm(r,e){try{const t=await Qf(r,e);return ni(r.appConfig,t)}catch(t){throw pl(t)&&t.customData.serverCode===409?await Al(r.appConfig):await ni(r.appConfig,{fid:e.fid,registrationStatus:0}),t}}async function hm(r){let e=await Bo(r.appConfig);for(;e.registrationStatus===1;)await El(100),e=await Bo(r.appConfig);if(e.registrationStatus===0){const{installationEntry:t,registrationPromise:s}=await Hr(r);return s||t}return e}function Bo(r){return _i(r,e=>{if(!e)throw pt.create("installation-not-found");return Il(e)})}function Il(r){return um(r)?{fid:r.fid,registrationStatus:0}:r}function um(r){return r.registrationStatus===1&&r.registrationTime+dl<Date.now()}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function dm({appConfig:r,heartbeatServiceProvider:e},t){const s=fm(r,t),i=Kf(r,t),n=e.getImmediate({optional:!0});if(n){const d=await n.getHeartbeatsHeader();d&&i.append("x-firebase-client",d)}const a={installation:{sdkVersion:fl,appId:r.appId}},l={method:"POST",headers:i,body:JSON.stringify(a)},h=await wl(()=>fetch(s,l));if(h.ok){const d=await h.json();return yl(d)}else throw await vl("Generate Auth Token",h)}function fm(r,{fid:e}){return`${gl(r)}/${e}/authTokens:generate`}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function Wr(r,e=!1){let t;const s=await _i(r.appConfig,n=>{if(!Cl(n))throw pt.create("not-registered");const a=n.authToken;if(!e&&gm(a))return n;if(a.requestStatus===1)return t=mm(r,e),n;{if(!navigator.onLine)throw pt.create("app-offline");const l=vm(n);return t=pm(r,l),l}});return t?await t:s.authToken}async function mm(r,e){let t=await Uo(r.appConfig);for(;t.authToken.requestStatus===1;)await El(100),t=await Uo(r.appConfig);const s=t.authToken;return s.requestStatus===0?Wr(r,e):s}function Uo(r){return _i(r,e=>{if(!Cl(e))throw pt.create("not-registered");const t=e.authToken;return _m(t)?Object.assign(Object.assign({},e),{authToken:{requestStatus:0}}):e})}async function pm(r,e){try{const t=await dm(r,e),s=Object.assign(Object.assign({},e),{authToken:t});return await ni(r.appConfig,s),t}catch(t){if(pl(t)&&(t.customData.serverCode===401||t.customData.serverCode===404))await Al(r.appConfig);else{const s=Object.assign(Object.assign({},e),{authToken:{requestStatus:0}});await ni(r.appConfig,s)}throw t}}function Cl(r){return r!==void 0&&r.registrationStatus===2}function gm(r){return r.requestStatus===2&&!ym(r)}function ym(r){const e=Date.now();return e<r.creationTime||r.creationTime+r.expiresIn<e+Gf}function vm(r){const e={requestStatus:1,requestTime:Date.now()};return Object.assign(Object.assign({},r),{authToken:e})}function _m(r){return r.requestStatus===1&&r.requestTime+dl<Date.now()}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function wm(r){const e=r,{installationEntry:t,registrationPromise:s}=await Hr(e);return s?s.catch(console.error):Wr(e).catch(console.error),t.fid}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function Em(r,e=!1){const t=r;return await Tm(t),(await Wr(t,e)).token}async function Tm(r){const{registrationPromise:e}=await Hr(r);e&&await e}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function bm(r){if(!r||!r.options)throw Ji("App Configuration");if(!r.name)throw Ji("App Name");const e=["projectId","apiKey","appId"];for(const t of e)if(!r.options[t])throw Ji(t);return{appName:r.name,projectId:r.options.projectId,apiKey:r.options.apiKey,appId:r.options.appId}}function Ji(r){return pt.create("missing-app-config-values",{valueName:r})}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Pl="installations",Sm="installations-internal",Am=r=>{const e=r.getProvider("app").getImmediate(),t=bm(e),s=ms(e,"heartbeat");return{app:e,appConfig:t,heartbeatServiceProvider:s,_delete:()=>Promise.resolve()}},Im=r=>{const e=r.getProvider("app").getImmediate(),t=ms(e,Pl).getImmediate();return{getId:()=>wm(t),getToken:i=>Em(t,i)}};function Cm(){Ye(new Fe(Pl,Am,"PUBLIC")),Ye(new Fe(Sm,Im,"PRIVATE"))}Cm();De(ul,Gr);De(ul,Gr,"esm2017");/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const oi="analytics",Pm="firebase_id",Rm="origin",Dm=60*1e3,xm="https://firebase.googleapis.com/v1alpha/projects/-/apps/{app-id}/webConfig",Kr="https://www.googletagmanager.com/gtag/js";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const we=new Sr("@firebase/analytics");/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Lm={"already-exists":"A Firebase Analytics instance with the appId {$id}  already exists. Only one Firebase Analytics instance can be created for each appId.","already-initialized":"initializeAnalytics() cannot be called again with different options than those it was initially called with. It can be called again with the same options to return the existing instance, or getAnalytics() can be used to get a reference to the already-initialized instance.","already-initialized-settings":"Firebase Analytics has already been initialized.settings() must be called before initializing any Analytics instanceor it will have no effect.","interop-component-reg-failed":"Firebase Analytics Interop Component failed to instantiate: {$reason}","invalid-analytics-context":"Firebase Analytics is not supported in this environment. Wrap initialization of analytics in analytics.isSupported() to prevent initialization in unsupported environments. Details: {$errorInfo}","indexeddb-unavailable":"IndexedDB unavailable or restricted in this environment. Wrap initialization of analytics in analytics.isSupported() to prevent initialization in unsupported environments. Details: {$errorInfo}","fetch-throttle":"The config fetch request timed out while in an exponential backoff state. Unix timestamp in milliseconds when fetch request throttling ends: {$throttleEndTimeMillis}.","config-fetch-failed":"Dynamic config fetch failed: [{$httpStatus}] {$responseMessage}","no-api-key":'The "apiKey" field is empty in the local Firebase config. Firebase Analytics requires this field tocontain a valid API key.',"no-app-id":'The "appId" field is empty in the local Firebase config. Firebase Analytics requires this field tocontain a valid app ID.',"no-client-id":'The "client_id" field is empty.',"invalid-gtag-resource":"Trusted Types detected an invalid gtag resource: {$gtagURL}."},Se=new li("analytics","Analytics",Lm);/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function km(r){if(!r.startsWith(Kr)){const e=Se.create("invalid-gtag-resource",{gtagURL:r});return we.warn(e.message),""}return r}function Rl(r){return Promise.all(r.map(e=>e.catch(t=>t)))}function Vm(r,e){let t;return window.trustedTypes&&(t=window.trustedTypes.createPolicy(r,e)),t}function Om(r,e){const t=Vm("firebase-js-sdk-policy",{createScriptURL:km}),s=document.createElement("script"),i=`${Kr}?l=${r}&id=${e}`;s.src=t?t==null?void 0:t.createScriptURL(i):i,s.async=!0,document.head.appendChild(s)}function Mm(r){let e=[];return Array.isArray(window[r])?e=window[r]:window[r]=e,e}async function Nm(r,e,t,s,i,n){const a=s[i];try{if(a)await e[a];else{const h=(await Rl(t)).find(d=>d.measurementId===i);h&&await e[h.appId]}}catch(l){we.error(l)}r("config",i,n)}async function Fm(r,e,t,s,i){try{let n=[];if(i&&i.send_to){let a=i.send_to;Array.isArray(a)||(a=[a]);const l=await Rl(t);for(const h of a){const d=l.find(p=>p.measurementId===h),m=d&&e[d.appId];if(m)n.push(m);else{n=[];break}}}n.length===0&&(n=Object.values(e)),await Promise.all(n),r("event",s,i||{})}catch(n){we.error(n)}}function $m(r,e,t,s){async function i(n,...a){try{if(n==="event"){const[l,h]=a;await Fm(r,e,t,l,h)}else if(n==="config"){const[l,h]=a;await Nm(r,e,t,s,l,h)}else if(n==="consent"){const[l,h]=a;r("consent",l,h)}else if(n==="get"){const[l,h,d]=a;r("get",l,h,d)}else if(n==="set"){const[l]=a;r("set",l)}else r(n,...a)}catch(l){we.error(l)}}return i}function zm(r,e,t,s,i){let n=function(...a){window[s].push(arguments)};return window[i]&&typeof window[i]=="function"&&(n=window[i]),window[i]=$m(n,r,e,t),{gtagCore:n,wrappedGtag:window[i]}}function Bm(r){const e=window.document.getElementsByTagName("script");for(const t of Object.values(e))if(t.src&&t.src.includes(Kr)&&t.src.includes(r))return t;return null}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Um=30,jm=1e3;class Gm{constructor(e={},t=jm){this.throttleMetadata=e,this.intervalMillis=t}getThrottleMetadata(e){return this.throttleMetadata[e]}setThrottleMetadata(e,t){this.throttleMetadata[e]=t}deleteThrottleMetadata(e){delete this.throttleMetadata[e]}}const Dl=new Gm;function qm(r){return new Headers({Accept:"application/json","x-goog-api-key":r})}async function Hm(r){var e;const{appId:t,apiKey:s}=r,i={method:"GET",headers:qm(s)},n=xm.replace("{app-id}",t),a=await fetch(n,i);if(a.status!==200&&a.status!==304){let l="";try{const h=await a.json();!((e=h.error)===null||e===void 0)&&e.message&&(l=h.error.message)}catch{}throw Se.create("config-fetch-failed",{httpStatus:a.status,responseMessage:l})}return a.json()}async function Wm(r,e=Dl,t){const{appId:s,apiKey:i,measurementId:n}=r.options;if(!s)throw Se.create("no-app-id");if(!i){if(n)return{measurementId:n,appId:s};throw Se.create("no-api-key")}const a=e.getThrottleMetadata(s)||{backoffCount:0,throttleEndTimeMillis:Date.now()},l=new Xm;return setTimeout(async()=>{l.abort()},Dm),xl({appId:s,apiKey:i,measurementId:n},a,l,e)}async function xl(r,{throttleEndTimeMillis:e,backoffCount:t},s,i=Dl){var n;const{appId:a,measurementId:l}=r;try{await Km(s,e)}catch(h){if(l)return we.warn(`Timed out fetching this Firebase app's measurement ID from the server. Falling back to the measurement ID ${l} provided in the "measurementId" field in the local Firebase config. [${h==null?void 0:h.message}]`),{appId:a,measurementId:l};throw h}try{const h=await Hm(r);return i.deleteThrottleMetadata(a),h}catch(h){const d=h;if(!Ym(d)){if(i.deleteThrottleMetadata(a),l)return we.warn(`Failed to fetch this Firebase app's measurement ID from the server. Falling back to the measurement ID ${l} provided in the "measurementId" field in the local Firebase config. [${d==null?void 0:d.message}]`),{appId:a,measurementId:l};throw h}const m=Number((n=d==null?void 0:d.customData)===null||n===void 0?void 0:n.httpStatus)===503?io(t,i.intervalMillis,Um):io(t,i.intervalMillis),p={throttleEndTimeMillis:Date.now()+m,backoffCount:t+1};return i.setThrottleMetadata(a,p),we.debug(`Calling attemptFetch again in ${m} millis`),xl(r,p,s,i)}}function Km(r,e){return new Promise((t,s)=>{const i=Math.max(e-Date.now(),0),n=setTimeout(t,i);r.addEventListener(()=>{clearTimeout(n),s(Se.create("fetch-throttle",{throttleEndTimeMillis:e}))})})}function Ym(r){if(!(r instanceof Ze)||!r.customData)return!1;const e=Number(r.customData.httpStatus);return e===429||e===500||e===503||e===504}class Xm{constructor(){this.listeners=[]}addEventListener(e){this.listeners.push(e)}abort(){this.listeners.forEach(e=>e())}}async function Qm(r,e,t,s,i){if(i&&i.global){r("event",t,s);return}else{const n=await e,a=Object.assign(Object.assign({},s),{send_to:n});r("event",t,a)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function Jm(){if(Tr())try{await br()}catch(r){return we.warn(Se.create("indexeddb-unavailable",{errorInfo:r==null?void 0:r.toString()}).message),!1}else return we.warn(Se.create("indexeddb-unavailable",{errorInfo:"IndexedDB is not available in this environment."}).message),!1;return!0}async function Zm(r,e,t,s,i,n,a){var l;const h=Wm(r);h.then(A=>{t[A.measurementId]=A.appId,r.options.measurementId&&A.measurementId!==r.options.measurementId&&we.warn(`The measurement ID in the local Firebase config (${r.options.measurementId}) does not match the measurement ID fetched from the server (${A.measurementId}). To ensure analytics events are always sent to the correct Analytics property, update the measurement ID field in the local config or remove it from the local config.`)}).catch(A=>we.error(A)),e.push(h);const d=Jm().then(A=>{if(A)return s.getId()}),[m,p]=await Promise.all([h,d]);Bm(n)||Om(n,m.measurementId),i("js",new Date);const b=(l=a==null?void 0:a.config)!==null&&l!==void 0?l:{};return b[Rm]="firebase",b.update=!0,p!=null&&(b[Pm]=p),i("config",m.measurementId,b),m.measurementId}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ep{constructor(e){this.app=e}_delete(){return delete rs[this.app.options.appId],Promise.resolve()}}let rs={},jo=[];const Go={};let Zi="dataLayer",tp="gtag",qo,Ll,Ho=!1;function sp(){const r=[];if(ta()&&r.push("This is a browser extension environment."),sa()||r.push("Cookies are not available."),r.length>0){const e=r.map((s,i)=>`(${i+1}) ${s}`).join(" "),t=Se.create("invalid-analytics-context",{errorInfo:e});we.warn(t.message)}}function ip(r,e,t){sp();const s=r.options.appId;if(!s)throw Se.create("no-app-id");if(!r.options.apiKey)if(r.options.measurementId)we.warn(`The "apiKey" field is empty in the local Firebase config. This is needed to fetch the latest measurement ID for this Firebase app. Falling back to the measurement ID ${r.options.measurementId} provided in the "measurementId" field in the local Firebase config.`);else throw Se.create("no-api-key");if(rs[s]!=null)throw Se.create("already-exists",{id:s});if(!Ho){Mm(Zi);const{wrappedGtag:n,gtagCore:a}=zm(rs,jo,Go,Zi,tp);Ll=n,qo=a,Ho=!0}return rs[s]=Zm(r,jo,Go,e,qo,Zi,t),new ep(r)}function rp(r=aa()){r=ut(r);const e=ms(r,oi);return e.isInitialized()?e.getImmediate():np(r)}function np(r,e={}){const t=ms(r,oi);if(t.isInitialized()){const i=t.getImmediate();if(Ws(e,t.getOptions()))return i;throw Se.create("already-initialized")}return t.initialize({options:e})}async function op(){if(ta()||!sa()||!Tr())return!1;try{return await br()}catch{return!1}}function ap(r,e,t,s){r=ut(r),Qm(Ll,rs[r.app.options.appId],e,t,s).catch(i=>we.error(i))}const Wo="@firebase/analytics",Ko="0.10.8";function lp(){Ye(new Fe(oi,(e,{options:t})=>{const s=e.getProvider("app").getImmediate(),i=e.getProvider("installations-internal").getImmediate();return ip(s,i,t)},"PUBLIC")),Ye(new Fe("analytics-internal",r,"PRIVATE")),De(Wo,Ko),De(Wo,Ko,"esm2017");function r(e){try{const t=e.getProvider(oi).getImmediate();return{logEvent:(s,i,n)=>ap(t,s,i,n)}}catch(t){throw Se.create("interop-component-reg-failed",{reason:t})}}}lp();let kl;function cp(){const e=oa({apiKey:"AIzaSyC2oOMCF6T2qjW6vsuiwKp7u4eA1QG9V1U",authDomain:"amazesv1.firebaseapp.com",projectId:"amazesv1",storageBucket:"amazesv1.firebasestorage.app",messagingSenderId:"5056362888",appId:"1:5056362888:web:edf69d4b49937651a0623d",measurementId:"G-PLNRBMVC30"});kl=Af(e),op().then(t=>{t&&rp(e)})}function hp(){return kl}const up="daily_times";async function dp(r){const e=hp(),t=Rc();await Ff(bf(e,up),{day:t,timeMs:r,createdAt:zf()})}class lt{constructor(){this.STORAGE_KEY="labyrinth_leap_progress",this.CURRENT_VERSION=2,this.progress=this.loadProgress(),this.migrateProgressIfNeeded()}static getInstance(){return lt.instance||(lt.instance=new lt),lt.instance}getCurrentLevel(){return this.progress.currentLevel}getHighestLevel(){return this.progress.highestLevel}getTotalStars(){return this.progress.totalStars}getTotalCoins(){return this.progress.totalCoins}isLevelUnlocked(e){if(typeof e=="number")return e<=this.progress.highestLevel;if(this.progress.unlockedLevels.has(e))return!0;const t=this.extractNumericLevel(e);return t!==null?t<=this.progress.highestLevel:!1}unlockLevel(e){this.progress.unlockedLevels.add(e),this.saveProgress()}unlockLevels(e){e.forEach(t=>this.progress.unlockedLevels.add(t)),this.saveProgress()}completeLevel(e,t,s,i,n,a){if(typeof e=="number"){this.completeLevelLegacy(e,t,s,i);return}this.completeLevelV2(e,t,s,i,n,a)}completeLevelLegacy(e,t,s,i){const n=this.progress.levelStats.get(e)||{completed:!1,bestTime:1/0,stars:0,attempts:0,lastPlayed:new Date};if(n.completed=!0,n.attempts++,n.lastPlayed=new Date,t<n.bestTime&&(n.bestTime=t),s>n.stars){const a=s-n.stars;n.stars=s,this.progress.totalStars+=a}this.progress.totalCoins+=i,this.progress.levelStats.set(e,n),e>=this.progress.highestLevel&&(this.progress.highestLevel=e+1),this.saveProgress()}completeLevelV2(e,t,s,i,n,a){const l=this.progress.levelStatsV2.get(e)||{levelId:e,completed:!1,bestTime:1/0,stars:0,attempts:0,lastPlayed:new Date,firstCompleted:void 0,objectives:new Map},h=l.completed;if(l.completed=!0,l.attempts++,l.lastPlayed=new Date,h||(l.firstCompleted=new Date),t<l.bestTime&&(l.bestTime=t),s>l.stars){const m=s-l.stars;l.stars=s,this.progress.totalStars+=m}n&&(l.objectives=new Map(n)),this.progress.totalCoins+=i,this.progress.levelStatsV2.set(e,l),a&&a.forEach(m=>this.progress.unlockedLevels.add(m));const d=this.extractNumericLevel(e);d!==null&&d>=this.progress.highestLevel&&(this.progress.highestLevel=d+1),this.saveProgress()}getLevelStats(e){return typeof e=="number"?this.progress.levelStats.get(e):this.progress.levelStatsV2.get(e)}getObjectiveProgress(e,t){const s=this.progress.levelStatsV2.get(e);return s==null?void 0:s.objectives.get(t)}getCompletedLevels(){const e=Array.from(this.progress.levelStats.entries()).filter(([s,i])=>i.completed).map(([s,i])=>s),t=Array.from(this.progress.levelStatsV2.entries()).filter(([s,i])=>i.completed).map(([s,i])=>s);return{legacy:e,v2:t}}extractNumericLevel(e){const t=e.match(/(\d+)/);return t?parseInt(t[1],10):null}loadProgress(){try{const e=localStorage.getItem(this.STORAGE_KEY);if(e){const t=JSON.parse(e),s=new Map;t.levelStats&&t.levelStats.forEach(([n,a])=>{const l={...a,lastPlayed:a.lastPlayed?new Date(a.lastPlayed):new Date};s.set(n,l)});const i=new Map;return t.levelStatsV2&&t.levelStatsV2.forEach(([n,a])=>{const l={...a,lastPlayed:new Date(a.lastPlayed),firstCompleted:a.firstCompleted?new Date(a.firstCompleted):void 0,objectives:new Map(a.objectives||[])};l.objectives.forEach(h=>{h.completedAt&&(h.completedAt=new Date(h.completedAt))}),i.set(n,l)}),{currentLevel:t.currentLevel||1,highestLevel:t.highestLevel||1,totalStars:t.totalStars||0,totalCoins:t.totalCoins||0,levelStats:s,levelStatsV2:i,unlockedLevels:new Set(t.unlockedLevels||[]),version:t.version||1}}}catch(e){console.warn("Failed to load progress:",e)}return{currentLevel:1,highestLevel:1,totalStars:0,totalCoins:0,levelStats:new Map,levelStatsV2:new Map,unlockedLevels:new Set(["level-001-tutorial"]),version:this.CURRENT_VERSION}}saveProgress(){try{const e=Array.from(this.progress.levelStatsV2.entries()).map(([s,i])=>[s,{...i,objectives:Array.from(i.objectives.entries())}]),t={...this.progress,levelStats:Array.from(this.progress.levelStats.entries()),levelStatsV2:e,unlockedLevels:Array.from(this.progress.unlockedLevels),version:this.CURRENT_VERSION};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(t))}catch(e){console.warn("Failed to save progress:",e)}}migrateProgressIfNeeded(){this.progress.version<this.CURRENT_VERSION&&(console.log(`Migrating progress from version ${this.progress.version} to ${this.CURRENT_VERSION}`),this.progress.version<2&&this.migrateToV2(),this.progress.version=this.CURRENT_VERSION,this.saveProgress())}migrateToV2(){this.progress.levelStatsV2||(this.progress.levelStatsV2=new Map),this.progress.unlockedLevels||(this.progress.unlockedLevels=new Set),this.progress.levelStats.forEach((e,t)=>{const s=`level-${t.toString().padStart(3,"0")}-migrated`;if(!this.progress.levelStatsV2.has(s)){const i={levelId:s,completed:e.completed,bestTime:e.bestTime,stars:e.stars,attempts:e.attempts,lastPlayed:e.lastPlayed,objectives:new Map};this.progress.levelStatsV2.set(s,i),e.completed&&this.progress.unlockedLevels.add(s)}}),this.progress.unlockedLevels.add("level-001-tutorial"),console.log(`Migrated ${this.progress.levelStats.size} legacy levels to new format`)}getPlayStats(){const e=Array.from(this.progress.levelStats.values()).filter(s=>s.completed).length,t=Array.from(this.progress.levelStatsV2.values()).filter(s=>s.completed).length;return{totalLevelsCompleted:e+t,legacyLevelsCompleted:e,v2LevelsCompleted:t,averageAttempts:this.getAverageAttempts(),totalPlayTime:this.getTotalPlayTime(),streakDays:this.getStreakDays(),unlockedLevelsCount:this.progress.unlockedLevels.size}}getAverageAttempts(){const e=Array.from(this.progress.levelStats.values()).filter(n=>n.completed),t=Array.from(this.progress.levelStatsV2.values()).filter(n=>n.completed),s=[...e,...t];return s.length===0?0:s.reduce((n,a)=>n+a.attempts,0)/s.length}getTotalPlayTime(){const e=Array.from(this.progress.levelStats.values()).filter(s=>s.completed).reduce((s,i)=>s+i.bestTime,0),t=Array.from(this.progress.levelStatsV2.values()).filter(s=>s.completed).reduce((s,i)=>s+i.bestTime,0);return e+t}getStreakDays(){const e=new Date;let t=0;for(let s=0;s<30;s++){const i=new Date(e);i.setDate(e.getDate()-s);const n=Array.from(this.progress.levelStats.values()).some(l=>new Date(l.lastPlayed).toDateString()===i.toDateString()),a=Array.from(this.progress.levelStatsV2.values()).some(l=>new Date(l.lastPlayed).toDateString()===i.toDateString());if(n||a)t++;else if(s>0)break}return t}getUnlockedLevels(){return Array.from(this.progress.unlockedLevels)}resetProgress(){this.progress={currentLevel:1,highestLevel:1,totalStars:0,totalCoins:0,levelStats:new Map,levelStatsV2:new Map,unlockedLevels:new Set(["level-001-tutorial"]),version:this.CURRENT_VERSION},this.saveProgress()}exportProgress(){return JSON.stringify({...this.progress,levelStats:Array.from(this.progress.levelStats.entries()),levelStatsV2:Array.from(this.progress.levelStatsV2.entries()).map(([e,t])=>[e,{...t,objectives:Array.from(t.objectives.entries())}]),unlockedLevels:Array.from(this.progress.unlockedLevels)},null,2)}importProgress(e){try{const t=JSON.parse(e);if(!t||typeof t!="object")throw new Error("Invalid progress data format");const s={currentLevel:t.currentLevel||1,highestLevel:t.highestLevel||1,totalStars:t.totalStars||0,totalCoins:t.totalCoins||0,levelStats:new Map(t.levelStats||[]),levelStatsV2:new Map,unlockedLevels:new Set(t.unlockedLevels||["level-001-tutorial"]),version:t.version||this.CURRENT_VERSION};return t.levelStatsV2&&t.levelStatsV2.forEach(([i,n])=>{const a={...n,lastPlayed:new Date(n.lastPlayed),firstCompleted:n.firstCompleted?new Date(n.firstCompleted):void 0,objectives:new Map(n.objectives||[])};s.levelStatsV2.set(i,a)}),this.progress=s,this.saveProgress(),!0}catch(t){return console.error("Failed to import progress:",t),!1}}}class bt{constructor(){this.events=[],this.maxEvents=100,this.debugElement=null,this.isVisible=!1,this.logToConsole=!0,this.logToScreen=!0,this.createDebugInterface(),this.setupGlobalErrorHandling()}static getInstance(){return bt.instance||(bt.instance=new bt),bt.instance}log(e,t,s,i,n){const a={timestamp:Date.now(),type:e,category:t,message:s,data:i,position:n};if(this.events.push(a),this.events.length>this.maxEvents&&(this.events=this.events.slice(-this.maxEvents)),this.logToConsole){const l=new Date(a.timestamp).toLocaleTimeString(),h=n?` @(${n.x},${n.y})`:"",d=i?` | Data: ${JSON.stringify(i)}`:"";console.log(` [${l}] ${e.toUpperCase()} | ${t} | ${s}${h}${d}`)}if(this.logToScreen&&this.isVisible&&this.updateDebugDisplay(),window.Android)try{window.Android.log(`MAZE_DEBUG: [${e}] ${t}: ${s}`)}catch{}}click(e,t,s,i){this.log("click",e,t,s,i)}touch(e,t,s,i){this.log("touch",e,t,s,i)}scene(e,t,s){this.log("scene",e,t,s)}level(e,t,s){this.log("level",e,t,s)}game(e,t,s){this.log("game",e,t,s)}error(e,t,s){this.log("error",e,t,s)}info(e,t,s){this.log("info",e,t,s)}toggle(){this.isVisible=!this.isVisible,this.debugElement&&(this.debugElement.style.display=this.isVisible?"block":"none",this.isVisible&&this.updateDebugDisplay())}show(){this.isVisible=!0,this.debugElement&&(this.debugElement.style.display="block",this.updateDebugDisplay())}hide(){this.isVisible=!1,this.debugElement&&(this.debugElement.style.display="none")}clear(){this.events=[],this.updateDebugDisplay(),console.clear()}getEvents(){return[...this.events]}getRecentEvents(e=10){return this.events.slice(-e)}exportLogs(){return JSON.stringify(this.events,null,2)}createDebugInterface(){this.debugElement=document.createElement("div"),this.debugElement.id="debug-overlay",this.debugElement.style.cssText=`
      position: fixed;
      top: 10px;
      right: 10px;
      width: 300px;
      max-height: 400px;
      background: rgba(0, 0, 0, 0.9);
      color: #00ff00;
      font-family: 'Courier New', monospace;
      font-size: 10px;
      padding: 10px;
      border-radius: 5px;
      z-index: 10000;
      overflow-y: auto;
      display: none;
      border: 1px solid #00ff00;
    `;const e=document.createElement("button");e.textContent="",e.style.cssText=`
      position: fixed;
      top: 10px;
      left: 10px;
      width: 40px;
      height: 40px;
      background: rgba(0, 0, 0, 0.8);
      color: #00ff00;
      border: 1px solid #00ff00;
      border-radius: 50%;
      font-size: 16px;
      z-index: 10001;
      cursor: pointer;
    `,e.addEventListener("click",()=>this.toggle());const t=document.createElement("button");t.textContent="",t.style.cssText=`
      position: fixed;
      top: 60px;
      left: 10px;
      width: 40px;
      height: 40px;
      background: rgba(0, 0, 0, 0.8);
      color: #ff0000;
      border: 1px solid #ff0000;
      border-radius: 50%;
      font-size: 16px;
      z-index: 10001;
      cursor: pointer;
    `,t.addEventListener("click",()=>this.clear()),document.body?(document.body.appendChild(this.debugElement),document.body.appendChild(e),document.body.appendChild(t)):document.addEventListener("DOMContentLoaded",()=>{document.body.appendChild(this.debugElement),document.body.appendChild(e),document.body.appendChild(t)}),document.addEventListener("keydown",s=>{s.ctrlKey&&s.key==="d"&&(s.preventDefault(),this.toggle())})}updateDebugDisplay(){if(!this.debugElement||!this.isVisible)return;const t=this.getRecentEvents(20).map(s=>{const i=new Date(s.timestamp).toLocaleTimeString(),n=this.getTypeColor(s.type),a=s.position?` @(${s.position.x},${s.position.y})`:"";return`<div style="color: ${n}; margin-bottom: 2px;">
        [${i}] ${s.type.toUpperCase()}<br>
        ${s.category}: ${s.message}${a}
        ${s.data?`<br><small>${JSON.stringify(s.data)}</small>`:""}
      </div>`}).join("");this.debugElement.innerHTML=`
      <div style="color: #00ff00; font-weight: bold; margin-bottom: 10px;">
         Debug Log (${this.events.length} events)
      </div>
      ${t}
    `,this.debugElement.scrollTop=this.debugElement.scrollHeight}getTypeColor(e){return{click:"#00ff00",touch:"#00ffff",scene:"#ffff00",level:"#ff8800",game:"#8800ff",error:"#ff0000",info:"#ffffff"}[e]||"#ffffff"}setupGlobalErrorHandling(){window.addEventListener("error",e=>{var t;this.error("JavaScript",`${e.message} at ${e.filename}:${e.lineno}`,{error:e.error,stack:(t=e.error)==null?void 0:t.stack})}),window.addEventListener("unhandledrejection",e=>{this.error("Promise",`Unhandled rejection: ${e.reason}`,{reason:e.reason})})}}const k=bt.getInstance();window.debug={log:(r,e,t,s)=>k.log(r,e,t,s),click:(r,e,t,s)=>k.click(r,e,t,s),touch:(r,e,t,s)=>k.touch(r,e,t,s),scene:(r,e,t)=>k.scene(r,e,t),level:(r,e,t)=>k.level(r,e,t),game:(r,e,t)=>k.game(r,e,t),error:(r,e,t)=>k.error(r,e,t),info:(r,e,t)=>k.info(r,e,t),toggle:()=>k.toggle(),show:()=>k.show(),hide:()=>k.hide(),clear:()=>k.clear(),export:()=>k.exportLogs()};class fp{constructor(e,t="src/assets/character/a_cute_elf/"){this.config=null,this.loadedTextures=new Map,this.createdAnimations=new Set,this.scene=e,this.basePath=t}async loadConfig(){try{const e=`${this.basePath}elf-character-config.json`,t=await fetch(e);if(!t.ok)throw new Error(`Failed to load elf config: ${t.statusText}`);this.config=await t.json(),console.log("Elf character config loaded successfully")}catch(e){throw console.error("Failed to load elf character config:",e),e}}async loadAssets(){if(!this.config)throw new Error("Config not loaded. Call loadConfig() first.");const e={success:!0,loadedTextures:[],createdAnimations:[],errors:[]};try{await this.loadIdleFrames(e),await this.loadWalkingFrames(e),this.createAnimations(e),console.log(`Elf character assets loaded: ${e.loadedTextures.length} textures, ${e.createdAnimations.length} animations`)}catch(t){e.success=!1,e.errors.push(t.message),console.error("Failed to load elf character assets:",t)}return e}getTextureKey(e,t,s){var n;const i=((n=this.config)==null?void 0:n.direction_mapping[e])||e;if(t==="idle")return`elf_idle_${i}`;{const a=s!==void 0?`_${s.toString().padStart(3,"0")}`:"";return`elf_walk_${i}${a}`}}getAnimationKey(e,t){var i;const s=((i=this.config)==null?void 0:i.direction_mapping[e])||e;return`elf_${t}_${s}`}areAssetsLoaded(){return this.config?this.getExpectedTextureKeys().every(t=>this.scene.textures.exists(t)):!1}getExpectedTextureKeys(){if(!this.config)return[];const e=[];return Object.keys(this.config.assets.idle_frames).forEach(t=>{e.push(`elf_idle_${t.replace("_","-")}`)}),Object.entries(this.config.assets.walking_frames).forEach(([t,s])=>{s.forEach((i,n)=>{e.push(`elf_walk_${t}_${n.toString().padStart(3,"0")}`)})}),e}async loadIdleFrames(e){if(!this.config)return;const t=[];Object.entries(this.config.assets.idle_frames).forEach(([s,i])=>{const n=`elf_idle_${s.replace("_","-")}`,a=`${this.basePath}${i}`,l=this.loadSingleTexture(n,a).then(()=>{e.loadedTextures.push(n)}).catch(h=>{e.errors.push(`Failed to load idle frame ${s}: ${h.message}`)});t.push(l)}),await Promise.all(t)}async loadWalkingFrames(e){if(!this.config)return;const t=[];Object.entries(this.config.assets.walking_frames).forEach(([s,i])=>{i.forEach((n,a)=>{const l=`elf_walk_${s}_${a.toString().padStart(3,"0")}`,h=`${this.basePath}${n}`,d=this.loadSingleTexture(l,h).then(()=>{e.loadedTextures.push(l)}).catch(m=>{e.errors.push(`Failed to load walking frame ${s}[${a}]: ${m.message}`)});t.push(d)})}),await Promise.all(t)}loadSingleTexture(e,t){return new Promise((s,i)=>{if(this.scene.textures.exists(e)){s();return}this.scene.load.image(e,t);const n=()=>{this.scene.textures.exists(e)?(this.loadedTextures.set(e,this.scene.textures.get(e)),s()):i(new Error(`Texture ${e} failed to load from ${t}`)),l()},a=h=>{i(new Error(`Failed to load texture ${e}: ${h}`)),l()},l=()=>{this.scene.load.off("complete",n),this.scene.load.off("loaderror",a)};this.scene.load.once("complete",n),this.scene.load.once("loaderror",a),this.scene.load.isLoading()||this.scene.load.start()})}createAnimations(e){this.config&&(Object.keys(this.config.assets.idle_frames).forEach(t=>{const s=`elf_idle_${t.replace("_","-")}`,i=`elf_idle_${t.replace("_","-")}`;if(this.scene.textures.exists(i)&&!this.scene.anims.exists(s))try{this.scene.anims.create({key:s,frames:[{key:i}],frameRate:this.config.animations.idle.frameRate,repeat:this.config.animations.idle.repeat,yoyo:this.config.animations.idle.yoyo}),this.createdAnimations.add(s),e.createdAnimations.push(s)}catch(n){e.errors.push(`Failed to create idle animation ${t}: ${n.message}`)}}),Object.entries(this.config.assets.walking_frames).forEach(([t,s])=>{const i=`elf_walk_${t}`;if(!this.scene.anims.exists(i))try{const n=s.map((a,l)=>({key:`elf_walk_${t}_${l.toString().padStart(3,"0")}`})).filter(a=>this.scene.textures.exists(a.key));n.length>0&&(this.scene.anims.create({key:i,frames:n,frameRate:this.config.animations.walking.frameRate,repeat:this.config.animations.walking.repeat,yoyo:this.config.animations.walking.yoyo}),this.createdAnimations.add(i),e.createdAnimations.push(i))}catch(n){e.errors.push(`Failed to create walking animation ${t}: ${n.message}`)}}))}createElfSprite(e,t="down"){if(!this.areAssetsLoaded())return console.warn("Elf character assets not fully loaded"),null;const s=this.getTextureKey(t,"idle");if(!this.scene.textures.exists(s))return console.warn(`Elf texture ${s} not found`),null;const i=this.scene.add.sprite(e.x,e.y,s);return this.config&&(i.setScale(this.config.character.scale),i.setOrigin(this.config.character.anchor.x,this.config.character.anchor.y)),i}getConfig(){return this.config}getLoadedTextures(){return Array.from(this.loadedTextures.keys())}getCreatedAnimations(){return Array.from(this.createdAnimations)}validateAssets(){const e={isValid:!0,missing:[],errors:[]};if(!this.config)return e.isValid=!1,e.errors.push("No configuration loaded"),e;const s=this.getExpectedTextureKeys().filter(i=>!this.scene.textures.exists(i));return s.length>0&&(e.isValid=!1,e.missing=s),e}cleanup(){for(const e of this.loadedTextures.keys())this.scene.textures.exists(e)&&this.scene.textures.remove(e);for(const e of this.createdAnimations)this.scene.anims.exists(e)&&this.scene.anims.remove(e);this.loadedTextures.clear(),this.createdAnimations.clear(),this.config=null,console.log("Elf character assets cleaned up")}}class mp{constructor(e){this.registeredAnimations=new Map,this.fallbackTextures=new Map,this.elfCharacterLoader=null,this.useElfCharacter=!1,this.scene=e,this.initializeElfCharacter()}registerAnimation(e){this.registeredAnimations.set(e.key,e),this.scene.anims.exists(e.key)||this.createPhaserAnimation(e)}getAnimation(e){return this.registeredAnimations.get(e)||null}hasAnimation(e){return this.registeredAnimations.has(e)||this.scene.anims.exists(e)}createAllAnimations(){for(const e of this.registeredAnimations.values())this.scene.anims.exists(e.key)||this.createPhaserAnimation(e)}async initializeElfCharacter(){try{this.elfCharacterLoader=new fp(this.scene),await this.elfCharacterLoader.loadConfig();const e=await this.elfCharacterLoader.loadAssets();e.success?(this.useElfCharacter=!0,this.registerElfAnimations(),console.log("Elf character successfully loaded and registered")):(console.warn("Elf character failed to load, falling back to basic animations:",e.errors),this.initializeFallbackAnimations())}catch(e){console.warn("Failed to initialize elf character, using fallback:",e),this.initializeFallbackAnimations()}}initializeFallbackAnimations(){this.createFallbackTextures(),this.registerFallbackAnimations()}createFallbackTextures(){["player_idle","player_walk_up","player_walk_down","player_walk_left","player_walk_right"].forEach(t=>{this.scene.textures.exists(t)||this.createPlayerTexture(t)})}createPlayerTexture(e){const t=this.scene.add.graphics();t.fillStyle(4286945),t.fillCircle(8,8,6),t.setStroke(2,1981066),t.strokeCircle(8,8,6),e.includes("up")?(t.fillStyle(16777215),t.fillTriangle(8,4,6,8,10,8)):e.includes("down")?(t.fillStyle(16777215),t.fillTriangle(8,12,6,8,10,8)):e.includes("left")?(t.fillStyle(16777215),t.fillTriangle(4,8,8,6,8,10)):e.includes("right")?(t.fillStyle(16777215),t.fillTriangle(12,8,8,6,8,10)):e.includes("idle")&&(t.fillStyle(16777215),t.fillCircle(8,6,1)),t.generateTexture(e,16,16),t.destroy(),this.fallbackTextures.set(e,e)}registerFallbackAnimations(){this.registerAnimation({key:"player_idle",frames:[{key:"player_idle",duration:1e3},{key:"player_idle",duration:1e3}],frameRate:2,repeat:-1,yoyo:!1}),["up","down","left","right"].forEach(t=>{this.registerAnimation({key:`player_walk_${t}`,frames:[{key:`player_walk_${t}`,duration:125},{key:"player_idle",duration:125},{key:`player_walk_${t}`,duration:125},{key:"player_idle",duration:125}],frameRate:8,repeat:-1,yoyo:!1})})}createPhaserAnimation(e){try{const t=[];e.frames.forEach(i=>{i.frame?t.push({key:i.key,frame:i.frame}):t.push({key:i.key})});const s={key:e.key,frames:t,frameRate:e.frameRate,repeat:e.repeat,yoyo:e.yoyo||!1};this.scene.anims.create(s),console.log(`Created animation: ${e.key}`)}catch(t){console.error(`Failed to create animation ${e.key}:`,t)}}registerAtlasAnimations(e,t){t.forEach(s=>{const i={key:s.key,frames:s.frames.map(n=>({key:e,frame:n.frame||n,duration:n.duration})),frameRate:s.frameRate||8,repeat:s.repeat!==void 0?s.repeat:-1,yoyo:s.yoyo||!1};this.registerAnimation(i)})}getAvailableAnimations(){return Array.from(this.registeredAnimations.keys())}validateAnimations(){const e={valid:[],invalid:[]};for(const[t,s]of this.registeredAnimations.entries())try{s.frames.every(n=>this.scene.textures.exists(n.key))?e.valid.push(t):e.invalid.push(t)}catch{e.invalid.push(t)}return e}registerElfAnimations(){if(!this.elfCharacterLoader)return;const e=["up","down","left","right"];e.forEach(t=>{const s=this.elfCharacterLoader.getAnimationKey(t,"idle");this.scene.anims.exists(s)&&this.registeredAnimations.set(`player_idle_${t}`,{key:s,frames:[{key:this.elfCharacterLoader.getTextureKey(t,"idle")}],frameRate:1,repeat:-1,yoyo:!1})}),e.forEach(t=>{const s=this.elfCharacterLoader.getAnimationKey(t,"walking");this.scene.anims.exists(s)&&this.registeredAnimations.set(`player_walk_${t}`,{key:s,frames:[],frameRate:8,repeat:-1,yoyo:!1})}),console.log(`Registered ${this.registeredAnimations.size} elf character animations`)}getPlayerTextureKey(e="down"){return this.useElfCharacter&&this.elfCharacterLoader?this.elfCharacterLoader.getTextureKey(e,"idle"):"player_idle"}getPlayerAnimationKey(e,t){return this.useElfCharacter&&this.elfCharacterLoader?this.elfCharacterLoader.getAnimationKey(e,t):`player_${t}_${e}`}isUsingElfCharacter(){return this.useElfCharacter}getElfCharacterLoader(){return this.elfCharacterLoader}useFallbackAnimations(){this.useElfCharacter=!1,this.registeredAnimations.clear(),this.initializeFallbackAnimations(),console.log("Switched to fallback animations")}destroy(){this.elfCharacterLoader&&(this.elfCharacterLoader.cleanup(),this.elfCharacterLoader=null),this.registeredAnimations.clear(),this.fallbackTextures.clear()}}class pp{constructor(e,t,s){this.idleTimer=null,this.movementTween=null,this.animationQueue=[],this.isInitialized=!1,this.defaultConfig={idleAnimation:"player_idle",walkAnimations:{up:"player_walk_up",down:"player_walk_down",left:"player_walk_left",right:"player_walk_right"},transitionDuration:100,movementDuration:200,idleDelay:1e3},this.scene=e,this.sprite=t,this.config={...this.defaultConfig,...s},this.state={currentAnimation:"",direction:null,isMoving:!1,isIdle:!0,position:{x:0,y:0},lastMoveTime:0},this.animationRegistry=new mp(e),this.initialize()}async initialize(){await this.waitForAnimationsReady(),this.animationRegistry.createAllAnimations(),this.playIdleAnimation(),this.setupIdleTimer(),this.isInitialized=!0,console.log("PlayerAnimationController initialized")}waitForAnimationsReady(){return new Promise(e=>{const t=()=>{if(this.animationRegistry.isUsingElfCharacter()){const s=this.animationRegistry.getElfCharacterLoader();if(s&&s.areAssetsLoaded()){e();return}}else{e();return}setTimeout(t,100)};t()})}playMovementAnimation(e,t,s){return new Promise(i=>{if(!this.isInitialized){console.warn("PlayerAnimationController not initialized"),i();return}this.state.direction=e,this.state.isMoving=!0,this.state.isIdle=!1,this.state.lastMoveTime=Date.now(),this.clearIdleTimer(),this.movementTween&&this.movementTween.stop();let n;this.animationRegistry.isUsingElfCharacter()?n=this.animationRegistry.getPlayerAnimationKey(e,"walking"):n=this.config.walkAnimations[e],this.animationRegistry.hasAnimation(n)?(this.sprite.play(n),this.state.currentAnimation=n):this.handleDirectionalFallback(e),this.gridToWorldPosition(t);const a=this.gridToWorldPosition(s);this.movementTween=this.scene.tweens.add({targets:this.sprite,x:a.x,y:a.y,duration:this.config.movementDuration,ease:"Power2",onComplete:()=>{this.state.position=s,this.state.isMoving=!1,this.transitionToIdle(),i()}})})}playIdleAnimation(){if(!this.isInitialized)return;let e;if(this.animationRegistry.isUsingElfCharacter()){const t=this.state.direction||"down";e=this.animationRegistry.getPlayerAnimationKey(t,"idle")}else e=this.config.idleAnimation;this.animationRegistry.hasAnimation(e)?(this.sprite.play(e),this.state.currentAnimation=e):(this.sprite.stop(),this.state.currentAnimation="idle_fallback"),this.state.isIdle=!0,this.state.isMoving=!1}updatePosition(e){const t=this.gridToWorldPosition(e);this.sprite.setPosition(t.x,t.y),this.state.position=e}getAnimationState(){return{...this.state}}isAnimating(){return this.state.isMoving||this.movementTween&&this.movementTween.isActive()}forceIdle(){this.movementTween&&(this.movementTween.stop(),this.movementTween=null),this.clearIdleTimer(),this.playIdleAnimation(),this.setupIdleTimer()}setConfig(e){this.config={...this.config,...e}}updateSprite(e){const t=this.gridToWorldPosition(this.state.position);if(e.setPosition(t.x,t.y),this.movementTween&&this.movementTween.stop(),this.sprite=e,this.state.isIdle)this.playIdleAnimation();else if(this.state.isMoving&&this.state.direction){const s=this.config.walkAnimations[this.state.direction];this.scene.anims.exists(s)&&this.sprite.play(s)}}destroy(){this.clearIdleTimer(),this.movementTween&&(this.movementTween.stop(),this.movementTween=null),this.animationRegistry&&this.animationRegistry.destroy(),this.animationQueue=[],this.isInitialized=!1,console.log("PlayerAnimationController destroyed")}handleDirectionalFallback(e){switch(e){case"left":this.sprite.setFlipX(!0);break;case"right":this.sprite.setFlipX(!1);break;case"up":this.sprite.setFlipX(!1),this.sprite.setTint(13421823);break;case"down":this.sprite.setFlipX(!1),this.sprite.setTint(16764108);break}this.scene.time.delayedCall(this.config.movementDuration,()=>{this.sprite.clearTint()})}transitionToIdle(){this.scene.time.delayedCall(this.config.transitionDuration,()=>{this.state.isMoving||(this.playIdleAnimation(),this.setupIdleTimer())})}setupIdleTimer(){this.clearIdleTimer(),this.idleTimer=this.scene.time.addEvent({delay:this.config.idleDelay,callback:()=>{this.state.isIdle&&!this.state.isMoving&&this.playIdleVariation()},loop:!0})}clearIdleTimer(){this.idleTimer&&(this.idleTimer.destroy(),this.idleTimer=null)}playIdleVariation(){this.sprite&&this.sprite.active&&this.scene.tweens.add({targets:this.sprite,scaleX:this.sprite.scaleX*1.05,scaleY:this.sprite.scaleY*1.05,duration:200,yoyo:!0,ease:"Sine.easeInOut"})}gridToWorldPosition(e){return{x:(this.scene.scale.width-240)/2+e.x*24+24/2,y:200+e.y*24+24/2}}queueAnimation(e){this.animationQueue.push(e)}clearAnimationQueue(){this.animationQueue=[]}getCurrentDirection(){return this.state.direction}isMoving(){return this.state.isMoving}isIdle(){return this.state.isIdle}getTimeSinceLastMove(){return Date.now()-this.state.lastMoveTime}setCellSize(e){}playCustomAnimation(e,t=!1){return new Promise(s=>{if(!this.scene.anims.exists(e)){console.warn(`Animation ${e} does not exist`),s();return}this.state.currentAnimation,this.sprite.play(e),this.state.currentAnimation=e,t?s():this.sprite.once("animationcomplete",()=>{this.state.isIdle&&this.playIdleAnimation(),s()})})}pauseAnimation(){this.sprite.anims.pause()}resumeAnimation(){this.sprite.anims.resume()}getConfig(){return{...this.config}}getAnimationRegistry(){return this.animationRegistry}}class gp{constructor(e,t,s){this.cellSize=24,this.currentTheme="default",this.tileCache=new Map,this.connectionCache=new Map,this.defaultTheme={floors:{default:{key:"maze_floor_default",scale:1,anchor:{x:.5,y:.5},tint:16115411}},walls:{straight:{key:"maze_wall_straight",scale:1,anchor:{x:.5,y:.5},tint:8368233},corner:{key:"maze_wall_corner",scale:1,anchor:{x:.5,y:.5},tint:8368233},junction:{key:"maze_wall_junction",scale:1,anchor:{x:.5,y:.5},tint:8368233},end:{key:"maze_wall_end",scale:1,anchor:{x:.5,y:.5},tint:8368233}},borders:{outer:{key:"maze_border_outer",scale:1,anchor:{x:.5,y:.5},tint:7048794}},background:{fill:{key:"maze_background",scale:1,anchor:{x:.5,y:.5},tint:9419919}},special:{start:{key:"maze_start_tile",scale:1,anchor:{x:.5,y:.5},tint:9498256},goal:{key:"maze_goal_tile",scale:1,anchor:{x:.5,y:.5},tint:16766720}}},this.scene=e,this.layerManager=t,this.assetManager=s}renderMaze(e,t){var m;const s=t||this.currentTheme,i=this.scene.add.group();if(this.layerManager&&this.layerManager.getLayer){const p=this.layerManager.getLayer("maze");p&&p.add(i)}const n=e.length,a=((m=e[0])==null?void 0:m.length)||0;this.connectionCache.clear();const l=this.createMazeBackground({width:a,height:n},s);return i.add(l),this.createFloorTiles(e,s).forEach(p=>{p&&i.add(p)}),this.createWallTiles(e,s).forEach(p=>{p&&i.add(p)}),console.log(`MazeTileRenderer: Created maze with ${n}x${a} tiles using theme: ${s}`),i}createFloorTiles(e,t){var h;const s=t||this.currentTheme,i=[],n=this.getThemeConfig(s),a=e.length,l=((h=e[0])==null?void 0:h.length)||0;for(let d=0;d<a;d++)for(let m=0;m<l;m++){const p=e[d][m];let b;if(p.type==="start")b=n.special.start;else if(p.type==="goal")b=n.special.goal;else if(n.floors.variants&&n.floors.variants.length>0){const C=(m+d*3)%n.floors.variants.length;b=n.floors.variants[C]}else b=n.floors.default;const A=this.createTileSprite(b,{x:m,y:d});A&&(A.setData("type","floor"),A.setData("cellType",p.type),A.setData("gridPosition",{x:m,y:d}),i.push(A))}return i}createWallTiles(e,t){var l;const s=t||this.currentTheme,i=[],n=e.length,a=((l=e[0])==null?void 0:l.length)||0;for(let h=0;h<n;h++)for(let d=0;d<a;d++){const m=e[h][d],p=this.createWallSegments({x:d,y:h},m.walls,e,s);i.push(...p)}return i}createMazeBackground(e,t){const s=t||this.currentTheme,i=this.scene.add.group(),n=this.getThemeConfig(s),a=e.width*this.cellSize,l=e.height*this.cellSize,h=this.scene.scale.width/2,d=200+l/2,m=this.scene.add.rectangle(h,d,a+40,l+40,this.getTintFromConfig(n.background.fill));return m.setStrokeStyle(4,this.getTintFromConfig(n.borders.outer)),i.add(m),this.createBorderTiles(e,s).forEach(b=>{b&&i.add(b)}),n.background.pattern&&this.createPatternTiles(e,n.background.pattern).forEach(A=>{A&&i.add(A)}),i}updateMazeTheme(e,t){const s=this.getThemeConfig(t);e.children.entries.forEach(i=>{if(i instanceof Phaser.GameObjects.Sprite){const n=i.getData("type"),a=i.getData("cellType");let l=null;if(n==="floor")a==="start"?l=s.special.start:a==="goal"?l=s.special.goal:l=s.floors.default;else if(n==="wall"){const h=i.getData("wallType")||"straight";l=s.walls[h]}l&&this.updateSpriteWithConfig(i,l)}else i instanceof Phaser.GameObjects.Group&&this.updateMazeTheme(i,t)}),this.currentTheme=t,console.log(`Updated maze theme to: ${t}`)}analyzeTileConnections(e,t,s){var d;const i=`${t},${s}`;if(this.connectionCache.has(i))return this.connectionCache.get(i);const n=e.length,a=((d=e[0])==null?void 0:d.length)||0;if(t<0||s<0||t>=a||s>=n)return{north:!1,south:!1,east:!1,west:!1,corners:{northEast:!1,northWest:!1,southEast:!1,southWest:!1}};const l=e[s][t],h={north:!(l.walls&8),south:!(l.walls&2),east:!(l.walls&1),west:!(l.walls&4),corners:{northEast:!1,northWest:!1,southEast:!1,southWest:!1}};return h.north&&h.east&&(h.corners.northEast=!0),h.north&&h.west&&(h.corners.northWest=!0),h.south&&h.east&&(h.corners.southEast=!0),h.south&&h.west&&(h.corners.southWest=!0),this.connectionCache.set(i,h),h}getWallTileForConnections(e,t){const s=this.getThemeConfig(t),i=[e.north,e.south,e.east,e.west].filter(Boolean).length;return i===0?s.walls.straight:i===1?s.walls.end:i===2?e.north&&e.south||e.east&&e.west?s.walls.straight:s.walls.corner:s.walls.junction}positionTile(e,t){const s=this.gridToWorldX(t.x),i=this.gridToWorldY(t.y);e.setPosition(s,i)}createWallSegments(e,t,s,i){const n=[],a=this.getThemeConfig(i),l=this.analyzeTileConnections(s,e.x,e.y);if(t&8){const h=this.getWallConfigForDirection("north",l,a),d=this.createTileSprite(h,{x:e.x,y:e.y-.5});d&&(d.setData("type","wall"),d.setData("direction","north"),d.setData("wallType",this.getWallTypeFromConfig(h,a)),n.push(d))}if(t&2){const h=this.getWallConfigForDirection("south",l,a),d=this.createTileSprite(h,{x:e.x,y:e.y+.5});d&&(d.setData("type","wall"),d.setData("direction","south"),d.setData("wallType",this.getWallTypeFromConfig(h,a)),n.push(d))}if(t&4){const h=this.getWallConfigForDirection("west",l,a),d=this.createTileSprite(h,{x:e.x-.5,y:e.y});d&&(d.setData("type","wall"),d.setData("direction","west"),d.setData("wallType",this.getWallTypeFromConfig(h,a)),n.push(d))}if(t&1){const h=this.getWallConfigForDirection("east",l,a),d=this.createTileSprite(h,{x:e.x+.5,y:e.y});d&&(d.setData("type","wall"),d.setData("direction","east"),d.setData("wallType",this.getWallTypeFromConfig(h,a)),n.push(d))}return n}createBorderTiles(e,t){const s=[],n=this.getThemeConfig(t).borders.outer,{width:a,height:l}=e;for(let h=-1;h<=a;h++){const d=this.createTileSprite(n,{x:h,y:-1});d&&(d.setData("type","border"),d.setData("position","top"),s.push(d));const m=this.createTileSprite(n,{x:h,y:l});m&&(m.setData("type","border"),m.setData("position","bottom"),s.push(m))}for(let h=0;h<l;h++){const d=this.createTileSprite(n,{x:-1,y:h});d&&(d.setData("type","border"),d.setData("position","left"),s.push(d));const m=this.createTileSprite(n,{x:a,y:h});m&&(m.setData("type","border"),m.setData("position","right"),s.push(m))}return s}createPatternTiles(e,t){const s=[],{width:i,height:n}=e,a=3;for(let l=0;l<n;l+=a)for(let h=0;h<i;h+=a){const d=this.createTileSprite(t,{x:h+.5,y:l+.5});d&&(d.setAlpha(.3),d.setData("type","pattern"),s.push(d))}return s}createTileSprite(e,t){try{let s;if(e.atlas&&e.frame)s=this.scene.add.sprite(0,0,e.atlas,e.frame);else{const i=this.scene.add.graphics();i.fillStyle(e.tint||16777215),i.fillRect(-this.cellSize/2,-this.cellSize/2,this.cellSize,this.cellSize);const n=i.generateTexture(e.key,this.cellSize,this.cellSize);s=this.scene.add.sprite(0,0,n),i.destroy()}return e.scale&&s.setScale(e.scale),e.anchor&&s.setOrigin(e.anchor.x,e.anchor.y),e.tint!==void 0&&s.setTint(e.tint),e.rotation!==void 0&&s.setRotation(e.rotation),this.positionTile(s,t),s}catch(s){return console.warn(`Failed to create tile sprite: ${s}`),null}}getWallConfigForDirection(e,t,s){const n={...this.getWallTileForConnections(t,this.currentTheme)};switch(e){case"north":n.rotation=0;break;case"east":n.rotation=Math.PI/2;break;case"south":n.rotation=Math.PI;break;case"west":n.rotation=-Math.PI/2;break}return n}getWallTypeFromConfig(e,t){return e===t.walls.straight?"straight":e===t.walls.corner?"corner":e===t.walls.junction?"junction":e===t.walls.end?"end":"straight"}getThemeConfig(e){if(this.assetManager&&this.assetManager.getThemeAsset){const t=this.assetManager.getThemeAsset(e,"maze","complete");if(t)return t}return this.defaultTheme}updateSpriteWithConfig(e,t){t.atlas&&t.frame?e.setTexture(t.atlas,t.frame):t.key&&e.setTexture(t.key),t.scale&&e.setScale(t.scale),t.anchor&&e.setOrigin(t.anchor.x,t.anchor.y),t.tint!==void 0&&e.setTint(t.tint),t.rotation!==void 0&&e.setRotation(t.rotation)}getTintFromConfig(e){return e.tint||16777215}gridToWorldX(e){const t=10*this.cellSize;return(this.scene.scale.width-t)/2+e*this.cellSize+this.cellSize/2}gridToWorldY(e){return 200+e*this.cellSize+this.cellSize/2}setCellSize(e){this.cellSize=e}getCellSize(){return this.cellSize}setCurrentTheme(e){this.currentTheme=e}getCurrentTheme(){return this.currentTheme}clearCaches(){this.tileCache.clear(),this.connectionCache.clear()}destroy(){this.clearCaches(),console.log("MazeTileRenderer destroyed and cleaned up")}}class Vl{constructor(e,t){this.layers=new Map,this.sprites=new Map,this.currentTheme="default",this.cellSize=24,this.spritePool=new Map,this.maxPoolSize=50,this.layerConfigs=[{name:"background",depth:0,visible:!0},{name:"maze",depth:100,visible:!0},{name:"gameObjects",depth:200,visible:!0},{name:"effects",depth:300,visible:!0},{name:"ui",depth:400,visible:!0}],this.scene=e,this.assetManager=t,this.setupLayers(),this.mazeTileRenderer=new gp(e,this,t)}setupLayers(){this.layers.clear();for(const e of this.layerConfigs){const t=this.scene.add.layer();t.setName(e.name),t.setDepth(e.depth),t.setVisible(e.visible),this.layers.set(e.name,t)}console.log(`SpriteRenderer: Created ${this.layers.size} rendering layers`)}getLayer(e){return this.layers.get(e)||null}createPlayerSprite(e,t){const s=t||this.currentTheme;let i;if(this.assetManager&&this.assetManager.getThemeAsset){const a=this.assetManager.getThemeAsset(s,"player","default");a?i={key:a.key,atlas:a.atlas,frame:a.frame,scale:a.scale||1,anchor:a.anchor||{x:.5,y:.5}}:i=this.getDefaultPlayerConfig()}else i=this.getDefaultPlayerConfig();const n=this.createSpriteFromConfig(i,e,"gameObjects");return this.sprites.set("player",n),n.setData("type","player"),n.setData("theme",s),console.log(`Created player sprite at (${e.x}, ${e.y}) with theme: ${s}`),n}createOrbSprite(e,t,s){const i=s||this.currentTheme;let n;if(this.assetManager&&this.assetManager.getThemeAsset){const l=this.assetManager.getThemeAsset(i,"orbs",t);if(l&&Array.isArray(l)&&l.length>0){const h=l[0];n={key:h.key,atlas:h.atlas,frame:h.frame,scale:h.scale||.8,anchor:h.anchor||{x:.5,y:.5}}}else n=this.getDefaultOrbConfig(t)}else n=this.getDefaultOrbConfig(t);const a=this.createSpriteFromConfig(n,e,"gameObjects");return a.setData("type","orb"),a.setData("orbType",t),a.setData("theme",i),this.addFloatingAnimation(a),a}createMazeTiles(e,t){var i;const s=t||this.currentTheme;try{this.mazeTileRenderer.setCurrentTheme(s),this.mazeTileRenderer.setCellSize(this.cellSize);const n=this.mazeTileRenderer.renderMaze(e,s);return console.log(`Created enhanced maze tiles: ${e.length}x${((i=e[0])==null?void 0:i.length)||0} grid with theme: ${s}`),n}catch(n){return console.warn("Enhanced maze rendering failed, falling back to basic implementation:",n),this.createBasicMazeTiles(e,s)}}createUISprite(e,t,s){const i=s||this.currentTheme;let n;if(this.assetManager&&this.assetManager.getThemeAsset){const l=this.assetManager.getThemeAsset(i,"ui",e);l?n={key:l.key,atlas:l.atlas,frame:l.frame,scale:l.scale||1,anchor:l.anchor||{x:.5,y:.5}}:n=this.getDefaultUIConfig(e)}else n=this.getDefaultUIConfig(e);const a=this.createSpriteFromConfig(n,t,"ui");return a.setData("type","ui"),a.setData("elementType",e),a.setData("theme",i),a}updateSpriteTheme(e,t){const s=e.getData("type"),i=e.getData("elementType")||e.getData("orbType")||"default";if(!s){console.warn("Cannot update theme: sprite missing type data");return}let n=null;if(this.assetManager&&this.assetManager.getThemeAsset){const a=s==="ui"?"ui":s==="orb"?"orbs":s,l=this.assetManager.getThemeAsset(t,a,i);l&&(n={key:l.key,atlas:l.atlas,frame:l.frame,scale:l.scale||e.scale,anchor:l.anchor})}n?(n.atlas&&n.frame?e.setTexture(n.atlas,n.frame):n.key&&e.setTexture(n.key),n.scale&&e.setScale(n.scale),n.anchor&&e.setOrigin(n.anchor.x,n.anchor.y),n.tint!==void 0&&e.setTint(n.tint),n.alpha!==void 0&&e.setAlpha(n.alpha),e.setData("theme",t),console.log(`Updated sprite theme from ${e.getData("theme")} to ${t}`)):console.warn(`No theme configuration found for ${s} in theme ${t}`)}positionSprite(e,t,s){const i=s||this.cellSize,n=this.gridToWorldX(t.x,i),a=this.gridToWorldY(t.y,i);e.setPosition(n,a)}scaleSprite(e,t){const s=t||1,i=Math.min(this.scene.scale.width/800,this.scene.scale.height/600),n=s*Math.max(.5,Math.min(2,i));e.setScale(n)}destroy(){this.mazeTileRenderer&&this.mazeTileRenderer.destroy(),this.sprites.clear();for(const[e,t]of this.spritePool.entries())t.forEach(s=>{s&&s.active&&s.destroy()});this.spritePool.clear();for(const[e,t]of this.layers.entries())t&&t.active&&t.destroy();this.layers.clear(),console.log("SpriteRenderer destroyed and cleaned up")}createBasicMazeTiles(e,t){var l;const s=this.scene.add.group(),i=this.getLayer("maze");i&&i.add(s);const n=e.length,a=((l=e[0])==null?void 0:l.length)||0;for(let h=0;h<n;h++)for(let d=0;d<a;d++){const m=e[h][d],p=this.createFloorTile({x:d,y:h},t);p&&s.add(p),this.createWallTiles({x:d,y:h},m.walls,t).forEach(A=>{A&&s.add(A)})}return console.log(`Created basic maze tiles: ${n}x${a} grid with theme: ${t}`),s}createSpriteFromConfig(e,t,s){let i;const n=`${e.key}_${e.atlas||"default"}_${e.frame||"default"}`;i=this.getFromPool(n),i||(e.atlas&&e.frame?i=this.scene.add.sprite(0,0,e.atlas,e.frame):i=this.scene.add.sprite(0,0,e.key)),e.scale&&i.setScale(e.scale),e.anchor&&i.setOrigin(e.anchor.x,e.anchor.y),e.tint!==void 0&&i.setTint(e.tint),e.alpha!==void 0&&i.setAlpha(e.alpha),this.positionSprite(i,t);const a=this.getLayer(s);return a&&a.add(i),i}createFloorTile(e,t){let s;if(this.assetManager&&this.assetManager.getThemeAsset){const n=this.assetManager.getThemeAsset(t,"maze","floors");if(n&&Array.isArray(n)&&n.length>0){const a=n[0];s={key:a.key,atlas:a.atlas,frame:a.frame,scale:a.scale||1,anchor:{x:.5,y:.5}}}else return null}else return null;const i=this.createSpriteFromConfig(s,e,"maze");return i.setData("type","floor"),i}createWallTiles(e,t,s){const i=[];if(!this.assetManager||!this.assetManager.getThemeAsset)return i;const n=this.assetManager.getThemeAsset(s,"maze","walls");if(!n||!Array.isArray(n)||n.length===0)return i;const a=n[0],l={key:a.key,atlas:a.atlas,frame:a.frame,scale:a.scale||1,anchor:{x:.5,y:.5}};if(t&1){const h=this.createSpriteFromConfig(l,{x:e.x+.5,y:e.y},"maze");h.setData("type","wall"),h.setData("direction","east"),i.push(h)}if(t&2){const h=this.createSpriteFromConfig(l,{x:e.x,y:e.y+.5},"maze");h.setData("type","wall"),h.setData("direction","south"),i.push(h)}if(t&4){const h=this.createSpriteFromConfig(l,{x:e.x-.5,y:e.y},"maze");h.setData("type","wall"),h.setData("direction","west"),i.push(h)}if(t&8){const h=this.createSpriteFromConfig(l,{x:e.x,y:e.y-.5},"maze");h.setData("type","wall"),h.setData("direction","north"),i.push(h)}return i}getDefaultPlayerConfig(){return{key:"player_default",scale:1,anchor:{x:.5,y:.5},tint:4286945}}getDefaultOrbConfig(e){const t=[16739179,5164484,16770669,9822675,15961e3],s=e.charCodeAt(0)%t.length;return{key:"orb_default",scale:.8,anchor:{x:.5,y:.5},tint:t[s]}}getDefaultUIConfig(e){return{key:`ui_${e}_default`,scale:1,anchor:{x:.5,y:.5},tint:16115411}}addFloatingAnimation(e){this.scene.tweens.add({targets:e,y:e.y-2,duration:1e3+Math.random()*500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}gridToWorldX(e,t){const s=10*t;return(this.scene.scale.width-s)/2+e*t+t/2}gridToWorldY(e,t){return 200+e*t+t/2}getFromPool(e){const t=this.spritePool.get(e);if(t&&t.length>0){const s=t.pop();if(s&&s.active)return s.setActive(!0).setVisible(!0),s}return null}returnToPool(e,t){const s=this.spritePool.get(t)||[];s.length<this.maxPoolSize?(e.setActive(!1).setVisible(!1),e.removeAllListeners(),s.push(e),this.spritePool.set(t,s)):e.destroy()}setCurrentTheme(e){this.currentTheme=e,console.log(`SpriteRenderer theme set to: ${e}`)}getCurrentTheme(){return this.currentTheme}setCellSize(e){this.cellSize=e}getCellSize(){return this.cellSize}getSprite(e){return this.sprites.get(e)||null}removeSprite(e){const t=this.sprites.get(e);t&&(t.destroy(),this.sprites.delete(e))}getSpritesByType(e){const t=[];for(const s of this.layers.values())s.list.forEach(i=>{i instanceof Phaser.GameObjects.Sprite&&i.getData("type")===e&&t.push(i)});return t}updateAllSpritesTheme(e){for(const t of this.layers.values())t.list.forEach(s=>{s instanceof Phaser.GameObjects.Sprite&&this.updateSpriteTheme(s,e)});this.currentTheme=e,console.log(`Updated all sprites to theme: ${e}`)}getMazeTileRenderer(){return this.mazeTileRenderer}updateMazeTheme(e,t){this.mazeTileRenderer&&this.mazeTileRenderer.updateMazeTheme(e,t)}}class Ol{constructor(e){this.spriteConfigs=new Map,this.scene=e.scene,this.assetManager=e.assetManager,this.defaultTheme=e.defaultTheme||"default",this.cellSize=e.cellSize||24,this.initializeDefaultConfigs()}createPlayer(e,t){const s=this.getPlayerConfig((t==null?void 0:t.theme)||this.defaultTheme,t==null?void 0:t.variant),i=this.createSprite(s,e);return i.setData("type","player"),i.setData("gameObjectType","player"),i.setName("player"),t!=null&&t.animations&&this.setupAnimations(i,t.animations),t!=null&&t.interactive&&this.makeInteractive(i),i}createOrb(e,t,s){const i=this.getOrbConfig((s==null?void 0:s.theme)||this.defaultTheme,(s==null?void 0:s.variant)||"default"),n=this.createSprite(i,e);return n.setData("type","orb"),n.setData("gameObjectType","orb"),n.setData("orbId",t),n.setName(`orb_${t}`),this.addFloatingAnimation(n),s!=null&&s.animations&&this.setupAnimations(n,s.animations),n}createWall(e,t,s){const i=this.getWallConfig((s==null?void 0:s.theme)||this.defaultTheme,t,s==null?void 0:s.variant),n=this.createSprite(i,e);return n.setData("type","wall"),n.setData("gameObjectType","wall"),n.setData("direction",t),n.setName(`wall_${t}_${e.x}_${e.y}`),n}createFloor(e,t){const s=this.getFloorConfig((t==null?void 0:t.theme)||this.defaultTheme,t==null?void 0:t.variant),i=this.createSprite(s,e);return i.setData("type","floor"),i.setData("gameObjectType","floor"),i.setName(`floor_${e.x}_${e.y}`),i}createUIElement(e,t,s){const i=this.getUIConfig((s==null?void 0:s.theme)||this.defaultTheme,e,s==null?void 0:s.variant),n=this.createSprite(i,t);return n.setData("type","ui"),n.setData("gameObjectType","ui"),n.setData("elementType",e),n.setName(`ui_${e}`),(s==null?void 0:s.interactive)!==!1&&this.makeInteractive(n),n}createEffect(e,t,s){const i=this.getEffectConfig((s==null?void 0:s.theme)||this.defaultTheme,e,s==null?void 0:s.variant),n=this.createSprite(i,t);return n.setData("type","effect"),n.setData("gameObjectType","effect"),n.setData("effectType",e),n.setName(`effect_${e}_${Date.now()}`),s!=null&&s.animations&&this.setupAnimations(n,s.animations),n}createFromOptions(e){const t=this.createSprite(e.config,e.position);return e.animations&&this.setupAnimations(t,e.animations),t}setDefaultTheme(e){this.defaultTheme=e}getDefaultTheme(){return this.defaultTheme}registerSpriteConfig(e,t){this.spriteConfigs.set(e,t)}getSpriteConfig(e){return this.spriteConfigs.get(e)||null}createSprite(e,t){let s;return e.atlas&&e.frame?s=this.scene.add.sprite(0,0,e.atlas,e.frame):s=this.scene.add.sprite(0,0,e.key),e.scale&&s.setScale(e.scale),e.anchor&&s.setOrigin(e.anchor.x,e.anchor.y),e.tint!==void 0&&s.setTint(e.tint),e.alpha!==void 0&&s.setAlpha(e.alpha),this.positionSprite(s,t),s}getPlayerConfig(e,t){if(this.assetManager&&this.assetManager.getThemeAsset){const s=this.assetManager.getThemeAsset(e,"player",t||"default");if(s)return{key:s.key,atlas:s.atlas,frame:s.frame,scale:s.scale||1,anchor:s.anchor||{x:.5,y:.5}}}return this.spriteConfigs.get("player_default")||{key:"player_circle",scale:1,anchor:{x:.5,y:.5},tint:4286945}}getOrbConfig(e,t){if(this.assetManager&&this.assetManager.getThemeAsset){const n=this.assetManager.getThemeAsset(e,"orbs",t);if(n&&Array.isArray(n)&&n.length>0){const a=n[0];return{key:a.key,atlas:a.atlas,frame:a.frame,scale:a.scale||.8,anchor:a.anchor||{x:.5,y:.5}}}}const s=[16739179,5164484,16770669,9822675,15961e3],i=t.charCodeAt(0)%s.length;return this.spriteConfigs.get("orb_default")||{key:"orb_circle",scale:.8,anchor:{x:.5,y:.5},tint:s[i]}}getWallConfig(e,t,s){if(this.assetManager&&this.assetManager.getThemeAsset){const i=this.assetManager.getThemeAsset(e,"maze","walls");if(i&&Array.isArray(i)&&i.length>0){const n=i[0];return{key:n.key,atlas:n.atlas,frame:n.frame,scale:n.scale||1,anchor:n.anchor||{x:.5,y:.5}}}}return this.spriteConfigs.get("wall_default")||{key:"wall_rectangle",scale:1,anchor:{x:.5,y:.5},tint:8368233}}getFloorConfig(e,t){if(this.assetManager&&this.assetManager.getThemeAsset){const s=this.assetManager.getThemeAsset(e,"maze","floors");if(s&&Array.isArray(s)&&s.length>0){const i=s[0];return{key:i.key,atlas:i.atlas,frame:i.frame,scale:i.scale||1,anchor:i.anchor||{x:.5,y:.5}}}}return this.spriteConfigs.get("floor_default")||{key:"floor_rectangle",scale:1,anchor:{x:.5,y:.5},tint:16115411}}getUIConfig(e,t,s){if(this.assetManager&&this.assetManager.getThemeAsset){const i=this.assetManager.getThemeAsset(e,"ui",t);if(i)return{key:i.key,atlas:i.atlas,frame:i.frame,scale:i.scale||1,anchor:i.anchor||{x:.5,y:.5}}}return this.spriteConfigs.get(`ui_${t}_default`)||{key:`ui_${t}`,scale:1,anchor:{x:.5,y:.5},tint:16115411}}getEffectConfig(e,t,s){if(this.assetManager&&this.assetManager.getThemeAsset){const i=this.assetManager.getThemeAsset(e,"effects",t);if(i)return{key:i.key,atlas:i.atlas,frame:i.frame,scale:i.scale||1,anchor:i.anchor||{x:.5,y:.5}}}return this.spriteConfigs.get(`effect_${t}_default`)||{key:`effect_${t}`,scale:1,anchor:{x:.5,y:.5},tint:16777215}}positionSprite(e,t){const s=this.gridToWorldX(t.x),i=this.gridToWorldY(t.y);e.setPosition(s,i)}gridToWorldX(e){const t=10*this.cellSize;return(this.scene.scale.width-t)/2+e*this.cellSize+this.cellSize/2}gridToWorldY(e){return 200+e*this.cellSize+this.cellSize/2}setupAnimations(e,t){e.setData("animations",t),t.length>0&&this.scene.anims.exists(t[0])&&e.play(t[0])}makeInteractive(e){e.setInteractive({useHandCursor:!0}),e.on("pointerover",()=>{e.setTint(16777215)}),e.on("pointerout",()=>{const t=e.getData("originalTint")||16777215;e.setTint(t)})}addFloatingAnimation(e){this.scene.tweens.add({targets:e,y:e.y-2,duration:1e3+Math.random()*500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}initializeDefaultConfigs(){this.spriteConfigs.set("player_default",{key:"player_circle",scale:1,anchor:{x:.5,y:.5},tint:4286945}),this.spriteConfigs.set("orb_default",{key:"orb_circle",scale:.8,anchor:{x:.5,y:.5},tint:16739179}),this.spriteConfigs.set("wall_default",{key:"wall_rectangle",scale:1,anchor:{x:.5,y:.5},tint:8368233}),this.spriteConfigs.set("floor_default",{key:"floor_rectangle",scale:1,anchor:{x:.5,y:.5},tint:16115411})}}class Ml{constructor(e){this.layers=new Map,this.layerOrder=[],this.defaultLayers=[{name:"background",depth:0,visible:!0,alpha:1,scrollFactor:{x:.5,y:.5}},{name:"maze-background",depth:50,visible:!0,alpha:1},{name:"maze-floor",depth:100,visible:!0,alpha:1},{name:"maze-walls",depth:150,visible:!0,alpha:1},{name:"game-objects",depth:200,visible:!0,alpha:1},{name:"player",depth:250,visible:!0,alpha:1},{name:"effects-low",depth:300,visible:!0,alpha:1},{name:"effects-high",depth:350,visible:!0,alpha:1},{name:"ui-background",depth:400,visible:!0,alpha:1},{name:"ui-elements",depth:450,visible:!0,alpha:1},{name:"ui-overlay",depth:500,visible:!0,alpha:1},{name:"debug",depth:1e3,visible:!1,alpha:.8}],this.scene=e,this.initializeDefaultLayers()}initializeDefaultLayers(){this.defaultLayers.forEach(e=>{this.createLayer(e)}),console.log(`LayerManager: Initialized ${this.layers.size} layers`)}createLayer(e){if(this.layers.has(e.name))return console.warn(`Layer ${e.name} already exists`),this.layers.get(e.name).layer;const t=this.scene.add.layer();t.setName(e.name),t.setDepth(e.depth),t.setVisible(e.visible),e.alpha!==void 0&&t.setAlpha(e.alpha),e.blendMode&&t.setBlendMode(e.blendMode),e.scrollFactor&&t.setScrollFactor(e.scrollFactor.x,e.scrollFactor.y);const s={layer:t,definition:e,sprites:new Set};return this.layers.set(e.name,s),this.updateLayerOrder(),console.log(`Created layer: ${e.name} (depth: ${e.depth})`),t}getLayer(e){const t=this.layers.get(e);return t?t.layer:null}getLayerGroup(e){return this.layers.get(e)||null}addSpriteToLayer(e,t){const s=this.layers.get(t);return s?(s.layer.add(e),s.sprites.add(e),e.setData("layer",t),!0):(console.warn(`Layer ${t} not found`),!1)}removeSpriteFromLayer(e){const t=e.getData("layer");if(!t)return!1;const s=this.layers.get(t);return s?(s.layer.remove(e),s.sprites.delete(e),e.removeData("layer"),!0):!1}moveSpriteToLayer(e,t){return this.removeSpriteFromLayer(e),this.addSpriteToLayer(e,t)}setLayerVisible(e,t){const s=this.layers.get(e);s&&(s.layer.setVisible(t),s.definition.visible=t)}setLayerAlpha(e,t){const s=this.layers.get(e);s&&(s.layer.setAlpha(t),s.definition.alpha=t)}setLayerDepth(e,t){const s=this.layers.get(e);s&&(s.layer.setDepth(t),s.definition.depth=t,this.updateLayerOrder())}getSpritesInLayer(e){const t=this.layers.get(e);return t?Array.from(t.sprites):[]}getLayerSpriteCount(e){const t=this.layers.get(e);return t?t.sprites.size:0}clearLayer(e){const t=this.layers.get(e);t&&(t.sprites.forEach(s=>{t.layer.remove(s),s.removeData("layer")}),t.sprites.clear())}destroyLayerSprites(e){const t=this.layers.get(e);t&&(t.sprites.forEach(s=>{s.destroy()}),t.sprites.clear())}destroyLayer(e){const t=this.layers.get(e);t&&(this.destroyLayerSprites(e),t.layer.destroy(),this.layers.delete(e),this.updateLayerOrder())}getLayerOrder(){return[...this.layerOrder]}getLayerInfo(){return Array.from(this.layers.entries()).map(([e,t])=>({name:e,depth:t.definition.depth,visible:t.definition.visible,spriteCount:t.sprites.size})).sort((e,t)=>e.depth-t.depth)}toggleDebugLayer(){const e=this.layers.get("debug");if(e){const t=!e.definition.visible;this.setLayerVisible("debug",t),console.log(`Debug layer ${t?"shown":"hidden"}`)}}showLayerStats(){console.log("Layer Statistics:"),console.table(this.getLayerInfo())}validateLayers(){const e={isValid:!0,errors:[],warnings:[]},t=new Map;for(const[s,i]of this.layers.entries()){const n=i.definition.depth;t.has(n)||t.set(n,[]),t.get(n).push(s)}for(const[s,i]of t.entries())i.length>1&&e.warnings.push(`Multiple layers at depth ${s}: ${i.join(", ")}`);for(const[s,i]of this.layers.entries())for(const n of i.sprites){n.active||e.warnings.push(`Inactive sprite found in layer ${s}`);const a=n.getData("layer");a!==s&&(e.errors.push(`Sprite layer data mismatch in ${s}: expected ${s}, got ${a}`),e.isValid=!1)}return e}optimizeLayers(){const e=[];for(const[t,s]of this.layers.entries())s.sprites.size===0&&!this.isEssentialLayer(t)&&e.push(t);e.forEach(t=>{console.log(`Removing empty layer: ${t}`),this.destroyLayer(t)}),console.log(`Layer optimization complete. Removed ${e.length} empty layers.`)}destroy(){for(const[e,t]of this.layers.entries())this.destroyLayerSprites(e),t.layer.destroy();this.layers.clear(),this.layerOrder=[],console.log("LayerManager destroyed and cleaned up")}updateLayerOrder(){this.layerOrder=Array.from(this.layers.keys()).sort((e,t)=>{const s=this.layers.get(e).definition.depth,i=this.layers.get(t).definition.depth;return s-i})}isEssentialLayer(e){return["background","maze-floor","maze-walls","game-objects","player","ui-elements"].includes(e)}createTemporaryLayer(e,t,s){const i={name:e,depth:t,visible:!0,alpha:1},n=this.createLayer(i);return s&&this.scene.time.delayedCall(s,()=>{this.destroyLayer(e)}),n}animateLayer(e,t,s=1e3){const i=this.layers.get(e);return i?this.scene.tweens.add({targets:i.layer,...t,duration:s,ease:"Power2"}):null}fadeLayer(e,t,s=500){return this.animateLayer(e,{alpha:t},s)}slideLayer(e,t,s,i=1e3){return this.animateLayer(e,{x:t,y:s},i)}getLayerForSpriteType(e){return{background:"background",floor:"maze-floor",wall:"maze-walls",orb:"game-objects",player:"player",effect:"effects-low",particle:"effects-high",ui:"ui-elements",button:"ui-elements",panel:"ui-background",overlay:"ui-overlay",debug:"debug"}[e]||"game-objects"}batchAddSprites(e){e.forEach(({sprite:t,layer:s})=>{this.addSpriteToLayer(t,s)})}sortLayerSprites(e,t){const s=this.layers.get(e);if(!s)return;const i=Array.from(s.sprites).sort(t);s.sprites.forEach(n=>{s.layer.remove(n)}),i.forEach(n=>{s.layer.add(n)})}}class yp{constructor(e){this.spriteRenderer=null,this.spriteFactory=null,this.layerManager=null,this.assetManager=null,this.playerSprite=null,this.animationController=null,this.currentConfig={},this.isInitialized=!1,this.gameStateSubscribed=!1,this.defaultConfig={theme:"default",scale:1,enablePhysics:!1,enableInteraction:!0,animations:{idleAnimation:"player_idle",walkAnimations:{up:"player_walk_up",down:"player_walk_down",left:"player_walk_left",right:"player_walk_right"},transitionDuration:100,movementDuration:200,idleDelay:1500}},this.scene=e.scene,this.gameCore=e.gameCore,this.spriteRenderer=e.spriteRenderer||null,this.spriteFactory=e.spriteFactory||null,this.layerManager=e.layerManager||null,this.assetManager=e.assetManager||null,this.initialize()}initialize(){this.createFallbackSystems(),this.subscribeToGameEvents(),this.isInitialized=!0,console.log("PlayerSpriteSystem initialized")}createPlayerSprite(e,t){var s;return this.currentConfig={...this.defaultConfig,...t},this.destroyPlayerSprite(),this.spriteFactory?this.playerSprite=this.spriteFactory.createPlayer(e,{theme:this.currentConfig.theme,animations:Object.keys(((s=this.currentConfig.animations)==null?void 0:s.walkAnimations)||{}),interactive:this.currentConfig.enableInteraction}):this.playerSprite=this.createFallbackPlayerSprite(e),this.applyPlayerSpriteConfig(),this.layerManager&&this.layerManager.addSpriteToLayer(this.playerSprite,"player"),this.animationController=new pp(this.scene,this.playerSprite,this.currentConfig.animations),this.currentConfig.enableInteraction&&this.setupPlayerInteraction(),console.log(`Created player sprite at (${e.x}, ${e.y})`),this.playerSprite}async movePlayer(e,t,s){if(!this.playerSprite||!this.animationController){console.warn("Player sprite not initialized");return}try{await this.animationController.playMovementAnimation(e,t,s),console.log(`Player moved ${e} from (${t.x}, ${t.y}) to (${s.x}, ${s.y})`)}catch(i){console.error("Error during player movement animation:",i),this.animationController.updatePosition(s)}}updateTheme(e){if(!this.playerSprite){console.warn("Player sprite not initialized");return}this.currentConfig.theme=e,this.spriteRenderer&&this.spriteRenderer.updateSpriteTheme(this.playerSprite,e),console.log(`Updated player sprite theme to: ${e}`)}getPlayerSprite(){return this.playerSprite}getAnimationController(){return this.animationController}isPlayerAnimating(){return this.animationController?this.animationController.isAnimating():!1}forcePlayerIdle(){this.animationController&&this.animationController.forceIdle()}updateConfig(e){this.currentConfig={...this.currentConfig,...e},this.playerSprite&&this.applyPlayerSpriteConfig(),this.animationController&&e.animations&&this.animationController.setConfig(e.animations)}syncWithGameState(){if(!(!this.playerSprite||!this.animationController))try{const t=this.gameCore.getGameState().player.position;this.animationController.isAnimating()||this.animationController.updatePosition(t)}catch(e){console.error("Error syncing player sprite with game state:",e)}}destroy(){this.unsubscribeFromGameEvents(),this.destroyPlayerSprite(),this.isInitialized=!1,console.log("PlayerSpriteSystem destroyed")}createFallbackSystems(){this.spriteRenderer||(this.spriteRenderer=new Vl(this.scene,this.assetManager)),this.spriteFactory||(this.spriteFactory=new Ol({scene:this.scene,assetManager:this.assetManager,defaultTheme:this.currentConfig.theme||"default"})),this.layerManager||(this.layerManager=new Ml(this.scene))}createFallbackPlayerSprite(e){if(this.animationController&&this.animationController.getAnimationRegistry().isUsingElfCharacter()){const n=this.animationController.getAnimationRegistry().getElfCharacterLoader();if(n){const a=n.createElfSprite(this.gridToWorldPosition(e),"down");if(a)return a}}const t=this.scene.add.graphics();t.fillStyle(4286945),t.fillCircle(0,0,8),t.generateTexture("player_fallback",16,16),t.destroy();const s=this.scene.add.sprite(0,0,"player_fallback"),i=this.gridToWorldPosition(e);return s.setPosition(i.x,i.y),s}applyPlayerSpriteConfig(){this.playerSprite&&(this.currentConfig.scale&&this.playerSprite.setScale(this.currentConfig.scale),this.currentConfig.enablePhysics&&this.scene.physics&&this.scene.physics.add.existing(this.playerSprite))}setupPlayerInteraction(){this.playerSprite&&(this.playerSprite.setInteractive({useHandCursor:!0}),this.playerSprite.on("pointerover",()=>{this.playerSprite.setTint(16777215)}),this.playerSprite.on("pointerout",()=>{this.playerSprite.clearTint()}),this.playerSprite.on("pointerdown",()=>{this.scene.tweens.add({targets:this.playerSprite,scaleX:this.playerSprite.scaleX*.9,scaleY:this.playerSprite.scaleY*.9,duration:100,yoyo:!0,ease:"Power2"})}))}subscribeToGameEvents(){this.gameStateSubscribed||(this.gameCore.on("player.moved",e=>{this.handlePlayerMoved(e)}),this.gameCore.on("state.changed",e=>{this.handleGameStateChanged(e)}),this.gameCore.on("game.initialized",e=>{this.handleGameInitialized(e)}),this.gameCore.on("game.reset",e=>{this.handleGameReset(e)}),this.gameStateSubscribed=!0)}unsubscribeFromGameEvents(){this.gameStateSubscribed&&(this.gameStateSubscribed=!1)}handlePlayerMoved(e){!this.playerSprite||!this.animationController||console.log(`Player moved event received: ${e.from.x},${e.from.y} -> ${e.to.x},${e.to.y}`)}handleGameStateChanged(e){this.syncWithGameState()}handleGameInitialized(e){const t=e.state;t&&t.player&&this.createPlayerSprite(t.player.position,this.currentConfig)}handleGameReset(e){this.animationController&&this.animationController.forceIdle(),this.syncWithGameState()}destroyPlayerSprite(){this.animationController&&(this.animationController.destroy(),this.animationController=null),this.playerSprite&&(this.layerManager&&this.layerManager.removeSpriteFromLayer(this.playerSprite),this.playerSprite.destroy(),this.playerSprite=null)}gridToWorldPosition(e){return{x:(this.scene.scale.width-240)/2+e.x*24+24/2,y:200+e.y*24+24/2}}getPlayerPosition(){if(this.animationController)return this.animationController.getAnimationState().position;try{return this.gameCore.getGameState().player.position}catch(e){return console.error("Error getting player position:",e),{x:0,y:0}}}getPlayerDirection(){return this.animationController?this.animationController.getCurrentDirection():null}isPlayerMoving(){return this.animationController?this.animationController.isMoving():!1}isPlayerIdle(){return this.animationController?this.animationController.isIdle():!0}async playCustomAnimation(e,t=!1){if(this.animationController)return this.animationController.playCustomAnimation(e,t)}setCellSize(e){this.animationController&&this.animationController.setCellSize(e)}getSystemStatus(){return{initialized:this.isInitialized,hasSprite:this.playerSprite!==null,hasAnimationController:this.animationController!==null,isAnimating:this.isPlayerAnimating(),currentTheme:this.currentConfig.theme||"default"}}validateSystem(){const e={isValid:!0,errors:[],warnings:[]};return this.isInitialized||(e.errors.push("System not initialized"),e.isValid=!1),this.playerSprite||e.warnings.push("No player sprite created"),this.animationController||e.warnings.push("No animation controller available"),this.playerSprite&&!this.playerSprite.active&&(e.errors.push("Player sprite is not active"),e.isValid=!1),e}reset(){this.destroyPlayerSprite();try{const e=this.gameCore.getGameState();e&&e.player&&this.createPlayerSprite(e.player.position,this.currentConfig)}catch(e){console.error("Error resetting player sprite system:",e)}}}class vp{constructor(e,t,s,i){this.orbSprites=new Map,this.orbConfigs=new Map,this.defaultTheme="default",this.scene=e,this.spriteFactory=t,this.animationController=s,this.particleManager=i,this.initializeOrbTypes()}createOrbSprite(e,t){const s=t||this.getDefaultOrbConfig(e.id,e),i={type:"orb",variant:s.type,theme:s.theme||this.defaultTheme,animations:this.getOrbAnimations(s.type)},n=this.spriteFactory.createOrb(e.position,e.id,i);return n.setData("orbState",e),n.setData("orbConfig",s),n.setData("orbType",s.type),n.setData("originalPosition",{...e.position}),this.applyVisualEffects(n,s),this.animationController.startFloatingAnimation(n,{speed:s.floatingSpeed||1e3,range:s.floatingRange||3,randomOffset:!0}),s.glowEffect&&this.animationController.addGlowEffect(n),s.pulseEffect&&this.animationController.addPulseEffect(n),this.orbSprites.set(e.id,n),this.orbConfigs.set(e.id,s),n}createOrbSprites(e,t){const s=[];return e.forEach((i,n)=>{if(!i.collected){const a=this.determineOrbType(i,n),l={type:a,theme:t||this.defaultTheme,floatingSpeed:800+Math.random()*400,floatingRange:2+Math.random()*2,glowEffect:a==="special"||a==="power",pulseEffect:a==="bonus"||a==="special"},h=this.createOrbSprite(i,l);s.push(h)}}),s}async animateOrbCollection(e,t){const s=this.orbSprites.get(e);if(!s){console.warn(`Orb sprite not found for ID: ${e}`);return}const i=this.orbConfigs.get(e),n=t||this.getDefaultCollectionConfig(i==null?void 0:i.type);this.animationController.stopFloatingAnimation(s);const a={x:s.x,y:s.y};this.particleManager.createCollectionEffect(a,{type:(i==null?void 0:i.type)||"energy",particleCount:n.particleCount||15,duration:n.animationDuration||500}),await this.animationController.animateCollection(s,{duration:n.animationDuration||500,scaleEffect:n.scaleEffect!==!1,fadeEffect:n.fadeEffect!==!1,rotation:!0,bounce:!0}),this.removeOrbSprite(e)}updateOrbTheme(e,t){const s=this.orbSprites.get(e);if(!s)return;const i=this.orbConfigs.get(e);i&&(i.theme=t,this.orbConfigs.set(e,i),this.applyVisualEffects(s,i))}getOrbSprite(e){return this.orbSprites.get(e)||null}getAllOrbSprites(){return Array.from(this.orbSprites.values())}removeOrbSprite(e){const t=this.orbSprites.get(e);t&&(this.animationController.stopAllAnimations(t),t.destroy(),this.orbSprites.delete(e),this.orbConfigs.delete(e))}clearAllOrbs(){this.orbSprites.forEach((e,t)=>{this.removeOrbSprite(t)})}setDefaultTheme(e){this.defaultTheme=e}pauseAnimations(){this.orbSprites.forEach(e=>{this.animationController.pauseAnimations(e)})}resumeAnimations(){this.orbSprites.forEach(e=>{this.animationController.resumeAnimations(e)})}initializeOrbTypes(){}getDefaultOrbConfig(e,t){let s="energy";if(t)s=this.determineOrbType(t,0);else{const i=parseInt(e.split("_")[1])||0,n=["energy","crystal","power","bonus","special"];s=n[i%n.length]}return{type:s,theme:this.defaultTheme,floatingSpeed:1e3,floatingRange:3,glowEffect:s==="special"||s==="power",pulseEffect:s==="bonus"||s==="special"}}getDefaultCollectionConfig(e){const t={animationDuration:500,particleCount:15,scaleEffect:!0,fadeEffect:!0,soundSync:!0};switch(e){case"special":return{...t,animationDuration:800,particleCount:25};case"power":return{...t,animationDuration:600,particleCount:20};default:return t}}determineOrbType(e,t){return e.value&&e.value>=50?"special":e.value&&e.value>=30?"power":e.value&&e.value>=20?"bonus":t%3===0?"crystal":"energy"}getOrbAnimations(e){switch(e){case"energy":return["orb_energy_idle","orb_energy_pulse"];case"crystal":return["orb_crystal_idle","orb_crystal_sparkle"];case"power":return["orb_power_idle","orb_power_glow"];case"bonus":return["orb_bonus_idle","orb_bonus_bounce"];case"special":return["orb_special_idle","orb_special_rainbow"];default:return["orb_default_idle"]}}applyVisualEffects(e,t){const s=t.type,i={energy:65535,crystal:16711935,power:16776960,bonus:65280,special:16711808};e.setTint(i[s]||16777215);const n={energy:.8,crystal:.9,power:1,bonus:.85,special:1.1};e.setScale(n[s]||.8)}}class _p{constructor(e){this.activeAnimations=new Map,this.floatingAnimations=new Map,this.scene=e}startFloatingAnimation(e,t){const s=e.getData("orbId")||e.name;this.stopFloatingAnimation(e);const i={speed:(t==null?void 0:t.speed)||1e3,range:(t==null?void 0:t.range)||3,randomOffset:(t==null?void 0:t.randomOffset)||!1,easing:(t==null?void 0:t.easing)||"Sine.easeInOut"},n=e.y;e.setData("originalY",n);const a=i.randomOffset?(Math.random()-.5)*i.range:0,l=this.scene.tweens.add({targets:e,y:n-i.range+a,duration:i.speed+(Math.random()*200-100),yoyo:!0,repeat:-1,ease:i.easing,onUpdate:()=>{e.rotation+=.001}});this.floatingAnimations.set(s,l),this.addToActiveAnimations(s,[l])}stopFloatingAnimation(e){const t=e.getData("orbId")||e.name,s=this.floatingAnimations.get(t);s&&(s.stop(),this.floatingAnimations.delete(t),this.removeFromActiveAnimations(t,[s]))}async animateCollection(e,t){const s=e.getData("orbId")||e.name,i={duration:(t==null?void 0:t.duration)||500,scaleEffect:(t==null?void 0:t.scaleEffect)!==!1,fadeEffect:(t==null?void 0:t.fadeEffect)!==!1,rotation:(t==null?void 0:t.rotation)!==!1,bounce:(t==null?void 0:t.bounce)!==!1,targetPosition:t==null?void 0:t.targetPosition};this.stopAllAnimations(e);const n=[];if(i.scaleEffect){const a=this.scene.tweens.add({targets:e,scaleX:e.scaleX*1.5,scaleY:e.scaleY*1.5,duration:i.duration*.3,ease:"Back.easeOut",yoyo:!0,onYoyo:()=>{this.scene.tweens.add({targets:e,scaleX:0,scaleY:0,duration:i.duration*.4,ease:"Back.easeIn"})}});n.push(a)}if(i.fadeEffect){const a=this.scene.tweens.add({targets:e,alpha:0,duration:i.duration,ease:"Cubic.easeOut"});n.push(a)}if(i.rotation){const a=this.scene.tweens.add({targets:e,rotation:e.rotation+Math.PI*2,duration:i.duration,ease:"Cubic.easeOut"});n.push(a)}if(i.bounce){const a=this.scene.tweens.add({targets:e,y:e.y-20,duration:i.duration*.4,ease:"Quad.easeOut",yoyo:!0});n.push(a)}if(i.targetPosition){const a=this.scene.tweens.add({targets:e,x:i.targetPosition.x,y:i.targetPosition.y,duration:i.duration*.8,ease:"Cubic.easeInOut"});n.push(a)}return this.addToActiveAnimations(s,n),new Promise(a=>{const l=Math.max(...n.map(h=>h.duration));this.scene.time.delayedCall(l,()=>{this.removeFromActiveAnimations(s,n),a()})})}addGlowEffect(e,t){const s=e.getData("orbId")||e.name,i={intensity:(t==null?void 0:t.intensity)||.3,speed:(t==null?void 0:t.speed)||1500,color:(t==null?void 0:t.color)||16777215},n=this.scene.tweens.add({targets:e,alpha:1-i.intensity,duration:i.speed,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"});this.addToActiveAnimations(s,[n])}addPulseEffect(e,t){const s=e.getData("orbId")||e.name,i={scale:(t==null?void 0:t.scale)||.1,speed:(t==null?void 0:t.speed)||800,intensity:(t==null?void 0:t.intensity)||1},n=e.scaleX,a=this.scene.tweens.add({targets:e,scaleX:n+i.scale,scaleY:n+i.scale,duration:i.speed,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"});this.addToActiveAnimations(s,[a])}createSparkleEffect(e,t=2e3){const s=e.getData("orbId")||e.name;for(let i=0;i<8;i++){const n=this.scene.add.graphics();n.fillStyle(16777215,.8),n.fillCircle(0,0,2);const a=i/8*Math.PI*2,l=15+Math.random()*10;n.x=e.x+Math.cos(a)*l,n.y=e.y+Math.sin(a)*l;const h=this.scene.tweens.add({targets:n,alpha:0,scaleX:0,scaleY:0,duration:t,ease:"Cubic.easeOut",onComplete:()=>{n.destroy()}});this.addToActiveAnimations(s,[h])}}pauseAnimations(e){const t=e.getData("orbId")||e.name,s=this.activeAnimations.get(t);s&&s.forEach(i=>{i.isPlaying()&&i.pause()})}resumeAnimations(e){const t=e.getData("orbId")||e.name,s=this.activeAnimations.get(t);s&&s.forEach(i=>{i.isPaused()&&i.resume()})}stopAllAnimations(e){const t=e.getData("orbId")||e.name,s=this.activeAnimations.get(t);s&&(s.forEach(i=>{i.stop()}),this.activeAnimations.delete(t)),this.stopFloatingAnimation(e)}createTrailEffect(e,t=1e3){const s=e.getData("orbId")||e.name;for(let i=0;i<5;i++){const n=this.scene.add.graphics();n.fillStyle(e.tintTopLeft,.3-i*.05),n.fillCircle(0,0,4-i),n.x=e.x,n.y=e.y;const a=this.scene.tweens.add({targets:n,alpha:0,scaleX:0,scaleY:0,duration:t-i*100,ease:"Cubic.easeOut",onComplete:()=>{n.destroy()}});this.addToActiveAnimations(s,[a])}}destroy(){this.activeAnimations.forEach((e,t)=>{e.forEach(s=>{s.stop()})}),this.activeAnimations.clear(),this.floatingAnimations.clear()}addToActiveAnimations(e,t){const s=this.activeAnimations.get(e)||[];this.activeAnimations.set(e,[...s,...t])}removeFromActiveAnimations(e,t){const i=(this.activeAnimations.get(e)||[]).filter(n=>!t.includes(n));i.length>0?this.activeAnimations.set(e,i):this.activeAnimations.delete(e)}}class wp{constructor(e){this.particleEmitters=new Map,this.effectConfigs=new Map,this.scene=e,this.initializeParticleTextures(),this.initializeEffectConfigs()}createCollectionEffect(e,t){const s=`collection_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,i={particleCount:t.particleCount||15,duration:t.duration||500,spread:t.spread||360,speed:t.speed||100,colors:t.colors||this.getOrbColors(t.type),size:t.size||{min:2,max:6},gravity:t.gravity||0,fadeOut:t.fadeOut!==!1,...t};return i.burstEffect!==!1&&this.createBurstEffect(e,i,s),i.sparkleTrail&&this.createSparkleTrail(e,i,s),i.scorePopup&&this.createScorePopup(e,i),s}createBurstEffect(e,t,s){const i=s||`burst_${Date.now()}`,n=this.scene.add.particles(e.x,e.y,"particle_circle",{speed:{min:t.speed*.5,max:t.speed*1.5},scale:{start:t.size.max/10,end:t.size.min/10},lifespan:t.duration,quantity:t.particleCount,tint:t.colors,alpha:{start:1,end:0},blendMode:"ADD",emitZone:{type:"edge",source:new Phaser.Geom.Circle(0,0,5),quantity:t.particleCount}});return n.explode(t.particleCount,e.x,e.y),this.particleEmitters.set(i,n),this.scene.time.delayedCall(t.duration+1e3,()=>{this.stopEffect(i)}),i}createSparkleTrail(e,t,s){const i=s?`${s}_sparkle`:`sparkle_${Date.now()}`;for(let n=0;n<t.particleCount/2;n++){const a=this.scene.add.graphics();a.fillStyle(t.colors[n%t.colors.length],.8),a.fillStar(0,0,4,2,4,0);const l=Math.random()*Math.PI*2,h=Math.random()*20;a.x=e.x+Math.cos(l)*h,a.y=e.y+Math.sin(l)*h,this.scene.tweens.add({targets:a,alpha:0,scaleX:0,scaleY:0,rotation:Math.PI*2,duration:t.duration+Math.random()*200,ease:"Cubic.easeOut",onComplete:()=>{a.destroy()}})}return i}createScorePopup(e,t){const s=this.scene.add.text(e.x,e.y,"+10",{fontSize:"16px",color:"#FFD700",stroke:"#000000",strokeThickness:2}).setOrigin(.5);this.scene.tweens.add({targets:s,y:e.y-30,alpha:0,scaleX:1.2,scaleY:1.2,duration:800,ease:"Cubic.easeOut",onComplete:()=>{s.destroy()}})}createAmbientEffect(e,t){const s=`ambient_${Date.now()}`,i={particleCount:t.particleCount||5,area:t.area||{width:100,height:100},speed:t.speed||{min:10,max:30},colors:t.colors||[16777215,15792383,15132410],lifetime:t.lifetime||{min:2e3,max:4e3},continuous:t.continuous!==!1,...t},n=this.scene.add.particles(e.x,e.y,"particle_circle",{speed:i.speed,scale:{start:.1,end:.05},lifespan:i.lifetime,alpha:{start:.6,end:0},tint:i.colors,blendMode:"ADD",emitZone:{type:"random",source:new Phaser.Geom.Rectangle(-i.area.width/2,-i.area.height/2,i.area.width,i.area.height)},frequency:500,quantity:1});return i.continuous||n.stop(),this.particleEmitters.set(s,n),s}createFloatingEffect(e,t){const s=`floating_${t}_${Date.now()}`,i=this.getOrbColors(t),n=this.scene.add.particles(e.x,e.y,"particle_circle",{speed:{min:5,max:15},scale:{start:.05,end:.02},lifespan:{min:1e3,max:2e3},alpha:{start:.4,end:0},tint:i,blendMode:"ADD",emitZone:{type:"edge",source:new Phaser.Geom.Circle(0,0,8),quantity:1},frequency:300,quantity:1});return this.particleEmitters.set(s,n),s}updateEffectPosition(e,t){const s=this.particleEmitters.get(e);s&&s.setPosition(t.x,t.y)}stopEffect(e){const t=this.particleEmitters.get(e);t&&(t.stop(),this.scene.time.delayedCall(2e3,()=>{t.destroy(),this.particleEmitters.delete(e)}))}pauseAllEffects(){this.particleEmitters.forEach(e=>{e.pause()})}resumeAllEffects(){this.particleEmitters.forEach(e=>{e.resume()})}stopAllEffects(){this.particleEmitters.forEach((e,t)=>{this.stopEffect(t)})}destroy(){this.stopAllEffects(),this.particleEmitters.clear(),this.effectConfigs.clear()}initializeParticleTextures(){if(!this.scene.textures.exists("particle_circle")){const e=this.scene.add.graphics();e.fillStyle(16777215),e.fillCircle(4,4,4),e.generateTexture("particle_circle",8,8),e.destroy()}if(!this.scene.textures.exists("particle_star")){const e=this.scene.add.graphics();e.fillStyle(16777215),e.fillStar(4,4,4,2,4,0),e.generateTexture("particle_star",8,8),e.destroy()}}initializeEffectConfigs(){this.effectConfigs.set("energy",{type:"energy",particleCount:12,duration:400,spread:360,speed:80,colors:[65535,33023,4251856],size:{min:2,max:5}}),this.effectConfigs.set("crystal",{type:"crystal",particleCount:15,duration:600,spread:360,speed:60,colors:[16711935,16744703,16758465],size:{min:3,max:7}}),this.effectConfigs.set("power",{type:"power",particleCount:20,duration:700,spread:360,speed:120,colors:[16776960,16766720,16753920],size:{min:3,max:8}}),this.effectConfigs.set("bonus",{type:"bonus",particleCount:18,duration:500,spread:360,speed:90,colors:[65280,3329330,9498256],size:{min:2,max:6}}),this.effectConfigs.set("special",{type:"special",particleCount:25,duration:800,spread:360,speed:150,colors:[16711808,16738740,16758465,14524637],size:{min:4,max:10}})}getOrbColors(e){const t=this.effectConfigs.get(e);return(t==null?void 0:t.colors)||[16777215]}}const Q=24;class Ep extends ee.Scene{constructor(){super("Game"),this.gameState=null,this.arrowButtons={},this.currentLevel=1,this.orbs=[]}create(){k.scene("Game","Game scene created",{sceneKey:this.scene.key,scaleWidth:this.scale.width,scaleHeight:this.scale.height}),this.cameras.main.setBackgroundColor("#F5E6D3"),this.gameCore=new Dc,this.levelService=new Qo,this.progressManager=lt.getInstance(),this.initializeSpriteSystem(),k.game("Game","Core services initialized"),this.subscribeToGameEvents();const e=this.registry.get("selectedLevelId"),t=this.registry.get("selectedLevelDefinition");e?(k.game("Game",`Using selected level: ${e}`),this.currentLevel=e):(k.game("Game","No selected level, using current level from progress manager"),this.currentLevel=this.progressManager.getCurrentLevel()),this.initLevel(t)}async initLevel(e){try{k.game("Game",`Initializing level: ${this.currentLevel}`,{hasPreloadedDefinition:!!e}),this.children.removeAll(),this.orbs=[],this.input.off("pointerdown"),this.input.off("pointermove");let t;e?(k.game("Game","Using preloaded level definition"),t=e):(k.game("Game",`Loading level definition for: ${this.currentLevel}`),t=await this.levelService.loadLevel(this.currentLevel.toString())),k.game("Game","Initializing GameCore with level definition",{levelId:t.id,levelName:t.metadata.name,generationType:t.generation.type}),this.gameCore.initializeLevel(t),this.gameState=this.gameCore.getGameState(),this.createUI(),this.renderGameState(),this.createArrowButtons(),this.updateArrowButtons(),this.setupInputHandlers(),this.gameCore.startGame()}catch(t){console.error("Failed to initialize level:",t)}}subscribeToGameEvents(){this.gameCore.on("game.initialized",e=>{this.gameState=e.state,console.log("Game initialized for level:",e.levelDefinition.id)}),this.gameCore.on("game.started",e=>{console.log("Game started at:",new Date(e.timestamp))}),this.gameCore.on("game.paused",e=>{console.log("Game paused after:",e.duration,"ms")}),this.gameCore.on("game.resumed",e=>{console.log("Game resumed after pause of:",e.pausedDuration,"ms")}),this.gameCore.on("game.completed",e=>{this.showCompletionUI(e.result)}),this.gameCore.on("game.failed",e=>{console.log("Game failed:",e.reason)}),this.gameCore.on("player.moved",e=>{this.animatePlayerMovement(e.from,e.to),this.updateArrowButtons()}),this.gameCore.on("player.move.attempted",e=>{e.blocked&&this.showMoveBlockedFeedback(e.direction,e.reason)}),this.gameCore.on("orb.collected",e=>{this.animateOrbCollection(e.orbId,e.position),this.updateHintText(),this.showScorePopup(e.position,e.score)}),this.gameCore.on("orb.collection.attempted",e=>{e.success||console.log("Orb collection failed:",e.reason)}),this.gameCore.on("objective.progress",e=>{console.log(`Objective ${e.objectiveId} progress: ${e.newProgress}/${e.target}`),e.completed&&this.showObjectiveCompletedFeedback(e.objectiveId)}),this.gameCore.on("objective.completed",e=>{console.log("Objective completed:",e.objectiveId)}),this.gameCore.on("score.changed",e=>{console.log(`Score changed: ${e.previousScore} -> ${e.newScore} (${e.change>0?"+":""}${e.change})`)}),this.gameCore.on("level.loaded",e=>{console.log("Level loaded:",e.levelId,e.result.success?"successfully":"with errors")}),this.gameCore.on("level.generated",e=>{console.log(`Level generated in ${e.generationTime}ms:`,{levelId:e.levelId,seed:e.seed,mazeSize:e.mazeSize,orbCount:e.orbCount})}),this.gameCore.on("state.changed",e=>{this.gameState=e.state,this.updateUI();const t=e.changes.filter(s=>["status","score","player.position"].includes(s.property));t.length>0&&console.log("Significant state changes:",t)}),this.gameCore.on("state.validated",e=>{e.valid||console.warn("State validation failed:",e.errors),e.warnings.length>0&&console.warn("State validation warnings:",e.warnings)}),this.gameCore.on("error",e=>{console.error("Game error:",e.error.message,e.context),this.showErrorFeedback(e.error.message,e.recoverable)}),this.gameCore.on("debug",e=>{e.level==="error"?console.error("[Game Debug]",e.message,e.data):e.level==="warn"?console.warn("[Game Debug]",e.message,e.data):e.level==="info"?console.info("[Game Debug]",e.message,e.data):console.log("[Game Debug]",e.message,e.data)})}createUI(){if(!this.gameState)return;const e=this.add.text(20,20," Back",{fontFamily:"Arial, sans-serif",fontSize:"16px",color:"#FFFFFF",backgroundColor:"#8B7355",padding:{x:12,y:6}}).setOrigin(0,0).setInteractive({useHandCursor:!0});e.on("pointerdown",()=>{k.click("Game","Back button clicked - returning to level select"),this.scene.start("LevelSelect")}),e.on("pointerover",()=>{e.setStyle({backgroundColor:"#A0522D"})}),e.on("pointerout",()=>{e.setStyle({backgroundColor:"#8B7355"})}),this.titleText=this.add.text(this.scale.width/2,50,"Labyrinth Leap",{fontFamily:"Arial, sans-serif",fontSize:"36px",color:"#7FB069",fontStyle:"bold"}).setOrigin(.5),this.subtitleText=this.add.text(this.scale.width/2,80,"Collect all the orbs and find your way to the goal!",{fontFamily:"Arial, sans-serif",fontSize:"14px",color:"#8B7355"}).setOrigin(.5);const t=120;this.add.circle(this.scale.width/2-60,t,12,13789470).setStrokeStyle(2,9127187),this.levelText=this.add.text(this.scale.width/2-60,t,this.currentLevel.toString(),{fontFamily:"Arial, sans-serif",fontSize:"14px",color:"#FFFFFF",fontStyle:"bold"}).setOrigin(.5);for(let i=0;i<3;i++){const n=i<this.currentLevel-1?8368233:13882323;this.add.circle(this.scale.width/2-20+i*20,t,6,n)}this.timerText=this.add.text(this.scale.width/2+60,t,"00:00",{fontFamily:"Arial, sans-serif",fontSize:"16px",color:"#D2691E",fontStyle:"bold"}).setOrigin(.5);const s=this.add.text(this.scale.width-20,20," Menu",{fontFamily:"Arial, sans-serif",fontSize:"16px",color:"#FFFFFF",backgroundColor:"#D2691E",padding:{x:12,y:6}}).setOrigin(1,0).setInteractive({useHandCursor:!0});s.on("pointerdown",()=>{k.click("Game","Pause/Menu button clicked"),this.showPauseMenu()}),s.on("pointerover",()=>{s.setStyle({backgroundColor:"#CD853F"})}),s.on("pointerout",()=>{s.setStyle({backgroundColor:"#D2691E"})}),this.hintText=this.add.text(this.scale.width/2,150,"Collect all the orbs to unlock the goal!",{fontFamily:"Arial, sans-serif",fontSize:"12px",color:"#8B7355",backgroundColor:"#F0E68C",padding:{x:8,y:4}}).setOrigin(.5),this.spaceHintText=this.add.text(this.scale.width/2,this.scale.height-40,"Use arrow buttons or tap to move.",{fontFamily:"Arial, sans-serif",fontSize:"12px",color:"#8B7355"}).setOrigin(.5)}update(e,t){if(!this.gameState||this.gameState.status!=="playing")return;const s=this.gameCore.getCurrentTime(),i=Math.floor(s/6e4),n=Math.floor(s%6e4/1e3);this.timerText.setText(`${i.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`)}renderGameState(){this.gameState&&(this.drawMaze(),this.createPlayer(),this.createOrbs())}updateUI(){this.gameState&&this.updateHintText()}cx(e){if(!this.gameState)return 0;const t=this.gameState.maze[0].length*Q;return(this.scale.width-t)/2+e*Q+Q/2}cy(e){return 200+e*Q+Q/2}drawMaze(){if(!this.gameState)return;const e=this.gameState.maze,t=e[0].length,s=e.length,i=t*Q,n=s*Q,a=(this.scale.width-i)/2,l=200;this.add.rectangle(a+i/2,l+n/2,i+20,n+20,8368233).setStrokeStyle(4,7048794),this.mazeGraphics=this.add.graphics(),this.mazeGraphics.fillStyle(16115411);for(let h=0;h<s;h++)for(let d=0;d<t;d++){const m=e[h][d],p=a+d*Q,b=l+h*Q;this.mazeGraphics.fillRect(p+2,b+2,Q-4,Q-4),m.walls&1&&this.mazeGraphics.fillRect(p+Q-2,b+2,4,Q-4),m.walls&2&&this.mazeGraphics.fillRect(p+2,b+Q-2,Q-4,4),m.walls&4&&this.mazeGraphics.fillRect(p-2,b+2,4,Q-4),m.walls&8&&this.mazeGraphics.fillRect(p+2,b-2,Q-4,4)}}createPlayer(){if(!this.gameState)return;const e=this.gameState.player.position;try{const t=this.playerSpriteSystem.createPlayerSprite(e,{theme:"default",scale:1,enableInteraction:!0});this.player=this.add.circle(this.cx(e.x),this.cy(e.y),8,4286945).setStrokeStyle(2,1981066).setVisible(!1),k.game("Game","Enhanced player sprite created",{position:e})}catch(t){console.error("Failed to create enhanced player sprite, using fallback:",t),this.player=this.add.circle(this.cx(e.x),this.cy(e.y),8,4286945).setStrokeStyle(2,1981066)}}createOrbs(){if(!this.gameState)return;this.orbs.forEach(t=>t.destroy()),this.orbs=[];try{if(this.orbSpriteSystem){this.orbSpriteSystem.clearAllOrbs();const t=this.orbSpriteSystem.createOrbSprites(this.gameState.orbs,"default");this.orbs=t.map(s=>({...s,destroy:()=>s.destroy(),getData:n=>s.getData(n),setData:(n,a)=>s.setData(n,a)})),k.game("Game",`Created ${t.length} enhanced orb sprites`);return}}catch(t){console.warn("Failed to create enhanced orb sprites, falling back to basic shapes:",t)}const e=[16739179,5164484,16770669,9822675,15961e3];this.gameState.orbs.forEach((t,s)=>{if(!t.collected){const i=e[s%e.length],n=this.add.circle(this.cx(t.position.x),this.cy(t.position.y),6,i).setStrokeStyle(2,9127187);n.setData("orbId",t.id),this.orbs.push(n)}})}createArrowButtons(){const e=this.scale.width/2,t=this.scale.height-100,s=40,i=60,n={fillStyle:16115411,lineStyle:{width:2,color:13808780}};this.arrowButtons.up=this.add.graphics(n),this.arrowButtons.up.fillRoundedRect(-s/2,-s/2,s,s,8),this.arrowButtons.up.strokeRoundedRect(-s/2,-s/2,s,s,8),this.arrowButtons.up.fillStyle(9139029),this.arrowButtons.up.fillTriangle(0,-8,-6,6,6,6),this.arrowButtons.up.setPosition(e,t-i),this.arrowButtons.up.setInteractive(new ee.Geom.Rectangle(-s/2,-s/2,s,s),ee.Geom.Rectangle.Contains),this.arrowButtons.up.on("pointerup",()=>this.handleButtonMove("up")),this.arrowButtons.down=this.add.graphics(n),this.arrowButtons.down.fillRoundedRect(-s/2,-s/2,s,s,8),this.arrowButtons.down.strokeRoundedRect(-s/2,-s/2,s,s,8),this.arrowButtons.down.fillStyle(9139029),this.arrowButtons.down.fillTriangle(0,8,-6,-6,6,-6),this.arrowButtons.down.setPosition(e,t+i),this.arrowButtons.down.setInteractive(new ee.Geom.Rectangle(-s/2,-s/2,s,s),ee.Geom.Rectangle.Contains),this.arrowButtons.down.on("pointerup",()=>this.handleButtonMove("down")),this.arrowButtons.left=this.add.graphics(n),this.arrowButtons.left.fillRoundedRect(-s/2,-s/2,s,s,8),this.arrowButtons.left.strokeRoundedRect(-s/2,-s/2,s,s,8),this.arrowButtons.left.fillStyle(9139029),this.arrowButtons.left.fillTriangle(-8,0,6,-6,6,6),this.arrowButtons.left.setPosition(e-i,t),this.arrowButtons.left.setInteractive(new ee.Geom.Rectangle(-s/2,-s/2,s,s),ee.Geom.Rectangle.Contains),this.arrowButtons.left.on("pointerup",()=>this.handleButtonMove("left")),this.arrowButtons.right=this.add.graphics(n),this.arrowButtons.right.fillRoundedRect(-s/2,-s/2,s,s,8),this.arrowButtons.right.strokeRoundedRect(-s/2,-s/2,s,s,8),this.arrowButtons.right.fillStyle(9139029),this.arrowButtons.right.fillTriangle(8,0,-6,-6,-6,6),this.arrowButtons.right.setPosition(e+i,t),this.arrowButtons.right.setInteractive(new ee.Geom.Rectangle(-s/2,-s/2,s,s),ee.Geom.Rectangle.Contains),this.arrowButtons.right.on("pointerup",()=>this.handleButtonMove("right"));const a=this.add.graphics(n);a.fillRoundedRect(-s/2,-s/2,s,s,8),a.strokeRoundedRect(-s/2,-s/2,s,s,8),a.fillStyle(13789470),a.fillCircle(0,0,6),a.setPosition(e,t),a.setInteractive(new ee.Geom.Rectangle(-s/2,-s/2,s,s),ee.Geom.Rectangle.Contains),a.on("pointerup",()=>this.dropOrb())}dropOrb(){console.log("Drop orb at current position")}setupInputHandlers(){this.input.on("pointerdown",e=>this.handlePointerInput(e.worldX,e.worldY)),this.input.on("pointermove",e=>{e.isDown&&this.handlePointerInput(e.worldX,e.worldY)}),this.setupKeyboardInput()}setupKeyboardInput(){var a,l,h,d,m,p,b,A,C,L,D,F,U;const e=(a=this.input.keyboard)==null?void 0:a.createCursorKeys(),t=(l=this.input.keyboard)==null?void 0:l.addKeys("W,S,A,D");e&&((h=e.up)==null||h.on("down",()=>this.handlePlayerMove("up")),(d=e.down)==null||d.on("down",()=>this.handlePlayerMove("down")),(m=e.left)==null||m.on("down",()=>this.handlePlayerMove("left")),(p=e.right)==null||p.on("down",()=>this.handlePlayerMove("right"))),t&&((b=t.W)==null||b.on("down",()=>this.handlePlayerMove("up")),(A=t.S)==null||A.on("down",()=>this.handlePlayerMove("down")),(C=t.A)==null||C.on("down",()=>this.handlePlayerMove("left")),(L=t.D)==null||L.on("down",()=>this.handlePlayerMove("right")));const s=(D=this.input.keyboard)==null?void 0:D.addKey(ee.Input.Keyboard.KeyCodes.SPACE),i=(F=this.input.keyboard)==null?void 0:F.addKey(ee.Input.Keyboard.KeyCodes.ESC);s==null||s.on("down",()=>this.handlePauseToggle()),i==null||i.on("down",()=>this.handlePauseToggle());const n=(U=this.input.keyboard)==null?void 0:U.addKey(ee.Input.Keyboard.KeyCodes.R);n==null||n.on("down",()=>this.handleReset())}handlePauseToggle(){if(!(!this.gameCore||!this.gameState))try{this.gameState.status==="playing"?(this.gameCore.pauseGame(),console.log("Game paused")):this.gameState.status==="paused"&&(this.gameCore.resumeGame(),console.log("Game resumed"))}catch(e){console.error("Error toggling pause:",e),this.showErrorFeedback("Failed to pause/resume game",!0)}}handleReset(){if(this.gameCore)try{this.gameCore.resetGame(),console.log("Game reset")}catch(e){console.error("Error resetting game:",e),this.showErrorFeedback("Failed to reset game",!0)}}handleButtonMove(e){const t=e==="up"?"up":e==="down"?"down":e==="left"?"left":"right",s=this.arrowButtons[t];s&&this.tweens.add({targets:s,scaleX:.9,scaleY:.9,duration:100,yoyo:!0,ease:"Power2"}),this.handlePlayerMove(e)}handlePlayerMove(e){if(!this.gameCore||!this.gameState){console.warn("Cannot move player: game not initialized");return}if(this.gameState.status!=="playing"){console.log("Move ignored: game not in playing state");return}try{const t=this.gameCore.movePlayer(e);t.success?console.log(`Player moved ${e} to position (${t.newPosition.x}, ${t.newPosition.y})`):(this.showMoveBlockedFeedback(this.directionToCardinal(e),t.reason),console.log("Move failed:",t.reason))}catch(t){console.error("Error during player move:",t),this.showErrorFeedback("Failed to move player",!0)}}directionToCardinal(e){switch(e){case"up":return"north";case"down":return"south";case"left":return"west";case"right":return"east";default:return"unknown"}}handlePointerInput(e,t){if(!this.gameState){console.warn("Cannot handle pointer input: game state not available");return}if(this.gameState.status!=="playing"){console.log("Pointer input ignored: game not in playing state");return}try{const s=this.gameState.maze;if(!s||s.length===0||!s[0]){console.error("Invalid maze data");return}const i=s[0].length,n=s.length,a=i*Q,l=(this.scale.width-a)/2,h=200,d=Math.floor((e-l)/Q),m=Math.floor((t-h)/Q);if(d<0||m<0||d>=i||m>=n){console.log("Pointer input outside maze bounds");return}const p=this.gameState.player.position,b=d-p.x,A=m-p.y;if(Math.abs(b)+Math.abs(A)!==1){console.log("Pointer input not adjacent to player");return}let C;if(b===1)C="right";else if(b===-1)C="left";else if(A===1)C="down";else if(A===-1)C="up";else{console.error("Invalid direction calculation");return}this.handlePlayerMove(C)}catch(s){console.error("Error handling pointer input:",s),this.showErrorFeedback("Input handling error",!0)}}updateArrowButtons(){if(!this.gameState)return;const e=this.gameState.player.position,t=this.gameState.maze[e.y][e.x];this.arrowButtons.up.setAlpha(t.walls&8?1:.4),this.arrowButtons.down.setAlpha(t.walls&2?1:.4),this.arrowButtons.left.setAlpha(t.walls&4?1:.4),this.arrowButtons.right.setAlpha(t.walls&1?1:.4)}async animatePlayerMovement(e,t){if(this.player)try{const s=this.getMovementDirection(e,t);if(s&&this.playerSpriteSystem)await this.playerSpriteSystem.movePlayer(s,e,t),k.game("Game","Enhanced player movement animation completed",{from:e,to:t,direction:s});else throw new Error("Direction calculation failed or sprite system unavailable")}catch(s){console.warn("Enhanced player animation failed, using fallback:",s),this.tweens.add({targets:this.player,x:this.cx(t.x),y:this.cy(t.y),duration:150})}}async animateOrbCollection(e,t){try{if(this.orbSpriteSystem){await this.orbSpriteSystem.animateOrbCollection(e,{animationDuration:500,particleCount:20,scaleEffect:!0,fadeEffect:!0,soundSync:!0});const i=this.orbs.findIndex(n=>n.getData("orbId")===e);i>=0&&this.orbs.splice(i,1),k.game("Game",`Enhanced orb collection animation completed for ${e}`);return}}catch(i){console.warn("Failed to animate enhanced orb collection, falling back to basic animation:",i)}const s=this.orbs.findIndex(i=>i.getData("orbId")===e);if(s>=0){const i=this.orbs[s];this.tweens.add({targets:i,scaleX:0,scaleY:0,alpha:0,duration:200,onComplete:()=>{i.destroy()}}),this.orbs.splice(s,1)}}updateHintText(){if(!this.gameState||!this.hintText)return;const e=this.gameState.orbs.filter(s=>s.collected).length,t=this.gameState.orbs.length;e>=t?(this.hintText.setText("All orbs collected! Find the goal!"),this.hintText.setStyle({backgroundColor:"#90EE90"})):(this.hintText.setText(`Collect all orbs to unlock the goal! (${e}/${t})`),this.hintText.setStyle({backgroundColor:"#F0E68C"}))}showCompletionUI(e){const t=this.gameCore.getCurrentTime(),s=this.gameCore.getCurrentLevelDefinition();this.add.text(this.scale.width/2,this.scale.height/2-60,"Level Complete!",{fontFamily:"Arial, sans-serif",fontSize:"24px",color:"#7FB069",backgroundColor:"#F5E6D3",padding:{x:20,y:10}}).setOrigin(.5),s&&this.add.text(this.scale.width/2,this.scale.height/2-30,s.metadata.name,{fontFamily:"Arial, sans-serif",fontSize:"16px",color:"#8B7355",backgroundColor:"#F5E6D3",padding:{x:15,y:5}}).setOrigin(.5);const i=Math.floor(t/6e4),n=Math.floor(t%6e4/1e3);this.add.text(this.scale.width/2,this.scale.height/2,`Time: ${i.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`,{fontFamily:"Arial, sans-serif",fontSize:"16px",color:"#8B7355",backgroundColor:"#F5E6D3",padding:{x:15,y:8}}).setOrigin(.5),e&&e.score!==void 0&&this.add.text(this.scale.width/2,this.scale.height/2+30,`Score: ${e.score}`,{fontFamily:"Arial, sans-serif",fontSize:"16px",color:"#8B7355",backgroundColor:"#F5E6D3",padding:{x:15,y:8}}).setOrigin(.5);const a=this.add.text(this.scale.width/2,this.scale.height/2+70,"Continue",{fontFamily:"Arial, sans-serif",fontSize:"18px",color:"#FFFFFF",backgroundColor:"#7FB069",padding:{x:20,y:10}}).setOrigin(.5).setInteractive({useHandCursor:!0});a.on("pointerdown",()=>{this.handleLevelCompletion(s)}),dp(t).catch(()=>{}),this.time.delayedCall(5e3,()=>{a.active&&this.handleLevelCompletion(s)})}async handleLevelCompletion(e){try{if(!e){k.error("Game","No current level definition for completion handling"),this.scene.start("LevelSelect");return}const t=this.gameCore.getCurrentTime();this.progressManager.completeLevel(e.id,t,3);const s=e.progression.unlocks;if(s&&s.length>0){const i=s[0];k.game("Game",`Advancing to next level: ${i}`);try{const n=await this.levelService.loadLevel(i);this.registry.set("selectedLevelId",i),this.registry.set("selectedLevelDefinition",n),this.scene.restart()}catch(n){k.error("Game",`Failed to load next level: ${i}`,n),this.scene.start("LevelSelect")}}else k.game("Game","No more levels available, returning to level select"),this.scene.start("LevelSelect")}catch(t){k.error("Game","Error handling level completion",t),this.scene.start("LevelSelect")}}showMoveBlockedFeedback(e,t){this.player&&this.tweens.add({targets:this.player,x:this.player.x+(e==="east"?5:e==="west"?-5:0),y:this.player.y+(e==="south"?5:e==="north"?-5:0),duration:100,yoyo:!0,ease:"Power2"})}showPauseMenu(){this.gameCore.getGameState().status==="playing"&&this.gameCore.pauseGame(),this.add.rectangle(this.scale.width/2,this.scale.height/2,this.scale.width,this.scale.height,0,.7).setData("isPauseMenu",!0);const t=this.add.container(this.scale.width/2,this.scale.height/2);t.setData("isPauseMenu",!0);const s=this.add.rectangle(0,0,280,320,16115411,1).setStrokeStyle(3,9139029);t.add(s);const i=this.add.text(0,-120,"Game Paused",{fontFamily:"Arial, sans-serif",fontSize:"24px",color:"#7FB069",fontStyle:"bold"}).setOrigin(.5);t.add(i);const n=this.add.text(0,-60,"Resume",{fontFamily:"Arial, sans-serif",fontSize:"18px",color:"#FFFFFF",backgroundColor:"#7FB069",padding:{x:20,y:10}}).setOrigin(.5).setInteractive({useHandCursor:!0});n.on("pointerdown",()=>{this.hidePauseMenu(),this.gameCore.resumeGame()}),t.add(n);const a=this.add.text(0,-10,"Restart Level",{fontFamily:"Arial, sans-serif",fontSize:"18px",color:"#FFFFFF",backgroundColor:"#D2691E",padding:{x:20,y:10}}).setOrigin(.5).setInteractive({useHandCursor:!0});a.on("pointerdown",()=>{this.hidePauseMenu(),this.gameCore.resetGame()}),t.add(a);const l=this.add.text(0,40,"Level Select",{fontFamily:"Arial, sans-serif",fontSize:"18px",color:"#FFFFFF",backgroundColor:"#8B7355",padding:{x:20,y:10}}).setOrigin(.5).setInteractive({useHandCursor:!0});l.on("pointerdown",()=>{this.hidePauseMenu(),this.scene.start("LevelSelect")}),t.add(l);const h=[n,a,l],d=["#8FD17A","#E6A85C","#A0522D"],m=["#7FB069","#D2691E","#8B7355"];h.forEach((p,b)=>{p.on("pointerover",()=>{p.setStyle({backgroundColor:d[b]})}),p.on("pointerout",()=>{p.setStyle({backgroundColor:m[b]})})})}hidePauseMenu(){this.children.list.forEach(e=>{e.getData("isPauseMenu")&&e.destroy()})}showScorePopup(e,t){const s=this.add.text(this.cx(e.x),this.cy(e.y),`+${t}`,{fontFamily:"Arial, sans-serif",fontSize:"16px",color:"#FFD700",fontStyle:"bold"}).setOrigin(.5);this.tweens.add({targets:s,y:s.y-30,alpha:0,duration:1e3,ease:"Power2",onComplete:()=>s.destroy()})}showObjectiveCompletedFeedback(e){const t=this.add.text(this.scale.width/2,180,"Objective Complete!",{fontFamily:"Arial, sans-serif",fontSize:"14px",color:"#7FB069",backgroundColor:"#F5E6D3",padding:{x:10,y:5}}).setOrigin(.5);this.time.delayedCall(2e3,()=>{this.tweens.add({targets:t,alpha:0,duration:500,onComplete:()=>t.destroy()})})}showErrorFeedback(e,t){const s=t?"#FFA500":"#FF0000",i=this.add.text(this.scale.width/2,this.scale.height-80,t?"Warning: "+e:"Error: "+e,{fontFamily:"Arial, sans-serif",fontSize:"12px",color:s,backgroundColor:"#F5E6D3",padding:{x:8,y:4},wordWrap:{width:this.scale.width-40}}).setOrigin(.5);this.time.delayedCall(5e3,()=>{i&&i.active&&this.tweens.add({targets:i,alpha:0,duration:500,onComplete:()=>i.destroy()})})}initializeSpriteSystem(){try{this.layerManager=new Ml(this),this.spriteRenderer=new Vl(this),this.spriteFactory=new Ol({scene:this,defaultTheme:"default",cellSize:Q}),this.orbAnimationController=new _p(this),this.particleEffectManager=new wp(this),this.orbSpriteSystem=new vp(this,this.spriteFactory,this.orbAnimationController,this.particleEffectManager),this.playerSpriteSystem=new yp({scene:this,gameCore:this.gameCore,spriteRenderer:this.spriteRenderer,layerManager:this.layerManager}),k.game("Game","Enhanced sprite systems initialized")}catch(e){console.error("Failed to initialize sprite systems:",e)}}getMovementDirection(e,t){const s=t.x-e.x,i=t.y-e.y;return Math.abs(s)+Math.abs(i)!==1?null:s===1?"right":s===-1?"left":i===1?"down":i===-1?"up":null}destroy(){this.playerSpriteSystem&&this.playerSpriteSystem.destroy(),this.orbSpriteSystem&&this.orbSpriteSystem.clearAllOrbs(),this.orbAnimationController&&this.orbAnimationController.destroy(),this.particleEffectManager&&this.particleEffectManager.destroy(),this.layerManager&&this.layerManager.destroy(),this.spriteRenderer&&this.spriteRenderer.destroy(),this.gameCore&&console.log("GameScene destroyed, cleaning up event listeners"),super.destroy()}}class Tp extends ee.Scene{constructor(){super("Boot")}preload(){}create(){this.scene.start("LevelSelect")}}class bp extends ee.Scene{constructor(){super("LevelSelect"),this.currentPage=0,this.LEVELS_PER_PAGE=20,this.availableLevels=[],this.levelMetadata=new Map}async create(){k.scene("LevelSelect","Scene created - initializing level selection",{sceneKey:this.scene.key,scaleWidth:this.scale.width,scaleHeight:this.scale.height}),this.progressManager=lt.getInstance(),this.levelService=new Qo,this.cameras.main.setBackgroundColor("#F5E6D3"),this.showLoading();try{await this.loadAvailableLevels(),this.hideLoading(),this.createUI(),this.createLevelGrid(),k.scene("LevelSelect","Scene fully loaded",{availableLevels:this.availableLevels.length,currentPage:this.currentPage})}catch(e){k.error("LevelSelect","Failed to create scene",e),this.hideLoading(),this.showError(`Failed to load levels: ${e instanceof Error?e.message:"Unknown error"}`)}}async loadAvailableLevels(){try{console.log(" Loading available levels..."),this.availableLevels=await this.levelService.listAvailableLevels(),console.log(` Found ${this.availableLevels.length} levels:`,this.availableLevels),await this.preloadLevelMetadata(),console.log(" Level metadata preloaded")}catch(e){throw console.error(" Failed to load available levels:",e),e}}async preloadLevelMetadata(){const e=this.currentPage*this.LEVELS_PER_PAGE,t=Math.min(e+this.LEVELS_PER_PAGE,this.availableLevels.length),s=this.availableLevels.slice(e,t);try{(await this.levelService.loadLevels(s,{validateSchema:!1,includeMetadata:!0})).forEach(n=>{this.levelMetadata.set(n.id,n)})}catch(i){console.warn("Failed to preload some level metadata:",i)}}showLoading(){this.loadingText=this.add.text(this.scale.width/2,this.scale.height/2,"Loading levels...",{fontFamily:"Arial, sans-serif",fontSize:"24px",color:"#7FB069",fontStyle:"bold"}).setOrigin(.5)}hideLoading(){this.loadingText&&(this.loadingText.destroy(),this.loadingText=void 0)}showError(e){this.errorText=this.add.text(this.scale.width/2,this.scale.height/2,e,{fontFamily:"Arial, sans-serif",fontSize:"18px",color:"#FF6B6B",fontStyle:"bold",wordWrap:{width:this.scale.width-100}}).setOrigin(.5),this.add.text(this.scale.width/2,this.scale.height/2+60,"Tap to retry",{fontFamily:"Arial, sans-serif",fontSize:"16px",color:"#7FB069",fontStyle:"bold"}).setOrigin(.5).setInteractive({useHandCursor:!0}).on("pointerup",()=>this.scene.restart())}createUI(){this.add.text(this.scale.width/2,50,"Select Level",{fontFamily:"Arial, sans-serif",fontSize:"32px",color:"#7FB069",fontStyle:"bold"}).setOrigin(.5),this.progressManager.getPlayStats();const e=this.progressManager.getTotalStars(),t=this.progressManager.getTotalCoins();this.add.text(this.scale.width/2,90,`Levels: ${this.availableLevels.length} | Stars: ${e} | Coins: ${t}`,{fontFamily:"Arial, sans-serif",fontSize:"14px",color:"#8B7355"}).setOrigin(.5),this.currentPage>0&&this.add.text(50,this.scale.height/2,"",{fontFamily:"Arial, sans-serif",fontSize:"32px",color:"#7FB069"}).setOrigin(.5).setInteractive({useHandCursor:!0}).on("pointerup",()=>this.previousPage());const s=Math.floor(this.availableLevels.length/this.LEVELS_PER_PAGE);this.currentPage<s&&this.add.text(this.scale.width-50,this.scale.height/2,"",{fontFamily:"Arial, sans-serif",fontSize:"32px",color:"#7FB069"}).setOrigin(.5).setInteractive({useHandCursor:!0}).on("pointerup",()=>this.nextPage())}createLevelGrid(){const e=this.currentPage*this.LEVELS_PER_PAGE,t=Math.min(e+this.LEVELS_PER_PAGE,this.availableLevels.length),s=this.availableLevels.slice(e,t),i=5,n=60,a=70,l=(this.scale.width-(i-1)*a)/2,h=150;s.forEach((d,m)=>{const p=m%i,b=Math.floor(m/i),A=l+p*a,C=h+b*a;this.createLevelButton(d,A,C,n)})}createLevelButton(e,t,s,i){const n=this.progressManager.isLevelUnlocked(e),a=this.progressManager.getLevelStats(e),l=this.levelMetadata.get(e);let h=n?a!=null&&a.completed?8368233:16115411:13882323;if(l&&n){const p={easy:8368233,medium:16032353,hard:15167313,expert:10309341};h=a!=null&&a.completed?p[l.metadata.difficulty]:16115411}const d=this.add.circle(t,s,i/2,h).setStrokeStyle(3,n?7048794:11119017),m=this.getLevelDisplayText(e,l);if(this.add.text(t,s-8,m,{fontFamily:"Arial, sans-serif",fontSize:"12px",color:n?"#FFFFFF":"#808080",fontStyle:"bold"}).setOrigin(.5),l&&n&&this.add.text(t,s+8,l.metadata.difficulty.charAt(0).toUpperCase(),{fontFamily:"Arial, sans-serif",fontSize:"10px",color:n?"#FFFFFF":"#808080"}).setOrigin(.5),a!=null&&a.completed&&a.stars>0)for(let p=0;p<a.stars;p++)this.add.text(t-15+p*15,s+20,"",{fontFamily:"Arial, sans-serif",fontSize:"10px",color:"#FFD700"}).setOrigin(.5);n&&d.setInteractive({useHandCursor:!0}).on("pointerup",()=>{k.click("LevelSelect",`Level button clicked: ${e}`,{levelId:e,position:{x:t,y:s},isCompleted:a==null?void 0:a.completed,stars:a==null?void 0:a.stars}),this.selectLevel(e)}).on("pointerover",()=>{k.touch("LevelSelect",`Level button hover: ${e}`,{levelId:e}),this.showLevelTooltip(e,t,s)}).on("pointerout",()=>{k.touch("LevelSelect",`Level button hover end: ${e}`,{levelId:e}),this.hideLevelTooltip()})}getLevelDisplayText(e,t){if(t!=null&&t.metadata.name)return t.metadata.name.length>8?t.metadata.name.substring(0,6)+"...":t.metadata.name;const s=e.match(/(\d+)/);return s?s[1]:e.length>6?e.substring(0,6):e}showLevelTooltip(e,t,s){const i=this.levelMetadata.get(e);if(!i)return;const n=`${i.metadata.name}
${i.metadata.difficulty}  ${i.metadata.estimatedTime}s`,a=this.add.rectangle(t,s-80,120,40,0,.8).setStrokeStyle(1,16777215),l=this.add.text(t,s-80,n,{fontFamily:"Arial, sans-serif",fontSize:"10px",color:"#FFFFFF",align:"center"}).setOrigin(.5);a.setData("isTooltip",!0),l.setData("isTooltip",!0)}hideLevelTooltip(){this.children.list.forEach(e=>{e.getData("isTooltip")&&e.destroy()})}async selectLevel(e){k.click("LevelSelect",`Level selected: ${e}`,{levelId:e,currentPage:this.currentPage,isUnlocked:this.progressManager.isLevelUnlocked(e),levelStats:this.progressManager.getLevelStats(e)});try{k.level("LevelSelect",`Loading level definition for ${e}`);const t=await this.levelService.loadLevel(e);k.level("LevelSelect",`Level loaded successfully: ${e}`,{levelName:t.metadata.name,difficulty:t.metadata.difficulty,generationType:t.generation.type}),this.registry.set("selectedLevelId",e),this.registry.set("selectedLevelDefinition",t),k.scene("LevelSelect","Starting Game scene",{levelId:e}),this.scene.start("Game")}catch(t){k.error("LevelSelect",`Failed to load level: ${e}`,t),console.error("Failed to load level:",t),this.showError(`Failed to load level: ${t instanceof Error?t.message:"Unknown error"}`)}}async previousPage(){this.currentPage>0&&(this.currentPage--,await this.refreshPage())}async nextPage(){const e=Math.floor(this.availableLevels.length/this.LEVELS_PER_PAGE);this.currentPage<e&&(this.currentPage++,await this.refreshPage())}async refreshPage(){this.children.removeAll(),this.showLoading();try{await this.preloadLevelMetadata(),this.hideLoading(),this.createUI(),this.createLevelGrid()}catch(e){this.hideLoading(),this.showError(`Failed to load page: ${e instanceof Error?e.message:"Unknown error"}`)}}}class St{constructor(){this.isActive=!1,this.touchIndicators=[]}static getInstance(){return St.instance||(St.instance=new St),St.instance}activate(){this.isActive||(this.isActive=!0,k.info("TouchDebugger","Touch debugging activated"),document.addEventListener("click",this.handleClick.bind(this),!0),document.addEventListener("touchstart",this.handleTouchStart.bind(this),!0),document.addEventListener("touchmove",this.handleTouchMove.bind(this),!0),document.addEventListener("touchend",this.handleTouchEnd.bind(this),!0),document.addEventListener("pointerdown",this.handlePointerDown.bind(this),!0),document.addEventListener("pointerup",this.handlePointerUp.bind(this),!0),document.addEventListener("mousedown",this.handleMouseDown.bind(this),!0),document.addEventListener("mouseup",this.handleMouseUp.bind(this),!0))}deactivate(){this.isActive&&(this.isActive=!1,k.info("TouchDebugger","Touch debugging deactivated"),document.removeEventListener("click",this.handleClick.bind(this),!0),document.removeEventListener("touchstart",this.handleTouchStart.bind(this),!0),document.removeEventListener("touchmove",this.handleTouchMove.bind(this),!0),document.removeEventListener("touchend",this.handleTouchEnd.bind(this),!0),document.removeEventListener("pointerdown",this.handlePointerDown.bind(this),!0),document.removeEventListener("pointerup",this.handlePointerUp.bind(this),!0),document.removeEventListener("mousedown",this.handleMouseDown.bind(this),!0),document.removeEventListener("mouseup",this.handleMouseUp.bind(this),!0),this.clearTouchIndicators())}handleClick(e){var i;const t=e.target,s={x:e.clientX,y:e.clientY};k.click("DOM",`Click on ${this.getElementDescription(t)}`,{tagName:t.tagName,className:t.className,id:t.id,textContent:(i=t.textContent)==null?void 0:i.substring(0,50),position:s,button:e.button,ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,altKey:e.altKey},s),this.showTouchIndicator(s,"click")}handleTouchStart(e){const t=e.target;Array.from(e.touches).forEach((s,i)=>{var a;const n={x:s.clientX,y:s.clientY};k.touch("DOM",`Touch start ${i+1}/${e.touches.length} on ${this.getElementDescription(t)}`,{tagName:t.tagName,className:t.className,id:t.id,textContent:(a=t.textContent)==null?void 0:a.substring(0,50),position:n,touchId:s.identifier,force:s.force,radiusX:s.radiusX,radiusY:s.radiusY},n),this.showTouchIndicator(n,"touchstart")})}handleTouchMove(e){if(Math.random()>.2)return;const t=e.target;Array.from(e.touches).forEach((s,i)=>{const n={x:s.clientX,y:s.clientY};k.touch("DOM",`Touch move ${i+1}/${e.touches.length}`,{tagName:t.tagName,position:n,touchId:s.identifier},n)})}handleTouchEnd(e){const t=e.target;Array.from(e.changedTouches).forEach((s,i)=>{const n={x:s.clientX,y:s.clientY};k.touch("DOM",`Touch end ${i+1} on ${this.getElementDescription(t)}`,{tagName:t.tagName,className:t.className,id:t.id,position:n,touchId:s.identifier},n),this.showTouchIndicator(n,"touchend")})}handlePointerDown(e){const t=e.target,s={x:e.clientX,y:e.clientY};k.touch("DOM",`Pointer down (${e.pointerType}) on ${this.getElementDescription(t)}`,{tagName:t.tagName,className:t.className,id:t.id,position:s,pointerId:e.pointerId,pointerType:e.pointerType,pressure:e.pressure,width:e.width,height:e.height},s)}handlePointerUp(e){const t=e.target,s={x:e.clientX,y:e.clientY};k.touch("DOM",`Pointer up (${e.pointerType}) on ${this.getElementDescription(t)}`,{tagName:t.tagName,className:t.className,id:t.id,position:s,pointerId:e.pointerId,pointerType:e.pointerType},s)}handleMouseDown(e){const t=e.target,s={x:e.clientX,y:e.clientY};k.touch("DOM",`Mouse down on ${this.getElementDescription(t)}`,{tagName:t.tagName,className:t.className,id:t.id,position:s,button:e.button},s)}handleMouseUp(e){const t=e.target,s={x:e.clientX,y:e.clientY};k.touch("DOM",`Mouse up on ${this.getElementDescription(t)}`,{tagName:t.tagName,className:t.className,id:t.id,position:s,button:e.button},s)}getElementDescription(e){let t=e.tagName.toLowerCase();if(e.id&&(t+=`#${e.id}`),e.className){const s=e.className.split(" ").filter(i=>i.trim()).slice(0,2);s.length>0&&(t+=`.${s.join(".")}`)}if(e.textContent&&e.textContent.trim()){const s=e.textContent.trim().substring(0,20);t+=` "${s}${e.textContent.length>20?"...":""}"`}return t}showTouchIndicator(e,t){const s=document.createElement("div"),i={click:"#00ff00",touchstart:"#00ffff",touchend:"#ff00ff",default:"#ffff00"},n=i[t]||i.default;if(s.style.cssText=`
      position: fixed;
      left: ${e.x-10}px;
      top: ${e.y-10}px;
      width: 20px;
      height: 20px;
      border: 2px solid ${n};
      border-radius: 50%;
      background: ${n}33;
      z-index: 9999;
      pointer-events: none;
      animation: touchIndicator 1s ease-out forwards;
    `,!document.getElementById("touch-indicator-styles")){const a=document.createElement("style");a.id="touch-indicator-styles",a.textContent=`
        @keyframes touchIndicator {
          0% { transform: scale(1); opacity: 1; }
          100% { transform: scale(2); opacity: 0; }
        }
      `,document.head.appendChild(a)}document.body.appendChild(s),this.touchIndicators.push(s),setTimeout(()=>{s.parentNode&&s.parentNode.removeChild(s);const a=this.touchIndicators.indexOf(s);a>-1&&this.touchIndicators.splice(a,1)},1e3)}clearTouchIndicators(){this.touchIndicators.forEach(e=>{e.parentNode&&e.parentNode.removeChild(e)}),this.touchIndicators=[]}}const er=St.getInstance(),ns=class ns{static initialize(){ns.initialized||(ns.initialized=!0,k.info("Debug","Initializing debug system"),er.activate(),k.info("App","Application starting",{userAgent:navigator.userAgent,platform:navigator.platform,language:navigator.language,screenSize:{width:screen.width,height:screen.height,availWidth:screen.availWidth,availHeight:screen.availHeight},windowSize:{width:window.innerWidth,height:window.innerHeight},devicePixelRatio:window.devicePixelRatio,timestamp:new Date().toISOString()}),window.Capacitor&&k.info("Capacitor","Capacitor detected",{platform:window.Capacitor.getPlatform(),isNativePlatform:window.Capacitor.isNativePlatform(),plugins:Object.keys(window.Capacitor.Plugins||{})}),window.Phaser&&k.info("Phaser","Phaser detected",{version:window.Phaser.VERSION}),window.addEventListener("resize",()=>{k.info("Window","Window resized",{newSize:{width:window.innerWidth,height:window.innerHeight}})}),window.addEventListener("orientationchange",()=>{var e,t;k.info("Device","Orientation changed",{orientation:((e=screen.orientation)==null?void 0:e.angle)||"unknown",type:((t=screen.orientation)==null?void 0:t.type)||"unknown"})}),document.addEventListener("visibilitychange",()=>{k.info("App",`App ${document.hidden?"backgrounded":"foregrounded"}`,{hidden:document.hidden,visibilityState:document.visibilityState})}),window.addEventListener("load",()=>{k.info("App","Page fully loaded")}),window.addEventListener("beforeunload",()=>{k.info("App","Page unloading")}),window.debugCommands={showDebug:()=>k.show(),hideDebug:()=>k.hide(),toggleDebug:()=>k.toggle(),clearDebug:()=>k.clear(),exportLogs:()=>{const e=k.exportLogs();return console.log("Exported logs:",e),e},enableTouchDebug:()=>er.activate(),disableTouchDebug:()=>er.deactivate(),logTest:()=>{k.info("Test","Test log message",{test:!0}),k.click("Test","Test click",{x:100,y:100},{x:100,y:100}),k.error("Test","Test error",new Error("Test error"))}},k.info("Debug","Debug system initialized successfully",{touchDebugging:!0,globalCommands:Object.keys(window.debugCommands)}))}static logPhaserEvent(e,t,s){k.game("Phaser",`${e}: ${t}`,s)}static logCapacitorEvent(e,t,s){k.info("Capacitor",`${e}.${t}`,s)}static logLevelEvent(e,t,s){k.level("Level",`${e}: ${t}`,s)}static logUserAction(e,t,s){k.click("User",e,t,s)}};ns.initialized=!1;let vr=ns;vr.initialize();cp();const Sp=360,Ap=640,Ip={type:ee.AUTO,parent:"app",backgroundColor:"#0f0f12",scale:{mode:ee.Scale.FIT,autoCenter:ee.Scale.CENTER_BOTH,width:Sp,height:Ap},physics:{default:"arcade",arcade:{gravity:{y:0},debug:!1}},scene:[Tp,bp,Ep]};new ee.Game(Ip);
